<?php
// Log de debug
$logFile = __DIR__ . '/../../storage/logs/conversas_bug.log';
@file_put_contents($logFile, date('Y-m-d H:i:s') . " - Carregando views/conversations/index.php\n", FILE_APPEND);

$layout = 'layouts.metronic.app';
$title = 'Conversas';
$pageTitle = 'Conversas';
$hidePageTitle = true; // Não mostrar título padrão, vamos usar layout customizado
$hideRightSidebar = true; // Esconder sidebar padrão do Metronic (vamos usar nosso próprio)

/**
 * Renderizar anexo
 */
function renderAttachment($attachment) {
    $type = $attachment['type'] ?? 'document';
    
    // Renderizar contato compartilhado (vCard)
    if ($type === 'contact') {
        $displayName = htmlspecialchars($attachment['display_name'] ?? 'Contato');
        $phones = $attachment['phones'] ?? [];
        $emails = $attachment['emails'] ?? [];
        $org = htmlspecialchars($attachment['organization'] ?? '');
        
        $html = '<div class="attachment-item mb-2">';
        $html .= '<div class="d-flex align-items-start gap-3 p-3 border rounded" style="background: rgba(255,255,255,0.05); max-width: 300px;">';
        
        // Avatar placeholder
        $html .= '<div style="flex-shrink:0; width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center;">';
        $initials = mb_strtoupper(mb_substr($displayName, 0, 1));
        $html .= '<span style="color:#fff; font-size:18px; font-weight:600;">' . $initials . '</span>';
        $html .= '</div>';
        
        $html .= '<div class="flex-grow-1" style="min-width:0;">';
        $html .= '<div class="fw-bold" style="font-size:14px;">' . $displayName . '</div>';
        if ($org) {
            $html .= '<div class="text-muted fs-8">' . $org . '</div>';
        }
        foreach ($phones as $phone) {
            $phoneNum = htmlspecialchars($phone['formatted'] ?? $phone['number'] ?? '');
            if ($phoneNum) {
                $html .= '<div class="d-flex align-items-center gap-1 mt-1">';
                $html .= '<i class="ki-duotone ki-phone fs-7 text-success"><span class="path1"></span><span class="path2"></span></i>';
                $html .= '<span class="fs-7 text-gray-700">' . $phoneNum . '</span>';
                $html .= '</div>';
            }
        }
        foreach ($emails as $email) {
            $html .= '<div class="d-flex align-items-center gap-1 mt-1">';
            $html .= '<i class="ki-duotone ki-sms fs-7 text-primary"><span class="path1"></span><span class="path2"></span></i>';
            $html .= '<span class="fs-7 text-gray-700">' . htmlspecialchars($email) . '</span>';
            $html .= '</div>';
        }
        $html .= '</div>';
        
        $html .= '</div>';
        $html .= '</div>';
        return $html;
    }
    
    // Renderizar localização
    if ($type === 'location' && isset($attachment['latitude']) && isset($attachment['longitude'])) {
        $lat = $attachment['latitude'];
        $lng = $attachment['longitude'];
        $name = htmlspecialchars($attachment['name'] ?? 'Localização');
        $address = htmlspecialchars($attachment['address'] ?? '');
        $mapsUrl = "https://www.google.com/maps?q={$lat},{$lng}";
        
        $html = '<div class="attachment-item mb-2">';
        $html .= '<a href="' . $mapsUrl . '" target="_blank" class="d-flex align-items-center gap-2 p-2 border rounded" style="text-decoration: none; color: inherit; background: rgba(255,255,255,0.05);">';
        $html .= '<i class="ki-duotone ki-geolocation fs-2 text-danger">';
        $html .= '<span class="path1"></span>';
        $html .= '<span class="path2"></span>';
        $html .= '</i>';
        $html .= '<div class="flex-grow-1">';
        $html .= '<div class="fw-semibold">' . $name . '</div>';
        if ($address) {
            $html .= '<div class="text-muted fs-7">' . $address . '</div>';
        }
        $html .= '<div class="text-muted fs-7">' . $lat . ', ' . $lng . '</div>';
        $html .= '</div>';
        $html .= '<i class="ki-duotone ki-arrow-top-right fs-4 text-primary">';
        $html .= '<span class="path1"></span>';
        $html .= '<span class="path2"></span>';
        $html .= '</i>';
        $html .= '</a>';
        $html .= '</div>';
        return $html;
    }
    
    // ✓ CORRIGIDO: Usar campo 'url' se disponível, senão construir a partir de 'path'
    $url = !empty($attachment['url']) 
        ? $attachment['url'] 
        : \App\Helpers\Url::to('/' . ltrim($attachment['path'] ?? '', '/'));
    
    $name = htmlspecialchars($attachment['original_name'] ?? 'Anexo');
    
    $html = '<div class="attachment-item mb-2">';
    
    if ($type === 'image') {
        // Placeholder base64 simples (pixel transparente 1x1)
        $placeholder = 'data:image/svg+xml;base64,' . base64_encode('<svg width="300" height="300" xmlns="http://www.w3.org/2000/svg"><rect width="300" height="300" fill="#f0f0f0"/></svg>');
        $html .= '<a href="javascript:void(0);" onclick="openImageLightbox(\'' . addslashes($url) . '\', \'' . addslashes($name) . '\'); return false;" class="d-inline-block lazy-image-container" data-src="' . $url . '" style="position: relative;">';
        $html .= '<img src="' . $placeholder . '" alt="' . $name . '" data-src="' . $url . '" class="lazy-image" style="max-width: 300px; max-height: 300px; border-radius: 8px; cursor: pointer; background: #f0f0f0; min-width: 100px; min-height: 100px;">';
        $html .= '<div class="lazy-loading-spinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>';
        $html .= '</a>';
    } elseif ($type === 'video') {
        $html .= '<div class="lazy-video-container" data-src="' . $url . '" data-type="' . ($attachment['mime_type'] ?? $attachment['mimetype'] ?? 'video/mp4') . '">';
        $html .= '<div class="lazy-video-placeholder" style="max-width: 300px; max-height: 200px; border-radius: 8px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; cursor: pointer; min-height: 200px;">';
        $html .= '<i class="ki-duotone ki-play fs-2x text-primary"><span class="path1"></span><span class="path2"></span></i>';
        $html .= '</div>';
        $html .= '<video controls style="max-width: 300px; max-height: 200px; border-radius: 8px; display: none;" preload="none">';
        $html .= '<source src="" type="' . ($attachment['mime_type'] ?? $attachment['mimetype'] ?? 'video/mp4') . '">';
        $html .= 'Seu navegador não suporta vídeo.';
        $html .= '</video>';
        $html .= '</div>';
    } elseif ($type === 'audio') {
        // Player de íudio estilo WhatsApp com largura adequada
        $html .= '<div class="attachment audio-attachment">';
        $html .= '<div class="d-flex align-items-center gap-2">';
        $html .= '<div class="me-1" style="flex-shrink: 0;">';
        $html .= '<i class="ki-duotone ki-music fs-4 text-primary" style="min-width: 20px; font-size: 18px !important;">';
        $html .= '<span class="path1"></span>';
        $html .= '<span class="path2"></span>';
        $html .= '</i>';
        $html .= '</div>';
        $html .= '<div class="flex-grow-1" style="min-width: 0; max-width: 100%;">';
        $html .= '<audio controls style="width: 100%; outline: none;">';
        $html .= '<source src="' . $url . '" type="' . ($attachment['mime_type'] ?? $attachment['mimetype'] ?? 'audio/webm') . '">';
        $html .= 'Seu navegador não suporta íudio.';
        $html .= '</audio>';
        
        // ✓ NOVO: Exibir transcrição/texto original se disponível e configurado
        $settings = \App\Services\ConversationSettingsService::getSettings();
        $showTranscription = $settings['audio_transcription']['show_transcription_in_chat'] ?? true;
        
        if ($showTranscription) {
            // Verificar se é íudio TTS (tem texto original) ou íudio transcrito
            $ttsOriginalText = $attachment['tts_original_text'] ?? null;
            $transcription = $attachment['transcription'] ?? null;
            
            if ($ttsOriginalText) {
                // üudio gerado pela IA - exibir texto original
                $html .= '<div class="audio-transcription mt-2" style="padding: 8px; background: rgba(52, 211, 153, 0.1); border-radius: 6px; border-left: 3px solid #34d399;">';
                $html .= '<div class="d-flex align-items-center gap-1 mb-1">';
                $html .= '<i class="ki-duotone ki-message-text-2 fs-7 text-success"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>';
                $html .= '<span class="text-success fs-8 fw-semibold">Conteúdo do íudio:</span>';
                $html .= '</div>';
                $html .= '<div class="fs-7" style="color: rgba(0,0,0,0.7);">' . nl2br(htmlspecialchars($ttsOriginalText)) . '</div>';
                $html .= '</div>';
            } elseif ($transcription && !empty($transcription['text'])) {
                // üudio do cliente - exibir transcrição
                $html .= '<div class="audio-transcription mt-2" style="padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px; border-left: 3px solid #3b82f6;">';
                $html .= '<div class="d-flex align-items-center gap-1 mb-1">';
                $html .= '<i class="ki-duotone ki-text fs-7 text-muted"><span class="path1"></span><span class="path2"></span></i>';
                $html .= '<span class="text-muted fs-8 fw-semibold">Transcrição:</span>';
                $html .= '</div>';
                $html .= '<div class="fs-7" style="color: rgba(0,0,0,0.7);">' . nl2br(htmlspecialchars($transcription['text'])) . '</div>';
                $html .= '</div>';
            }
        }
        
        $html .= '</div>';
        $html .= '</div>';
        $html .= '</div>';
    } else {
        // Para documentos, usar URL direta se o arquivo estiver em assets/
        $attachmentPath = $attachment['path'] ?? '';
        if (strpos($attachmentPath, 'assets/') === 0) {
            // Caminho direto para arquivo público
            $downloadUrl = \App\Helpers\Url::to('/' . $attachmentPath);
        } else {
            // Rota de download para arquivos fora de assets/
            $downloadUrl = \App\Helpers\Url::to('/attachments/' . urlencode($attachmentPath) . '/download');
        }
        
        // Verificar se é PDF para exibir botão de preview
        $mimeType = $attachment['mime_type'] ?? $attachment['mimetype'] ?? '';
        $ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
        $isPdf = ($ext === 'pdf' || strpos($mimeType, 'pdf') !== false);
        
        // URL para visualização inline (sem /download)
        $viewUrl = '';
        if ($isPdf) {
            if (strpos($attachmentPath, 'assets/') === 0) {
                $viewUrl = \App\Helpers\Url::to('/' . $attachmentPath);
            } else {
                $viewUrl = \App\Helpers\Url::to('/attachments/' . urlencode($attachmentPath));
            }
        }
        
        // Ícone contextual baseado na extensão
        $iconClass = 'ki-file';
        if ($isPdf) $iconClass = 'ki-document';
        elseif (in_array($ext, ['doc', 'docx', 'odt', 'rtf'])) $iconClass = 'ki-notepad';
        elseif (in_array($ext, ['xls', 'xlsx', 'ods', 'csv'])) $iconClass = 'ki-chart-simple';
        elseif (in_array($ext, ['ppt', 'pptx', 'odp'])) $iconClass = 'ki-screen';
        elseif (in_array($ext, ['zip', 'rar', '7z', 'gz', 'tar'])) $iconClass = 'ki-archive';
        elseif (in_array($ext, ['psd', 'ai', 'cdr', 'eps', 'indd'])) $iconClass = 'ki-design-2';
        
        $html .= '<div class="d-flex align-items-center gap-2 p-2 border rounded doc-link" style="background: rgba(255,255,255,0.05);">';
        $html .= '<i class="ki-duotone ' . $iconClass . ' fs-2" style="flex-shrink:0;">';
        $html .= '<span class="path1"></span>';
        $html .= '<span class="path2"></span>';
        $html .= '</i>';
        $html .= '<div class="flex-grow-1 document-box">';
        $html .= '<div class="fw-semibold doc-filename" title="' . $name . '">' . $name . '</div>';
        if (isset($attachment['size'])) {
            $size = $attachment['size'];
            $sizeStr = $size < 1024 ? $size . ' Bytes' : ($size < 1048576 ? round($size / 1024, 2) . ' KB' : round($size / 1048576, 2) . ' MB');
            $html .= '<div class="text-muted fs-7">' . $sizeStr . '</div>';
        }
        $html .= '</div>';
        
        // Botão de visualização para PDF
        if ($isPdf && $viewUrl) {
            $html .= '<a href="' . $viewUrl . '" target="_blank" class="pdf-preview-btn" title="Visualizar PDF" onclick="event.stopPropagation();">';
            $html .= '<i class="ki-duotone ki-eye fs-4 text-info">';
            $html .= '<span class="path1"></span>';
            $html .= '<span class="path2"></span>';
            $html .= '<span class="path3"></span>';
            $html .= '</i>';
            $html .= '</a>';
        }
        
        // Botão de download
        $html .= '<a href="' . $downloadUrl . '" target="_blank" title="Baixar arquivo" onclick="event.stopPropagation();" style="flex-shrink:0; text-decoration:none;">';
        $html .= '<i class="ki-duotone ki-arrow-down fs-4 text-primary">';
        $html .= '<span class="path1"></span>';
        $html .= '<span class="path2"></span>';
        $html .= '</i>';
        $html .= '</a>';
        $html .= '</div>';
    }
    
    $html .= '</div>';
    return $html;
}

/**
 * Formatar data para exibição (HOJE, ONTEM, ou data formatada)
 */
function formatDateLabel($dateString) {
    $date = new DateTime($dateString);
    $today = new DateTime();
    $yesterday = new DateTime('yesterday');
    
    $dateOnly = $date->format('Y-m-d');
    $todayOnly = $today->format('Y-m-d');
    $yesterdayOnly = $yesterday->format('Y-m-d');
    
    if ($dateOnly === $todayOnly) {
        return 'HOJE';
    } elseif ($dateOnly === $yesterdayOnly) {
        return 'ONTEM';
    } else {
        // Formato: "DIA X" (ex: "15 de Janeiro de 2025")
        $months = [
            1 => 'Janeiro', 2 => 'Fevereiro', 3 => 'Março', 4 => 'Abril',
            5 => 'Maio', 6 => 'Junho', 7 => 'Julho', 8 => 'Agosto',
            9 => 'Setembro', 10 => 'Outubro', 11 => 'Novembro', 12 => 'Dezembro'
        ];
        $day = (int)$date->format('d');
        $month = (int)$date->format('m');
        $year = (int)$date->format('Y');
        
        return $day . ' de ' . $months[$month] . ' de ' . $year;
    }
}

/**
 * Verificar se duas datas são de dias diferentes
 */
function isDifferentDay($date1, $date2) {
    if (empty($date1) || empty($date2)) {
        return false;
    }
    
    $d1 = new DateTime($date1);
    $d2 = new DateTime($date2);
    
    return $d1->format('Y-m-d') !== $d2->format('Y-m-d');
}

/**
 * Renderizar separador de data
 */
function renderDateSeparator($dateString) {
    $label = formatDateLabel($dateString);
    return '<div class="date-separator" data-date="' . htmlspecialchars($dateString) . '">
        <span class="date-separator-line"></span>
        <span class="date-separator-label">' . htmlspecialchars($label) . '</span>
        <span class="date-separator-line"></span>
    </div>';
}

/**
 * Obter ícone SVG oficial do canal
 */
function getChannelIconSvg($channel, $size = 16) {
    $icons = [
        'whatsapp' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#25D366" style="vertical-align: middle;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>',
        'whatsapp_official' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#25D366" style="vertical-align: middle;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>',
        'instagram' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="url(#instagram-gradient)" style="vertical-align: middle;"><defs><linearGradient id="instagram-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#833AB4;stop-opacity:1" /><stop offset="50%" style="stop-color:#FD1D1D;stop-opacity:1" /><stop offset="100%" style="stop-color:#FCAF45;stop-opacity:1" /></linearGradient></defs><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>',
        'facebook' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#1877F2" style="vertical-align: middle;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>',
        'instagram_comment' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="url(#instagram-gradient-php-comment)" style="vertical-align: middle;"><defs><linearGradient id="instagram-gradient-php-comment" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#833AB4;stop-opacity:1" /><stop offset="50%" style="stop-color:#FD1D1D;stop-opacity:1" /><stop offset="100%" style="stop-color:#FCAF45;stop-opacity:1" /></linearGradient></defs><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>',
        'tiktok' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#000000" style="vertical-align: middle;"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>',
        'telegram' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#0088cc" style="vertical-align: middle;"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>',
        'email' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>',
        'chat' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>',
        'mercadolivre' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#FFF159" style="vertical-align: middle;"><path d="M12.5 0C5.596 0 0 5.596 0 12.5S5.596 25 12.5 25 25 19.404 25 12.5 19.404 0 12.5 0zm0 22.5c-5.523 0-10-4.477-10-10S6.977 2.5 12.5 2.5 22.5 6.977 22.5 12.5 18.023 22.5 12.5 22.5z"/><path d="M8.75 7.5h7v9h-7z" fill="#3483FA"/></svg>',
        'webchat' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>',
        'olx' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#00A859" style="vertical-align: middle;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
        'linkedin' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#0077B5" style="vertical-align: middle;"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>',
        'google_business' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#4285F4" style="vertical-align: middle;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
        'youtube' => '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="#FF0000" style="vertical-align: middle;"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>'
    ];
    
    return $icons[$channel] ?? '<svg xmlns="http://www.w3.org/2000/svg" width="' . $size . '" height="' . $size . '" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>';
}

/**
 * Renderizar status de mensagem
 */
function renderMessageStatus($msg) {
    $status = $msg['status'] ?? 'sent';
    $readAt = $msg['read_at'] ?? null;
    $deliveredAt = $msg['delivered_at'] ?? null;
    $errorMessage = $msg['error_message'] ?? null;
    
    // Se houver erro
    if ($status === 'failed' || !empty($errorMessage)) {
        $errorText = htmlspecialchars($errorMessage ?? 'Erro ao enviar');
        
        // Verificar se é erro de número sem WhatsApp (no LID found)
        $isNoWhatsApp = !empty($errorMessage) && (
            stripos($errorMessage, 'no LID found') !== false ||
            stripos($errorMessage, 'not a valid whatsapp') !== false ||
            stripos($errorMessage, 'invalid whatsapp') !== false
        );
        
        if ($isNoWhatsApp) {
            return '<div class="message-error-container">
                <span class="message-status message-status-error" title="' . $errorText . '">
                    <i class="ki-duotone ki-cross-circle fs-6">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <span class="message-status-label">Erro</span>
                </span>
                <div class="message-error-alert mt-2">
                    <i class="ki-duotone ki-information-3 fs-5 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <span>Esse número não possui WhatsApp vinculado!</span>
                </div>
            </div>';
        }
        
        return '<span class="message-status message-status-error" title="' . $errorText . '">
            <i class="ki-duotone ki-cross-circle fs-6">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
            <span class="message-status-label">Erro</span>
        </span>';
    }
    
    // Se foi lida
    if (!empty($readAt)) {
        return '<span class="message-status" title="Lida em ' . date('d/m/Y H:i', strtotime($readAt)) . '">
            <i class="ki-duotone ki-double-check fs-6" style="color: #0088cc;">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
            <span class="message-status-label">Lida</span>
        </span>';
    }
    
    // Se foi entregue
    if (!empty($deliveredAt)) {
        return '<span class="message-status" title="Entregue em ' . date('d/m/Y H:i', strtotime($deliveredAt)) . '">
            <i class="ki-duotone ki-double-check fs-6 text-white">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
            <span class="message-status-label">Entregue</span>
        </span>';
    }
    
    // Enviado (padrão)
    return '<span class="message-status" title="Enviado">
        <i class="ki-duotone ki-check fs-6 text-white">
            <span class="path1"></span>
        </i>
        <span class="message-status-label">Enviado</span>
    </span>';
}

// Content
ob_start();
?>

<style>
/* Garantir que dropdowns do header fiquem acima do layout de conversas */
#kt_header .menu-sub-dropdown,
#kt_header [data-kt-menu="true"],
.header .menu.menu-sub.menu-sub-dropdown {
    z-index: 1200 !important;
}

/* Cabeçalho de Mêtricas */
.conversations-metrics-header {
    padding: 15px 20px;
    background: var(--bs-body-bg);
    border-bottom: 1px solid var(--bs-border-color);
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    position: sticky;
    top: 0;
    z-index: 100;
}

.conversations-metrics-header h2 {
    margin: 0;
    white-space: nowrap;
}

.conversations-metrics-header #agent-metrics-container {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-left: auto;
}

.conversations-metrics-header #agent-metrics-container > div {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

/* Layout Principal - 3 Colunas */
.conversations-layout {
    display: flex;
    flex-direction: row;
    height: calc(100vh - 180px); /* Ajustado para incluir o cabeçalho de mêtricas */
    overflow: hidden;
    margin: 0;
    padding: 0 20px 0 0; /* Padding á direita para respiro */
    position: relative;
    z-index: 1; /* Z-index baixo para não sobrepor o header */
    width: 100%; /* 100% da largura disponível */
    box-sizing: border-box; /* Inclui padding na largura */
}

/* Forçar o container pai a ocupar toda largura - Remove padding do sidebar do Metronic */
.sidebar-enabled .wrapper {
    padding-right: 0 !important;
}

.app-content {
    max-width: 100% !important;
    padding-right: 0 !important;
}

.app-wrapper {
    padding-right: 0 !important;
}

.app-main {
    padding-right: 0 !important;
}

/* Coluna 1: Lista de Conversas */
.conversations-list {
    width: 380px;
    flex-shrink: 0;
    border-right: 1px solid var(--bs-border-color);
    display: flex;
    flex-direction: column;
    background: var(--bs-body-bg);
}

.conversations-list-header {
    padding: 20px;
    border-bottom: 1px solid var(--bs-border-color);
    flex-shrink: 0;
}

/* Grid de filtros: 2 colunas preenchendo toda a largura */
.filters-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
}

.filters-grid .form-select {
    width: 100% !important;
    min-width: 0 !important;
    font-size: 11.5px !important;
    padding: 4px 28px 4px 8px !important;
    height: 30px !important;
}

/* Painel de filtros (dropdown abaixo das abas) */
.filters-panel {
    background: var(--bs-body-bg);
    border-bottom: 1px solid var(--bs-border-color);
    padding: 10px 12px;
    flex-shrink: 0;
    animation: filterSlideDown 0.15s ease-out;
}

@keyframes filterSlideDown {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Botão de filtro na barra de abas */
.conversation-filter-btn {
    width: 30px !important;
    height: 30px !important;
    border-radius: 6px !important;
    padding: 0 !important;
    color: var(--bs-gray-500);
    background: transparent;
    border: 1px solid transparent;
    transition: all 0.15s ease;
}

.conversation-filter-btn:hover {
    color: var(--bs-primary);
    background: var(--bs-gray-100);
    border-color: var(--bs-border-color);
}

.conversation-filter-btn.filter-active {
    color: var(--bs-primary);
    background: rgba(var(--bs-primary-rgb), 0.1);
    border-color: var(--bs-primary);
}

.conversations-list-items {
    flex: 1;
    overflow-y: auto;
    overflow-x: visible; /* Permitir que dropdowns não sejam cortados */
}

/* ============================================
   ABAS DE CONVERSAS
   ============================================ */
.conversation-tabs-bar {
    flex-shrink: 0;
    background: var(--bs-body-bg);
    padding: 0 8px;
    padding-top: 6px;
    /* Linha inferior que conecta as abas com a lista */
    border-bottom: 2px solid var(--bs-primary);
    position: relative;
}

.hide-scrollbar::-webkit-scrollbar {
    display: none;
}
.hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.conversation-tab {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    /* Apenas cantos superiores arredondados */
    border-radius: 8px 8px 0 0;
    font-size: 12px;
    font-weight: 500;
    color: var(--bs-gray-600);
    background: transparent;
    border: 1px solid transparent;
    border-bottom: none;
    transition: all 0.15s ease;
    white-space: nowrap;
    cursor: pointer;
    margin-bottom: -2px; /* Para sobrepor a borda inferior */
    position: relative;
    z-index: 1;
}

.conversation-tab:hover {
    background: var(--bs-gray-200);
    color: var(--bs-gray-800);
    border-color: var(--bs-border-color);
    border-bottom: none;
}

.conversation-tab.active {
    background: var(--bs-primary);
    color: #fff;
    border-color: var(--bs-primary);
    border-bottom: 2px solid var(--bs-primary);
    z-index: 2;
}

.conversation-tab .tab-color-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.conversation-tab.active .tab-color-dot {
    border: 1.5px solid rgba(255,255,255,0.7);
}

.conversation-tab .tab-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    border-radius: 9px;
    font-size: 10px;
    font-weight: 600;
    background: rgba(0,0,0,0.1);
    color: inherit;
}

.conversation-tab.active .tab-count {
    background: rgba(255,255,255,0.25);
    color: #fff;
}

.conversation-tab-add {
    width: 26px !important;
    height: 26px !important;
    border-radius: 6px 6px 0 0 !important;
    padding: 0 !important;
    margin-bottom: -2px;
    color: var(--bs-gray-500);
    background: transparent;
    border: 1px dashed var(--bs-border-color);
    border-bottom: none;
}

.conversation-tab-add:hover {
    color: var(--bs-primary);
    background: var(--bs-gray-100);
    border-color: var(--bs-primary);
}

/* Dark mode */
body.dark-mode .conversation-tab:hover,
[data-bs-theme="dark"] .conversation-tab:hover {
    background: var(--bs-gray-800);
    color: var(--bs-gray-300);
    border-color: var(--bs-gray-700);
}

body.dark-mode .conversation-tab.active,
[data-bs-theme="dark"] .conversation-tab.active {
    background: var(--bs-primary);
    color: #fff;
    border-color: var(--bs-primary);
}

body.dark-mode .conversation-tab-add,
[data-bs-theme="dark"] .conversation-tab-add {
    border-color: var(--bs-gray-700);
    color: var(--bs-gray-500);
}

body.dark-mode .conversation-tab-add:hover,
[data-bs-theme="dark"] .conversation-tab-add:hover {
    color: var(--bs-primary);
    background: var(--bs-gray-800);
}

body.dark-mode .conversation-filter-btn:hover,
[data-bs-theme="dark"] .conversation-filter-btn:hover {
    background: var(--bs-gray-800);
    border-color: var(--bs-gray-700);
}

body.dark-mode .filters-panel,
[data-bs-theme="dark"] .filters-panel {
    background: var(--bs-gray-900);
    border-color: var(--bs-gray-700);
}

/* Submenu "Setar como" inline no dropdown */
.set-as-submenu {
    border-top: 1px solid var(--bs-border-color);
    background: var(--bs-gray-100);
    margin: 0 -8px;
    padding: 8px 12px !important;
}

body.dark-mode .set-as-submenu,
[data-bs-theme="dark"] .set-as-submenu {
    background: var(--bs-gray-800);
}

/* Modal de gerenciamento de abas - altura mínima */
.swal2-html-container-tabs {
    min-height: 400px !important;
}

.conversation-item {
    padding: 15px 20px;
    border-bottom: 1px solid var(--bs-border-color);
    cursor: pointer;
    transition: background 0.15s ease;
    position: relative;
    overflow: visible; /* Permitir que dropdown apareça completamente */
}

.conversation-item:hover {
    background: var(--bs-gray-100);
}

.conversation-item.active {
    background: var(--bs-primary-light);
    border-left: 3px solid var(--bs-primary);
}

.conversation-item.pinned {
    background: rgba(255, 193, 7, 0.05);
    border-left: 3px solid rgba(255, 193, 7, 0.3);
}

.conversation-item.pinned.active {
    background: rgba(255, 193, 7, 0.1);
    border-left: 3px solid rgba(255, 193, 7, 0.5);
}

.hover-bg-light:hover {
    background-color: var(--bs-gray-100) !important;
}

.cursor-pointer {
    cursor: pointer;
}

.conversation-item-header {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 0;
    margin-bottom: 6px;
}

.conversation-item-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--bs-text-dark);
    flex: 1;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.conversation-item-time {
    font-size: 12px;
    color: var(--bs-text-muted);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
    white-space: nowrap;
    position: relative;
}

.conversation-item-time .btn,
.conversation-item-time button {
    flex-shrink: 0;
}

/* Dropdown de açÁes - melhor visibilidade e overflow */
.conversation-item-actions {
    position: relative;
    z-index: 10;
    display: inline-block; /* Garantir que dropdown seja posicionado em relação ao botão */
}

/* Quando dropdown está aberto, aumentar z-index do item da conversa */
.conversation-item:has(.conversation-item-actions .dropdown-menu.show) {
    z-index: 1000 !important;
    position: relative;
}

/* Garantir que o dropdown-menu tenha z-index alto */
.conversation-item-actions .dropdown-menu {
    z-index: 1050 !important;
}

.conversation-item-actions .btn {
    opacity: 0.6;
    transition: opacity 0.2s ease, background-color 0.2s ease;
    padding: 6px 8px !important;
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.conversation-item-actions .btn i {
    font-size: 1.25rem !important; /* fs-5 equivalente */
}

.conversation-item-actions .btn:hover {
    opacity: 1 !important;
    background-color: var(--bs-gray-200) !important;
}

.conversation-item-actions .btn:hover i {
    color: var(--bs-primary) !important;
}

.conversation-item:hover .conversation-item-actions .btn {
    opacity: 0.8;
}

.conversation-item-actions .dropdown-menu {
    position: absolute !important;
    top: 100% !important;
    right: 0 !important;
    left: auto !important;
    margin-top: 2px !important;
    margin-right: 0 !important;
    min-width: 200px;
    z-index: 1000 !important;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: 1px solid var(--bs-border-color);
    max-height: none !important;
    overflow: visible !important;
    transform: none !important;
}

/* Garantir z-index para o item da conversa */
.conversation-item {
    position: relative !important;
}

.conversation-item-actions {
    position: relative !important;
}

/* Estilos para modo dark */
[data-bs-theme="dark"] .conversation-item-actions .dropdown-menu,
.dark-mode .conversation-item-actions .dropdown-menu,
body.dark-mode .conversation-item-actions .dropdown-menu {
    background-color: var(--bs-gray-800) !important;
    border-color: var(--bs-gray-700) !important;
}

[data-bs-theme="dark"] .conversation-item-actions .dropdown-item,
.dark-mode .conversation-item-actions .dropdown-item,
body.dark-mode .conversation-item-actions .dropdown-item {
    color: var(--bs-white) !important;
}

[data-bs-theme="dark"] .conversation-item-actions .dropdown-item:hover,
.dark-mode .conversation-item-actions .dropdown-item:hover,
body.dark-mode .conversation-item-actions .dropdown-item:hover {
    background-color: var(--bs-gray-700) !important;
    color: var(--bs-white) !important;
}

[data-bs-theme="dark"] .conversation-item-actions .dropdown-divider,
.dark-mode .conversation-item-actions .dropdown-divider,
body.dark-mode .conversation-item-actions .dropdown-divider {
    border-color: var(--bs-gray-700) !important;
}

/* Garantir que o dropdown não seja cortado pela altura da linha */
.conversation-item {
    overflow: visible !important;
}

/* Garantir que o dropdown apareça acima de outros elementos */
.conversation-item-actions.show .dropdown-menu {
    display: block !important;
}

/* Garantir que o container da lista não corte o dropdown */
.conversations-list-items {
    overflow-y: auto;
    overflow-x: visible;
    position: relative;
}

/* Garantir que o dropdown apareça acima de outros itens */
.conversation-item-actions {
    position: relative;
    z-index: 10;
}

.conversation-item-actions.show {
    z-index: 1051;
}

.conversation-item-preview {
    font-size: 13px;
    color: var(--bs-text-gray-700);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 8px;
    max-width: 100%;
    display: block;
}

.conversation-item-search-match {
    margin-top: 4px;
    margin-bottom: 4px;
}

.conversation-item-search-match .badge {
    font-size: 0.75rem;
    padding: 2px 6px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}
}

.conversation-item-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    position: relative;
    padding-right: 30px; /* Espaço para o badge */
}

.conversation-item-channel {
    font-size: 12px;
    color: var(--bs-text-gray-700);
    display: flex;
    align-items: center;
    gap: 4px;
}

.conversation-item-channel svg {
    flex-shrink: 0;
}

.conversation-item-badge {
    background: #f1416c;
    color: #fff;
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
    display: inline-block;
    position: absolute;
    right: 15px;
    bottom: 15px;
    z-index: 1;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Coluna 2: ürea de Chat */
.chat-area {
    flex: 1 1 auto;
    min-width: 0; /* Permite que o flex shrink funcione */
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    background: var(--bs-body-bg);
}

.chat-header {
    padding: 20px 25px;
    border-bottom: 1px solid var(--bs-border-color);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-header-info {
    display: flex;
    align-items: center;
    gap: 15px;
    min-width: 0;
}

.chat-header-text {
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.chat-header-title {
    font-weight: 600;
    font-size: 16px;
    color: var(--bs-text-dark);
    margin-bottom: 3px;
}

.chat-header-subtitle {
    font-size: 13px;
    color: var(--bs-text-gray-700);
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
}

.chat-header-channel {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.chat-header-separator {
    color: var(--bs-text-gray-500);
}

.chat-header-actions {
    flex-wrap: wrap;
}

/* Banner de Mesclar Conversas */
.chat-merge-alert {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
    border-bottom: 2px solid #ffc107;
    padding: 12px 20px;
    flex-shrink: 0;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-merge-alert-content {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.chat-merge-alert-icon {
    color: #856404;
    flex-shrink: 0;
}

.chat-merge-alert-text {
    flex: 1;
    min-width: 200px;
    color: #856404;
    font-size: 13px;
}

.chat-merge-alert-text strong {
    display: block;
    font-size: 14px;
    margin-bottom: 2px;
}

[data-bs-theme="dark"] .chat-merge-alert {
    background: linear-gradient(135deg, #3d3520 0%, #4a3f1f 100%);
    border-color: #b38600;
}

[data-bs-theme="dark"] .chat-merge-alert-icon,
[data-bs-theme="dark"] .chat-merge-alert-text {
    color: #ffc107;
}

[data-bs-theme="dark"] .chat-merge-alert-text strong {
    color: #ffe066;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px 25px;
    background: var(--bs-gray-100);
    position: relative;
    width: 100%;
    max-width: 100%;
}

/* Quando acesso é restrito, bloquear scroll completamente */
.chat-messages.access-restricted {
    overflow: hidden !important;
}

.chat-messages.access-restricted .restricted-access-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    overflow: hidden;
}

/* Indicador de carregamento de mensagens antigas */
.messages-loading {
    text-align: center;
    padding: 15px;
    color: var(--bs-text-muted);
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.messages-loading .spinner-border {
    width: 1.5rem;
    height: 1.5rem;
}

.messages-load-more {
    text-align: center;
    padding: 10px;
    color: var(--bs-primary);
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
}

.messages-load-more:hover {
    opacity: 0.7;
    transform: scale(1.05);
}

/* Hover elevate effect para cards de histórico */
.hover-elevate-up {
    transition: all 0.2s ease-in-out;
}

.hover-elevate-up:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
}

/* Highlight de mensagem encontrada na busca */
.chat-message.message-highlight {
    animation: messageHighlight 0.5s ease-in-out;
}

.chat-message.message-highlight .message-bubble {
    background-color: rgba(255, 193, 7, 0.2) !important;
    border: 2px solid rgba(255, 193, 7, 0.6) !important;
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.4) !important;
}

@keyframes messageHighlight {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
    100% {
        transform: scale(1);
    }
}

/* Estilos para resultados de busca */
.message-search-result {
    transition: background-color 0.2s;
}

.message-search-result:hover {
    background-color: var(--bs-gray-100) !important;
}

.message-search-result.bg-light-primary {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.message-search-result.hover-bg-light-primary:hover {
    background-color: rgba(13, 110, 253, 0.15) !important;
}

[data-bs-theme="dark"] .message-search-result.hover-bg-light-primary:hover {
    background-color: rgba(13, 110, 253, 0.25) !important;
}

[data-bs-theme="dark"] #messageSearchResults {
    background-color: var(--bs-gray-800) !important;
    border-color: var(--bs-gray-700) !important;
}

[data-bs-theme="dark"] #messageSearchResults .text-gray-800 {
    color: var(--bs-gray-100) !important;
}

[data-bs-theme="dark"] #messageSearchResults .text-gray-600 {
    color: var(--bs-gray-300) !important;
}

[data-bs-theme="dark"] #messageSearchResults .text-gray-500 {
    color: var(--bs-gray-400) !important;
}

[data-bs-theme="dark"] #messageSearchResults .text-gray-700 {
    color: var(--bs-gray-200) !important;
}

/* Remover z-index customizados - deixar Bootstrap gerenciar */

[data-bs-theme="dark"] #messageSearchResults mark {
    background-color: #ffc107;
    color: #000;
}

.template-quick-group-header {
    padding: 8px 12px;
    background-color: var(--bs-gray-100);
    font-weight: 600;
    font-size: 12px;
    color: var(--bs-gray-700);
    border-bottom: 1px solid var(--bs-gray-200);
    margin-top: 8px;
}

.template-quick-group-header:first-child {
    margin-top: 0;
}

[data-bs-theme="dark"] .template-quick-group-header {
    background-color: var(--bs-gray-800);
    color: var(--bs-gray-300);
    border-bottom-color: var(--bs-gray-700);
}

#messageSearchResults mark {
    background-color: #ffc107;
    color: #000;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
}

.chat-message {
    display: flex;
    margin-bottom: 20px;
    gap: 10px;
    min-width: 0;
    width: 100%;
    max-width: 100%;
}

.chat-message.incoming {
    justify-content: flex-start;
}

.chat-message.outgoing {
    justify-content: flex-end;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bs-gray-200);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: var(--bs-text-muted);
    flex-shrink: 0;
}

.message-content {
    max-width: 60%;
    min-width: 0;
    overflow-wrap: break-word;
    word-wrap: break-word;
    box-sizing: border-box;
}

/* Permitir que áudios sejam mais largos */
.chat-message .message-content:has(.audio-only),
.chat-message .message-content:has(.audio-attachment) {
    max-width: calc(100% - 20px) !important;
    min-width: 0 !important;
    width: 100%;
    box-sizing: border-box;
}

/* Forçar attachment-item a não limitar largura */
.audio-only .attachment-item,
.message-bubble .attachment-item:has(.audio-attachment) {
    max-width: none !important;
    width: 100%;
}

/* Fix: Nome de arquivo não sair do box de documento */
.attachment-item .document-box {
    min-width: 0;
    max-width: 100%;
    overflow: hidden;
}
.attachment-item .document-box .doc-filename {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 200px;
    display: block;
}
.attachment-item .doc-link {
    max-width: 300px;
    overflow: hidden;
}
/* Botão de preview PDF */
.attachment-item .pdf-preview-btn {
    flex-shrink: 0;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}
.attachment-item .pdf-preview-btn:hover {
    background: rgba(0, 0, 0, 0.08);
}

.message-bubble {
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
}

/* Reações de mensagem */
.message-reactions {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 2px;
}
.reaction-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 8px;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.06);
    font-size: 16px;
    line-height: 1.2;
    cursor: default;
    border: 1px solid rgba(0, 0, 0, 0.08);
    transition: background 0.2s;
}
.reaction-badge:hover {
    background: rgba(0, 0, 0, 0.1);
}
.reaction-count {
    font-size: 11px;
    color: #666;
    font-weight: 600;
}
[data-theme="dark"] .reaction-badge {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.15);
}
[data-theme="dark"] .reaction-badge:hover {
    background: rgba(255, 255, 255, 0.15);
}
[data-theme="dark"] .reaction-count {
    color: #aaa;
}

/* Reaction picker popup */
.reaction-picker {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    border-radius: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    padding: 6px 8px;
    display: flex;
    gap: 2px;
    z-index: 100;
    animation: reactionPickerIn 0.15s ease-out;
    white-space: nowrap;
}
@keyframes reactionPickerIn {
    from { opacity: 0; transform: translateX(-50%) scale(0.8) translateY(4px); }
    to { opacity: 1; transform: translateX(-50%) scale(1) translateY(0); }
}
.reaction-picker-emoji {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    cursor: pointer;
    border-radius: 50%;
    transition: transform 0.15s, background 0.15s;
    border: none;
    background: none;
    padding: 0;
}
.reaction-picker-emoji:hover {
    transform: scale(1.3);
    background: rgba(0,0,0,0.06);
}
[data-theme="dark"] .reaction-picker {
    background: #2b2b3d;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
[data-theme="dark"] .reaction-picker-emoji:hover {
    background: rgba(255,255,255,0.1);
}

/* Reduzir padding quando contêm apenas íudio (manter background da bolha) */
.message-bubble.audio-only {
    padding: 8px !important;
    line-height: 1 !important;
}

.message-bubble.audio-only .audio-attachment {
    margin: 0;
}

/* Evitar player de áudio estourar a bolha */
.audio-attachment {
    max-width: 100%;
    overflow: hidden;
}

.audio-attachment audio {
    width: 100%;
    max-width: 100%;
}

/* Player de íudio deve herdar cor de fundo da bolha */
.chat-message.outgoing .audio-attachment > div {
    background: rgba(255, 255, 255, 0.15) !important;
}

.chat-message.incoming .audio-attachment > div {
    background: var(--bs-gray-100) !important;
}

/* Garantir que botÁes de ação apareçam sobre o player de íudio */
.message-content:has(.audio-attachment) {
    position: relative;
}

.message-content:has(.audio-attachment) .message-actions {
    z-index: 10;
}

/* Banner de IA Ativa */
.ai-active-banner {
    padding: 12px 20px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border-bottom: 1px solid rgba(99, 102, 241, 0.2);
    flex-shrink: 0;
    animation: slideDown 0.3s ease-out;
}

.ai-active-banner-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.ai-active-banner-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 50%;
    color: white;
}

.ai-active-banner-info {
    flex: 1;
    min-width: 0;
}

.ai-active-banner-title {
    display: flex;
    align-items: center;
    font-weight: 600;
    font-size: 14px;
    color: var(--bs-text-dark);
    margin-bottom: 2px;
}

.ai-active-banner-subtitle {
    font-size: 12px;
    color: var(--bs-text-gray-700);
    display: flex;
    align-items: center;
}

.ai-active-banner-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Dark mode para banner de IA */
[data-theme="dark"] .ai-active-banner {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
    border-bottom-color: rgba(99, 102, 241, 0.3);
}

/* Badge de mensagem de IA */
.ai-message-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    margin-bottom: 6px;
    font-size: 11px;
    color: #6366f1;
    font-weight: 500;
}

.ai-message-badge .ai-avatar-mini {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    font-size: 9px;
    font-weight: 600;
    flex-shrink: 0;
}

.ai-message-badge .ai-avatar-mini img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.ai-message-badge i {
    color: #6366f1;
    font-size: 12px;
}

.ai-badge-text {
    font-size: 11px;
    font-weight: 500;
}

/* Avatar do agente de IA nas mensagens */
.chat-message.outgoing .message-avatar.ai-agent-avatar {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 12px;
}

.chat-message.outgoing .message-avatar.ai-agent-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* Estilo especial para mensagens de IA */
.message-bubble.ai-message {
    border-left: 3px solid #6366f1;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
}

.chat-message.outgoing .message-bubble.ai-message {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
    border-left-color: #6366f1;
}

/* Dark mode para badge de IA */
[data-theme="dark"] .ai-message-badge {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
    border-color: rgba(99, 102, 241, 0.3);
    color: #818cf8;
}

[data-theme="dark"] .ai-message-badge i {
    color: #818cf8;
}

[data-theme="dark"] .message-bubble.ai-message {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border-left-color: #818cf8;
}

[data-theme="dark"] .chat-message.outgoing .message-bubble.ai-message {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
    border-left-color: #818cf8;
}

/* Player de íudio - layout unificado */
.audio-attachment {
    max-width: none !important;
    min-width: 380px !important;
    width: 100%;
    margin: 0;
    line-height: 1;
}

.audio-attachment > div {
    padding: 10px 14px !important;
    line-height: 1.1;
    display: flex !important;
    align-items: center !important;
    background: var(--bs-gray-100) !important;
    border-radius: 18px !important;
    min-width: 380px !important;
}

.audio-attachment audio {
    width: 100% !important;
    min-width: 300px !important;
    height: 34px !important;
    max-height: 34px !important;
    min-height: 34px !important;
    display: block !important;
}

/* Lazy loading styles */
.lazy-image-container {
    position: relative;
    display: inline-block;
}

.lazy-image {
    transition: opacity 0.3s ease-in-out;
}

.lazy-image.loading {
    opacity: 0.5;
}

.lazy-image.loaded {
    opacity: 1;
}

.lazy-loading-spinner {
    pointer-events: none;
}

.lazy-video-container {
    position: relative;
}

.lazy-video-placeholder {
    transition: opacity 0.2s;
}

.lazy-video-placeholder:hover {
    opacity: 0.8;
}

.lazy-video-container video.loaded {
    display: block !important;
}

.lazy-video-container .lazy-video-placeholder.loaded {
    display: none !important;
}

/* Garantir que o ícone não aumente a altura */
.audio-attachment i {
    line-height: 1;
    display: flex;
    align-items: center;
}

.chat-message.incoming .message-bubble {
    background: var(--bs-body-bg);
    color: var(--bs-text-dark);
    border-bottom-left-radius: 4px;
    border: 1px solid var(--bs-border-color);
}

.chat-message.outgoing .message-bubble {
    background: var(--bs-primary);
    color: #fff;
    border-bottom-right-radius: 4px;
}

.message-time {
    font-size: 11px;
    color: var(--bs-text-muted);
    margin-top: 4px;
    padding: 0 4px;
}

/* Separador de data */
.date-separator {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
    gap: 12px;
    width: 100%;
    max-width: 100%;
    min-width: 0;
    flex-shrink: 0;
}

.date-separator-line {
    flex: 1;
    height: 1px;
    background: var(--bs-border-color);
    opacity: 0.5;
}

.date-separator-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--bs-text-muted);
    padding: 4px 12px;
    background: var(--bs-gray-100);
    border-radius: 12px;
    white-space: nowrap;
}

[data-bs-theme="dark"] .date-separator-label {
    background: var(--bs-gray-800);
    color: var(--bs-gray-300);
}

[data-bs-theme="dark"] .date-separator-line {
    background: var(--bs-gray-700);
}

.chat-message.incoming .message-time {
    text-align: left;
}

.chat-message.outgoing .message-time {
    text-align: right;
}

.message-status {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 4px;
    position: relative;
}

.message-status-label {
    font-size: 10px;
    opacity: 0.7;
    margin-left: 2px;
    white-space: nowrap;
}

.message-status-error {
    color: #f1416c !important;
}

.message-status-error .message-status-label {
    color: #f1416c;
    opacity: 1;
}

/* Container de erro de mensagem */
.message-error-container {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

/* Alerta de erro de número sem WhatsApp */
.message-error-alert {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
    border: 1px solid #f8b4b4;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    color: #c53030;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(197, 48, 48, 0.15);
    animation: shake 0.5s ease-in-out;
}

.message-error-alert i {
    color: #e53e3e;
}

[data-bs-theme="dark"] .message-error-alert {
    background: linear-gradient(135deg, #2d1f1f 0%, #3d2020 100%);
    border-color: #7c3030;
    color: #feb2b2;
}

[data-bs-theme="dark"] .message-error-alert i {
    color: #fc8181;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
    20%, 40%, 60%, 80% { transform: translateX(2px); }
}

/* Mensagem Citada/Reply */
.quoted-message {
    border-left: 2px solid rgba(255, 255, 255, 0.2);
    padding: 8px 12px;
    margin-bottom: 8px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
    font-size: 12px;
    opacity: 0.85;
    transition: all 0.2s;
    cursor: pointer !important;
}

.quoted-message:hover {
    opacity: 1;
    background: rgba(0, 0, 0, 0.12);
    border-left-color: rgba(255, 255, 255, 0.3);
    transform: translateX(2px);
}

.chat-message.incoming .quoted-message {
    border-left-color: rgba(var(--bs-primary-rgb), 0.4);
    background: rgba(var(--bs-primary-rgb), 0.06);
}

.chat-message.incoming .quoted-message:hover {
    background: rgba(var(--bs-primary-rgb), 0.12);
    border-left-color: rgba(var(--bs-primary-rgb), 0.6);
}

.quoted-message-header {
    font-weight: 600;
    margin-bottom: 4px;
    color: rgba(255, 255, 255, 0.9);
}

.chat-message.incoming .quoted-message-header {
    color: var(--bs-primary);
}

.quoted-message-content {
    color: rgba(255, 255, 255, 0.7);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.chat-message.incoming .quoted-message-content {
    color: var(--bs-text-muted);
}

/* Botão de Reply */
.message-actions {
    position: absolute;
    top: 4px;
    right: 4px;
    opacity: 0;
    transition: opacity 0.2s;
    display: flex;
    gap: 4px;
}

.chat-message:hover .message-actions {
    opacity: 1;
}

.message-actions-btn {
    background: rgba(0, 0, 0, 0.5);
    border: none;
    color: #fff;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
}

.message-actions-btn:hover {
    background: rgba(0, 0, 0, 0.7);
}

.chat-message.incoming .message-actions-btn {
    background: rgba(255, 255, 255, 0.8);
    color: var(--bs-text-dark);
}

.chat-message.incoming .message-actions-btn:hover {
    background: rgba(255, 255, 255, 1);
}

.message-content {
    position: relative;
}

/* Preview de Reply */
.reply-preview {
    background: rgba(255, 255, 255, 0.05);
    border-left: 3px solid var(--bs-primary);
    padding: 8px 12px;
    margin-bottom: 8px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.reply-preview-content {
    flex-grow: 1;
    min-width: 0;
}

.reply-preview-header {
    font-weight: 600;
    font-size: 12px;
    color: var(--bs-primary);
    margin-bottom: 2px;
}

.reply-preview-text {
    font-size: 12px;
    color: var(--bs-text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.reply-preview-close {
    background: transparent;
    border: none;
    color: var(--bs-text-muted);
    cursor: pointer;
    padding: 4px;
    font-size: 16px;
    line-height: 1;
}

.reply-preview-close:hover {
    color: var(--bs-text-dark);
}

/* Mensagem de Sistema/Evento */
.chat-message.system {
    justify-content: center;
    margin: 15px 0;
}

.chat-message.system .message-bubble {
    background: transparent;
    color: var(--bs-text-muted);
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px dashed var(--bs-border-color);
}

/* Nota Interna - Alinhada á direita como mensagens enviadas */
.chat-message.note {
    justify-content: flex-end;
}

.chat-message.note .message-content {
    max-width: 60%;
}

.chat-message.note .message-bubble {
    background: rgba(255, 193, 7, 0.15); /* Amarelo translúcido */
    border: 1px solid rgba(255, 193, 7, 0.4);
    border-right: 3px solid #ffc107;
    color: var(--bs-text-dark);
    border-bottom-right-radius: 4px;
}

.chat-message.note .message-time {
    text-align: right;
}

.note-header {
    font-weight: 600;
    color: #ff9800;
    margin-bottom: 6px;
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Campo de Envio */
.chat-input {
    border-top: 1px solid var(--bs-border-color);
    padding: 20px 25px;
    background: var(--bs-body-bg);
    flex-shrink: 0;
}

.chat-input-toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
}

.chat-input-textarea {
    width: 100%;
    min-height: 60px;
    max-height: 150px;
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    resize: vertical;
    font-family: inherit;
    background: var(--bs-body-bg);
    color: var(--bs-text-dark);
}

.chat-input-textarea:focus {
    outline: none;
    border-color: var(--bs-primary);
}

/* Seletor rípido de templates */
.template-quick-select {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    margin-bottom: 8px;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1050;
    max-height: 400px;
    display: flex;
    flex-direction: column;
}

.template-quick-select-header {
    padding: 12px;
    border-bottom: 1px solid var(--bs-border-color);
    flex-shrink: 0;
}

.template-quick-select-list {
    flex: 1;
    overflow-y: auto;
    max-height: 320px;
}

.template-quick-item {
    padding: 12px;
    border-bottom: 1px solid var(--bs-border-color);
    cursor: pointer;
    transition: background 0.15s ease;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.template-quick-item:hover,
.template-quick-item.selected {
    background: var(--bs-primary-light);
}

.template-quick-item-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--bs-text-dark);
}

.template-quick-item-preview {
    font-size: 12px;
    color: var(--bs-text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.template-quick-item-category {
    display: inline-block;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    background: var(--bs-gray-100);
    color: var(--bs-text-muted);
    margin-top: 4px;
}

.chat-input-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
}

/* Estado vazio */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--bs-text-muted);
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.3;
    color: var(--bs-text-muted);
}

/* Scrollbar customizado */
.conversations-list-items::-webkit-scrollbar,
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.conversations-list-items::-webkit-scrollbar-track,
.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.conversations-list-items::-webkit-scrollbar-thumb,
.chat-messages::-webkit-scrollbar-thumb {
    background: var(--bs-gray-300);
    border-radius: 3px;
}

.conversations-list-items::-webkit-scrollbar-thumb:hover,
.chat-messages::-webkit-scrollbar-thumb:hover {
    background: var(--bs-gray-400);
}

/* ============================================================================
   RESPONSIVIDADE MOBILE
   ============================================================================ */

/* Mobile: Layout vertical com navegação entre views */
@media (max-width: 767px) {
    /* Layout principal - vertical em mobile */
    .conversations-layout {
        flex-direction: column;
        height: calc(100vh - 60px);
        margin: 0;
        padding: 0;
        position: relative;
        overflow: hidden;
    }
    
    /* Sistema de views - apenas uma visível por vez */
    .conversations-list,
    .chat-area,
    .conversation-sidebar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        transition: transform 0.3s ease, opacity 0.3s ease;
        z-index: 1;
    }
    
    /* View ativa */
    .conversations-list.mobile-active,
    .chat-area.mobile-active,
    .conversation-sidebar.mobile-active {
        z-index: 10;
        transform: translateX(0);
        opacity: 1;
    }
    
    /* Views inativas - escondidas á esquerda ou direita */
    .conversations-list:not(.mobile-active) {
        transform: translateX(-100%);
        opacity: 0;
        pointer-events: none;
    }
    
    .chat-area:not(.mobile-active) {
        transform: translateX(100%);
        opacity: 0;
        pointer-events: none;
    }
    
    .conversation-sidebar:not(.mobile-active) {
        transform: translateX(100%);
        opacity: 0;
        pointer-events: none;
    }
    
    /* Cabeçalho de mêtricas - mobile */
    .conversations-metrics-header {
        padding: 10px 15px;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .conversations-metrics-header h2 {
        font-size: 1.25rem;
    }
    
    .conversations-metrics-header #agent-metrics-container {
        display: none !important; /* Ocultar métricas e SLAs no mobile */
    }
    
    /* Lista de conversas - full width em mobile */
    .conversations-list {
        width: 100%;
        max-width: 100%;
        border-right: none;
    }
    
    .conversations-list-header {
        padding: 15px;
        position: sticky;
        top: 0;
        background: var(--bs-body-bg);
        z-index: 100;
        border-bottom: 1px solid var(--bs-border-color);
    }
    
    /* ürea de chat - full width em mobile */
    .chat-area {
        width: 100%;
        max-width: 100%;
    }
    
    .chat-header {
        padding: 12px 15px;
        position: sticky;
        top: 0;
        background: var(--bs-body-bg);
        z-index: 100;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .chat-header-info {
        width: 100%;
        gap: 10px;
    }

    .chat-header .symbol {
        width: 40px;
        height: 40px;
    }

    .chat-header-title {
        font-size: 15px;
        line-height: 1.2;
    }

    .chat-header-subtitle {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }

    .chat-header-separator {
        display: none;
    }

    .chat-header-channel svg {
        display: none;
    }
    
    /* Botão voltar no header do chat (mobile) */
    .chat-header-back-btn {
        display: flex !important;
        margin-right: 10px;
    }
    
    /* Ocultar busca de mensagens em mobile (pode ser acessada via menu) */
    .chat-header .position-relative.d-flex.gap-2 {
        display: none !important;
    }
    
    /* BotÁes do header - ajustar tamanho */
    .chat-header .btn {
        padding: 8px !important;
        min-width: 40px;
        height: 40px;
    }

    .chat-header-actions {
        width: 100%;
        gap: 8px;
        justify-content: flex-start;
    }
    
    /* Mensagens - padding reduzido em mobile */
    .chat-messages {
        padding: 15px;
    }
    
    /* Mensagens - largura maior em mobile */
    .message-content {
        max-width: 85% !important;
    }
    
    /* Input de mensagem - fixo no rodapé */
    .chat-input-container {
        position: sticky;
        bottom: 0;
        background: var(--bs-body-bg);
        padding: 15px;
        border-top: 1px solid var(--bs-border-color);
        z-index: 100;
    }
    
    /* Sidebar como drawer full-screen */
    .conversation-sidebar {
        width: 100% !important;
        max-width: 100% !important;
        border-left: none;
        z-index: 1000;
    }
    
    .conversation-sidebar.open {
        width: 100% !important;
    }
    
    /* Header do sidebar com botão voltar */
    .sidebar-header {
        padding: 15px;
        position: sticky;
        top: 0;
        background: var(--bs-body-bg);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .sidebar-back-btn {
        display: flex !important;
        flex-shrink: 0;
    }
    
    .sidebar-header .nav {
        flex: 1;
    }
    
    /* Overlay quando sidebar aberto */
    .sidebar-overlay {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    
    .sidebar-overlay.active {
        opacity: 1;
        pointer-events: all;
    }
    
    /* Cards de conversa mais compactos */
    .conversation-item {
        padding: 12px 15px;
    }
    
    .conversation-item-name {
        font-size: 14px;
    }
    
    .conversation-item-preview {
        font-size: 12px;
    }
    
    /* Filtros mobile */
    .filters-panel {
        padding: 8px 10px;
    }
    .filters-grid {
        grid-template-columns: 1fr 1fr;
        gap: 4px;
    }
}

/* Tablet: Layout híbrido */
@media (min-width: 768px) and (max-width: 991px) {
    .conversations-layout {
        height: calc(100vh - 80px);
    }
    
    .conversations-list {
        width: 320px;
        flex-shrink: 0;
    }
    
    .chat-area {
        flex: 1;
    }
    
    /* Sidebar como drawer lateral */
    .conversation-sidebar {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        width: 0;
        max-width: 400px;
        z-index: 1000;
        transition: width 0.3s ease;
    }
    
    .conversation-sidebar.open {
        width: 400px !important;
    }
    
    .sidebar-overlay {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    
    .sidebar-overlay.active {
        opacity: 1;
        pointer-events: all;
    }
}

/* Desktop: Manter layout original */
@media (min-width: 992px) {
    .chat-header-back-btn,
    .sidebar-back-btn {
        display: none !important;
    }
    
    .sidebar-overlay {
        display: none !important;
    }
}
/* AnimaçÁes para Assistente IA */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.hover-shadow-lg {
    transition: all 0.3s ease;
}

.hover-shadow-lg:hover {
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15) !important;
    transform: translateY(-2px);
}
/* SweetAlert2 Dark Mode Support - Estilos movidos para arquivo global: css/custom/sweetalert-dark.css */
</style>

<!-- SLA Indicator CSS -->
<link rel="stylesheet" href="<?= \App\Helpers\Url::asset('css/custom/sla-indicator.css') ?>">

<!-- Realtime Coaching CSS já incluído no layout principal (app.php) -->

<!-- Script inline para definir função ANTES do HTML do botão -->
<script>
// 🔐 Permissões de Funil do Usuário (para filtrar conversas em tempo real)
window.userFunnelPermissions = <?= json_encode([
    'allowed_funnel_ids' => \App\Models\AgentFunnelPermission::getAllowedFunnelIds(\App\Helpers\Auth::id()),
    'allowed_stage_ids' => \App\Models\AgentFunnelPermission::getAllowedStageIds(\App\Helpers\Auth::id())
]) ?>;

/**
 * Verifica se o usuário tem permissão para visualizar uma conversa baseado no funil/etapa
 * @param {Object} conversation - Objeto da conversa
 * @returns {boolean} - true se pode visualizar, false se não
 */
function canViewConversationByFunnel(conversation) {
    if (!conversation) return false;
    
    const permissions = window.userFunnelPermissions;
    if (!permissions) return true; // Fallback: permitir se não houver permissões carregadas
    
    // Se allowed_funnel_ids é null = Admin (pode ver tudo)
    if (permissions.allowed_funnel_ids === null) {
        return true;
    }
    
    // Se conversa não tem funil, permitir (conversas antigas)
    if (!conversation.funnel_id) {
        return true;
    }
    
    // Verificar se tem permissão no funil
    const funnelId = parseInt(conversation.funnel_id);
    const allowedFunnels = permissions.allowed_funnel_ids || [];
    
    if (!allowedFunnels.includes(funnelId)) {
        console.log('🚫 [Filtro Funil] Conversa bloqueada - convId:', conversation.id, 'funnelId:', funnelId, 'allowedFunnels:', allowedFunnels);
        return false; // Não tem permissão no funil
    }
    
    // Se tem etapa, verificar permissão da etapa
    if (conversation.funnel_stage_id) {
        const stageId = parseInt(conversation.funnel_stage_id);
        const allowedStages = permissions.allowed_stage_ids || [];
        
        // Se allowed_stage_ids é null = Admin (pode ver todas)
        if (allowedStages === null) {
            return true;
        }
        
        if (!allowedStages.includes(stageId)) {
            console.log('🚫 [Filtro Etapa] Conversa bloqueada - convId:', conversation.id, 'stageId:', stageId, 'allowedStages:', allowedStages);
            return false; // Não tem permissão na etapa
        }
    }
    
    // Tem permissão!
    return true;
}

// Helper para obter informaçÁes de canais
function getChannelInfo(channel) {
    const channels = {
        'whatsapp': {
            name: 'WhatsApp',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#25D366" style="vertical-align: middle;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>',
            emoji: '💬'
        },
        'whatsapp_official': {
            name: 'WhatsApp Oficial',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#25D366" style="vertical-align: middle;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>',
            emoji: '💬'
        },
        'instagram': {
            name: 'Instagram',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="url(#instagram-gradient-js)" style="vertical-align: middle;"><defs><linearGradient id="instagram-gradient-js" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#833AB4;stop-opacity:1" /><stop offset="50%" style="stop-color:#FD1D1D;stop-opacity:1" /><stop offset="100%" style="stop-color:#FCAF45;stop-opacity:1" /></linearGradient></defs><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.40z"/></svg>',
            emoji: '📷'
        },
        'instagram_comment': {
            name: 'Comentário',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="url(#instagram-gradient-comment)" style="vertical-align: middle;"><defs><linearGradient id="instagram-gradient-comment" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#833AB4;stop-opacity:1" /><stop offset="50%" style="stop-color:#FD1D1D;stop-opacity:1" /><stop offset="100%" style="stop-color:#FCAF45;stop-opacity:1" /></linearGradient></defs><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>',
            emoji: '💬'
        },
        'facebook': {
            name: 'Facebook',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#1877F2" style="vertical-align: middle;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>',
            emoji: '👥'
        },
        'tiktok': {
            name: 'TikTok',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#000000" style="vertical-align: middle;"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>',
            emoji: '🎵'
        },
        'telegram': {
            name: 'Telegram',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#0088cc" style="vertical-align: middle;"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>',
            emoji: '✉️'
        },
        'email': {
            name: 'Email',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>',
            emoji: '📧'
        },
        'chat': {
            name: 'Chat',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>',
            emoji: '💬'
        },
        'mercadolivre': {
            name: 'Mercado Livre',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FFF159" style="vertical-align: middle;"><path d="M12.5 0C5.596 0 0 5.596 0 12.5S5.596 25 12.5 25 25 19.404 25 12.5 19.404 0 12.5 0zm0 22.5c-5.523 0-10-4.477-10-10S6.977 2.5 12.5 2.5 22.5 6.977 22.5 12.5 18.023 22.5 12.5 22.5z"/><path d="M8.75 7.5h7v9h-7z" fill="#3483FA"/></svg>',
            emoji: '🛒'
        },
        'webchat': {
            name: 'WebChat',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>',
            emoji: '💬'
        },
        'olx': {
            name: 'OLX',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#00A859" style="vertical-align: middle;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
            emoji: '🏷️'
        },
        'linkedin': {
            name: 'LinkedIn',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#0077B5" style="vertical-align: middle;"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>',
            emoji: '💼'
        },
        'google_business': {
            name: 'Google Business',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#4285F4" style="vertical-align: middle;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
            emoji: '🔧'
        },
        'youtube': {
            name: 'YouTube',
            icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#FF0000" style="vertical-align: middle;"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>',
            emoji: '▶️'
        }
    };
    
    return channels[channel] || { name: 'Chat', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>', emoji: '💬' };
}

// Definir função IMEDIATAMENTE para estar disponível quando o HTML for renderizado
(function() {
    // Mostrar modal de nova conversa
    window.showNewConversationModal = function() {
        const modal = document.getElementById('kt_modal_new_conversation');
        if (!modal) {
            console.error('Modal de nova conversa não encontrado');
            return;
        }
        
        // Limpar formulírio
        const form = modal.querySelector('#newConversationForm');
        if (form) form.reset();
        
        // Resetar canal para WhatsApp (padrão)
        const channelSelect = modal.querySelector('#new_conversation_channel');
        if (channelSelect) {
            channelSelect.value = 'whatsapp';
            // Disparar evento change para atualizar visibilidade do campo WhatsApp
            channelSelect.dispatchEvent(new Event('change'));
        }
        
        // Abrir modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Focar no campo nome
        setTimeout(() => {
            const nameInput = modal.querySelector('#new_contact_name');
            if (nameInput) nameInput.focus();
        }, 300);
    };
    
    // showNewConversationModal definida no escopo global
})();
</script>

<!-- Cabeçalho com Mêtricas de SLA e Tempo de Resposta -->
<div class="conversations-metrics-header" style="padding: 15px 20px; background: var(--bs-body-bg); border-bottom: 1px solid var(--bs-border-color); display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
    <div class="d-flex align-items-center gap-3">
        <h2 class="mb-0 fw-bold fs-3">Conversas - Sistema Multiatendimento</h2>
    </div>
    <div class="d-flex align-items-center gap-4 flex-wrap" id="agent-metrics-container" style="margin-left: auto;">
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted fs-7">Tempo primeira resposta:</span>
            <span class="fw-bold text-primary" id="metric-first-response">-</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted fs-7">Tempo de respostas:</span>
            <span class="fw-bold text-info" id="metric-response">-</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted fs-7">SLA primeira resposta:</span>
            <span class="fw-bold" id="metric-sla-first-response">-</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted fs-7">SLA Respostas:</span>
            <span class="fw-bold" id="metric-sla-response">-</span>
        </div>
    </div>
</div>

<div class="conversations-layout">
    
    <!-- COLUNA 1: LISTA DE CONVERSAS -->
    <div class="conversations-list mobile-active" id="conversationsListView">
        
        <!-- Header com busca -->
        <div class="conversations-list-header">
            <div class="d-flex gap-2">
                <div class="position-relative flex-grow-1">
                    <i class="ki-duotone ki-magnifier fs-3 text-gray-500 position-absolute top-50 translate-middle ms-6">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                    <input type="text" id="kt_conversations_search" class="form-control form-control-solid ps-10" placeholder="Buscar conversas e mensagens..." value="<?= htmlspecialchars($filters['search'] ?? '') ?>">
                </div>
                <!-- Botão de Convites Pendentes -->
                <button type="button" class="btn btn-sm btn-icon btn-light-warning position-relative" id="btn_pending_invites" title="Convites pendentes" onclick="showPendingInvitesModal()">
                    <i class="ki-duotone ki-notification-on fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                        <span class="path5"></span>
                    </i>
                    <span id="headerPendingInvitesBadge" class="position-absolute top-0 start-100 translate-middle badge badge-circle badge-sm badge-danger d-none">0</span>
                </button>
                
                <button type="button" class="btn btn-sm btn-icon btn-primary" id="btn_new_conversation" title="Nova conversa" onclick="if(typeof showNewConversationModal === 'function') { showNewConversationModal(); } else { console.error('showNewConversationModal não está definida'); }">
                    <i class="ki-duotone ki-plus fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </button>
            </div>
        </div>
        
        <!-- Barra unificada: Abas + Filtros -->
        <div id="conversationTabsBar" class="conversation-tabs-bar">
            <div class="d-flex align-items-end w-100">
                <!-- Abas (scrollable) -->
                <div class="d-flex align-items-center gap-0 overflow-auto hide-scrollbar flex-grow-1" id="conversationTabsList">
                    <button type="button" class="btn btn-sm conversation-tab active" data-tab-id="all" data-tag-id="" onclick="switchConversationTab(this)">
                        <span class="tab-name">Todas</span>
                        <?php if (!empty($conversations)): ?>
                            <span class="tab-count"><?= count($conversations) ?></span>
                        <?php endif; ?>
                    </button>
                    <?php if (!empty($userTabs)): ?>
                        <?php foreach ($userTabs as $tab): ?>
                            <button type="button" class="btn btn-sm conversation-tab" 
                                    data-tab-id="<?= $tab['id'] ?>" 
                                    data-tag-id="<?= $tab['tag_id'] ?>"
                                    onclick="switchConversationTab(this)">
                                <span class="tab-color-dot" style="background-color: <?= htmlspecialchars($tab['tag_color'] ?? '#009ef7') ?>;"></span>
                                <span class="tab-name"><?= htmlspecialchars($tab['tag_name']) ?></span>
                                <?php if (!empty($tab['conversation_count'])): ?>
                                    <span class="tab-count"><?= $tab['conversation_count'] ?></span>
                                <?php endif; ?>
                            </button>
                        <?php endforeach; ?>
                    <?php endif; ?>
                    <button type="button" class="btn btn-sm btn-icon conversation-tab-add" title="Gerenciar abas" onclick="showManageTabsModal()">
                        <i class="ki-duotone ki-plus fs-7">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
                <!-- Botão Filtros (abre dropdown) -->
                <div class="flex-shrink-0 d-flex align-items-center" style="padding-bottom: 6px; margin-bottom: -2px;">
                    <button type="button" class="btn btn-sm btn-icon conversation-filter-btn position-relative" 
                            id="filterToggleBtn" onclick="toggleFiltersDropdown()" title="Filtros">
                        <i class="ki-duotone ki-filter fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        <span class="badge badge-sm badge-circle badge-danger position-absolute top-0 end-0 d-none" id="activeFiltersCount">0</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Painel de Filtros (dropdown oculto) -->
        <div id="filtersPanel" class="filters-panel d-none">
            <div class="filters-grid">
                <select id="filter_status" class="form-select form-select-sm form-select-solid">
                    <option value="" <?= empty($filters['status']) && empty($filters['is_spam']) && empty($filters['unanswered']) ? 'selected' : '' ?>>Todas</option>
                    <option value="open" <?= ($filters['status'] ?? '') === 'open' ? 'selected' : '' ?>>Abertas</option>
                    <option value="resolved" <?= ($filters['status'] ?? '') === 'resolved' ? 'selected' : '' ?>>Resolvidas</option>
                    <option value="closed" <?= ($filters['status'] ?? '') === 'closed' ? 'selected' : '' ?>>Fechadas</option>
                    <option value="spam" <?= !empty($filters['is_spam']) ? 'selected' : '' ?>>Spam</option>
                    <option value="unanswered" <?= !empty($filters['unanswered']) ? 'selected' : '' ?>>Não respondidas</option>
                </select>
                
                <select id="filter_channel" class="form-select form-select-sm form-select-solid">
                    <option value="">Canais</option>
                    <option value="whatsapp" <?= ($filters['channel'] ?? '') === 'whatsapp' ? 'selected' : '' ?>>WhatsApp</option>
                    <option value="whatsapp_official" <?= ($filters['channel'] ?? '') === 'whatsapp_official' ? 'selected' : '' ?>>WhatsApp Oficial</option>
                    <option value="instagram" <?= ($filters['channel'] ?? '') === 'instagram' ? 'selected' : '' ?>>Instagram</option>
                    <option value="instagram_comment" <?= ($filters['channel'] ?? '') === 'instagram_comment' ? 'selected' : '' ?>>Instagram Coment.</option>
                    <option value="facebook" <?= ($filters['channel'] ?? '') === 'facebook' ? 'selected' : '' ?>>Facebook</option>
                    <option value="tiktok" <?= ($filters['channel'] ?? '') === 'tiktok' ? 'selected' : '' ?>>TikTok</option>
                    <option value="telegram" <?= ($filters['channel'] ?? '') === 'telegram' ? 'selected' : '' ?>>Telegram</option>
                    <option value="email" <?= ($filters['channel'] ?? '') === 'email' ? 'selected' : '' ?>>Email</option>
                    <option value="chat" <?= ($filters['channel'] ?? '') === 'chat' ? 'selected' : '' ?>>Chat</option>
                    <option value="mercadolivre" <?= ($filters['channel'] ?? '') === 'mercadolivre' ? 'selected' : '' ?>>Mercado Livre</option>
                    <option value="webchat" <?= ($filters['channel'] ?? '') === 'webchat' ? 'selected' : '' ?>>WebChat</option>
                    <option value="olx" <?= ($filters['channel'] ?? '') === 'olx' ? 'selected' : '' ?>>OLX</option>
                    <option value="linkedin" <?= ($filters['channel'] ?? '') === 'linkedin' ? 'selected' : '' ?>>LinkedIn</option>
                    <option value="google_business" <?= ($filters['channel'] ?? '') === 'google_business' ? 'selected' : '' ?>>Google Business</option>
                    <option value="youtube" <?= ($filters['channel'] ?? '') === 'youtube' ? 'selected' : '' ?>>YouTube</option>
                </select>
                
                <?php if (!empty($departments)): ?>
                <select id="filter_department" class="form-select form-select-sm form-select-solid">
                    <option value="">Setores</option>
                    <?php foreach ($departments as $dept): ?>
                        <option value="<?= $dept['id'] ?>" <?= ($filters['department_id'] ?? '') == $dept['id'] ? 'selected' : '' ?>>
                            <?= htmlspecialchars($dept['name']) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
                <?php endif; ?>
                
                <?php if (!empty($tags)): ?>
                <select id="filter_tag" class="form-select form-select-sm form-select-solid">
                    <option value="">Tags</option>
                    <?php foreach ($tags as $tag): ?>
                        <option value="<?= $tag['id'] ?>" <?= ($filters['tag_id'] ?? '') == $tag['id'] ? 'selected' : '' ?>>
                            <?= htmlspecialchars($tag['name']) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
                <?php endif; ?>
                
                <?php 
                $canViewAllConversations = \App\Helpers\Permission::can('conversations.view.all');
                $currentUserId = \App\Helpers\Auth::id();
                ?>
                <?php if ($canViewAllConversations || !empty($agents)): ?>
                <select id="filter_agent" class="form-select form-select-sm form-select-solid">
                    <option value="">Agentes</option>
                    <option value="unassigned" <?= ($filters['agent_id'] ?? '') === 'unassigned' ? 'selected' : '' ?>>Não atribuídas</option>
                    <?php if ($canViewAllConversations && !empty($agents)): ?>
                        <?php foreach ($agents as $agent): ?>
                            <option value="<?= $agent['id'] ?>" <?= ($filters['agent_id'] ?? '') == $agent['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($agent['name']) ?>
                            </option>
                        <?php endforeach; ?>
                    <?php elseif (!$canViewAllConversations && $currentUserId): ?>
                        <?php 
                        $currentUser = \App\Models\User::find($currentUserId);
                        if ($currentUser): ?>
                            <option value="<?= $currentUser['id'] ?>" <?= ($filters['agent_id'] ?? '') == $currentUser['id'] ? 'selected' : '' ?>>
                                Minhas conversas
                            </option>
                        <?php endif; ?>
                    <?php endif; ?>
                </select>
                <?php endif; ?>

                <select id="filter_funnel" class="form-select form-select-sm form-select-solid">
                    <option value="">Funil</option>
                </select>
                <select id="filter_stage" class="form-select form-select-sm form-select-solid" disabled>
                    <option value="">Etapa</option>
                </select>
            </div>
            <div class="d-flex align-items-center gap-2 mt-2">
                <button type="button" class="btn btn-sm btn-light-primary flex-grow-1" onclick="openAdvancedFilters()" title="Filtros Avançados">
                    <i class="ki-duotone ki-setting-2 fs-6 me-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Avançados
                </button>
                <button type="button" class="btn btn-sm btn-light-danger" onclick="clearAllFilters()" title="Limpar Filtros">
                    <i class="ki-duotone ki-cross fs-6">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Limpar
                </button>
            </div>
        </div>

        <!-- Lista de conversas -->
        <div class="conversations-list-items">
                <?php if (empty($conversations)): ?>
                <div class="empty-state">
                    <i class="ki-duotone ki-message-text">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <h5>Nenhuma conversa</h5>
                    <p class="text-muted">Aguarde novas mensagens</p>
                    </div>
                <?php else: ?>
                                <?php foreach ($conversations as $conv): ?>
                    <?php
                    $channelIcon = getChannelIconSvg($conv['channel'] ?? 'chat', 16);
                    
                    $channelName = match($conv['channel'] ?? 'chat') {
                        'whatsapp' => 'WhatsApp',
                        'whatsapp_official' => 'WhatsApp Oficial',
                        'instagram' => 'Instagram',
                        'instagram_comment' => 'Comentário',
                        'facebook' => 'Facebook',
                        'tiktok' => 'TikTok',
                        'telegram' => 'Telegram',
                        'email' => 'Email',
                        'chat' => 'Chat',
                        'mercadolivre' => 'Mercado Livre',
                        'webchat' => 'WebChat',
                        'olx' => 'OLX',
                        'linkedin' => 'LinkedIn',
                        'google_business' => 'Google Business',
                        'youtube' => 'YouTube',
                        default => 'Chat'
                    };
                    
                    $isActive = ($selectedConversationId == $conv['id']);
                    ?>
                    <?php
                    // Usar first_response_at calculado das mensagens se disponível, senão usar o campo da conversa
                    $firstResponseAt = !empty($conv['first_response_at_calc']) ? $conv['first_response_at_calc'] : ($conv['first_response_at'] ?? '');
                    $lastContactAt = $conv['last_contact_message_at'] ?? '';
                    $lastAgentAt = $conv['last_agent_message_at'] ?? '';
                    $lastMessageFromAgent = !empty($lastAgentAt) && (empty($lastContactAt) || strtotime($lastAgentAt) >= strtotime($lastContactAt));
                    ?>
                    <div class="conversation-item <?= $isActive ? 'active' : '' ?> <?= !empty($conv['pinned']) ? 'pinned' : '' ?>" 
                         data-conversation-id="<?= $conv['id'] ?>"
                         data-status="<?= htmlspecialchars($conv['status'] ?? 'open') ?>"
                         data-created-at="<?= htmlspecialchars($conv['created_at'] ?? '') ?>"
                         data-first-response-at="<?= htmlspecialchars($firstResponseAt) ?>"
                         data-last-message-at="<?= htmlspecialchars($conv['last_message_at'] ?? '') ?>"
                         data-last-contact-message-at="<?= htmlspecialchars($lastContactAt) ?>"
                         data-last-agent-message-at="<?= htmlspecialchars($lastAgentAt) ?>"
                         data-agent-id="<?= htmlspecialchars($conv['agent_id'] ?? '') ?>"
                         data-onclick="selectConversation">
                        <div class="d-flex gap-3 w-100">
                            <!-- Avatar -->
                            <div class="symbol symbol-45px flex-shrink-0">
                                <?php
                                $name = $conv['contact_name'] ?? 'NN';
                                $parts = explode(' ', $name);
                                $initials = strtoupper(substr($parts[0], 0, 1) . (isset($parts[1]) ? substr($parts[1], 0, 1) : ''));
                                
                                if (!empty($conv['contact_avatar'])):
                                ?>
                                    <div class="symbol-label"><img src="<?= htmlspecialchars($conv['contact_avatar']) ?>" alt="<?= htmlspecialchars($name) ?>" class="h-45px w-45px rounded" style="object-fit: cover;"></div>
                                <?php else: ?>
                                    <div class="symbol-label bg-light-primary text-primary fw-bold"><?= $initials ?></div>
                                <?php endif; ?>
                            </div>
                            
                            <!-- Conteúdo -->
                            <div class="flex-grow-1 min-w-0">
                                <div class="conversation-item-header">
                                    <div class="conversation-item-name d-flex align-items-center gap-2">
                                        <?php if (!empty($conv['pinned'])): ?>
                                        <i class="ki-duotone ki-pin fs-7 text-warning" title="Fixada">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                        <?php endif; ?>
                                                        <?php if (!empty($conv['is_spam'])): ?>
                                                            <span class="badge badge-sm badge-danger" title="Marcada como spam">⚠️ SPAM</span>
                                                        <?php endif; ?>
                                                        <?php
                                                        $nameRaw = $conv['contact_name'] ?? 'Sem nome';
                                                        $maxName = 22;
                                                        $displayName = mb_strlen($nameRaw) > $maxName ? mb_substr($nameRaw, 0, $maxName) . '...' : $nameRaw;
                                                        echo htmlspecialchars($displayName);
                                                        ?>
                                    </div>
                            <div class="conversation-item-time d-flex align-items-center gap-2">
                                <?php
                                if (!empty($conv['last_message_at'])) {
                                    $time = strtotime($conv['last_message_at']);
                                    $diff = time() - $time;
                                    if ($diff < 60) {
                                        echo 'Agora';
                                    } elseif ($diff < 3600) {
                                        echo floor($diff / 60) . 'min';
                                    } elseif ($diff < 86400) {
                                        echo date('H:i', $time);
                                    } else {
                                        echo date('d/m', $time);
                                    }
                                } else {
                                    echo '-';
                                }
                                ?>
                                <div class="dropdown conversation-item-actions">
                                    <button type="button" class="btn btn-sm btn-icon btn-light p-0" 
                                            data-bs-toggle="dropdown" 
                                            aria-expanded="false"
                                            onclick="event.stopPropagation();">
                                        <i class="ki-duotone ki-setting-2 text-muted">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                            <span class="path4"></span>
                                            <span class="path5"></span>
                                        </i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" data-conversation-id="<?= $conv['id'] ?>">
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); togglePin(<?= $conv['id'] ?>, <?= !empty($conv['pinned']) ? 'true' : 'false' ?>); return false;">
                                                <i class="ki-duotone ki-pin fs-7 me-2 <?= !empty($conv['pinned']) ? 'text-warning' : '' ?>">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                <?= !empty($conv['pinned']) ? 'Desfixar' : 'Fixar' ?>
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); markConversationAsRead(<?= $conv['id'] ?>); return false;">
                                                <i class="ki-duotone ki-check fs-7 me-2 text-success">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                Marcar como Lido
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); markConversationAsUnread(<?= $conv['id'] ?>); return false;">
                                                <i class="ki-duotone ki-eye-slash fs-7 me-2 text-danger">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                Marcar como Não Lido
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); showReminderModal(<?= $conv['id'] ?>); return false;">
                                                <i class="ki-duotone ki-notification-bing fs-7 me-2 text-primary">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                Agendar Lembrete
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="dropdown-submenu">
                                            <a class="dropdown-item d-flex align-items-center justify-content-between" href="#" onclick="event.stopPropagation(); event.preventDefault(); toggleSetAsSubmenu(this, <?= $conv['id'] ?>);">
                                                <span>
                                                    <i class="ki-duotone ki-tag fs-7 me-2 text-info">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                    </i>
                                                    Setar como
                                                </span>
                                                <i class="ki-duotone ki-right fs-8 ms-2"><span class="path1"></span><span class="path2"></span></i>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="conversation-item-preview">
                            <?= htmlspecialchars(mb_substr($conv['last_message'] ?? 'Sem mensagens', 0, 37)) ?>
                            <?= mb_strlen($conv['last_message'] ?? '') > 37 ? '...' : '' ?>
                        </div>
                        <div class="conversation-item-meta">
                            <span class="conversation-item-channel">
                                <?= $channelIcon ?> <?= $channelName ?>
                            </span>
                            <span class="conversation-item-tags d-flex gap-1 flex-wrap">
                                <?php if (!empty($conv['tags']) && is_array($conv['tags'])): ?>
                                    <?php foreach (array_slice($conv['tags'], 0, 2) as $tag): ?>
                                        <span class="badge badge-sm" style="background-color: <?= htmlspecialchars($tag['color'] ?? '#009ef7') ?>20; color: <?= htmlspecialchars($tag['color'] ?? '#009ef7') ?>;">
                                            <?= htmlspecialchars($tag['name']) ?>
                                        </span>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </span>
                            <?php if (!empty($conv['unread_count'])): ?>
                                <span class="conversation-item-badge"><?= $conv['unread_count'] ?></span>
                            <?php endif; ?>
                        </div>
                            </div><!-- fim flex-grow -->
                        </div><!-- fim d-flex -->
                    </div>
                <?php endforeach; ?>
                                                    <?php endif; ?>
        </div>
        <div class="text-center py-3">
            <button class="btn btn-light btn-sm" id="loadMoreConversationsBtn" style="display:none;">
                <span class="spinner-border spinner-border-sm align-middle me-2" role="status" aria-hidden="true" style="display:none;"></span>
                Carregar mais
            </button>
        </div>
                                            </div>
    
    <!-- COLUNA 2: üREA DE CHAT -->
    <div class="chat-area" id="chatAreaView">
        
        <!-- Header do Chat (sempre presente, mas pode estar oculto) -->
        <div class="chat-header" id="chatHeader" style="<?= empty($selectedConversation) ? 'display: none;' : '' ?>">
            <!-- Botão Voltar (Mobile) -->
            <button class="btn btn-sm btn-icon btn-light chat-header-back-btn d-none" onclick="showListView()" title="Voltar para lista" id="chatHeaderBackBtn" style="display: none;">
                <i class="ki-duotone ki-arrow-left fs-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </button>
            <div class="chat-header-info">
                <div class="symbol symbol-circle symbol-50px">
                    <?php
                    $initials = '';
                    if (!empty($selectedConversation)) {
                        $name = $selectedConversation['contact_name'] ?? 'NN';
                        $parts = explode(' ', $name);
                        $initials = strtoupper(substr($parts[0], 0, 1) . (isset($parts[1]) ? substr($parts[1], 0, 1) : ''));
                    }
                    ?>
                    <div class="symbol-label bg-light-primary text-primary fs-3 fw-bold"><?= $initials ?></div>
                </div>
                <div class="chat-header-text">
                    <div class="chat-header-title" id="chat-header-contact-name"><?= htmlspecialchars($selectedConversation['contact_name'] ?? 'Sem nome') ?></div>
                    <div class="chat-header-subtitle">
                        <?php
                        $channelIcon = getChannelIconSvg($selectedConversation['channel'] ?? 'chat', 18);
                        $channelName = match($selectedConversation['channel'] ?? 'chat') {
                            'whatsapp' => 'WhatsApp',
                            'whatsapp_official' => 'WhatsApp Oficial',
                            'instagram' => 'Instagram',
                            'instagram_comment' => 'Comentário',
                            'facebook' => 'Facebook',
                            'tiktok' => 'TikTok',
                            'telegram' => 'Telegram',
                            'email' => 'Email',
                            'chat' => 'Chat',
                            'mercadolivre' => 'Mercado Livre',
                            'webchat' => 'WebChat',
                            'olx' => 'OLX',
                            'linkedin' => 'LinkedIn',
                            'google_business' => 'Google Business',
                            'youtube' => 'YouTube',
                            default => 'Chat'
                        };
                        ?>
                        <span class="chat-header-channel" id="chat-header-channel"><?= $channelIcon . ' ' . $channelName ?></span>
                        <span class="chat-header-separator">•</span>
                        <?php
                        $statusClass = match($selectedConversation['status'] ?? 'open') {
                            'open' => 'success',
                            'resolved' => 'info',
                            'closed' => 'dark',
                            default => 'secondary'
                        };
                        $statusText = match($selectedConversation['status'] ?? 'open') {
                            'open' => 'Aberta',
                            'resolved' => 'Resolvida',
                            'closed' => 'Fechada',
                            default => 'Desconhecida'
                        };
                        ?>
                        <span class="chat-header-status" id="chat-header-status">
                            <span class="badge badge-sm badge-light-<?= $statusClass ?>"><?= $statusText ?></span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2 chat-header-actions">
                <!-- Busca de mensagens -->
                <div class="position-relative d-flex gap-2" style="width: 250px;">
                    <div class="position-relative flex-grow-1">
                        <input type="text" id="messageSearch" class="form-control form-control-sm form-control-solid ps-10" 
                               placeholder="Buscar mensagens...">
                        <i class="ki-duotone ki-magnifier position-absolute top-50 translate-middle-y start-0 ms-3 fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        <div id="messageSearchResults" class="position-absolute top-100 start-0 w-100 bg-body border rounded shadow-lg d-none" style="max-height: 300px; overflow-y: auto; z-index: 1000; margin-top: 5px;">
                            <!-- Resultados da busca serão inseridos aqui -->
                        </div>
                    </div>
                    <button class="btn btn-sm btn-icon btn-light-primary" onclick="showMessageSearchFilters()" title="Filtros avançados" id="messageSearchFiltersBtn">
                        <i class="ki-duotone ki-filter fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
                
                <!-- Botão para mencionar/convidar agente -->
                <button class="btn btn-sm btn-icon btn-light-warning" onclick="showMentionAgentModal()" title="Mencionar agente">
                    <i class="ki-duotone ki-user-tick fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                </button>
                
                <?php
                // Verificar se hí conta Api4Com habilitada e ramal do usuírio
                $api4comAccount = \App\Models\Api4ComAccount::getFirstEnabled();
                $hasApi4Com = !empty($api4comAccount);
                $currentUserId = \App\Helpers\Auth::id();
                $hasExtension = false;
                if ($hasApi4Com && $currentUserId) {
                    $extension = \App\Models\Api4ComExtension::findByUserAndAccount($currentUserId, $api4comAccount['id']);
                    $hasExtension = !empty($extension) && $extension['status'] === 'active';
                }
                $canMakeCalls = $hasApi4Com && $hasExtension && \App\Helpers\Permission::can('api4com_calls.create');
                $showCallButton = $canMakeCalls && !empty($selectedConversation) && !empty($selectedConversation['contact_phone']);
                ?>
                <button class="btn btn-sm btn-icon btn-light-success" onclick="startApi4ComCall(currentConversationId)" title="Ligar via Api4Com" id="btnApi4ComCall" style="<?= $showCallButton ? '' : 'display:none;' ?>">
                    <i class="ki-duotone ki-phone fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </button>
                <script>
                    // Disponibilizar informação de capacidade Api4Com para JavaScript
                    window.api4comCanMakeCalls = <?= $canMakeCalls ? 'true' : 'false' ?>;
                </script>
                
                <button class="btn btn-sm btn-icon btn-light-primary" onclick="toggleConversationSidebar()" title="Detalhes da conversa">
                    <i class="ki-duotone ki-burger-menu fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                    </i>
                </button>
            </div>
        </div>
        
        <!-- Banner de IA Ativa (aparece quando IA está ativa) -->
        <div id="aiActiveBanner" class="ai-active-banner d-none" style="display: none !important;">
            <div class="ai-active-banner-content">
                <div class="ai-active-banner-icon">
                    <i class="ki-duotone ki-robot fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                    </i>
                </div>
                <div class="ai-active-banner-info">
                    <div class="ai-active-banner-title">
                        <span class="ai-agent-name">Agente de IA Ativo</span>
                        <span class="badge badge-sm badge-light-success ms-2">Ativo</span>
                    </div>
                    <div class="ai-active-banner-subtitle">
                        <span class="ai-agent-type"></span>
                        <span class="ai-messages-count ms-2"></span>
                    </div>
                </div>
                <div class="ai-active-banner-actions">
                    <button class="btn btn-sm btn-light-primary" id="aiHistoryButton">
                        <i class="ki-duotone ki-eye fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Ver Histórico
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-danger" id="removeAIButton" title="Remover IA">
                        <i class="ki-duotone ki-cross fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Banner de Outras Conversas (Mesclar) - Sempre aparece para todos -->
        <div id="chat-merge-alert" class="chat-merge-alert" style="display: none;">
            <div class="chat-merge-alert-content">
                <div class="chat-merge-alert-icon">
                    <i class="ki-duotone ki-information-2 fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                </div>
                <div class="chat-merge-alert-text">
                    <strong>Existem outras conversas deste contato!</strong>
                    <span id="chat-merge-alert-info"></span>
                </div>
                <?php if (\App\Helpers\Permission::canAny(['conversations.edit.own', 'conversations.edit.department', 'conversations.edit.all'])): ?>
                <button type="button" class="btn btn-sm btn-warning" onclick="openMergeModal()">
                    <i class="ki-duotone ki-arrows-loop fs-5 me-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Mesclar
                </button>
                <?php endif; ?>
                <button type="button" class="btn btn-sm btn-icon btn-light" onclick="dismissMergeAlert()" title="Dispensar">
                    <i class="ki-duotone ki-cross fs-4">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </button>
            </div>
        </div>
        
        <!-- Mensagens (sempre presente) -->
        <div class="chat-messages <?= !empty($accessRestricted) ? 'access-restricted' : '' ?>" 
             id="chatMessages" 
             data-conversation-id="<?= $selectedConversation['id'] ?? '' ?>">
            <?php if (!empty($selectedConversation) && !empty($accessRestricted)): ?>
                <!-- ======================================== -->
                <!-- ACESSO RESTRITO - TELA OFUSCADA -->
                <!-- ======================================== -->
                <div class="restricted-access-container" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden; z-index: 100;">
                    <!-- Mensagens fake ofuscadas (blur) -->
                    <div class="blurred-messages" style="filter: blur(8px); opacity: 0.3; pointer-events: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 20px; overflow: hidden;">
                        <div class="message message-received mb-3" style="max-width: 70%; background: var(--bs-gray-200); padding: 12px 16px; border-radius: 12px;">
                            <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 80%;"></div>
                            <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 60%; margin-top: 8px;"></div>
                        </div>
                        <div class="message message-sent mb-3" style="max-width: 70%; background: var(--bs-primary); padding: 12px 16px; border-radius: 12px; margin-left: auto;">
                            <div style="height: 14px; background: rgba(255,255,255,0.5); border-radius: 4px; width: 90%;"></div>
                        </div>
                        <div class="message message-received mb-3" style="max-width: 70%; background: var(--bs-gray-200); padding: 12px 16px; border-radius: 12px;">
                            <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 70%;"></div>
                            <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 85%; margin-top: 8px;"></div>
                            <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 50%; margin-top: 8px;"></div>
                        </div>
                        <div class="message message-sent mb-3" style="max-width: 70%; background: var(--bs-primary); padding: 12px 16px; border-radius: 12px; margin-left: auto;">
                            <div style="height: 14px; background: rgba(255,255,255,0.5); border-radius: 4px; width: 75%;"></div>
                            <div style="height: 14px; background: rgba(255,255,255,0.5); border-radius: 4px; width: 60%; margin-top: 8px;"></div>
                        </div>
                    </div>
                    
                    <!-- Overlay com botão de solicitar -->
                    <div class="restricted-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(var(--bs-body-bg-rgb, 255, 255, 255), 0.85); z-index: 10;">
                        <div class="text-center p-5">
                            <div class="mb-4">
                                <i class="ki-duotone ki-shield-cross fs-4x text-warning">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                            </div>
                            
                            <h3 class="fw-bold mb-3">Acesso Restrito</h3>
                            <p class="text-muted mb-4">
                                Você não está atribuído nem é participante desta conversa.<br>
                                Solicite participação para ter acesso completo.
                            </p>
                            
                            <?php if (!empty($accessInfo['has_pending_request'])): ?>
                                <!-- Jí tem solicitação pendente -->
                                <div class="alert alert-warning d-inline-flex align-items-center mb-4" role="alert">
                                    <i class="ki-duotone ki-timer fs-2 me-2 text-warning">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                    </i>
                                    <div class="text-start">
                                        <div class="fw-bold">Solicitação Pendente</div>
                                        <div class="fs-7">Aguarde aprovação de um agente.</div>
                                    </div>
                                </div>
                            <?php else: ?>
                                <!-- Botão para solicitar participação -->
                                <button class="btn btn-primary btn-lg" onclick="requestParticipation(<?= (int)$selectedConversationId ?>)">
                                    <i class="ki-duotone ki-entrance-right fs-2 me-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    Solicitar Participação
                                </button>
                            <?php endif; ?>
                            
                            <div class="mt-4">
                                <small class="text-muted">
                                    Conversa atribuída a: <strong><?= htmlspecialchars($selectedConversation['agent_name'] ?? 'Não atribuída') ?></strong>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            <?php elseif (!empty($selectedConversation)): ?>
                <?php if (!empty($selectedConversation['messages'])): ?>
                    <?php 
                    $lastDate = null;
                    $isFirstMessage = true;
                    foreach ($selectedConversation['messages'] as $msg): 
                        $msgCreatedAt = $msg['created_at'] ?? date('Y-m-d H:i:s');
                        
                        // Verificar se precisa adicionar separador de data
                        // Sempre adicionar antes da primeira mensagem ou quando o dia muda
                        if ($isFirstMessage || ($lastDate !== null && isDifferentDay($lastDate, $msgCreatedAt))) {
                            echo renderDateSeparator($msgCreatedAt);
                            $lastDate = $msgCreatedAt;
                            $isFirstMessage = false;
                        } elseif ($lastDate === null) {
                            // Garantir que sempre hí um separador antes da primeira mensagem
                            echo renderDateSeparator($msgCreatedAt);
                            $lastDate = $msgCreatedAt;
                            $isFirstMessage = false;
                        }
                    ?>
                        <?php
                        // Garantir que as chaves existem para evitar warnings
                        $msgType = $msg['type'] ?? 'message';
                        $msgDirection = $msg['direction'] ?? 'outgoing';
                        $msgContent = $msg['content'] ?? '';
                        $msgSenderName = $msg['sender_name'] ?? 'Sistema';
                        $msgCreatedAt = $msg['created_at'] ?? date('Y-m-d H:i:s');
                        ?>
                        
                        <?php if ($msgType === 'system'): ?>
                            <!-- Evento do sistema -->
                            <div class="chat-message system">
                                <div class="message-content">
                                    <div class="message-bubble">
                                        <i class="ki-duotone ki-information fs-5 me-1">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                        </i>
                                        <?= htmlspecialchars($msgContent) ?>
                                    </div>
                                </div>
                            </div>
                        
                        <?php elseif ($msgType === 'note'): ?>
                            <!-- Nota interna - Alinhada á direita como mensagens enviadas -->
                            <?php
                            // Verificar se é nota de sistema (ligação) - não escapar HTML
                            $isSystemNote = (
                                strpos($msgContent, '📞') === 0 || 
                                strpos($msgContent, '✅') === 0 || 
                                strpos($msgContent, '📴') === 0 || 
                                strpos($msgContent, '❌') === 0 || 
                                strpos($msgContent, '🎙') === 0 ||
                                strpos($msgContent, '<strong>') !== false ||
                                strpos($msgContent, '<br') !== false ||
                                strpos($msgContent, '<a ') !== false
                            );
                            $noteDisplayContent = $isSystemNote 
                                ? $msgContent 
                                : str_replace("\n", "<br>", htmlspecialchars($msgContent));
                            ?>
                            <div class="chat-message note outgoing" data-message-id="<?= $msg['id'] ?? '' ?>" data-timestamp="<?= strtotime($msgCreatedAt) * 1000 ?>">
                                <div class="message-content">
                                    <div class="message-bubble">
                                        <div class="note-header">
                                            <i class="ki-duotone ki-note fs-6">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                            Nota Interna • <?= htmlspecialchars($msgSenderName) ?>
                                        </div>
                                        <?= $noteDisplayContent ?>
                                    </div>
                                    <div class="message-time"><?= date('H:i', strtotime($msgCreatedAt)) ?></div>
                                </div>
                            </div>
                        
                                            <?php else: ?>
                            <!-- Mensagem normal -->
                            <?php
                            // Verificar se é mensagem de IA
                            $isAIMessage = !empty($msg['ai_agent_id']);
                            $aiAgentName = $msg['ai_agent_name'] ?? 'Assistente IA';
                            $aiAgentInitials = '';
                            if ($isAIMessage && $aiAgentName) {
                                $parts = explode(' ', $aiAgentName);
                                $aiAgentInitials = strtoupper(substr($parts[0], 0, 1) . (isset($parts[1]) ? substr($parts[1], 0, 1) : ''));
                            }
                            ?>
                            <div class="chat-message <?= $msgDirection === 'incoming' ? 'incoming' : 'outgoing' ?>" data-message-id="<?= $msg['id'] ?? '' ?>" data-timestamp="<?= strtotime($msgCreatedAt) * 1000 ?>">
                                <?php if ($msgDirection === 'incoming'): ?>
                                    <?php if (!empty($selectedConversation['contact_avatar'])): ?>
                                        <img src="<?= htmlspecialchars($selectedConversation['contact_avatar']) ?>" alt="Avatar" class="message-avatar" style="object-fit: cover;">
                                    <?php else: ?>
                                        <div class="message-avatar"><?= $initials ?></div>
                                    <?php endif; ?>
                                <?php elseif ($isAIMessage && $msgDirection === 'outgoing'): ?>
                                    <!-- Avatar do agente de IA -->
                                    <div class="message-avatar ai-agent-avatar" title="<?= htmlspecialchars($aiAgentName) ?>">
                                        <?= $aiAgentInitials ?: '🤖' ?>
                                    </div>
                                <?php endif; ?>
                                <div class="message-content">
                                    <div class="message-actions">
                                        <?php
                                        // Escapar corretamente para JavaScript (remover quebras de linha e caracteres problemáticos)
                                        $jsEscapedSender = addslashes(preg_replace('/[\r\n]+/', ' ', $msgSenderName));
                                        $jsEscapedContent = addslashes(preg_replace('/[\r\n]+/', ' ', substr($msgContent, 0, 100)));
                                        ?>
                                        <button class="message-actions-btn" onclick="replyToMessage(<?= $msg['id'] ?? 0 ?>, '<?= $jsEscapedSender ?>', '<?= $jsEscapedContent ?>')" title="Responder">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="9 10 4 15 9 20"></polyline>
                                                <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
                                            </svg>
                                        </button>
                                        <button class="message-actions-btn reaction-trigger-btn" onclick="toggleReactionPicker(event, <?= $msg['id'] ?? 0 ?>)" title="Reagir">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                            </svg>
                                        </button>
                                        <button class="message-actions-btn" onclick="forwardMessage(<?= $msg['id'] ?? 0 ?>)" title="Encaminhar">
                                            <i class="ki-duotone ki-arrow-right fs-6">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                        </button>
                                    </div>
                                            <?php
                                    // Verificar se é uma mensagem citada/reply
                                    $isQuoted = strpos($msgContent, '↩️') === 0;
                                    
                                    // Verificar se é apenas íudio (sem texto e sem outros anexos)
                                    $hasOnlyAudio = false;
                                    if (!empty($msg['attachments']) && empty($msgContent) && !$isQuoted) {
                                        $attachments = is_string($msg['attachments']) ? json_decode($msg['attachments'], true) : $msg['attachments'];
                                        if (is_array($attachments)) {
                                            $audioCount = 0;
                                            $totalCount = count($attachments);
                                            foreach ($attachments as $att) {
                                                $attType = $att['type'] ?? '';
                                                $attMime = $att['mime_type'] ?? $att['mimetype'] ?? '';
                                                if ($attType === 'audio' || strpos($attMime, 'audio/') === 0) {
                                                    $audioCount++;
                                                }
                                            }
                                            $hasOnlyAudio = ($audioCount === $totalCount && $totalCount > 0);
                                        }
                                    }
                                    $bubbleClass = $hasOnlyAudio ? 'message-bubble audio-only' : 'message-bubble';
                                    if ($isAIMessage) {
                                        $bubbleClass .= ' ai-message';
                                    }
                                    ?>
                                    <?php if ($isAIMessage && $msgDirection === 'outgoing'): ?>
                                        <div class="ai-message-badge" title="Mensagem enviada por <?= htmlspecialchars($aiAgentName) ?>">
                                            <div class="ai-avatar-mini">
                                                <?= $aiAgentInitials ?: '🤖' ?>
                                            </div>
                                            <i class="ki-duotone ki-robot fs-7">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                                <span class="path4"></span>
                                            </i>
                                            <span class="ai-badge-text"><?= htmlspecialchars($aiAgentName) ?></span>
                                        </div>
                                    <?php endif; ?>
                                    <div class="<?= $bubbleClass ?>">
                                        <?php 
                                        // Verificar se tem reply atravês do campo quoted_message_id
                                        $hasQuote = !empty($msg['quoted_message_id']) || $isQuoted;
                                        if ($hasQuote): 
                                            // Priorizar campos separados, senão extrair do content
                                            if (!empty($msg['quoted_message_id'])) {
                                                $quotedMsgId = $msg['quoted_message_id'];
                                                $quotedSenderName = $msg['quoted_sender_name'] ?? 'Remetente';
                                                $quotedText = $msg['quoted_text'] ?? '';
                                                // Limitar texto citado
                                                if (mb_strlen($quotedText) > 100) {
                                                    $quotedText = mb_substr($quotedText, 0, 100) . '...';
                                                }
                                                $actualContent = $msgContent; // Content não foi modificado
                                            } else {
                                                // Mensagem antiga com formato antigo (↩️ no content)
                                                $lines = explode("\n", $msgContent, 2);
                                                $quotedText = substr($lines[0], 2); // Remove "↩️ "
                                                $actualContent = $lines[1] ?? '';
                                                $quotedMsgId = null;
                                                $quotedSenderName = 'Remetente';
                                            }
                                        ?>
                                            <div class="quoted-message" onclick="console.log('Quoted message clicado, ID:', <?= $quotedMsgId ?: 'null' ?>); <?= $quotedMsgId ? "scrollToMessage({$quotedMsgId})" : "console.log('Sem ID para scroll')" ?>" title="<?= $quotedMsgId ? 'Clique para ver a mensagem original' : 'Mensagem original não disponível' ?>" data-quoted-id="<?= $quotedMsgId ?: '' ?>">
                                                <div class="quoted-message-header"><?= htmlspecialchars($quotedSenderName) ?></div>
                                                <div class="quoted-message-content"><?= htmlspecialchars($quotedText) ?></div>
                                            </div>
                                        <?php endif; ?>
                                        
                                        <?php if (!empty($msg['attachments']) && is_array($msg['attachments'])): ?>
                                            <?php foreach ($msg['attachments'] as $attachment): ?>
                                                <?= renderAttachment($attachment) ?>
                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                        <?php 
                                        // Verificar se o conteúdo é apenas um nome de arquivo técnico (não exibir)
                                        $contentToShow = $isQuoted ? $actualContent : $msgContent;
                                        $trimmedContent = trim($contentToShow);
                                        
                                        // Detectar nomes de arquivo técnicos gerados automaticamente
                                        // Padrões: audio_*, document_*, image_*, video_*, IMG_*, VID_*, etc.
                                        $isTechnicalFilename = preg_match('/^(audio|document|video|image|img|vid|file|sticker|ptt)_[A-Za-z0-9_-]+\.[a-z0-9]+$/i', $trimmedContent);
                                        
                                        // Também detectar se é apenas o nome do arquivo igual ao anexo
                                        $hasMatchingAttachment = false;
                                        if (!empty($msg['attachments']) && is_array($msg['attachments'])) {
                                            foreach ($msg['attachments'] as $att) {
                                                $attFilename = $att['original_name'] ?? $att['filename'] ?? $att['name'] ?? '';
                                                if ($trimmedContent === $attFilename) {
                                                    $hasMatchingAttachment = true;
                                                    break;
                                                }
                                            }
                                        }
                                        
                                        $isMediaPlaceholder = in_array($trimmedContent, ['Documento', 'Imagem', 'Vídeo', 'Áudio', 'Mensagem de voz', 'Figurinha', 'Mídia']);
                                        $shouldShowContent = !empty($msgContent) && !$isTechnicalFilename && !$hasMatchingAttachment && !$isMediaPlaceholder;
                                        ?>
                                        <?php if ($shouldShowContent): ?>
                                            <div class="<?= (!empty($msg['attachments']) || $isQuoted) ? 'mt-2' : '' ?>">
                                                <?= str_replace("\n", "<br>", htmlspecialchars($contentToShow)) ?>
                                            </div>
                                        <?php endif; ?>
                                    </div>
                                    <?php 
                                    // Renderizar reações
                                    $reactions = $msg['reactions'] ?? [];
                                    if (is_string($reactions)) {
                                        $reactions = json_decode($reactions, true) ?? [];
                                    }
                                    if (!empty($reactions)): 
                                        // Agrupar por emoji
                                        $grouped = [];
                                        foreach ($reactions as $r) {
                                            $emoji = $r['emoji'] ?? '';
                                            if (!isset($grouped[$emoji])) {
                                                $grouped[$emoji] = ['count' => 0, 'names' => []];
                                            }
                                            $grouped[$emoji]['count']++;
                                            $grouped[$emoji]['names'][] = $r['sender_name'] ?? ($r['from'] === 'agent' ? 'Agente' : 'Contato');
                                        }
                                    ?>
                                    <div class="message-reactions">
                                        <?php foreach ($grouped as $emoji => $data): ?>
                                            <span class="reaction-badge" title="<?= htmlspecialchars(implode(', ', $data['names'])) ?>">
                                                <?= $emoji ?><?php if ($data['count'] > 1): ?> <span class="reaction-count"><?= $data['count'] ?></span><?php endif; ?>
                                            </span>
                                        <?php endforeach; ?>
                                    </div>
                                    <?php endif; ?>
                                    <div class="message-time">
                                        <?= date('H:i', strtotime($msgCreatedAt)) ?>
                                        <?php if ($msgDirection === 'outgoing'): ?>
                                            <?= renderMessageStatus($msg) ?>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        <?php endif; ?>
                        
                    <?php 
                        // Atualizar última data processada
                        $lastDate = $msgCreatedAt;
                    endforeach; ?>
                                            <?php else: ?>
                    <div class="empty-state">
                        <i class="ki-duotone ki-message-text">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <h5>Nenhuma mensagem</h5>
                        <p class="text-muted">Envie a primeira mensagem</p>
                    </div>
                                            <?php endif; ?>
            <?php else: ?>
                <!-- Estado vazio - nenhuma conversa selecionada -->
                <div class="empty-state">
                    <i class="ki-duotone ki-message-text-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <h3>Selecione uma conversa</h3>
                    <p class="text-muted">Escolha uma conversa da lista para começar</p>
                </div>
            <?php endif; ?>
        </div>
        
        <!-- Campo de Envio (sempre presente, mas pode estar oculto) -->
        <div class="chat-input" id="chatInput" style="<?= (empty($selectedConversation) || !empty($accessRestricted)) ? 'display: none;' : '' ?>">
                <!-- Preview de Reply -->
                <div id="replyPreview" class="reply-preview d-none">
                    <div class="reply-preview-content">
                        <div class="reply-preview-header" id="replyPreviewHeader"></div>
                        <div class="reply-preview-text" id="replyPreviewText"></div>
                    </div>
                    <button class="reply-preview-close" onclick="cancelReply()" title="Cancelar resposta">
                        <i class="ki-duotone ki-cross fs-4">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
                
                <div class="chat-input-toolbar">
                    <button class="btn btn-sm btn-icon btn-light-primary" title="Anexar arquivo" onclick="attachFile()">
                        <i class="ki-duotone ki-paper-clip fs-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                    <button type="button" class="btn btn-sm btn-light-secondary d-none" id="cancelRecordingBtn" title="Cancelar gravação" onclick="cancelRecording()">
                        <i class="ki-duotone ki-cross-circle fs-3"><span class="path1"></span><span class="path2"></span></i>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-primary" id="recordAudioBtn" title="Gravar íudio" onclick="toggleAudioRecording()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-primary" title="Agendar mensagem" onclick="showScheduleMessageModal()">
                        <i class="ki-duotone ki-calendar-tick fs-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                            <span class="path4"></span>
                        </i>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-success" title="Ver mensagens agendadas" onclick="showScheduledMessagesModal()">
                        <i class="ki-duotone ki-calendar fs-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-primary" title="Emoji" onclick="toggleEmoji()">
                        <span class="fs-3" style="line-height: 1;">😊</span>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-primary" id="aiAssistantBtn" title="Assistente IA" onclick="showAIAssistantModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                            <rect x="4" y="8" width="16" height="12" rx="2"></rect>
                            <rect x="9" y="2" width="6" height="6" rx="1"></rect>
                            <circle cx="9" cy="13" r="1.5" fill="currentColor"></circle>
                            <circle cx="15" cy="13" r="1.5" fill="currentColor"></circle>
                            <path d="M9 17h6"></path>
                        </svg>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-success" id="mockupGeneratorBtn" title="Gerar Mockup" onclick="showMockupGeneratorModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-primary" title="Templates" onclick="showTemplatesModal()">
                        <i class="ki-duotone ki-message-text fs-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-primary" title="Variíveis" onclick="showVariablesModal()">
                        <i class="ki-duotone ki-code fs-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                            <span class="path4"></span>
                        </i>
                    </button>
                    <button class="btn btn-sm btn-icon btn-light-primary" id="agentNameToggle" title="Enviar nome do agente" onclick="toggleAgentName()">
                        <i class="ki-duotone ki-user fs-3" id="agentNameToggleIcon">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
                
                <div class="position-relative">
                    <textarea id="messageInput" class="chat-input-textarea" placeholder="Digite sua mensagem..." rows="2"></textarea>
                    <div id="pendingAttachmentsContainer" class="d-flex gap-3 flex-wrap mt-3"></div>
                    
                    <!-- Dropdown rípido de templates -->
                    <div id="templateQuickSelect" class="template-quick-select d-none">
                        <div class="template-quick-select-header">
                            <div class="d-flex align-items-center gap-2">
                                <i class="ki-duotone ki-message-text fs-4 text-primary">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                                <span class="fw-semibold">Templates</span>
                            </div>
                            <input type="text" id="templateQuickSearch" class="form-control form-control-sm mt-2" placeholder="Buscar template...">
                        </div>
                        <div class="template-quick-select-list" id="templateQuickList">
                            <div class="text-center text-muted py-5">
                                <i class="ki-duotone ki-loader fs-3x mb-3">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                <div>Carregando templates...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-footer">
                    <div class="form-check form-check-sm form-check-custom">
                        <input class="form-check-input" type="checkbox" id="noteToggle">
                        <label class="form-check-label text-muted fs-7" for="noteToggle">
                            <i class="ki-duotone ki-note fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Nota Interna
                        </label>
                    </div>
                    
                    <button class="btn btn-sm btn-primary" onclick="sendMessage()">
                        <i class="ki-duotone ki-send fs-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Enviar
                    </button>
                </div>
        </div>
        
    </div>
    
    <?php if (empty($accessRestricted)): ?>
        <?php include __DIR__ . '/sidebar-conversation.php'; ?>
    <?php else: ?>
        <!-- Sidebar Ofuscada quando acesso restrito -->
        <div class="conversation-sidebar" id="conversationSidebar" style="position: relative;">
            <div style="filter: blur(8px); opacity: 0.3; pointer-events: none; height: 100%; padding: 20px;">
                <div style="height: 80px; background: var(--bs-gray-200); border-radius: 8px; margin-bottom: 20px;"></div>
                <div style="height: 40px; background: var(--bs-gray-200); border-radius: 8px; margin-bottom: 15px;"></div>
                <div style="height: 40px; background: var(--bs-gray-200); border-radius: 8px; margin-bottom: 15px;"></div>
                <div style="height: 100px; background: var(--bs-gray-200); border-radius: 8px; margin-bottom: 15px;"></div>
                <div style="height: 60px; background: var(--bs-gray-200); border-radius: 8px;"></div>
            </div>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: rgba(var(--bs-body-bg-rgb, 255, 255, 255), 0.7);">
                <div class="text-center text-muted">
                    <i class="ki-duotone ki-lock-2 fs-3x mb-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <p class="fs-7">Acesso Restrito</p>
                </div>
            </div>
        </div>
    <?php endif; ?>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeConversationSidebar()"></div>
    
</div>

<!-- MODAL: Templates de Mensagens -->
<div class="modal fade" id="kt_modal_templates" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Templates de Mensagens</h2>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-light-warning" onclick="showPersonalTemplatesModal()" title="Gerenciar meus templates">
                        <i class="ki-duotone ki-user fs-5 me-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Meus Templates
                    </button>
                    <button type="button" class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal" aria-label="Fechar">
                        <i class="ki-duotone ki-cross fs-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="mb-5">
                    <input type="text" id="templateSearch" class="form-control form-control-solid" placeholder="Buscar template...">
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-row-dashed align-middle gs-0 gy-4">
                        <thead>
                            <tr class="fw-bold text-muted">
                                <th class="min-w-200px">Nome</th>
                                <th class="min-w-150px">Categoria</th>
                                <th class="text-end min-w-100px">AçÁes</th>
                            </tr>
                        </thead>
                        <tbody id="templatesList">
                            <tr>
                                <td colspan="3" class="text-center text-muted py-10">
                                    <i class="ki-duotone ki-loader fs-3x mb-3">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    <div>Carregando templates...</div>
                                        </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Trocar Número de Envio -->
<div class="modal fade" id="kt_modal_change_account" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-450px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Trocar Número de Envio</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-5 py-3">
                    <div class="d-flex align-items-center">
                        <i class="ki-duotone ki-information-5 fs-2 text-info me-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <span class="fs-7">A próxima mensagem será enviada pelo número selecionado.</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Número atual:</label>
                    <div id="change-account-current" class="text-muted fs-7">-</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Selecione o novo número:</label>
                    <div id="change-account-list" class="border rounded" style="max-height: 250px; overflow-y: auto;">
                        <div class="text-muted p-3">Carregando...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmChangeAccount()">
                    <i class="ki-duotone ki-check fs-4 me-1"></i>
                    Confirmar Troca
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Mesclar Conversas -->
<div class="modal fade" id="kt_modal_merge_conversations" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-500px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Mesclar Conversas</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-5">
                    <div class="d-flex">
                        <i class="ki-duotone ki-information-5 fs-2 text-info me-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <div>
                            <strong>O que vai acontecer:</strong>
                            <ul class="mb-0 mt-2 ps-3">
                                <li>Mensagens serão movidas para esta conversa</li>
                                <li>Conversas duplicadas serão removidas</li>
                                <li>Histórico será unificado</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="mb-5">
                    <label class="form-label fw-bold">Conversas a mesclar:</label>
                    <div id="merge-conversations-list" class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                        <div class="text-muted">Carregando...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="executeMerge()">
                    <i class="ki-duotone ki-arrows-loop fs-4 me-1"></i>
                    Mesclar Conversas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Assistente IA -->
<div class="modal fade" id="kt_modal_ai_assistant" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-900px">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <div class="d-flex align-items-center">
                    <div class="symbol symbol-50px me-3">
                        <div class="symbol-label bg-light-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 30px; height: 30px;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="9" cy="9" r="1.5"></circle>
                                <circle cx="15" cy="9" r="1.5"></circle>
                                <path d="M9 15h6"></path>
                            </svg>
                        </div>
                    </div>
                    <div>
                        <h2 class="fw-bold mb-0">Assistente IA</h2>
                        <div class="text-muted fs-7" id="aiAgentInfo">
                            <span class="spinner-border spinner-border-sm text-primary me-2" role="status" style="width: 12px; height: 12px;"></span>
                            Carregando agente...
                        </div>
                    </div>
                </div>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body pt-5">
                <div id="aiAssistantLoading" class="text-center py-15 d-none">
                    <div class="mb-5">
                        <span class="spinner-border spinner-border-lg text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></span>
                    </div>
                    <div class="fw-semibold fs-5 mb-2">Carregando funcionalidades...</div>
                    <div class="text-muted">Aguarde enquanto preparamos o Assistente IA</div>
                </div>
                
                <div id="aiAssistantContent" class="d-none">
                    <!-- Funcionalidade: Gerar Resposta -->
                    <div class="card card-flush shadow-sm mb-7" id="aiFeatureGenerateResponse">
                        <div class="card-header border-0 pt-5">
                <div class="card-title">
                                <div class="d-flex align-items-center">
                                    <div class="symbol symbol-45px me-3">
                                        <div class="symbol-label bg-light-primary">
                                            <i class="ki-duotone ki-message-text text-primary fs-2x">
                            <span class="path1"></span>
                            <span class="path2"></span>
                                                <span class="path3"></span>
                        </i>
                    </div>
                </div>
                                    <div>
                                        <h3 class="fw-bold mb-1">Gerar Resposta</h3>
                                        <p class="text-muted fs-7 mb-0">Gera sugestÁes inteligentes baseadas no contexto da conversa</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-0">
                            <div class="row g-4 mb-6">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold mb-2">
                                        <i class="ki-duotone ki-notepad fs-6 text-muted me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                                        Tom da Resposta
                                    </label>
                                    <select id="aiResponseTone" class="form-select form-select-solid">
                                        <option value="professional">💼 Profissional</option>
                                        <option value="friendly">😊 Amigível</option>
                                        <option value="formal">👔 Formal</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold mb-2">
                                        <i class="ki-duotone ki-abstract-26 fs-6 text-muted me-1">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                            <span class="path3"></span>
                                            <span class="path4"></span>
                                        </i>
                                        Quantidade de SugestÁes
                                    </label>
                                    <select id="aiResponseCount" class="form-select form-select-solid">
                                        <option value="1">1 sugestão</option>
                                        <option value="2">2 sugestÁes</option>
                                        <option value="3" selected>3 sugestÁes</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="aiResponseResults" class="d-none">
                                <div class="separator separator-dashed my-6"></div>
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div class="d-flex align-items-center">
                                        <i class="ki-duotone ki-check-circle fs-2x text-success me-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                        <h4 class="fw-bold mb-0">SugestÁes Geradas</h4>
                                    </div>
                                    <button class="btn btn-sm btn-light-primary" onclick="loadAIResponseHistory()" title="Ver histórico">
                                        <i class="ki-duotone ki-time fs-5">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                        Histórico
                        </button>
                            </div>
                                <div id="aiResponseSuggestions" class="mb-4"></div>
                            </div>
                            
                            <!-- Histórico de Respostas -->
                            <div id="aiResponseHistory" class="d-none">
                                <div class="separator separator-dashed my-6"></div>
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4 class="fw-bold mb-0">
                                        <i class="ki-duotone ki-time fs-2x text-primary me-2">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                        Histórico de Respostas
                                    </h4>
                                    <button class="btn btn-sm btn-light" onclick="hideAIResponseHistory()">
                                        <i class="ki-duotone ki-cross fs-5">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                        Fechar
                                    </button>
                                </div>
                                <div id="aiResponseHistoryContent" class="mb-4">
                                    <div class="text-center py-10">
                                        <span class="spinner-border spinner-border-sm text-primary mb-3" role="status"></span>
                                        <div class="text-muted">Carregando histórico...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary w-100" onclick="generateAIResponse()" id="aiGenerateBtn">
                                <span class="indicator-label">
                                    <i class="ki-duotone ki-abstract-26 fs-2 me-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                        <span class="path4"></span>
                                    </i>
                                    Gerar Respostas
                                </span>
                                <span class="indicator-progress d-none">
                                    Gerando...
                                    <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                </span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Outras Funcionalidades -->
                    <div class="mb-5">
                        <h4 class="fw-bold mb-4">
                            <i class="ki-duotone ki-setting-3 fs-2 text-primary me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            Outras Funcionalidades
                        </h4>
                        <div class="row g-4" id="aiOtherFeatures">
                            <!-- Serí preenchido dinamicamente -->
                        </div>
                    </div>
                </div>
                
                <div id="aiAssistantError" class="alert alert-danger d-none">
                    <div class="d-flex align-items-center">
                        <i class="ki-duotone ki-information-5 fs-2x me-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <div>
                            <div class="fw-bold">Erro</div>
                            <div id="aiAssistantErrorMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Filtros Avançados de Busca de Mensagens -->
<div class="modal fade" id="kt_modal_message_search_filters" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-600px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Filtros de Busca</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <form id="messageSearchFiltersForm">
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Tipo de Mensagem:</label>
                        <select id="filterMessageType" class="form-select form-select-solid">
                            <option value="">Todos</option>
                            <option value="text">Texto</option>
                            <option value="image">Imagem</option>
                            <option value="video">Vídeo</option>
                            <option value="audio">üudio</option>
                            <option value="document">Documento</option>
                            <option value="location">Localização</option>
                            <option value="note">Nota Interna</option>
                        </select>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Remetente:</label>
                        <select id="filterSenderType" class="form-select form-select-solid">
                            <option value="">Todos</option>
                            <option value="contact">Contato</option>
                            <option value="agent">Agente</option>
                            <option value="ai">Agente de IA</option>
                        </select>
                    </div>
                    
                    <div class="mb-5" id="filterSenderIdContainer" style="display: none;">
                        <label class="form-label fw-semibold">Agente Específico:</label>
                        <select id="filterSenderId" class="form-select form-select-solid">
                            <option value="">Todos os agentes</option>
                            <?php 
                            $agents = \App\Models\User::getAgents();
                            foreach ($agents as $agent): 
                            ?>
                                <option value="<?= $agent['id'] ?>"><?= htmlspecialchars($agent['name']) ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Data Inicial:</label>
                        <input type="date" id="filterDateFrom" class="form-control form-control-solid">
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Data Final:</label>
                        <input type="date" id="filterDateTo" class="form-control form-control-solid">
                    </div>
                    
                    <div class="mb-5">
                        <div class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" id="filterHasAttachments" value="1">
                            <label class="form-check-label" for="filterHasAttachments">
                                Apenas mensagens com anexos
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-light" onclick="clearMessageSearchFilters()">Limpar</button>
                        <button type="button" class="btn btn-primary" onclick="applyMessageSearchFilters()">Aplicar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Variíveis Disponíveis -->
<div class="modal fade" id="kt_modal_variables" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Variíveis Disponíveis</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <div class="mb-5">
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="ki-duotone ki-information-5 fs-2x me-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <div>
                            <div class="fw-bold">Como usar variíveis</div>
                            <div class="fs-7">Clique em uma variível para inseri-la automaticamente no campo de mensagem. As variíveis serão substituídas pelos valores reais quando a mensagem for enviada.</div>
                        </div>
                    </div>
                </div>
                <div class="row g-3" id="variablesList">
                    <div class="col-12 text-center py-10">
                        <span class="spinner-border spinner-border-sm text-primary mb-3" role="status"></span>
                        <div class="text-muted">Carregando variíveis...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Gerenciar Templates Pessoais -->
<div class="modal fade" id="kt_modal_personal_templates" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-800px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">
                    <i class="ki-duotone ki-user fs-2x text-warning me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Meus Templates de Mensagens
                </h2>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-primary" onclick="showCreatePersonalTemplateModal()">
                        <i class="ki-duotone ki-plus fs-5">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Novo Template
                    </button>
                    <button type="button" class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal" aria-label="Fechar">
                        <i class="ki-duotone ki-cross fs-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="mb-5">
                    <input type="text" id="personalTemplateSearch" class="form-control form-control-solid" placeholder="Buscar meus templates...">
                </div>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-row-dashed align-middle gs-0 gy-4">
                        <thead>
                            <tr class="fw-bold text-muted">
                                <th class="min-w-200px">Nome</th>
                                <th class="min-w-150px">Categoria</th>
                                <th class="min-w-300px">Conteúdo</th>
                                <th class="text-end min-w-150px">AçÁes</th>
                            </tr>
                        </thead>
                        <tbody id="personalTemplatesList">
                            <tr>
                                <td colspan="4" class="text-center text-muted py-10">
                                    <span class="spinner-border spinner-border-sm text-primary mb-3" role="status"></span>
                                    <div>Carregando templates...</div>
                                        </td>
                                    </tr>
                            </tbody>
                        </table>
                    </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Criar/Editar Template Pessoal -->
<div class="modal fade" id="kt_modal_personal_template_form" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-700px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold" id="personalTemplateFormTitle">Novo Template Pessoal</h2>
                <button type="button" class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal" aria-label="Fechar">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </button>
            </div>
            <div class="modal-body">
                <form id="personalTemplateForm">
                    <input type="hidden" id="personalTemplateId" name="id">
                    <input type="hidden" name="is_personal" value="1">
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Nome do Template <span class="text-danger">*</span></label>
                        <input type="text" id="personalTemplateName" name="name" class="form-control form-control-solid" placeholder="Ex: Saudação Inicial" required>
                        <div class="form-text">Dì um nome descritivo para identificar este template facilmente.</div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Categoria</label>
                        <input type="text" id="personalTemplateCategory" name="category" class="form-control form-control-solid" placeholder="Ex: Saudação, Follow-up, Suporte">
                        <div class="form-text">Categoria opcional para organizar seus templates.</div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Descrição</label>
                        <textarea id="personalTemplateDescription" name="description" class="form-control form-control-solid" rows="2" placeholder="Descrição opcional do template"></textarea>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">
                            Conteúdo do Template <span class="text-danger">*</span>
                            <button type="button" class="btn btn-sm btn-light-primary ms-2" onclick="showVariablesModal()" title="Ver variíveis disponíveis">
                                <i class="ki-duotone ki-code fs-6">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                    <span class="path4"></span>
                                </i>
                                Variíveis
                            </button>
                        </label>
                        <textarea id="personalTemplateContent" name="content" class="form-control form-control-solid" rows="6" placeholder="Digite o conteúdo do template. Use {{variavel}} para variíveis dinâmicas." required></textarea>
                        <div class="form-text">
                            Use variíveis como <code>{{contact.name}}</code>, <code>{{agent.name}}</code>, <code>{{date}}</code>, etc.
                        </div>
                    </div>
                    
                    <div class="mb-5">
                        <div class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" id="personalTemplateActive" name="is_active" value="1" checked>
                            <label class="form-check-label" for="personalTemplateActive">
                                Template ativo
                            </label>
                        </div>
                        <div class="form-text">Templates inativos não aparecerão na lista de seleção.</div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="personalTemplateSubmitBtn">
                            <span class="indicator-label">Salvar Template</span>
                            <span class="indicator-progress d-none">
                                Salvando...
                                <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Atribuir Conversa -->
<div class="modal fade" id="kt_modal_assign" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-500px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Atribuir Conversa</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <form id="assignForm">
                    <div class="mb-5">
                                    <label class="form-label fw-semibold">Agente:</label>
                        <select id="assignAgent" class="form-select form-select-solid" required>
                            <option value="">Selecione um agente...</option>
                            <option value="0">Deixar sem atribuição</option>
                            <?php if (!empty($agents)): ?>
                                        <?php foreach ($agents as $agent): ?>
                                    <option value="<?= $agent['id'] ?>">
                                                <?= htmlspecialchars($agent['name']) ?>
                                        <?php if (!empty($agent['email'])): ?>
                                            (<?= htmlspecialchars($agent['email']) ?>)
                <?php endif; ?>
                                            </option>
                                        <?php endforeach; ?>
                            <?php endif; ?>
                                    </select>
                                </div>
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Setor (opcional):</label>
                        <select id="assignDepartment" class="form-select form-select-solid">
                            <option value="">Manter setor atual</option>
                                <?php if (!empty($departments)): ?>
                                        <?php foreach ($departments as $dept): ?>
                                    <option value="<?= $dept['id'] ?>">
                                                <?= htmlspecialchars($dept['name']) ?>
                                            </option>
                                        <?php endforeach; ?>
                            <?php endif; ?>
                                    </select>
                                </div>
                    
                    <!-- Campo de Nota Interna para o próximo agente -->
                    <div class="mb-5">
                        <label class="form-label fw-semibold">
                            <i class="ki-duotone ki-message-notif fs-5 me-1 text-warning">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                            </i>
                            Nota para o próximo agente (opcional):
                        </label>
                        <textarea 
                            id="assignInternalNote" 
                            class="form-control form-control-solid" 
                            rows="3" 
                            placeholder="Ex: Cliente precisa de informações sobre o produto X, já foi enviado orçamento..."
                        ></textarea>
                        <div class="form-text text-muted">
                            <i class="ki-duotone ki-eye-slash fs-7 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                            Esta nota será visível apenas para agentes (não será enviada ao cliente)
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Atribuir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Escalar de IA para Humano -->
<div class="modal fade" id="kt_modal_escalate" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-500px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Escalar para Agente Humano</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <div class="alert alert-info d-flex align-items-center p-5 mb-5">
                    <i class="ki-duotone ki-information fs-2hx text-info me-4">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <div class="d-flex flex-column">
                        <h4 class="mb-1">Escalação de IA</h4>
                        <span>Esta conversa será transferida de um agente de IA para um agente humano. Você pode escolher um agente específico ou deixar o sistema atribuir automaticamente.</span>
                    </div>
                </div>
                <form id="escalateForm">
                    <input type="hidden" id="escalateConversationId" value="">
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Agente (opcional):</label>
                        <select id="escalateAgent" class="form-select form-select-solid">
                            <option value="">Atribuir automaticamente</option>
                            <?php if (!empty($agents)): ?>
                                <?php foreach ($agents as $agent): ?>
                                    <option value="<?= $agent['id'] ?>">
                                        <?= htmlspecialchars($agent['name']) ?>
                                        <?php if (!empty($agent['email'])): ?>
                                            (<?= htmlspecialchars($agent['email']) ?>)
                                <?php endif; ?>
                                            </option>
                                        <?php endforeach; ?>
                            <?php endif; ?>
                                    </select>
                        <div class="form-text">Deixe em branco para atribuição automítica baseada em disponibilidade e carga de trabalho.</div>
                                </div>
                                <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="ki-duotone ki-arrow-up fs-5 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Escalar Agora
                        </button>
                                </div>
                </form>
                            </div>
                        </div>
                    </div>
                </div>

<!-- MODAL: Mudar Setor -->
<div class="modal fade" id="kt_modal_change_department" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-500px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Mudar Setor</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <form id="changeDepartmentForm">
                    <input type="hidden" id="changeDepartmentConversationId" value="">
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Setor:</label>
                        <select id="changeDepartmentSelect" class="form-select form-select-solid">
                            <option value="">Sem setor</option>
                            <?php if (!empty($departments)): ?>
                                <?php foreach ($departments as $dept): ?>
                                    <option value="<?= $dept['id'] ?>">
                                        <?= htmlspecialchars($dept['name']) ?>
                                    </option>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </select>
                        <div class="form-text">Selecione um setor para esta conversa ou deixe "Sem setor" para remover.</div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="ki-duotone ki-check fs-5 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Gerenciar Tags -->
<div class="modal fade" id="kt_modal_tags" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Gerenciar Tags</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
            </div>
            </div>
            <div class="modal-body">
                <div class="mb-5">
                    <input type="text" id="tagSearch" class="form-control form-control-solid" placeholder="Buscar tag...">
                </div>
                <div class="d-flex flex-wrap gap-2 mb-5" id="currentTags">
                    <!-- Tags atuais serão inseridas aqui -->
                </div>
                <div class="separator my-5"></div>
                <div class="mb-5">
                    <label class="form-label fw-semibold">Tags Disponíveis:</label>
                    <div class="d-flex flex-wrap gap-2" id="availableTags">
                        <!-- Tags disponíveis serão inseridas aqui -->
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="saveTags()">Salvar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Gerenciar Agentes do Contato -->
<div class="modal fade" id="kt_modal_contact_agents" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-600px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Gerenciar Agentes do Contato</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <div class="alert alert-info d-flex align-items-start p-4 mb-5">
                    <i class="ki-duotone ki-information-5 fs-2x me-3">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <div>
                        <div class="fw-semibold mb-1">Atribuição Automítica</div>
                        <div class="fs-7">Quando uma conversa fechada for reaberta ou o contato chamar novamente após ter conversa fechada, será atribuído automaticamente ao agente principal.</div>
                    </div>
                </div>
                
                <input type="hidden" id="contactAgentsModalContactId" value="">
                
                <div class="mb-5">
                    <label class="form-label fw-semibold mb-3">Agentes Atribuídos:</label>
                    <div id="contactAgentsList" class="border rounded p-3" style="min-height: 100px; max-height: 300px; overflow-y: auto;">
                        <div class="text-muted fs-7 text-center py-3">Carregando...</div>
                    </div>
                </div>
                
                <div class="separator my-5"></div>
                
                <div class="mb-5">
                    <label class="form-label fw-semibold mb-3">Adicionar Novo Agente:</label>
                    <div class="d-flex gap-2">
                        <select id="addContactAgentSelect" class="form-select form-select-solid flex-grow-1">
                            <option value="">Selecione um agente...</option>
                            <?php if (!empty($agents)): ?>
                                <?php foreach ($agents as $agent): ?>
                                    <option value="<?= $agent['id'] ?>">
                                        <?= htmlspecialchars($agent['name']) ?>
                                        <?php if (!empty($agent['email'])): ?>
                                            (<?= htmlspecialchars($agent['email']) ?>)
                                        <?php endif; ?>
                                    </option>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="addContactAgentFromModal()">
                            <i class="ki-duotone ki-plus fs-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            Adicionar
                        </button>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="addAsPrimaryAgent" value="1">
                        <label class="form-check-label" for="addAsPrimaryAgent">
                            Definir como agente principal
                        </label>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Editar Contato Inline -->
<div class="modal fade" id="kt_modal_edit_contact" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-600px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Editar Contato</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <form id="editContactForm" novalidate>
                    <input type="hidden" id="editContactId" value="">
                    
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold required">Nome</label>
                            <input type="text" class="form-control form-control-solid" id="editContactName" name="name" required>
                            <div class="invalid-feedback">Por favor, informe o nome do contato.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Sobrenome</label>
                            <input type="text" class="form-control form-control-solid" id="editContactLastName" name="last_name">
                        </div>
                    </div>
                    
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Email</label>
                            <input type="text" class="form-control form-control-solid" id="editContactEmail" name="email">
                            <div class="form-text text-muted">Opcional - informe se disponível</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                Telefone
                                <i class="ki-duotone ki-information-3 fs-7 ms-1" title="O telefone não pode ser alterado">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                            </label>
                            <input type="text" class="form-control form-control-solid bg-light" id="editContactPhone" name="phone" placeholder="Ex: 5511999999999" readonly>
                            <div class="form-text text-muted">O telefone não pode ser alterado</div>
                        </div>
                    </div>
                    
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Cidade</label>
                            <input type="text" class="form-control form-control-solid" id="editContactCity" name="city">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">País</label>
                            <input type="text" class="form-control form-control-solid" id="editContactCountry" name="country">
                        </div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Empresa</label>
                        <input type="text" class="form-control form-control-solid" id="editContactCompany" name="company">
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Bio</label>
                        <textarea class="form-control form-control-solid" id="editContactBio" name="bio" rows="3" placeholder="InformaçÁes adicionais sobre o contato..."></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="ki-duotone ki-check fs-5 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Salvar AlteraçÁes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Lightbox de Imagem -->
<div class="modal fade" id="kt_modal_image_lightbox" tabindex="-1" aria-hidden="true" style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: 90vw;">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-header border-0 pb-2" style="background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-radius: 8px 8px 0 0;">
                <h5 class="modal-title text-white" id="kt_lightbox_image_title">Imagem</h5>
                <button type="button" class="btn btn-icon btn-sm btn-light" data-bs-dismiss="modal" aria-label="Fechar">
                    <i class="ki-duotone ki-cross fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </button>
            </div>
            <div class="modal-body text-center p-3" style="background: rgba(0,0,0,0.9); min-height: 400px; display: flex; align-items: center; justify-content: center;">
                <img id="kt_lightbox_image_src" src="" alt="Imagem" class="img-fluid rounded" style="max-height: 80vh; max-width: 100%; object-fit: contain; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
            </div>
            <div class="modal-footer border-0 pt-2" style="background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-radius: 0 0 8px 8px; justify-content: center;">
                <a id="kt_lightbox_download_btn" href="" download class="btn btn-light">
                    <i class="ki-duotone ki-download fs-3 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Baixar Imagem
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-3 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Lightbox backdrop escuro */
#kt_modal_image_lightbox.modal {
    background-color: rgba(0, 0, 0, 0.92) !important;
    z-index: 99999 !important; /* Garantir que fique acima do header */
}

#kt_modal_image_lightbox .modal-dialog {
    z-index: 100000 !important;
}

#kt_modal_image_lightbox .modal-backdrop {
    background-color: rgba(0, 0, 0, 0.95) !important;
    z-index: 99998 !important;
}

/* Animação suave para a imagem */
#kt_lightbox_image_src {
    transition: all 0.3s ease-in-out;
    cursor: zoom-in;
}

#kt_lightbox_image_src:hover {
    transform: scale(1.02);
}

/* Ajuste para modo escuro */
[data-bs-theme="dark"] #kt_modal_image_lightbox .modal-header,
[data-bs-theme="dark"] #kt_modal_image_lightbox .modal-footer {
    background: rgba(20,20,20,0.85) !important;
}
</style>

<!-- MODAL: Gerenciar Participantes -->
<div class="modal fade" id="kt_modal_participants" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Gerenciar Participantes</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </div>
                                                </div>
            <div class="modal-body">
                <div class="mb-5" id="currentParticipants">
                    <!-- Participantes atuais serão inseridos aqui -->
                                                        </div>
                <div class="separator my-5"></div>
                <div class="mb-5">
                    <label class="form-label fw-semibold mb-2">Adicionar Agente:</label>
                    <div class="d-flex gap-2">
                        <select id="participantUserSelect" class="form-select form-select-solid flex-grow-1">
                            <option value="">Selecione um agente...</option>
                        </select>
                        <button type="button" class="btn btn-primary" id="addParticipantBtn" onclick="sendParticipantInvite()">
                            <i class="ki-duotone ki-user-plus fs-5 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Adicionar
                        </button>
                    </div>
                    <div class="form-text text-muted mt-2">
                        <i class="ki-duotone ki-information-3 fs-7 me-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        O agente será adicionado imediatamente como participante da conversa.
                    </div>
                </div>
                
                <!-- Convites Pendentes (modal antigo - não usado) -->
                <div class="mb-5" id="pendingInvitesSection" style="display: none;">
                    <label class="form-label fw-semibold mb-2 text-warning">
                        <i class="ki-duotone ki-timer fs-6 me-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        Convites Pendentes:
                    </label>
                    <div id="pendingInvitesListOld"></div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Agendar Mensagem -->
<div class="modal fade" id="kt_modal_schedule_message" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Agendar Mensagem</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <form id="scheduleMessageForm">
                    <input type="hidden" id="schedule_conversation_id" name="conversation_id">
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Mensagem:</label>
                        <textarea class="form-control form-control-solid" id="schedule_message_content" name="content" rows="5" placeholder="Digite sua mensagem aqui..."></textarea>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Anexar arquivo (opcional):</label>
                        <input type="file" class="form-control form-control-solid" id="schedule_message_attachment" name="attachment" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt">
                        <div class="form-text">Você pode anexar imagens, vídeos, áudios ou documentos</div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Data e Hora:</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" class="form-control form-control-solid" id="schedule_message_date" name="date" required>
                            </div>
                            <div class="col-6">
                                <input type="time" class="form-control form-control-solid" id="schedule_message_time" name="time" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-3">OpçÁes:</label>
                        <div class="form-check form-check-custom form-check-solid mb-2">
                            <input class="form-check-input" type="checkbox" id="schedule_cancel_if_resolved" name="cancel_if_resolved">
                            <label class="form-check-label" for="schedule_cancel_if_resolved">
                                Cancelar se conversa foi resolvida
                            </label>
                        </div>
                        <div class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" id="schedule_cancel_if_responded" name="cancel_if_responded">
                            <label class="form-check-label" for="schedule_cancel_if_responded">
                                Cancelar se já foi respondida
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Ver Mensagens Agendadas -->
<div class="modal fade" id="kt_modal_scheduled_messages" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-800px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Mensagens Agendadas</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <!-- Filtros -->
                <div class="mb-5">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="scheduled_status_filter" id="filter_all" value="" checked>
                        <label class="btn btn-sm btn-outline btn-outline-dashed btn-active-light-primary" for="filter_all">Todas</label>
                        
                        <input type="radio" class="btn-check" name="scheduled_status_filter" id="filter_pending" value="pending">
                        <label class="btn btn-sm btn-outline btn-outline-dashed btn-active-light-warning" for="filter_pending">Pendentes</label>
                        
                        <input type="radio" class="btn-check" name="scheduled_status_filter" id="filter_sent" value="sent">
                        <label class="btn btn-sm btn-outline btn-outline-dashed btn-active-light-success" for="filter_sent">Enviadas</label>
                        
                        <input type="radio" class="btn-check" name="scheduled_status_filter" id="filter_cancelled" value="cancelled">
                        <label class="btn btn-sm btn-outline btn-outline-dashed btn-active-light-danger" for="filter_cancelled">Canceladas</label>
                        
                        <input type="radio" class="btn-check" name="scheduled_status_filter" id="filter_failed" value="failed">
                        <label class="btn btn-sm btn-outline btn-outline-dashed btn-active-light-dark" for="filter_failed">Falhadas</label>
                    </div>
                </div>
                
                <!-- Lista de mensagens -->
                <div id="scheduledMessagesList" style="max-height: 500px; overflow-y: auto;">
                    <div class="text-center py-10">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Agendar Lembrete -->
<div class="modal fade" id="kt_modal_reminder" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-500px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Agendar Lembrete</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <form id="reminderForm">
                    <input type="hidden" id="reminder_conversation_id" name="conversation_id">
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Data e Hora do Lembrete:</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" class="form-control form-control-solid" id="reminder_date" name="date" required>
                            </div>
                            <div class="col-6">
                                <input type="time" class="form-control form-control-solid" id="reminder_time" name="time" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Nota (opcional):</label>
                        <textarea class="form-control form-control-solid" id="reminder_note" name="note" rows="3" placeholder="Ex: Verificar se cliente respondeu"></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Criar Lembrete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Nova Conversa -->
<div class="modal fade" id="kt_modal_new_conversation" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Nova Conversa</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <form id="newConversationForm">
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Canal:</label>
                        <select class="form-select form-select-solid" id="new_conversation_channel" name="channel" required>
                            <option value="">Selecione um canal...</option>
                            <option value="whatsapp" selected>WhatsApp</option>
                            <option value="whatsapp_official">WhatsApp Oficial</option>
                            <option value="instagram">Instagram</option>
                            <option value="facebook">Facebook</option>
                            <option value="tiktok">TikTok</option>
                            <option value="telegram">Telegram</option>
                            <option value="email">Email</option>
                            <option value="chat">Chat</option>
                            <option value="mercadolivre">Mercado Livre</option>
                            <option value="webchat">WebChat</option>
                            <option value="olx">OLX</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="google_business">Google Business</option>
                            <option value="youtube">YouTube</option>
                        </select>
                        <div class="form-text">Selecione o canal para envio da mensagem</div>
                    </div>
                    
                    <div class="mb-5" id="new_conversation_whatsapp_account_container">
                        <label class="form-label fw-semibold mb-2">Integração WhatsApp:</label>
                        <select class="form-select form-select-solid" id="new_conversation_whatsapp_account" name="whatsapp_account_id">
                            <option value="">Selecione uma integração...</option>
                            <?php 
                            $whatsappAccounts = $whatsappAccounts ?? \App\Models\IntegrationAccount::getActiveWhatsApp();
                            if (empty($whatsappAccounts)): ?>
                                <option value="" disabled>Nenhuma integração WhatsApp ativa encontrada</option>
                            <?php else: ?>
                                <?php foreach ($whatsappAccounts as $account): ?>
                                    <option value="<?= $account['id'] ?>">
                                        <?= htmlspecialchars($account['name']) ?> 
                                        (<?= htmlspecialchars($account['phone_number']) ?>)
                                    </option>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </select>
                        <div class="form-text">Selecione qual conta WhatsApp utilizar para envio</div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Funil:</label>
                        <select class="form-select form-select-solid" id="new_conversation_funnel" name="funnel_id">
                            <option value="">Selecione um funil...</option>
                            <?php if (empty($funnelsForNewConversation)): ?>
                                <option value="" disabled>Nenhum funil disponível para você</option>
                            <?php else: ?>
                                <?php foreach ($funnelsForNewConversation as $funnel): ?>
                                    <option value="<?= $funnel['id'] ?>">
                                        <?= htmlspecialchars($funnel['name'] ?? 'Funil sem nome') ?>
                                    </option>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </select>
                        <div class="form-text">Opcional: escolha o funil (apenas os que você tem permissão)</div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Etapa:</label>
                        <select class="form-select form-select-solid" id="new_conversation_stage" name="stage_id" disabled>
                            <option value="">Selecione um funil primeiro</option>
                        </select>
                        <div class="form-text">Opcional: etapas disponíveis no funil selecionado</div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Nome do Contato:</label>
                        <input type="text" class="form-control form-control-solid" id="new_contact_name" name="name" placeholder="Nome completo" required>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Telefone:</label>
                        <div class="input-group">
                            <span class="input-group-text">+55</span>
                            <input type="text" class="form-control form-control-solid" id="new_contact_phone" name="phone" placeholder="DDD + Número (ex: 11 98765-4321)" maxlength="20" required>
                        </div>
                        <div class="form-text">Digite apenas DDD e número (ex: 11987654321)</div>
                    </div>
                    
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Mensagem:</label>
                        <textarea class="form-control form-control-solid" id="new_conversation_message" name="message" rows="4" placeholder="Digite sua mensagem aqui..." required></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="indicator-label">Enviar Mensagem</span>
                            <span class="indicator-progress">Enviando...
                                <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Filtros Avançados -->
<div class="modal fade" id="kt_modal_advanced_filters" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-700px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Filtros Avançados</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="advancedFiltersForm">
                    <!-- Canais (Multi-select) -->
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Canais:</label>
                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background: var(--bs-gray-100);">
                            <?php
                            $selectedChannels = is_array($filters['channels'] ?? null) ? $filters['channels'] : [];
                            $legacyChannel = $filters['channel'] ?? '';
                            
                            // Canais disponíveis com ícones SVG oficiais
                            $availableChannels = [
                                'whatsapp' => ['icon' => getChannelIconSvg('whatsapp', 18), 'name' => 'WhatsApp'],
                                'whatsapp_official' => ['icon' => getChannelIconSvg('whatsapp_official', 18), 'name' => 'WhatsApp Oficial'],
                                'instagram' => ['icon' => getChannelIconSvg('instagram', 18), 'name' => 'Instagram'],
                                'instagram_comment' => ['icon' => getChannelIconSvg('instagram_comment', 18), 'name' => 'Instagram Comentário'],
                                'facebook' => ['icon' => getChannelIconSvg('facebook', 18), 'name' => 'Facebook'],
                                'tiktok' => ['icon' => getChannelIconSvg('tiktok', 18), 'name' => 'TikTok'],
                                'telegram' => ['icon' => getChannelIconSvg('telegram', 18), 'name' => 'Telegram'],
                                'email' => ['icon' => getChannelIconSvg('email', 18), 'name' => 'Email'],
                                'chat' => ['icon' => getChannelIconSvg('chat', 18), 'name' => 'Chat'],
                                'mercadolivre' => ['icon' => getChannelIconSvg('mercadolivre', 18), 'name' => 'Mercado Livre'],
                                'webchat' => ['icon' => getChannelIconSvg('webchat', 18), 'name' => 'WebChat'],
                                'olx' => ['icon' => getChannelIconSvg('olx', 18), 'name' => 'OLX'],
                                'linkedin' => ['icon' => getChannelIconSvg('linkedin', 18), 'name' => 'LinkedIn'],
                                'google_business' => ['icon' => getChannelIconSvg('google_business', 18), 'name' => 'Google Business'],
                                'youtube' => ['icon' => getChannelIconSvg('youtube', 18), 'name' => 'YouTube']
                            ];
                            
                            foreach ($availableChannels as $channelValue => $channelInfo):
                                $isChecked = in_array($channelValue, $selectedChannels) || $legacyChannel === $channelValue;
                            ?>
                                <label class="form-check form-check-custom form-check-solid mb-2">
                                    <input class="form-check-input" type="checkbox" name="channels[]" value="<?= $channelValue ?>" id="filter_channel_<?= $channelValue ?>" <?= $isChecked ? 'checked' : '' ?>>
                                    <span class="form-check-label"><?= $channelInfo['icon'] ?> <?= htmlspecialchars($channelInfo['name']) ?></span>
                                </label>
                            <?php endforeach; ?>
                        </div>
                        <div class="form-text">Selecione um ou mais canais</div>
                    </div>
                    
                    <!-- IntegraçÁes WhatsApp (mostrar apenas se WhatsApp selecionado) -->
                    <div class="mb-5" id="whatsapp_accounts_filter" style="display: none;">
                        <label class="form-label fw-semibold mb-2">IntegraçÁes WhatsApp:</label>
                        <div class="border rounded p-3" style="max-height: 150px; overflow-y: auto; background: var(--bs-gray-100);">
                            <?php 
                            $whatsappAccounts = \App\Models\IntegrationAccount::getActiveWhatsApp();
                            $selectedAccounts = [];
                            if (isset($filters['whatsapp_account_ids']) && is_array($filters['whatsapp_account_ids'])) {
                                $selectedAccounts = $filters['whatsapp_account_ids'];
                            } elseif (!empty($filters['whatsapp_account_id'])) {
                                $selectedAccounts = [(int)$filters['whatsapp_account_id']];
                            }
                            if (empty($whatsappAccounts)): ?>
                                <div class="text-muted fs-7">Nenhuma integração WhatsApp cadastrada</div>
                                            <?php else: ?>
                                <?php foreach ($whatsappAccounts as $account): ?>
                                    <label class="form-check form-check-custom form-check-solid mb-2">
                                        <input class="form-check-input" type="checkbox" name="whatsapp_account_ids[]" value="<?= $account['id'] ?>" <?= in_array($account['id'], $selectedAccounts) ? 'checked' : '' ?>>
                                        <span class="form-check-label">
                                            <?= htmlspecialchars($account['name']) ?> 
                                            <span class="text-muted fs-7">(<?= htmlspecialchars($account['phone_number']) ?>)</span>
                                        </span>
                                    </label>
                                <?php endforeach; ?>
                                            <?php endif; ?>
                        </div>
                        <div class="form-text">Filtrar por número/integração específica do WhatsApp</div>
                    </div>
                    
                    <!-- Tags (Multi-select) -->
                    <?php if (!empty($tags)): ?>
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Tags:</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: var(--bs-gray-100);">
                            <?php 
                            $selectedTags = [];
                            if (isset($filters['tag_ids']) && is_array($filters['tag_ids'])) {
                                $selectedTags = $filters['tag_ids'];
                            } elseif (!empty($filters['tag_id'])) {
                                $selectedTags = [(int)$filters['tag_id']];
                            }
                            foreach ($tags as $tag): ?>
                                <label class="form-check form-check-custom form-check-solid mb-2">
                                    <input class="form-check-input" type="checkbox" name="tag_ids[]" value="<?= $tag['id'] ?>" <?= in_array($tag['id'], $selectedTags) ? 'checked' : '' ?>>
                                    <span class="form-check-label">
                                        <span class="badge badge-sm" style="background-color: <?= htmlspecialchars($tag['color'] ?? '#009ef7') ?>20; color: <?= htmlspecialchars($tag['color'] ?? '#009ef7') ?>;">
                                            <?= htmlspecialchars($tag['name']) ?>
                                        </span>
                                    </span>
                                </label>
                                <?php endforeach; ?>
                    </div>
                        <div class="form-text">Selecione uma ou mais tags</div>
                    </div>
                <?php endif; ?>
                    
                    <!-- Agentes (Multi-select) -->
                    <?php 
                    $canViewAllConversations = \App\Helpers\Permission::can('conversations.view.all');
                    $currentUserId = \App\Helpers\Auth::id();
                    ?>
                    <?php if ($canViewAllConversations || !empty($agents)): ?>
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Agentes Atribuídos:</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: var(--bs-gray-100);">
                            <?php 
                            $selectedAgents = [];
                            if (isset($filters['agent_ids']) && is_array($filters['agent_ids'])) {
                                $selectedAgents = $filters['agent_ids'];
                            } elseif (!empty($filters['agent_id']) && $filters['agent_id'] !== 'unassigned') {
                                $selectedAgents = [(int)$filters['agent_id']];
                            }
                            
                            // Opção para não atribuídas
                            ?>
                            <label class="form-check form-check-custom form-check-solid mb-2">
                                <input class="form-check-input" type="checkbox" name="agent_ids[]" value="unassigned" <?= (!empty($filters['agent_id']) && $filters['agent_id'] === 'unassigned') || in_array('unassigned', $selectedAgents) ? 'checked' : '' ?>>
                                <span class="form-check-label">🔴 Não atribuídas</span>
                            </label>
                            
                            <?php if ($canViewAllConversations && !empty($agents)): ?>
                                <?php foreach ($agents as $agent): ?>
                                    <label class="form-check form-check-custom form-check-solid mb-2">
                                        <input class="form-check-input" type="checkbox" name="agent_ids[]" value="<?= $agent['id'] ?>" <?= in_array($agent['id'], $selectedAgents) ? 'checked' : '' ?>>
                                        <span class="form-check-label">
                                            <?= htmlspecialchars($agent['name']) ?>
                                            <?php if (!empty($agent['email'])): ?>
                                                <span class="text-muted fs-7">(<?= htmlspecialchars($agent['email']) ?>)</span>
                                            <?php endif; ?>
                                        </span>
                                    </label>
                                <?php endforeach; ?>
                            <?php elseif (!$canViewAllConversations && $currentUserId): ?>
                                <?php 
                                $currentUser = \App\Models\User::find($currentUserId);
                                if ($currentUser): ?>
                                    <label class="form-check form-check-custom form-check-solid mb-2">
                                        <input class="form-check-input" type="checkbox" name="agent_ids[]" value="<?= $currentUser['id'] ?>" <?= in_array($currentUser['id'], $selectedAgents) ? 'checked' : '' ?>>
                                        <span class="form-check-label">Minhas conversas</span>
                                    </label>
                                <?php endif; ?>
                            <?php endif; ?>
                        </div>
                        <div class="form-text">Selecione um ou mais agentes</div>
                    </div>
                    <?php endif; ?>
                    
                    <!-- Funis (Multi-select) -->
                    <?php 
                    $allFunnels = \App\Models\Funnel::whereActive();
                    $selectedFunnels = [];
                    if (isset($filters['funnel_ids']) && is_array($filters['funnel_ids'])) {
                        $selectedFunnels = array_map('intval', $filters['funnel_ids']);
                    } elseif (!empty($filters['funnel_id'])) {
                        $selectedFunnels = [(int)$filters['funnel_id']];
                    }
                    ?>
                    <?php if (!empty($allFunnels)): ?>
                    <div class="mb-5">
                        <label class="form-label fw-semibold mb-2">Funis:</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: var(--bs-gray-100);">
                            <?php foreach ($allFunnels as $funnel): ?>
                                <label class="form-check form-check-custom form-check-solid mb-2">
                                    <input class="form-check-input" type="checkbox" name="funnel_ids[]" value="<?= $funnel['id'] ?>" id="filter_funnel_<?= $funnel['id'] ?>" <?= in_array($funnel['id'], $selectedFunnels) ? 'checked' : '' ?>>
                                    <span class="form-check-label">
                                        <?= htmlspecialchars($funnel['name']) ?>
                                        <?php if (!empty($funnel['description'])): ?>
                                            <span class="text-muted fs-7">(<?= htmlspecialchars($funnel['description']) ?>)</span>
                                        <?php endif; ?>
                                    </span>
                                </label>
                            <?php endforeach; ?>
                        </div>
                        <div class="form-text">Selecione um ou mais funis</div>
                    </div>
                    <?php endif; ?>
                    
                    <!-- Etapas (Multi-select) -->
                    <?php 
                    $allStages = [];
                    if (!empty($selectedFunnels)) {
                        // Carregar etapas dos funis selecionados
                        foreach ($selectedFunnels as $funnelId) {
                            $stages = \App\Models\Funnel::getStages($funnelId);
                            foreach ($stages as $stage) {
                                $allStages[] = $stage;
                            }
                        }
                    } else {
                        // Se nenhum funil selecionado, carregar todas as etapas de todos os funis ativos
                        foreach ($allFunnels as $funnel) {
                            $stages = \App\Models\Funnel::getStages($funnel['id']);
                            foreach ($stages as $stage) {
                                $allStages[] = $stage;
                            }
                        }
                    }
                    
                    $selectedStages = [];
                    if (isset($filters['funnel_stage_ids']) && is_array($filters['funnel_stage_ids'])) {
                        $selectedStages = array_map('intval', $filters['funnel_stage_ids']);
                    } elseif (!empty($filters['funnel_stage_id'])) {
                        $selectedStages = [(int)$filters['funnel_stage_id']];
                    }
                    ?>
                    <?php if (!empty($allStages)): ?>
                    <div class="mb-5" id="stages_filter_container">
                        <label class="form-label fw-semibold mb-2">Etapas:</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: var(--bs-gray-100);">
                            <?php 
                            // Agrupar etapas por funil para melhor organização
                            $stagesByFunnel = [];
                            foreach ($allStages as $stage) {
                                $funnelId = $stage['funnel_id'];
                                if (!isset($stagesByFunnel[$funnelId])) {
                                    $funnel = \App\Models\Funnel::find($funnelId);
                                    $stagesByFunnel[$funnelId] = [
                                        'funnel_name' => $funnel ? $funnel['name'] : 'Funil #' . $funnelId,
                                        'stages' => []
                                    ];
                                }
                                $stagesByFunnel[$funnelId]['stages'][] = $stage;
                            }
                            
                            foreach ($stagesByFunnel as $funnelId => $funnelData): ?>
                                <div class="mb-3">
                                    <div class="fw-semibold fs-7 text-muted mb-1"><?= htmlspecialchars($funnelData['funnel_name']) ?>:</div>
                                    <?php foreach ($funnelData['stages'] as $stage): ?>
                                        <label class="form-check form-check-custom form-check-solid mb-2 ms-3">
                                            <input class="form-check-input" type="checkbox" name="funnel_stage_ids[]" value="<?= $stage['id'] ?>" id="filter_stage_<?= $stage['id'] ?>" <?= in_array($stage['id'], $selectedStages) ? 'checked' : '' ?>>
                                            <span class="form-check-label">
                                                <?php if (!empty($stage['color'])): ?>
                                                    <span class="badge badge-sm" style="background-color: <?= htmlspecialchars($stage['color']) ?>20; color: <?= htmlspecialchars($stage['color']) ?>;">
                                                        <?= htmlspecialchars($stage['name']) ?>
                                                    </span>
                                                <?php else: ?>
                                                    <?= htmlspecialchars($stage['name']) ?>
                                                <?php endif; ?>
                                            </span>
                                        </label>
                                    <?php endforeach; ?>
                                </div>
                            <?php endforeach; ?>
                        </div>
                        <div class="form-text">Selecione uma ou mais etapas</div>
                    </div>
                    <?php endif; ?>
                    
                    <!-- Status de Resposta -->
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Status de Resposta:</label>
                        <div class="d-flex gap-3">
                            <label class="form-check form-check-custom form-check-solid">
                                <input class="form-check-input" type="radio" name="response_status" value="" <?= empty($filters['unanswered']) && empty($filters['answered']) ? 'checked' : '' ?>>
                                <span class="form-check-label">Todas</span>
                            </label>
                            <label class="form-check form-check-custom form-check-solid">
                                <input class="form-check-input" type="radio" name="response_status" value="unanswered" <?= !empty($filters['unanswered']) ? 'checked' : '' ?>>
                                <span class="form-check-label">Sem Resposta</span>
                            </label>
                            <label class="form-check form-check-custom form-check-solid">
                                <input class="form-check-input" type="radio" name="response_status" value="answered" <?= !empty($filters['answered']) ? 'checked' : '' ?>>
                                <span class="form-check-label">Respondidas</span>
                            </label>
            </div>
        </div>
                    
                    <!-- Período -->
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Data Inicial:</label>
                            <input type="date" id="filter_date_from" name="date_from" class="form-control form-control-solid" value="<?= htmlspecialchars($filters['date_from'] ?? '') ?>">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Data Final:</label>
                            <input type="date" id="filter_date_to" name="date_to" class="form-control form-control-solid" value="<?= htmlspecialchars($filters['date_to'] ?? '') ?>">
                        </div>
                    </div>
                    
                    <!-- Fixadas -->
                    <div class="mb-5">
                        <label class="form-label fw-semibold">Conversas Fixadas:</label>
                        <div class="d-flex gap-3">
                            <label class="form-check form-check-custom form-check-solid">
                                <input class="form-check-input" type="radio" name="pinned" value="" <?= !isset($filters['pinned']) ? 'checked' : '' ?>>
                                <span class="form-check-label">Todas</span>
                            </label>
                            <label class="form-check form-check-custom form-check-solid">
                                <input class="form-check-input" type="radio" name="pinned" value="1" <?= isset($filters['pinned']) && $filters['pinned'] === true ? 'checked' : '' ?>>
                                <span class="form-check-label">Apenas Fixadas</span>
                            </label>
                            <label class="form-check form-check-custom form-check-solid">
                                <input class="form-check-input" type="radio" name="pinned" value="0" <?= isset($filters['pinned']) && $filters['pinned'] === false ? 'checked' : '' ?>>
                                <span class="form-check-label">Não Fixadas</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Ordenação -->
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Ordenar por:</label>
                            <select id="filter_order_by" name="order_by" class="form-select form-select-solid">
                                <option value="">Padrão (Atualização)</option>
                                <option value="last_message" <?= ($filters['order_by'] ?? '') === 'last_message' ? 'selected' : '' ?>>Última Mensagem</option>
                                <option value="created_at" <?= ($filters['order_by'] ?? '') === 'created_at' ? 'selected' : '' ?>>Data de Criação</option>
                                <option value="updated_at" <?= ($filters['order_by'] ?? '') === 'updated_at' ? 'selected' : '' ?>>Última Atualização</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Direção:</label>
                            <select id="filter_order_dir" name="order_dir" class="form-select form-select-solid">
                                <option value="DESC" <?= ($filters['order_dir'] ?? 'DESC') === 'DESC' ? 'selected' : '' ?>>Decrescente</option>
                                <option value="ASC" <?= ($filters['order_dir'] ?? '') === 'ASC' ? 'selected' : '' ?>>Crescente</option>
                            </select>
                        </div>
                    </div>
                </form>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-light me-3" onclick="clearAllFilters()">Limpar Tudo</button>
                    <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="applyAdvancedFilters()">Aplicar Filtros</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Mencionar/Convidar Agente -->
<div class="modal fade" id="kt_modal_mention_agent" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-500px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">
                    <i class="ki-duotone ki-user-tick fs-2 text-warning me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    Convidar Agente
                </h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body">
                <div class="mb-5">
                    <label class="form-label fw-semibold required">Selecione o Agente:</label>
                    <select id="mentionAgentSelect" class="form-select form-select-solid">
                        <option value="">Carregando agentes...</option>
                    </select>
                    <div class="form-text">O agente receberí um convite para participar desta conversa</div>
                </div>
                <div class="mb-5">
                    <label class="form-label fw-semibold">Nota/Contexto (opcional):</label>
                    <textarea id="mentionAgentNote" class="form-control form-control-solid" rows="3" 
                              placeholder="Ex: Preciso de ajuda têcnica com esta solicitação..."></textarea>
                    <div class="form-text">Esta nota será enviada junto com o convite</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="sendMentionInvite()">
                    <i class="ki-duotone ki-send fs-5 me-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Enviar Convite
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Convites e Solicitações Pendentes -->
<div class="modal fade" id="kt_modal_pending_invites" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">
                    <i class="ki-duotone ki-notification-on fs-2 text-primary me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                        <span class="path5"></span>
                    </i>
                    Convites e Solicitações
                    <span id="pendingInvitesCountBadge" class="badge badge-circle badge-primary ms-2 d-none">0</span>
                </h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>
            <div class="modal-body p-0">
                <!-- Tabs para separar convites de solicitaçÁes -->
                <ul class="nav nav-tabs nav-line-tabs nav-line-tabs-2x border-transparent fs-6 fw-semibold mb-0 px-5 pt-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" data-bs-toggle="tab" href="#tab_invites" role="tab">
                            <i class="ki-duotone ki-entrance-left fs-4 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Convites para Você
                            <span id="invitesTabCount" class="badge badge-sm badge-primary ms-2 d-none">0</span>
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-bs-toggle="tab" href="#tab_requests" role="tab">
                            <i class="ki-duotone ki-entrance-right fs-4 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Solicitações de Participação
                            <span id="requestsTabCount" class="badge badge-sm badge-warning ms-2 d-none">0</span>
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Tab: Convites para Você -->
                    <div class="tab-pane fade show active p-5" id="tab_invites" role="tabpanel">
                        <div id="pendingInvitesList"></div>
                    </div>
                    
                    <!-- Tab: Solicitações de Participação -->
                    <div class="tab-pane fade p-5" id="tab_requests" role="tabpanel">
                        <div id="pendingRequestsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================
// FUNÇòES GLOBAIS - DEFINIR PRIMEIRO
// ============================================

// ============================================
// SISTEMA DE MENÇòES/CONVITES DE AGENTES
// ============================================

/**
 * Mostrar modal para mencionar/convidar agente
 */
function startApi4ComCall(conversationId) {
    if (!conversationId) {
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'ID da conversa não encontrado'
        });
        return;
    }
    
    // Verificar se o WebPhone está conectado (se estiver habilitado)
    const webphoneReady = window.api4comWebphone && window.api4comWebphone.isReady();
    const webphoneWidget = document.getElementById('api4com-webphone-widget');
    const webphoneEnabled = webphoneWidget && webphoneWidget.style.display !== 'none';
    
    if (webphoneEnabled && !webphoneReady) {
        Swal.fire({
            icon: 'warning',
            title: 'WebPhone Não Conectado',
            html: 'O WebPhone não está registrado no servidor SIP.<br><br>' +
                  'Clique no botão <strong>📞 WebPhone</strong> no canto inferior direito para conectar.<br><br>' +
                  '<small class="text-muted">Status atual: ' + (window.api4comWebphone?.getStatus() || 'não iniciado') + '</small>',
            confirmButtonText: 'Tentar Mesmo Assim',
            showCancelButton: true,
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                executeApi4ComCall(conversationId);
            }
        });
        return;
    }
    
    executeApi4ComCall(conversationId);
}

function executeApi4ComCall(conversationId) {
    // Expandir o painel do WebPhone ANTES de iniciar a chamada
    const webphonePanel = document.getElementById('webphone-panel');
    const webphoneToggle = document.getElementById('webphone-toggle');
    if (webphonePanel && webphoneToggle) {
        webphonePanel.style.display = 'block';
        webphoneToggle.style.display = 'none';
    }
    
    // Desabilitar botão durante a requisição
    const btn = document.getElementById('btnApi4ComCall');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    }
    
    fetch("<?= \App\Helpers\Url::to('/conversations') ?>/" + conversationId + "/api4com-call", {
        method: "POST",
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
    .then(data => {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="ki-duotone ki-phone fs-2"><span class="path1"></span><span class="path2"></span></i>';
        }
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Chamada Iniciada',
                html: 'Chamada iniciada! Aguarde a conexão...<br><small class="text-muted">O WebPhone irá atender automaticamente</small>',
                timer: 3000,
                showConfirmButton: false
            });
            
            // Expandir o painel do WebPhone se existir
            const webphonePanel = document.getElementById('webphone-panel');
            const webphoneToggle = document.getElementById('webphone-toggle');
            if (webphonePanel && webphoneToggle) {
                webphonePanel.style.display = 'block';
                webphoneToggle.style.display = 'none';
            }
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: data.message || 'Erro ao iniciar chamada'
            });
        }
    })
    .catch(error => {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="ki-duotone ki-phone fs-2"><span class="path1"></span><span class="path2"></span></i>';
        }
        
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao iniciar chamada: ' + error.message
        });
    });
}

function showMentionAgentModal() {
    const conversationId = window.currentConversationId;
    if (!conversationId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione uma conversa primeiro'
        });
        return;
    }
    
    const modal = document.getElementById('kt_modal_mention_agent');
    if (!modal) {
        console.error('Modal de menção não encontrado');
        return;
    }
    
    // Limpar campos
    document.getElementById('mentionAgentSelect').innerHTML = '<option value="">Carregando agentes...</option>';
    document.getElementById('mentionAgentNote').value = '';
    
    // Carregar agentes disponíveis
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/available-agents`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('mentionAgentSelect');
        if (data.success && data.agents && data.agents.length > 0) {
            let options = '<option value="">Selecione um agente...</option>';
            data.agents.forEach(agent => {
                options += `<option value="${agent.id}">${escapeHtml(agent.name)} ${agent.email ? '(' + escapeHtml(agent.email) + ')' : ''}</option>`;
            });
            select.innerHTML = options;
        } else {
            select.innerHTML = '<option value="">Nenhum agente disponível</option>';
        }
    })
    .catch(error => {
        console.error('Erro ao carregar agentes:', error);
        document.getElementById('mentionAgentSelect').innerHTML = '<option value="">Erro ao carregar agentes</option>';
    });
    
    // Abrir modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

/**
 * Enviar convite de menção
 */
function sendMentionInvite() {
    const conversationId = window.currentConversationId;
    const agentId = document.getElementById('mentionAgentSelect').value;
    const note = document.getElementById('mentionAgentNote').value.trim();
    
    if (!agentId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione um agente para convidar'
        });
        return;
    }
    
    // Mostrar loading
    Swal.fire({
        title: 'Enviando convite...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/mention`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            user_id: parseInt(agentId),
            note: note || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Convite Enviado!',
                text: 'O agente receberí uma notificação para participar da conversa.',
                timer: 3000,
                showConfirmButton: false
            });
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_mention_agent'));
            if (modal) modal.hide();
            
            // Atualizar sidebar se estiver aberto (para mostrar nova menção)
            if (typeof selectConversation === 'function') {
                selectConversation(conversationId);
            }
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: data.message || 'Erro ao enviar convite'
            });
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao enviar convite'
        });
    });
}

/**
 * Mostrar modal de convites pendentes
 */
function showPendingInvitesModal() {
    const modal = document.getElementById('kt_modal_pending_invites');
    if (!modal) {
        console.error('Modal de convites não encontrado');
        return;
    }
    
    // Carregar convites
    loadPendingInvites();
    
    // Abrir modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

/**
 * Carregar convites pendentes
 */
function loadPendingInvites() {
    const container = document.getElementById('pendingInvitesList');
    if (!container) {
        console.error('Container pendingInvitesList não encontrado');
        return;
    }
    
    container.innerHTML = `
        <div class="text-center py-10">
            <span class="spinner-border spinner-border-sm text-primary"></span>
            <span class="ms-2 text-muted">Carregando convites...</span>
        </div>
    `;
    
    fetch('<?= \App\Helpers\Url::to('/conversations/invites') ?>', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            renderPendingInvites(data.invites || []);
            const invitesCount = data.count || 0;
            updateInvitesTabCount(invitesCount);
        } else {
            container.innerHTML = `
                <div class="text-center py-10 text-muted">
                    <i class="ki-duotone ki-information-5 fs-2x mb-3"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>
                    <div>${data.message || 'Erro ao carregar convites'}</div>
                </div>`;
        }
    })
    .catch(error => {
        console.error('Erro ao carregar convites:', error);
        container.innerHTML = `
            <div class="text-center py-10 text-muted">
                <i class="ki-duotone ki-cross-circle fs-2x text-danger mb-3"><span class="path1"></span><span class="path2"></span></i>
                <div>Erro ao carregar convites</div>
                <div class="fs-7 mt-2">${error.message}</div>
            </div>`;
    });
    
    // Também carregar solicitações de participação
    loadPendingRequestsModal();
}

/**
 * Atualizar contador de convites na tab
 */
function updateInvitesTabCount(count) {
    const badge = document.getElementById('invitesTabCount');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }
    // Atualizar contador geral tambêm
    updatePendingInvitesCount(count);
}

/**
 * Carregar solicitaçÁes de participação pendentes (no modal)
 */
function loadPendingRequestsModal() {
    const container = document.getElementById('pendingRequestsList');
    if (!container) {
        console.error('Container pendingRequestsList não encontrado');
        return;
    }
    
    container.innerHTML = `
        <div class="text-center py-10">
            <span class="spinner-border spinner-border-sm text-primary"></span>
            <span class="ms-2 text-muted">Carregando solicitações...</span>
        </div>
    `;
    
    fetch('<?= \App\Helpers\Url::to('/conversations/requests/pending') ?>', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            renderPendingRequestsModal(data.requests || []);
            updateRequestsTabCount(data.count || 0);
        } else {
            container.innerHTML = `
                <div class="text-center py-10 text-muted">
                    <i class="ki-duotone ki-information-5 fs-2x mb-3"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>
                    <div>${data.message || 'Erro ao carregar solicitações'}</div>
                </div>`;
        }
    })
    .catch(error => {
        console.error('Erro ao carregar solicitações:', error);
        container.innerHTML = `
            <div class="text-center py-10 text-muted">
                <i class="ki-duotone ki-cross-circle fs-2x text-danger mb-3"><span class="path1"></span><span class="path2"></span></i>
                <div>Erro ao carregar solicitações</div>
                <div class="fs-7 mt-2">${error.message}</div>
            </div>`;
    });
}

/**
 * Atualizar contador de solicitaçÁes na tab
 */
function updateRequestsTabCount(count) {
    const badge = document.getElementById('requestsTabCount');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }
}

/**
 * Renderizar lista de solicitaçÁes de participação no modal
 */
function renderPendingRequestsModal(requests) {
    const container = document.getElementById('pendingRequestsList');
    if (!container) {
        console.error('Container pendingRequestsList não encontrado!');
        return;
    }
    
    if (requests.length === 0) {
        container.innerHTML = `
            <div class="text-center py-10">
                <i class="ki-duotone ki-check-circle fs-3x text-success mb-3">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <h5 class="text-muted">Nenhuma solicitação pendente</h5>
                <p class="text-gray-500 fs-7">Não há agentes solicitando participar das suas conversas</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    requests.forEach(req => {
        const channelInfo = getChannelInfo(req.channel);
        const channelIcon = channelInfo.icon;
        
        const timeAgo = formatTime(req.created_at);
        const requesterInitials = getInitials(req.requester_name || 'A');
        const contactInitials = getInitials(req.contact_name || 'C');
        
        html += `
            <div class="d-flex align-items-start gap-3 p-4 border rounded mb-3 bg-light-primary">
                <!-- Avatar do solicitante -->
                <div class="symbol symbol-45px symbol-circle">
                    ${req.requester_avatar 
                        ? `<img src="${escapeHtml(req.requester_avatar)}" alt="${escapeHtml(req.requester_name || '')}">`
                        : `<div class="symbol-label bg-light-warning text-warning fw-bold">${requesterInitials}</div>`
                    }
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-0">${escapeHtml(req.requester_name || 'Agente')}</h6>
                            <span class="text-muted fs-7">quer participar da conversa</span>
                        </div>
                        <span class="badge badge-light-primary fs-8">${timeAgo}</span>
                    </div>
                    
                    <!-- Info da conversa -->
                    <div class="bg-white rounded p-2 mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="symbol symbol-25px symbol-circle">
                                ${req.contact_avatar 
                                    ? `<img src="${escapeHtml(req.contact_avatar)}" alt="">`
                                    : `<span class="symbol-label bg-light-info text-info fs-8">${contactInitials}</span>`
                                }
                            </div>
                            <div>
                                <span class="fw-semibold fs-7">${escapeHtml(req.contact_name || 'Contato')}</span>
                                <span class="text-muted fs-8 ms-1">${channelIcon}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${req.note ? `<div class="text-muted fs-7 mb-2 fst-italic">"${escapeHtml(req.note)}"</div>` : ''}
                    
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-sm btn-success" onclick="approveRequestFromModal(${req.id})">
                            <i class="ki-duotone ki-check fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Aprovar
                        </button>
                        <button class="btn btn-sm btn-light-danger" onclick="rejectRequestFromModal(${req.id})">
                            <i class="ki-duotone ki-cross fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Recusar
                        </button>
                        <button class="btn btn-sm btn-light-primary" onclick="viewConversationFromRequest(${req.conversation_id})">
                            <i class="ki-duotone ki-eye fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            Ver Conversa
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

/**
 * Aprovar solicitação a partir do modal
 */
function approveRequestFromModal(requestId) {
    Swal.fire({
        title: 'Aprovar solicitação?',
        text: 'Este agente será adicionado como participante da conversa.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, aprovar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Aprovando...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            fetch(`<?= \App\Helpers\Url::to('/conversations/requests') ?>/${requestId}/approve`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Aprovado!',
                        text: 'O agente agora é participante da conversa.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recarregar lista de solicitaçÁes
                    loadPendingRequestsModal();
                    loadPendingInvitesCount();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message || 'Erro ao aprovar solicitação'
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao aprovar solicitação'
                });
            });
        }
    });
}

/**
 * Recusar solicitação a partir do modal
 */
function rejectRequestFromModal(requestId) {
    Swal.fire({
        title: 'Recusar solicitação?',
        text: 'Esta ação não poderí ser desfeita.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, recusar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`<?= \App\Helpers\Url::to('/conversations/requests') ?>/${requestId}/reject`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Recusada',
                        text: 'Solicitação recusada.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recarregar lista de solicitaçÁes
                    loadPendingRequestsModal();
                    loadPendingInvitesCount();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message || 'Erro ao recusar solicitação'
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao recusar solicitação'
                });
            });
        }
    });
}

/**
 * Ver conversa a partir de solicitação no modal
 */
function viewConversationFromRequest(conversationId) {
    if (typeof selectConversation === 'function') {
        selectConversation(conversationId);
        
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_pending_invites'));
        if (modal) modal.hide();
    }
}

/**
 * Renderizar lista de convites pendentes
 */
function renderPendingInvites(invites) {
    const container = document.getElementById('pendingInvitesList');
    if (!container) {
        console.error('Container pendingInvitesList não encontrado!');
        return;
    }
    
    if (invites.length === 0) {
        container.innerHTML = `
            <div class="text-center py-10">
                <i class="ki-duotone ki-check-circle fs-3x text-success mb-3">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <h5 class="text-muted">Nenhum convite pendente</h5>
                <p class="text-gray-500 fs-7">Você não tem convites para participar de conversas</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    invites.forEach(invite => {
        const channelInfo = getChannelInfo(invite.channel);
        const channelIcon = channelInfo.icon;
        
        const timeAgo = formatTime(invite.created_at);
        const initials = getInitials(invite.contact_name || 'NN');
        
        html += `
            <div class="d-flex align-items-start gap-3 p-4 border rounded mb-3 bg-light-warning">
                <div class="symbol symbol-45px symbol-circle">
                    ${invite.contact_avatar 
                        ? `<img src="${escapeHtml(invite.contact_avatar)}" alt="${escapeHtml(invite.contact_name || '')}">`
                        : `<div class="symbol-label bg-light-primary text-primary fw-bold">${initials}</div>`
                    }
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-0">${escapeHtml(invite.contact_name || 'Sem nome')}</h6>
                            <span class="text-muted fs-7">${channelIcon} ${escapeHtml(invite.channel || 'chat')}</span>
                        </div>
                        <span class="badge badge-light-warning fs-8">${timeAgo}</span>
                    </div>
                    <p class="text-muted fs-7 mb-2">
                        <strong>${escapeHtml(invite.mentioned_by_name || 'Alguêm')}</strong> convidou vocì para esta conversa
                    </p>
                    ${invite.note ? `<div class="bg-white rounded p-2 mb-2 fs-7"><em>"${escapeHtml(invite.note)}"</em></div>` : ''}
                    ${invite.last_message ? `<div class="text-gray-600 fs-7 mb-2">Última mensagem: ${escapeHtml(invite.last_message.substring(0, 50))}${invite.last_message.length > 50 ? '...' : ''}</div>` : ''}
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-sm btn-success" onclick="acceptInvite(${invite.id}, ${invite.conversation_id})">
                            <i class="ki-duotone ki-check fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Aceitar
                        </button>
                        <button class="btn btn-sm btn-light-danger" onclick="declineInvite(${invite.id})">
                            <i class="ki-duotone ki-cross fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Recusar
                        </button>
                        <button class="btn btn-sm btn-light-primary" onclick="viewConversationFromInvite(${invite.conversation_id})">
                            <i class="ki-duotone ki-eye fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            Ver
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

/**
 * Aceitar convite
 */
function acceptInvite(mentionId, conversationId) {
    Swal.fire({
        title: 'Aceitar convite?',
        text: 'Você será adicionado como participante desta conversa.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, aceitar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Aceitando...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            fetch(`<?= \App\Helpers\Url::to('/conversations/invites') ?>/${mentionId}/accept`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Convite aceito!',
                        text: 'Você agora é participante da conversa.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recarregar lista de convites
                    loadPendingInvites();
                    
                    // Atualizar contador
                    loadPendingInvitesCount();
                    
                    // Opcional: Abrir a conversa
                    if (conversationId) {
                        setTimeout(() => {
                            if (typeof selectConversation === 'function') {
                                selectConversation(conversationId);
                            }
                            // Fechar modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_pending_invites'));
                            if (modal) modal.hide();
                        }, 1500);
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message || 'Erro ao aceitar convite'
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao aceitar convite'
                });
            });
        }
    });
}

/**
 * Recusar convite
 */
function declineInvite(mentionId) {
    Swal.fire({
        title: 'Recusar convite?',
        text: 'O convite será marcado como recusado.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, recusar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#dc3545'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`<?= \App\Helpers\Url::to('/conversations/invites') ?>/${mentionId}/decline`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Convite recusado',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    
                    // Recarregar lista de convites
                    loadPendingInvites();
                    
                    // Atualizar contador
                    loadPendingInvitesCount();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message || 'Erro ao recusar convite'
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao recusar convite'
                });
            });
        }
    });
}

/**
 * Ver conversa a partir do convite (preview)
 */
function viewConversationFromInvite(conversationId) {
    if (typeof selectConversation === 'function') {
        selectConversation(conversationId);
        
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_pending_invites'));
        if (modal) modal.hide();
    }
}

/**
 * Atualizar contador de convites pendentes
 */
function updatePendingInvitesCount(count) {
    const badge = document.getElementById('pendingInvitesCountBadge');
    const headerBadge = document.getElementById('headerPendingInvitesBadge');
    
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }
    
    if (headerBadge) {
        if (count > 0) {
            headerBadge.textContent = count;
            headerBadge.classList.remove('d-none');
        } else {
            headerBadge.classList.add('d-none');
        }
    }
}

/**
 * Carregar contagem de convites pendentes
 */
function loadPendingInvitesCount() {
    // Usar novo endpoint que retorna ambos os contadores
    fetch('<?= \App\Helpers\Url::to('/conversations/invites/counts') ?>', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar contador total (convites + solicitaçÁes)
            updatePendingInvitesCount(data.total_count || 0);
            
            // Atualizar contadores das tabs
            updateInvitesTabCount(data.invites_count || 0);
            updateRequestsTabCount(data.requests_count || 0);
        }
    })
    .catch(error => console.error('Erro ao carregar contagem de convites/solicitaçÁes:', error));
}

// Carregar contagem de convites ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadPendingInvitesCount();
    
    // Atualizar a cada 30 segundos (apenas se não estiver em modo WebSocket exclusivo)
    if (!window.realtimeConfig || window.realtimeConfig.connectionType !== 'websocket') {
        console.log('[Convites] Iniciando polling de convites a cada 30 segundos');
        setInterval(loadPendingInvitesCount, 30000);
    } else {
        console.log('[Convites] WebSocket ativo, polling de convites desabilitado');
    }
    
    // Configurar listeners WebSocket para convites em tempo real
    setupInviteWebSocketListeners();
});

/**
 * Configurar listeners WebSocket para notificaçÁes de convites em tempo real
 */
function setupInviteWebSocketListeners() {
    // Verificar se o cliente WebSocket está disponível
    if (typeof window.realtimeClient === 'undefined' && typeof window.websocketClient === 'undefined') {
        console.warn('[Convites] Cliente WebSocket não encontrado, usando apenas polling');
        return;
    }
    
    const client = window.realtimeClient || window.websocketClient;
    
    // Listener para novo convite recebido
    client.on('new_mention', (data) => {
        // Atualizar contador do sino
        loadPendingInvitesCount();
        
        // Mostrar notificação toast
        if (typeof Swal !== 'undefined') {
            const mentionData = data.mention || data;
            Swal.fire({
                icon: 'info',
                title: 'Novo Convite!',
                html: `<strong>${escapeHtml(mentionData.mentioned_by_name || 'Um agente')}</strong> convidou vocì para participar de uma conversa.`,
                toast: true,
                position: 'top-end',
                showConfirmButton: true,
                confirmButtonText: 'Ver',
                showCancelButton: true,
                cancelButtonText: 'Fechar',
                timer: 10000,
                timerProgressBar: true
            }).then(result => {
                if (result.isConfirmed) {
                    showPendingInvitesModal();
                }
            });
        }
        
        // Tocar som de notificação se disponível
        if (typeof playNotificationSound === 'function') {
            playNotificationSound();
        }
    });
    
    // Listener para convite aceito (quem enviou o convite recebe)
    client.on('mention_accepted', (data) => {
        const mentionData = data.mention || data;
        
        // Mostrar notificação
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: 'Convite Aceito!',
                html: `<strong>${escapeHtml(mentionData.mentioned_user_name || 'O agente')}</strong> aceitou participar da conversa.`,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        }
        
        // Atualizar lista de participantes se o modal estiver aberto
        if (mentionData.conversation_id && window.currentConversationId == mentionData.conversation_id) {
            loadParticipantsForConversation(mentionData.conversation_id);
            
            // Atualizar sidebar
            if (typeof selectConversation === 'function') {
                selectConversation(mentionData.conversation_id);
            }
        }
    });
    
    // Listener para convite recusado (quem enviou o convite recebe)
    client.on('mention_declined', (data) => {
        const mentionData = data.mention || data;
        
        // Mostrar notificação
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'warning',
                title: 'Convite Recusado',
                html: `<strong>${escapeHtml(mentionData.mentioned_user_name || 'O agente')}</strong> recusou participar da conversa.`,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        }
        
        // Atualizar lista de convites pendentes se o modal estiver aberto
        if (mentionData.conversation_id) {
            loadPendingInvitesForConversation(mentionData.conversation_id);
        }
    });
    
    // Listener para atualização de conversa (quando alguêm é adicionado como participante)
    client.on('conversation_updated', (data) => {
        // Se o update inclui mudança de participantes, atualizar
        if (data && data.type && data.type.includes('mention')) {
            if (data.conversation_id && window.currentConversationId == data.conversation_id) {
                loadParticipantsForConversation(data.conversation_id);
            }
        }
    });
    
    // ============================================
    // LISTENERS PARA SOLICITAÇòES DE PARTICIPAÇâO
    // ============================================
    
    // Listener para nova solicitação de participação
    client.on('new_participation_request', (data) => {
        // Atualizar contador do sino
        loadPendingInvitesCount();
        
        // Mostrar notificação toast
        if (typeof Swal !== 'undefined') {
            const requestData = data.mention || data;
            Swal.fire({
                icon: 'info',
                title: 'Nova Solicitação!',
                html: `<strong>${escapeHtml(requestData.mentioned_by_name || 'Um agente')}</strong> está solicitando participar de uma conversa.`,
                toast: true,
                position: 'top-end',
                showConfirmButton: true,
                confirmButtonText: 'Ver',
                showCancelButton: true,
                cancelButtonText: 'Fechar',
                timer: 10000,
                timerProgressBar: true
            }).then(result => {
                if (result.isConfirmed) {
                    showPendingInvitesModal();
                    // Ir para aba de solicitaçÁes
                    const requestsTab = document.querySelector('a[href="#tab_requests"]');
                    if (requestsTab) {
                        const tab = new bootstrap.Tab(requestsTab);
                        tab.show();
                    }
                }
            });
        }
        
        // Se estiver na conversa que recebeu a solicitação, mostrar banner
        if (data.mention && data.mention.conversation_id == window.currentConversationId) {
            // Recarregar conversa para mostrar o banner
            selectConversation(window.currentConversationId);
        }
        
        // Tocar som de notificação se disponível
        if (typeof playNotificationSound === 'function') {
            playNotificationSound();
        }
    });
    
    // Listener para solicitação aprovada (quem solicitou recebe)
    client.on('request_approved', (data) => {
        const requestData = data.mention || data;
        
        // Mostrar notificação
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: 'Solicitação Aprovada!',
                html: `Você agora é participante da conversa.`,
                toast: true,
                position: 'top-end',
                showConfirmButton: true,
                confirmButtonText: 'Ver Conversa',
                timer: 8000,
                timerProgressBar: true
            }).then(result => {
                if (result.isConfirmed && requestData.conversation_id) {
                    selectConversation(requestData.conversation_id);
                }
            });
        }
        
        // Recarregar lista de conversas
        if (typeof refreshConversationList === 'function') {
            refreshConversationList();
        }
        
        // Se estiver vendo a conversa que foi aprovada, recarregar
        if (requestData.conversation_id == window.currentConversationId) {
            selectConversation(window.currentConversationId);
        }
    });
    
    // Listener para solicitação recusada (quem solicitou recebe)
    client.on('request_rejected', (data) => {
        const requestData = data.mention || data;
        
        // Mostrar notificação
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'warning',
                title: 'Solicitação Recusada',
                html: `Sua solicitação de participação foi recusada.`,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        }
    });
    
    console.log('[Convites] ✓ Listeners WebSocket configurados para convites e solicitaçÁes em tempo real');
}

// ============================================
// FIM SISTEMA DE MENÇòES/CONVITES
// ============================================

// Mostrar modal de nova conversa (definir IMEDIATAMENTE para estar disponível globalmente)
// Esta função DEVE estar definida antes de qualquer HTML que possa tentar usí-la
function showNewConversationModal() {
    const modal = document.getElementById('kt_modal_new_conversation');
    if (!modal) {
        console.error('Modal de nova conversa não encontrado');
        return;
    }
    
    // Limpar formulírio
    const form = modal.querySelector('#newConversationForm');
    if (form) form.reset();
    
    // Resetar canal para WhatsApp (padrão)
    const channelSelect = modal.querySelector('#new_conversation_channel');
    if (channelSelect) {
        channelSelect.value = 'whatsapp';
        // Disparar evento change para atualizar visibilidade do campo WhatsApp
        channelSelect.dispatchEvent(new Event('change'));
    }
    
    // Abrir modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Focar no campo nome
    setTimeout(() => {
        const nameInput = modal.querySelector('#new_contact_name');
        if (nameInput) nameInput.focus();
    }, 300);
}

// Garantir que a função esteja no escopo global IMEDIATAMENTE
window.showNewConversationModal = showNewConversationModal;

// ============================================
// FUNÇòES DE IA - DEFINIR IMEDIATAMENTE
// ============================================

/**
 * Carregar status da IA na conversa
 */
window.loadAIAgentStatus = function(conversationId) {
    if (!conversationId) {
        if (typeof window.updateAIAgentSidebar === 'function') {
            window.updateAIAgentSidebar({ has_ai: false });
        }
        return;
    }
    
    // Mostrar estado de carregamento
    const statusDiv = document.getElementById('sidebar-ai-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<div class="text-muted fs-7">Carregando...</div>';
    }
    
    const url = `<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/ai-status`;
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            if (typeof window.updateAIAgentSidebar === 'function') {
                window.updateAIAgentSidebar(data.data);
            }
            if (typeof window.updateAIActiveBanner === 'function') {
                window.updateAIActiveBanner(data.data, conversationId);
            }
        } else {
            console.error('Erro ao carregar status da IA:', data.message);
            if (typeof window.updateAIAgentSidebar === 'function') {
                window.updateAIAgentSidebar({ has_ai: false });
            }
            if (typeof window.updateAIActiveBanner === 'function') {
                window.updateAIActiveBanner({ has_ai: false }, conversationId);
            }
        }
    })
    .catch(error => {
        console.error('Erro ao carregar status da IA:', error);
        if (typeof window.updateAIAgentSidebar === 'function') {
            window.updateAIAgentSidebar({ has_ai: false });
        }
        if (typeof window.updateAIActiveBanner === 'function') {
            window.updateAIActiveBanner({ has_ai: false }, conversationId);
        }
    });
};

/**
 * Atualizar sidebar com status da IA
 */
window.updateAIAgentSidebar = function(status) {
    const section = document.getElementById('sidebar-ai-agent-section');
    
    if (!section) {
        return;
    }
    
    const statusDiv = document.getElementById('sidebar-ai-status');
    const actionsDiv = document.getElementById('sidebar-ai-actions');
    const addSection = document.getElementById('sidebar-ai-add-section');
    
    if (status.has_ai && status.ai_agent) {
        // Tem IA ativa
        const agent = status.ai_agent;
        const stats = status.ai_conversation || {};
        
        if (statusDiv) {
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <div class="symbol symbol-35px symbol-circle me-3">
                        <div class="symbol-label bg-light-primary">
                            <i class="ki-duotone ki-abstract-26 fs-2 text-primary">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <a href="#" class="text-dark fw-bold text-hover-primary fs-6">${agent.name || 'IA'}</a>
                        <span class="text-muted fw-semibold d-block fs-7">${agent.model || 'gpt-4'}</span>
                    </div>
                </div>
                
                ${stats.messages_count ? `
                <div class="mb-2">
                    <span class="text-gray-600 fs-7">Mensagens: </span>
                    <span class="badge badge-light-info fs-7">${stats.messages_count || 0}</span>
                </div>
                ` : ''}
            `;
        }
        
        if (actionsDiv) actionsDiv.style.display = '';
        if (addSection) addSection.style.display = 'none';
    } else {
        // Sem IA ativa
        if (statusDiv) {
            statusDiv.innerHTML = '<div class="text-muted fs-7">Nenhum agente de IA ativo nesta conversa</div>';
        }
        if (actionsDiv) actionsDiv.style.display = 'none';
        if (addSection) addSection.style.display = 'block';
    }
    
    // Atualizar banner de IA ativa (se a função existir)
    if (typeof window.updateAIActiveBanner === 'function') {
        const conversationId = window.currentConversationId || 0;
        window.updateAIActiveBanner(status, conversationId);
    }
};

// Fallback: funçÁes de automação no sidebar (caso não venham de sidebar-conversation.php)
if (typeof window.updateAutomationSidebar !== 'function') {
    window.updateAutomationSidebar = function(data) {
        const statusDiv = document.getElementById('sidebar-automation-status');
        if (!statusDiv) return;
        if (!data || !data.has_automation || !data.automation) {
            statusDiv.innerHTML = '<div class="text-muted fs-7">Nenhuma automação ativa</div>';
            return;
        }
        const automation = data.automation;
        const execStatus = automation.execution_status || 'unknown';
        const autoStatus = automation.automation_status || 'inactive';
        const lastExec = automation.last_execution_at ? formatTime(automation.last_execution_at) : '—';
        statusDiv.innerHTML = `
            <div class="d-flex flex-column gap-1">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge ${autoStatus === 'active' ? 'badge-success' : 'badge-light'}">${autoStatus === 'active' ? 'Ativa' : 'Inativa'}</span>
                    ${automation.trigger_type ? `<span class="badge badge-light">${escapeHtml(automation.trigger_type)}</span>` : ''}
                </div>
                <div class="fw-semibold">${escapeHtml(automation.name || 'Automação')}</div>
                <div class="text-muted fs-8">Execução: ${escapeHtml(execStatus)}</div>
                <div class="text-muted fs-8">Última: ${lastExec}</div>
            </div>
        `;
    };
}

if (typeof window.loadAutomationStatus !== 'function') {
    window.loadAutomationStatus = function(conversationId) {
        if (!conversationId) {
            window.updateAutomationSidebar({ has_automation: false });
            return;
        }
        const statusDiv = document.getElementById('sidebar-automation-status');
        if (statusDiv) {
            statusDiv.innerHTML = '<div class="text-muted fs-7">Carregando...</div>';
        }
        const url = `<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/automation-status`;
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.updateAutomationSidebar(data.data);
            } else {
                window.updateAutomationSidebar({ has_automation: false });
            }
        })
        .catch(() => {
            window.updateAutomationSidebar({ has_automation: false });
        });
    };
}

/**
 * Mostrar modal de adicionar agente de IA
 */
window.showAddAIAgentModal = function() {
    const conversationId = window.currentConversationId || 0;
    
    if (!conversationId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione uma conversa primeiro'
        });
        return;
    }
    
    // Carregar agentes disponíveis
    const url = `<?= \App\Helpers\Url::to('/ai-agents/available') ?>`;
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text().then(text => {
            try {
                return JSON.parse(text);
            } catch (e) {
                throw new Error('Resposta não é um JSON válido.');
            }
        });
    })
    .then(data => {
        if (!data.success || !data.data || data.data.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Atenção',
                text: data.message || 'Nenhum agente de IA disponível'
            });
            return;
        }
        
        const agents = data.data;
        const agentOptions = agents.map(agent => 
            `<option value="${agent.id}">${agent.name} (${agent.agent_type})</option>`
        ).join('');
        
        Swal.fire({
            title: 'Adicionar Agente de IA',
            html: `
                <div class="text-start">
                    <div class="mb-4">
                        <label class="form-label">Selecione o agente:</label>
                        <select id="swal-ai-agent-select" class="form-select">
                            <option value="">Selecione...</option>
                            ${agentOptions}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" id="swal-process-immediately" checked>
                            <span class="form-check-label">
                                Processar mensagens imediatamente
                            </span>
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" id="swal-assume-conversation">
                            <span class="form-check-label">
                                Assumir conversa (remover agente humano se houver)
                            </span>
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input" type="checkbox" id="swal-only-if-unassigned">
                            <span class="form-check-label">
                                Apenas se não tiver agente atribuído
                            </span>
                        </label>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Adicionar IA',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const agentId = document.getElementById('swal-ai-agent-select').value;
                if (!agentId) {
                    Swal.showValidationMessage('Selecione um agente de IA');
                    return false;
                }
                
                return {
                    ai_agent_id: agentId,
                    process_immediately: document.getElementById('swal-process-immediately').checked,
                    assume_conversation: document.getElementById('swal-assume-conversation').checked,
                    only_if_unassigned: document.getElementById('swal-only-if-unassigned').checked
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                window.addAIAgentToConversation(conversationId, result.value);
            }
        });
    })
    .catch(error => {
        console.error('❌ Erro ao carregar agentes:', error);
        console.error('Detalhes do erro:', {
            message: error.message,
            stack: error.stack
        });
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: `Erro ao carregar agentes de IA: ${error.message}`
        });
    });
};

/**
 * Adicionar agente de IA á conversa
 */
window.addAIAgentToConversation = function(conversationId, data) {
    const btn = Swal.getConfirmButton();
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adicionando...';
    
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/ai-agents`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: result.message || 'Agente de IA adicionado com sucesso',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recarregar status da IA após atualização do banco
                    setTimeout(() => {
                        window.loadAIAgentStatus(conversationId);
                    }, 500);
                    
                    // Recarregar conversa se necessário
                    if (typeof selectConversation === 'function') {
                        selectConversation(conversationId);
                    }
        } else {
            throw new Error(result.message || 'Erro ao adicionar agente de IA');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: error.message || 'Erro ao adicionar agente de IA'
        });
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
};

/**
 * Mostrar histórico de mensagens da IA
 */
window.showAIHistory = function() {
    const conversationId = window.currentConversationId || 0;
    if (!conversationId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione uma conversa primeiro'
        });
        return;
    }
    
    // Carregar mensagens da IA
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/ai-messages?limit=50`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Erro ao carregar histórico');
        }
        
        const messages = data.data || [];
        
        if (messages.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'Histórico',
                text: 'Nenhuma mensagem da IA encontrada'
            });
            return;
        }
        
        // Carregar nome do agente
        fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/ai-status`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(statusData => {
            const agentName = statusData.success && statusData.data?.ai_agent 
                ? statusData.data.ai_agent.name 
                : 'Agente de IA';
            
            // Formatar mensagens
            const messagesHtml = messages.map(msg => {
                const date = new Date(msg.created_at);
                const formattedDate = date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const toolsHtml = msg.tools_used && msg.tools_used.length > 0
                    ? `<div class="mt-2"><small class="text-muted">🔌 Tools: ${msg.tools_used.join(', ')}</small></div>`
                    : '';
                
                const escapeDiv = document.createElement('div');
                escapeDiv.textContent = msg.content;
                const escapedContent = escapeDiv.innerHTML;
                
                return `
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">${formattedDate}</small>
                        </div>
                        <div class="text-gray-800">${escapedContent}</div>
                        ${toolsHtml}
                    </div>
                `;
            }).join('');
            
            Swal.fire({
                title: `Histórico - ${agentName}`,
                html: `
                    <div style="max-height: 400px; overflow-y: auto; text-align: left;">
                        ${messagesHtml}
                    </div>
                `,
                width: '600px',
                showConfirmButton: true,
                confirmButtonText: 'Fechar'
            });
        });
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: error.message || 'Erro ao carregar histórico da IA'
        });
    });
};

/**
 * Remover agente de IA da conversa
 */
window.removeAIAgent = function() {
    const conversationId = window.currentConversationId || 0;
    if (!conversationId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione uma conversa primeiro'
        });
        return;
    }
    
    Swal.fire({
        title: 'Remover Agente de IA',
        html: `
            <div class="text-start">
                <p>Deseja realmente remover o agente de IA desta conversa?</p>
                
                <div class="mb-3">
                    <label class="form-check form-check-custom form-check-solid">
                        <input class="form-check-input" type="checkbox" id="swal-assign-to-human" checked>
                        <span class="form-check-label">
                            Atribuir a agente humano após remover
                        </span>
                    </label>
                </div>
                
                <div id="swal-human-agent-select-container" style="display: none;">
                    <label class="form-label">Selecione o agente:</label>
                    <select id="swal-human-agent-select" class="form-select">
                        <option value="">Distribuição automítica</option>
                    </select>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Remover',
        cancelButtonText: 'Cancelar',
        didOpen: () => {
            const assignCheckbox = document.getElementById('swal-assign-to-human');
            const selectContainer = document.getElementById('swal-human-agent-select-container');
            
            assignCheckbox.addEventListener('change', function() {
                selectContainer.style.display = this.checked ? 'block' : 'none';
            });
        },
        preConfirm: () => {
            const assignToHuman = document.getElementById('swal-assign-to-human').checked;
            const humanAgentId = document.getElementById('swal-human-agent-select').value;
            
            return {
                assign_to_human: assignToHuman,
                human_agent_id: humanAgentId || null,
                reason: 'Removido manualmente pelo usuírio'
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const btn = Swal.getConfirmButton();
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Removendo...';
            
            fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/ai-agents`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(result.value)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: data.message || 'Agente de IA removido com sucesso',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recarregar status da IA
                    window.loadAIAgentStatus(conversationId);
                    
                    // Recarregar conversa se necessário
                    if (typeof selectConversation === 'function') {
                        selectConversation(conversationId);
                    }
                } else {
                    throw new Error(data.message || 'Erro ao remover agente de IA');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: error.message || 'Erro ao remover agente de IA'
                });
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }
    });
};

// ============================================
// VARIüVEIS E OUTRAS FUNÇòES
// ============================================

// Capturar erros globais para diagnosticar rapidamente
window.onerror = function(message, source, lineno, colno, error) {
    console.error('Erro global capturado:', { message, source, lineno, colno, error });
    // Mostrar alerta mínimo para o usuírio perceber
    try {
        Swal.fire({
            icon: 'error',
            title: 'Erro de script',
            html: `<div style="text-align:left;font-size:12px;">${message}<br><small>${source}:${lineno}:${colno}</small></div>`,
            confirmButtonText: 'OK'
        });
    } catch (e) {
        alert('Erro de script: ' + message + ' (' + source + ':' + lineno + ')');
    }
    return false;
};

window.addEventListener('unhandledrejection', function(event) {
    console.error('Promise rejeitada não tratada:', event.reason);
    try {
        Swal.fire({
            icon: 'error',
            title: 'Erro inesperado',
            html: `<div style="text-align:left;font-size:12px;">${(event.reason && event.reason.message) ? event.reason.message : event.reason}</div>`,
            confirmButtonText: 'OK'
        });
    } catch (e) {
        alert('Erro inesperado: ' + (event.reason && event.reason.message ? event.reason.message : event.reason));
    }
});

// Fallback para avatares faltando (404) -> usa avatar em branco
window.addEventListener('error', function(e) {
    const target = e.target;
    if (target && target.tagName === 'IMG' && target.src && target.src.indexOf('/media/avatars/contacts/') !== -1) {
        target.onerror = null;
        target.src = '<?= \App\Helpers\Url::asset('media/avatars/blank.png') ?>';
    }
}, true);

// Selecionar conversa (carregar via AJAX sem recarregar pígina)
// Sistema de Polling (fallback quando WebSocket não está disponível)
// Declarar variíveis e funçÁes ANTES de serem usadas
let pollingInterval = null;
// Controlar último ID de mensagem por conversa para evitar "vazar" valor entre conversas
const lastMessageIds = {};
let lastMessageId = null; // mantém o valor da conversa atual para uso rápido
let currentPollingConversationId = null;
let pendingAttachments = []; // anexos aguardando envio (clipboard/drag/drop/file picker)

// Sistema de Paginação Infinita
let isLoadingMessages = false;
let hasMoreMessages = true;
let oldestMessageId = null;
let currentConversationId = null;
let currentContactAvatar = null; // Avatar do contato da conversa atual
let conversationPageSize = 50; // ✅ Limite de conversas por página (50 conversas por carregamento)
let conversationOffset = 0;
let conversationHasMore = true;
let isLoadingConversations = false;
let lastConversationsParams = null;

// Helper para converter valores vindos do PHP em JSON válido
function parsePhpJson(value) {
    try {
        return JSON.parse(value);
    } catch (e) {
        return null;
    }
}

// Se já vier um ID da URL/PHP, setar na inicialização
const initialConversationId = parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
if (initialConversationId) {
    currentConversationId = initialConversationId;
    currentContactAvatar = parsePhpJson('<?= json_encode($selectedConversation['contact_avatar'] ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
}

// Função para adicionar event listener ao botão (funciona mesmo se DOM já estiver carregado)
function attachNewConversationButton() {
    const btnNewConversation = document.getElementById('btn_new_conversation');
    if (btnNewConversation) {
        // Verificar se já tem listener (evitar duplicação)
        if (btnNewConversation.dataset.listenerAttached === 'true') {
            return;
        }
        
        // Adicionar listener diretamente (sem clonar para preservar onclick)
        btnNewConversation.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (typeof showNewConversationModal === 'function') {
                showNewConversationModal();
            }
        }, true); // Usar capture phase para garantir que execute
        
        // Marcar como anexado
        btnNewConversation.dataset.listenerAttached = 'true';
    }
}

// Tentar adicionar o listener imediatamente (se DOM já estiver pronto)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachNewConversationButton);
} else {
    // DOM já está pronto, executar imediatamente
    setTimeout(attachNewConversationButton, 100); // Pequeno delay para garantir que tudo está pronto
}

// Garantir inscrição no cliente de tempo real para conversas da lista (necessário no modo polling)
function subscribeVisibleConversations() {
    if (typeof window.wsClient === 'undefined') return;
    const items = document.querySelectorAll('.conversation-item[data-conversation-id]');
    items.forEach(item => {
        const id = parseInt(item.getAttribute('data-conversation-id'));
        if (!isNaN(id)) {
            window.wsClient.subscribe(id);
        }
    });
}

/**
 * Atualizar tempos relativos de todas as conversas na lista
 */
/**
 * ✅ CORREÇÃO: Atualizar texto de tempo SEM apagar o dropdown de ações.
 * O dropdown .conversation-item-actions fica DENTRO de .conversation-item-time,
 * então usar textContent apaga o dropdown inteiro.
 */
function setTimeText(timeElement, timeText) {
    if (!timeElement) return;
    
    const actionsDropdown = timeElement.querySelector('.conversation-item-actions');
    
    // Encontrar nó de texto existente
    let timeTextNode = null;
    for (const node of timeElement.childNodes) {
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
            timeTextNode = node;
            break;
        }
    }
    
    if (timeTextNode) {
        timeTextNode.textContent = timeText;
    } else if (actionsDropdown) {
        // Inserir texto ANTES do dropdown
        timeElement.insertBefore(document.createTextNode(timeText), actionsDropdown);
    } else {
        // Nenhum dropdown presente - seguro usar textContent
        timeElement.textContent = timeText;
    }
}

function updateConversationTimes() {
    const conversationItems = document.querySelectorAll('.conversation-item');
    conversationItems.forEach(item => {
        const timeElement = item.querySelector('.conversation-item-time');
        const updatedAt = item.getAttribute('data-updated-at');
        if (timeElement && updatedAt) {
            setTimeText(timeElement, formatTime(updatedAt));
        }
    });
}

// Remover badge (não lidas) de uma conversa na lista
function removeConversationBadge(conversationId) {
    if (!conversationId) return;
    const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (!conversationItem) return;
    const badge = conversationItem.querySelector('.conversation-item-badge');
    if (badge) badge.remove();
}

// Mover conversa para o topo da lista
function moveConversationToTop(conversationId) {
    const list = document.querySelector('.conversations-list-items');
    const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (list && conversationItem) {
        list.insertBefore(conversationItem, list.firstChild);
    }
}

// Verificar se hí dropdown aberto em uma conversa
function hasOpenDropdown(conversationId) {
    const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (!conversationItem) return false;
    const dropdown = conversationItem.querySelector('.conversation-item-actions');
    if (!dropdown) return false;
    // Verificar múltiplas formas de detectar dropdown aberto
    return dropdown.classList.contains('show') || 
           dropdown.querySelector('.dropdown-menu.show') ||
           dropdown.dataset.isOpen === 'true' ||
           dropdown.querySelector('button[aria-expanded="true"]') !== null;
}

// Preservar dropdown aberto durante atualizaçÁes
function preserveOpenDropdown(conversationId) {
    const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (!conversationItem) return null;
    const dropdown = conversationItem.querySelector('.conversation-item-actions');
    if (!dropdown) return null;
    const isOpen = dropdown.classList.contains('show') || dropdown.querySelector('.dropdown-menu.show');
    return isOpen ? conversationId : null;
}

// Restaurar dropdown aberto após atualização
function restoreOpenDropdown(conversationId) {
    if (!conversationId) return;
    setTimeout(() => {
        const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (!conversationItem) return;
        const dropdown = conversationItem.querySelector('.conversation-item-actions');
        if (!dropdown) return;
        const button = dropdown.querySelector('button[data-bs-toggle="dropdown"]');
        if (button) {
            const bsDropdown = bootstrap.Dropdown.getInstance(button) || new bootstrap.Dropdown(button);
            bsDropdown.show();
        }
    }, 50);
}

// Garantir que o dropdown de açÁes exista e reflita o estado
function ensureActionsDropdown(conversationItem, pinned, conversationId, preserveOpen = false) {
    const timeContainer = conversationItem.querySelector('.conversation-item-time');
    if (!timeContainer) return;

    // Verificar se dropdown está aberto antes de remover
    const wasOpen = preserveOpen && hasOpenDropdown(conversationId);

    // Remover dropdown existente se houver
    const existingDropdown = conversationItem.querySelector('.conversation-item-actions');
    if (existingDropdown) {
        existingDropdown.remove();
    }

    const pinText = pinned ? 'Desfixar' : 'Fixar';
    const pinIconClass = pinned ? 'text-warning' : '';

    const dropdownHtml = `
        <div class="dropdown conversation-item-actions">
            <button type="button" class="btn btn-sm btn-icon btn-light p-0" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    onclick="event.stopPropagation();">
                <i class="ki-duotone ki-setting-2 text-muted">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                    <span class="path4"></span>
                    <span class="path5"></span>
                </i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" data-conversation-id="${conversationId}">
                <li>
                    <a class="dropdown-item" href="#" onclick="event.stopPropagation(); togglePin(${conversationId}, ${pinned ? 'true' : 'false'}); return false;">
                        <i class="ki-duotone ki-pin fs-7 me-2 ${pinIconClass}">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        ${pinText}
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" onclick="event.stopPropagation(); markConversationAsRead(${conversationId}); return false;">
                        <i class="ki-duotone ki-check fs-7 me-2 text-success">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Marcar como Lido
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" onclick="event.stopPropagation(); markConversationAsUnread(${conversationId}); return false;">
                        <i class="ki-duotone ki-eye-slash fs-7 me-2 text-danger">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Marcar como Não Lido
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="#" onclick="event.stopPropagation(); showReminderModal(${conversationId}); return false;">
                        <i class="ki-duotone ki-notification-bing fs-7 me-2 text-primary">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Agendar Lembrete
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li class="dropdown-submenu">
                    <a class="dropdown-item d-flex align-items-center justify-content-between" href="#" onclick="event.stopPropagation(); event.preventDefault(); toggleSetAsSubmenu(this, ${conversationId});">
                        <span>
                            <i class="ki-duotone ki-tag fs-7 me-2 text-info"><span class="path1"></span><span class="path2"></span></i>
                            Setar como
                        </span>
                        <i class="ki-duotone ki-right fs-8 ms-2"><span class="path1"></span><span class="path2"></span></i>
                    </a>
                </li>
            </ul>
        </div>
    `;

    // Inserir dropdown no timeContainer
    timeContainer.insertAdjacentHTML('beforeend', dropdownHtml);

    // Restaurar dropdown aberto se estava aberto antes
    if (wasOpen) {
        restoreOpenDropdown(conversationId);
    }

    // Atualizar classe do item
    if (pinned) {
        conversationItem.classList.add('pinned');
    } else {
        conversationItem.classList.remove('pinned');
    }
}

// Atualizar atributos de data (updated_at) e resortear a lista
function updateConversationMeta(conversationItem, conv) {
    if (!conversationItem || !conv) return;
    // Manter estabilidade da ordenação: priorizar last_message_at; se não houver, manter valor atual; por último usar updated_at
    const currentUpdated = conversationItem.dataset.updatedAt || null;
    const updatedAt = conv.last_message_at || currentUpdated || conv.updated_at || new Date().toISOString();
    conversationItem.dataset.updatedAt = updatedAt;
}

// Determinar se a última mensagem foi do agente (para mostrar borda verde/SLA ok)
function isLastMessageFromAgent(data) {
    const lastAgent = data.last_agent_message_at || data.lastAgentMessageAt || '';
    const lastContact = data.last_contact_message_at || data.lastContactMessageAt || '';
    if (!lastAgent) return false;
    if (!lastContact) return true;
    const agentTs = Date.parse(lastAgent);
    const contactTs = Date.parse(lastContact);
    if (isNaN(agentTs)) return false;
    if (isNaN(contactTs)) return true;
    return agentTs >= contactTs;
}

function applySlaVisualState(conversationItem, conv) {
    // DESABILITADO: Não aplicar classes SLA ao conversation-item
    // O sistema de SLA (sla-indicator.js) é responsável por aplicar classes apenas ao avatar
    // Remover qualquer classe sla-ok que possa ter sido adicionada
    if (conversationItem) {
        conversationItem.classList.remove('sla-ok');
    }
    return;
}

function sortConversationList() {
    try {
        const list = document.querySelector('.conversations-list-items');
        if (!list) return;
        
        const items = Array.from(list.children);
        if (items.length === 0) return;
        
        // Ordenar: pinned primeiro, depois last_message_at desc, depois ID desc (desempate)
        items.sort((a, b) => {
            const pinnedA = a.classList?.contains('pinned') ? 1 : 0;
            const pinnedB = b.classList?.contains('pinned') ? 1 : 0;
            if (pinnedA !== pinnedB) return pinnedB - pinnedA;
            
            // Usar last-message-at (mais preciso) com fallback para updated-at
            const dateStrA = a.dataset?.lastMessageAt || a.dataset?.updatedAt || '';
            const dateStrB = b.dataset?.lastMessageAt || b.dataset?.updatedAt || '';
            const dateA = Date.parse(dateStrA) || 0;
            const dateB = Date.parse(dateStrB) || 0;
            if (dateA !== dateB) return dateB - dateA;
            
            // Critério de desempate: ID da conversa (maior primeiro = mais recente)
            const idA = parseInt(a.dataset?.conversationId) || 0;
            const idB = parseInt(b.dataset?.conversationId) || 0;
            return idB - idA;
        });
        
        items.forEach(item => {
            if (item && list) {
                list.appendChild(item);
            }
        });
    } catch (error) {
        // Silently fail
    }
}

// Atualizar preview/tempo/badge de um item de conversa com dados recebidos
function applyConversationUpdate(conv) {
    const conversationItem = document.querySelector(`[data-conversation-id="${conv.id}"]`);
    if (!conversationItem) return;
    
    // Verificar se a etapa/funil mudou e se ainda deve aparecer na lista atual
    const currentFunnelFilter = new URLSearchParams(window.location.search).get('funnel_id');
    const currentStageFilter = new URLSearchParams(window.location.search).get('stage_id');
    
    // Se há filtro de funil/etapa ativo e a conversa não pertence mais ao filtro, recarregar lista
    if (currentFunnelFilter || currentStageFilter) {
        const oldFunnelId = conversationItem.dataset.funnelId;
        const oldStageId = conversationItem.dataset.stageId;
        const newFunnelId = conv.funnel_id ? String(conv.funnel_id) : '';
        const newStageId = conv.funnel_stage_id ? String(conv.funnel_stage_id) : '';
        
        // Se funil/etapa mudou e está fora do filtro, remover da lista
        if ((currentFunnelFilter && newFunnelId !== currentFunnelFilter) ||
            (currentStageFilter && newStageId !== currentStageFilter)) {
            console.log('[Realtime] Conversa', conv.id, 'saiu do filtro atual, removendo da lista');
            conversationItem.remove();
            return;
        }
        
        // Atualizar dataset com novos valores
        conversationItem.dataset.funnelId = newFunnelId;
        conversationItem.dataset.stageId = newStageId;
    }

    // Preservar dropdown aberto se estiver aberto
    const wasOpen = hasOpenDropdown(conv.id);

            const preview = conversationItem.querySelector('.conversation-item-preview');
            const time = conversationItem.querySelector('.conversation-item-time');
            const badge = conversationItem.querySelector('.conversation-item-badge');
            const avatarContainer = conversationItem.querySelector('.symbol-label');
            const pinned = conv.pinned === 1 || conv.pinned === true;
            const firstResponseAt = conv.first_response_at_calc || conv.first_response_at || '';
            const lastContactAt = conv.last_contact_message_at || '';
            const lastAgentAt = conv.last_agent_message_at || '';

            if (preview && conv.last_message) {
                const maxChars = 37;
                const content = conv.last_message.length > maxChars
                    ? conv.last_message.substring(0, maxChars) + '...'
                    : conv.last_message;
                preview.textContent = content;
            }
    if (time && (conv.last_message_at || conv.updated_at)) {
        // Não atualizar o tempo se dropdown estiver aberto (evita fechar)
        if (!wasOpen) {
            setTimeText(time, formatTime(conv.last_message_at || conv.updated_at));
        }
    }

    if (avatarContainer) {
        if (conv.contact_avatar) {
            avatarContainer.innerHTML = `<img src="${escapeHtml(conv.contact_avatar)}" alt="${escapeHtml(conv.contact_name || '')}" class="h-45px w-45px rounded" style="object-fit: cover;">`;
        } else {
            avatarContainer.textContent = getInitials(conv.contact_name || 'NN');
        }
    }

    // Garantir botão de fixar e classe pinned (preservar dropdown aberto)
            ensureActionsDropdown(conversationItem, pinned, conv.id, wasOpen);

    // Atualizar data attributes para SLA/tempos
    conversationItem.dataset.status = conv.status || 'open';
    conversationItem.dataset.createdAt = conv.created_at || conversationItem.dataset.createdAt || '';
    conversationItem.dataset.firstResponseAt = firstResponseAt;
    conversationItem.dataset.lastMessageAt = conv.last_message_at || conv.updated_at || conversationItem.dataset.lastMessageAt || '';
    conversationItem.dataset.lastContactMessageAt = lastContactAt;
    conversationItem.dataset.lastAgentMessageAt = lastAgentAt;
    conversationItem.dataset.agentId = conv.agent_id || conversationItem.dataset.agentId || '';

    // Atualizar estado visual de SLA (borda verde quando última msg é do agente)
    applySlaVisualState(conversationItem, conv);

    // ⚠️ IMPORTANTE: Respeitar conversas marcadas manualmente como não lidas
    const isManuallyMarkedAsUnread = window.manuallyMarkedAsUnread && window.manuallyMarkedAsUnread.has(conv.id);
    const hasManualBadge = badge && badge.getAttribute('data-manual-unread') === 'true';
    
    // Se foi marcada manualmente como não lida, não remover o badge
    if (isManuallyMarkedAsUnread || hasManualBadge) {
        // Apenas atualizar o número se aumentou
        if (badge && conv.unread_count > 0) {
            badge.textContent = conv.unread_count;
        }
    } else {
        // Comportamento normal: atualizar badge baseado em unread_count
        const unreadCount = conv.unread_count || 0;
        if (unreadCount > 0) {
            if (badge) {
                badge.textContent = unreadCount;
            } else {
                const badgeHtml = `<span class="conversation-item-badge">${unreadCount}</span>`;
                const meta = conversationItem.querySelector('.conversation-item-meta');
                if (meta) meta.insertAdjacentHTML('beforeend', badgeHtml);
            }
        } else if (badge) {
            badge.remove();
        }
    }
    
    // Atualizar meta e resortear
    updateConversationMeta(conversationItem, conv);
    sortConversationList();
}

/**
 * Iniciar polling (verificação periódica de novas mensagens)
 */
// Helpers para lastMessageId por conversa
function setLastMessageIdForConversation(conversationId, messageId) {
    if (!conversationId || !messageId) return;
    const idNum = parseInt(messageId);
    if (isNaN(idNum)) return;
    const key = String(conversationId);
    const prev = lastMessageIds[key] || 0;
    lastMessageIds[key] = Math.max(prev, idNum);
    if (currentConversationId && String(currentConversationId) === key) {
        lastMessageId = lastMessageIds[key];
    }
}

function getLastMessageIdForConversation(conversationId) {
    if (!conversationId) return 0;
    const key = String(conversationId);
    return lastMessageIds[key] || 0;
}

function resetConversationState(conversationId) {
    currentConversationId = conversationId ? parseInt(conversationId) : null;
    lastMessageId = getLastMessageIdForConversation(conversationId);
    oldestMessageId = null;
    hasMoreMessages = true;
}

function startPolling(conversationId) {
    // Parar polling anterior se existir
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    currentPollingConversationId = conversationId;
    
    // Se não houver conversa selecionada, não fazer polling
    if (!conversationId) {
        return;
    }
    
    // Verificar se deve usar polling (respeitar configuração)
    if (window.realtimeConfig && window.realtimeConfig.connectionType === 'websocket') {
        console.log('[Polling] Sistema configurado para WebSocket apenas, polling desabilitado');
        return;
    }
    
    // Obter intervalo configurado (padrão: 30 segundos - mais eficiente que 3s)
    const pollingInterval_ms = (window.realtimeConfig && window.realtimeConfig.pollingInterval) 
        ? Math.max(window.realtimeConfig.pollingInterval, 10000) // Mínimo 10 segundos
        : 30000; // Padrão 30 segundos (recomendação de performance)
    
    console.log(`[Polling] Iniciando polling de mensagens a cada ${pollingInterval_ms/1000} segundos`);
    
    // Rodada imediata para zerar delay inicial
    checkForNewMessages(conversationId);
    
    // Verificar novas mensagens no intervalo configurado
    pollingInterval = setInterval(() => {
        checkForNewMessages(conversationId);
    }, pollingInterval_ms);
}

/**
 * Parar polling
 */
function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
    currentPollingConversationId = null;
}

/**
 * Verificar novas mensagens via AJAX
 */
function checkForNewMessages(conversationId) {
    if (!conversationId) return;
    
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    // Buscar apenas mensagens novas
    const conversationIdNum = parseInt(conversationId);
    const lastMessageIdNum = parseInt(getLastMessageIdForConversation(conversationId)) || 0;
    if (isNaN(conversationIdNum)) {
        console.error('ID de conversa inválido:', conversationId);
        return;
    }
    // Usar endpoint de mensagens, não a pígina da conversa, para evitar 404 e carregar apenas JSON
    const url = `<?= \App\Helpers\Url::to('/conversations') ?>/${conversationIdNum}/messages?last_message_id=${lastMessageIdNum}`;
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.messages && data.messages.length > 0) {
            // Adicionar apenas mensagens novas
            data.messages.forEach(msg => {
                const existingMsg = chatMessages.querySelector(`[data-message-id="${msg.id}"]`);
                if (!existingMsg) {
                    addMessageToChat(msg);
                    lastMessageId = Math.max(lastMessageId || 0, msg.id || 0);
                    
                    // Disparar evento para atualizar SLA
                    document.dispatchEvent(new CustomEvent('realtime:new_message', { 
                        detail: { 
                            conversation_id: conversationId, 
                            message: msg 
                        } 
                    }));
                }
            });
            
            // Atualizar lista de conversas tambêm
            if (data.messages.length > 0) {
                updateConversationListPreview(conversationId, data.messages[data.messages.length - 1]);
            }
        }
    })
    .catch(error => {
        // Silenciar erros de polling (normal quando não hí novas mensagens)
        if (error.message && !error.message.includes('404')) {
            console.error('Erro ao verificar novas mensagens:', error);
        }
    });
}

/**
 * Atualizar preview da conversa na lista
 */
function updateConversationListPreview(conversationId, lastMessage) {
    const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (conversationItem && lastMessage) {
        // Preservar dropdown aberto se estiver aberto
        const wasOpen = hasOpenDropdown(conversationId);
        
        const preview = conversationItem.querySelector('.conversation-item-preview');
        const time = conversationItem.querySelector('.conversation-item-time');
        
        if (preview) {
            const content = lastMessage.content || '';
            const maxChars = 37;
            preview.textContent = content.substring(0, maxChars) + (content.length > maxChars ? '...' : '');
        }
        if (time && lastMessage.created_at) {
            // Não atualizar o tempo se dropdown estiver aberto (evita fechar)
            if (!wasOpen) {
                // Usar formatTime com o timestamp real da mensagem
                setTimeText(time, formatTime(lastMessage.created_at));
            }
            // Atualizar data-updated-at para ordenação correta (sempre)
            conversationItem.setAttribute('data-updated-at', lastMessage.created_at);
        }
        
        // Atualizar datasets de SLA/tempos
        if (lastMessage.sender_type === 'contact') {
            conversationItem.dataset.lastContactMessageAt = lastMessage.created_at;
        } else if (lastMessage.sender_type === 'agent') {
            conversationItem.dataset.lastAgentMessageAt = lastMessage.created_at;
        }
        
        // Atualizar indicador SLA em tempo real
        if (window.SLAIndicator) {
            const convData = window.SLAIndicator.getConversationData(conversationId);
            if (convData) {
                window.SLAIndicator.updateConversation(conversationId, convData);
            }
        }
        
        // Garantir dropdown de açÁes está atualizado (preservar se estava aberto)
        const pinned = conversationItem.classList.contains('pinned');
        ensureActionsDropdown(conversationItem, pinned, conversationId, wasOpen);
        
        // Resortear lista após atualizar (mas preservar posição se dropdown aberto)
        if (!wasOpen) {
            sortConversationList();
        }
    }
}

function selectConversation(id) {
    // Atualizar conversa selecionada globalmente e resetar estado local
    resetConversationState(id);
    window.currentConversationId = currentConversationId;
    
    // Disparar evento de conversa aberta (para NotificationManager limpar contador)
    document.dispatchEvent(new CustomEvent('conversation:opened', {
        detail: { conversationId: id, id: id }
    }));

    // Marcar conversa como ativa na lista
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    const conversationItem = document.querySelector(`[data-conversation-id="${id}"]`);
    if (conversationItem) {
        conversationItem.classList.add('active');
        
        // Remover da lista de marcadas manualmente como não lidas
        if (window.manuallyMarkedAsUnread && window.manuallyMarkedAsUnread.has(id)) {
            window.manuallyMarkedAsUnread.delete(id);
        }
        
        // Remover badge de não lidas imediatamente (otimista - antes da resposta do servidor)
        const badge = conversationItem.querySelector('.conversation-item-badge');
        if (badge) {
            badge.remove();
        }
    }
    
    // Mostrar header e input (se estiverem ocultos)
    const chatHeader = document.getElementById('chatHeader');
    const chatInput = document.getElementById('chatInput');
    if (chatHeader) chatHeader.style.display = '';
    if (chatInput) chatInput.style.display = '';
    
    // Mostrar loading
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) {
        console.error('Elemento chatMessages não encontrado');
        return;
    }
    
    // Limpar caixa de mensagem ao trocar de conversa (evita texto pendente em outra conversa)
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.value = '';
        messageInput.style.height = 'auto';
    }
    const noteToggle = document.getElementById('noteToggle');
    if (noteToggle) {
        noteToggle.checked = false;
    }
    
    // Atualizar data-conversation-id para o coaching inline detectar
    chatMessages.setAttribute('data-conversation-id', id);
    
    chatMessages.innerHTML = `
        <div class="d-flex align-items-center justify-content-center" style="height: 100%;">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <div class="text-muted">Carregando conversa...</div>
            </div>
        </div>
    `;
    
    // Fazer requisição AJAX
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${id}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        // Verificar se a resposta é JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Resposta não é JSON:', text.substring(0, 200));
            throw new Error('Resposta do servidor não é JSON. Status: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        // 🔧 DEBUG: Log para verificar resposta do servidor
        console.log('🔧 [selectConversation] Resposta recebida:', {
            success: data.success,
            access_restricted: data.access_restricted,
            access_restricted_type: typeof data.access_restricted,
            has_conversation: !!data.conversation,
            access_info: data.access_info
        });
        
    if (data.success && data.conversation) {
            // Atualizar URL sem recarregar (preservando filtros existentes)
            const currentParams = new URLSearchParams(window.location.search);
            currentParams.set('id', id); // Adicionar ou atualizar apenas o ID
            const newUrl = `<?= \App\Helpers\Url::to('/conversations') ?>?${currentParams.toString()}`;
            window.history.pushState({ conversationId: id }, '', newUrl);
            
            // ============================================
            // VERIFICAR SE ACESSO É RESTRITO
            // ============================================
            // ✅ CORREÇÃO: Verificar tanto boolean true quanto string "true" ou valor truthy
            if (data.access_restricted === true || data.access_restricted === 'true' || data.access_restricted === 1) {
                console.log('🔒 [selectConversation] Acesso restrito detectado - exibindo overlay');
                
                // ✅ GARANTIR que accessInfo sempre existe (mesmo que vazio)
                const accessInfo = data.access_info || {
                    can_view: false,
                    is_participant: false,
                    is_assigned: false,
                    has_pending_request: false
                };
                
                showRestrictedAccessView(id, data.conversation, accessInfo);
                return;
            } else {
                console.log('✅ [selectConversation] Acesso permitido - carregando conversa normalmente');
            }
            
            // ============================================
            // RESETAR ESTADO DE ACESSO RESTRITO (se estava restrito antes)
            // ============================================
            resetRestrictedAccessState();
            
            // Remover badge de não lidas da conversa atual na lista
            if (conversationItem) {
                const badge = conversationItem.querySelector('.conversation-item-badge');
                if (badge) {
                    badge.remove();
                }
            }
            
            // Atualizar header do chat
            updateChatHeader(data.conversation);
            
            // Resetar paginação
            currentConversationId = parseInt(id);
            window.currentConversationId = currentConversationId; // Garantir que window tambêm é atualizado
            currentContactAvatar = data.conversation.contact_avatar || null; // Armazenar avatar do contato
            isLoadingMessages = false;
            hasMoreMessages = true;
            oldestMessageId = null;
            
            // Remover indicador "Início da conversa" se existir (de conversa anterior)
            const noMoreMsgIndicator = document.getElementById('noMoreMessagesIndicator');
            if (noMoreMsgIndicator) {
                noMoreMsgIndicator.remove();
            }
            
            // Atualizar mensagens
            const messages = data.messages || [];
    if (messages.length > 0) {
        oldestMessageId = messages[0].id; // Primeira mensagem (mais antiga)
        // Garantir lastMessageId para polling incremental
        const lastMsg = messages[messages.length - 1];
        if (lastMsg && lastMsg.id) {
            lastMessageId = lastMsg.id;
            setLastMessageIdForConversation(currentConversationId, lastMsg.id);
        }
    } else {
        // Sem mensagens, zera controles
        oldestMessageId = null;
        lastMessageId = 0;
        setLastMessageIdForConversation(currentConversationId, 0);
    }
    updateChatMessages(messages, true);
            
            // Atualizar sidebar
            updateConversationSidebar(data.conversation, data.tags || []);
            
            // Carregar status da IA e atualizar banner
            if (typeof loadAIAgentStatus === 'function') {
                loadAIAgentStatus(id);
            }
            // Carregar status da automação
            if (typeof loadAutomationStatus === 'function') {
                loadAutomationStatus(id);
            }
            
            // Atualizar timeline quando conversa é selecionada
            updateConversationTimeline(data.conversation.id);
            
            // Exibir solicitaçÁes de participação pendentes (se houver)
            if (data.pending_requests && data.pending_requests.length > 0) {
                showPendingRequestsBanner(data.pending_requests);
            } else {
                hidePendingRequestsBanner();
            }
            
            // Scroll para última mensagem
            setTimeout(() => {
                const chatMessagesEl = document.getElementById('chatMessages');
                if (chatMessagesEl) {
                    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
                }
            }, 100);
            
            // Adicionar listener de scroll para paginação infinita
            setupInfiniteScroll();
            
            // Inscrever no WebSocket para esta conversa (quando disponível) e manter polling como fallback
            if (typeof window.wsClient !== 'undefined') {
                try {
                    window.wsClient.subscribe(id);
                } catch (e) {
                    console.error('Erro ao inscrever conversa no WebSocket:', e);
                }
            }
            // Manter polling ativo como fallback para garantir entrega imediata mesmo se o WS falhar
            startPolling(id);
            
            // Rodada imediata para garantir que nada ficou pendente entre a carga inicial e o início do loop
            checkForNewMessages(id);
            
            // Atualizar último ID de mensagem conhecido
            if (data.messages && data.messages.length > 0) {
                const lastMsg = data.messages[data.messages.length - 1];
                if (lastMsg.id) {
                    lastMessageId = lastMsg.id;
                    setLastMessageIdForConversation(currentConversationId, lastMsg.id);
                }
            }

            // Garantir truncamento visual do preview (limitando caracteres)
            const preview = document.querySelector(`[data-conversation-id="${id}"] .conversation-item-preview`);
        if (preview) {
            const text = preview.textContent || '';
            const maxChars = 37;
            if (text.length > maxChars) {
                preview.textContent = text.substring(0, maxChars) + '...';
            }
        }
        } else {
            alert('Erro ao carregar conversa: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao carregar conversa:', error);
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="d-flex align-items-center justify-content-center" style="height: 100%;">
                    <div class="text-center text-danger">
                        <i class="ki-duotone ki-information fs-3x mb-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <div class="fw-semibold">Erro ao carregar conversa</div>
                        <div class="text-muted fs-7">${escapeHtml(error.message || 'Erro desconhecido')}</div>
                        <button class="btn btn-sm btn-primary mt-3" onclick="selectConversation(${id})">Tentar novamente</button>
                    </div>
                </div>
            `;
        } else {
            alert('Erro ao carregar conversa: ' + (error.message || 'Erro desconhecido'));
        }
    });
}

// Atualizar header do chat
function updateChatHeader(conversation) {
    const header = document.getElementById('chatHeader');
    if (!header) return;
    
    const contactName = conversation.contact_name || 'Sem nome';
    const initials = getInitials(contactName);
    const channel = conversation.channel || 'chat';
    const status = conversation.status || 'open';
    
    let channelLabel = '💬 Chat';
    if (typeof getChannelInfo === 'function') {
        const channelInfo = getChannelInfo(channel);
        channelLabel = `${channelInfo.icon} ${channelInfo.name}`;
    } else {
        channelLabel = {
            'whatsapp': '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="#25D366" style="vertical-align: middle; margin-right: 4px;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg> WhatsApp',
            'email': '📧 Email',
            'chat': '💬 Chat'
        }[channel] || '💬 Chat';
    }
    
    const statusClass = {
        'open': 'success',
        'resolved': 'info',
        'closed': 'dark'
    }[status] || 'secondary';
    
    const statusText = {
        'open': 'Aberta',
        'resolved': 'Resolvida',
        'closed': 'Fechada'
    }[status] || 'Desconhecida';
    
    // Atualizar avatar
    const avatarLabel = header.querySelector('.symbol-label');
    if (avatarLabel) {
        if (conversation.contact_avatar) {
            avatarLabel.innerHTML = `<img src="${escapeHtml(conversation.contact_avatar)}" alt="${escapeHtml(contactName)}" class="h-45px w-45px rounded" style="object-fit: cover;">`;
        } else {
            avatarLabel.textContent = initials;
        }
    }
    
    // Atualizar nome
    const nameElement = header.querySelector('.chat-header-title');
    if (nameElement) {
        nameElement.textContent = contactName;
    }
    
    // Atualizar canal e status
    const channelElement = header.querySelector('#chat-header-channel');
    if (channelElement) {
        channelElement.innerHTML = channelLabel;
    }
    const statusElement = header.querySelector('#chat-header-status');
    if (statusElement) {
        statusElement.innerHTML = `<span class="badge badge-sm badge-light-${statusClass}">${statusText}</span>`;
    }
    
    // Atualizar botão de chamada Api4Com
    const callBtn = document.getElementById('btnApi4ComCall');
    if (callBtn) {
        // Mostrar botão se usuírio pode fazer chamadas E contato tem telefone
        const contactPhone = conversation.contact_phone || '';
        if (window.api4comCanMakeCalls && contactPhone) {
            callBtn.style.display = '';
        } else {
            callBtn.style.display = 'none';
        }
    }
}

// ============================================
// SISTEMA DE ACESSO RESTRITO / SOLICITAÇâO DE PARTICIPAÇâO
// ============================================

/**
 * Resetar estado de acesso restrito (quando muda para uma conversa permitida)
 */
function resetRestrictedAccessState() {
    // Remover classe de acesso restrito do chat
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.classList.remove('access-restricted');
    }
    
    // Mostrar input de mensagem
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.style.display = '';
    }
    
    // Resetar sidebar - remover overlay de acesso restrito
    const sidebar = document.getElementById('conversationSidebar');
    if (sidebar) {
        // Verificar se é a sidebar ofuscada (tem overlay de acesso restrito)
        const restrictedOverlay = sidebar.querySelector('.restricted-overlay, [style*="filter: blur"]');
        if (restrictedOverlay || sidebar.querySelector('[style*="Acesso Restrito"]')) {
            // Recarregar a sidebar via include dinâmico não é possível, 
            // mas podemos esconder o overlay
            sidebar.innerHTML = `
                <div class="text-center p-5">
                    <span class="spinner-border spinner-border-sm text-primary"></span>
                    <span class="ms-2 text-muted">Carregando...</span>
                </div>
            `;
        }
    }
}

/**
 * Mostrar view de acesso restrito (chat ofuscado com botão de solicitar)
 */
function showRestrictedAccessView(conversationId, conversation, accessInfo) {
    console.log('🔒 [showRestrictedAccessView] CHAMADA - conversationId:', conversationId, 'accessInfo:', accessInfo);
    
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatHeader = document.getElementById('chatHeader');
    
    if (!chatMessages) {
        console.error('❌ [showRestrictedAccessView] Elemento chatMessages não encontrado!');
        return;
    }
    
    console.log('✅ [showRestrictedAccessView] Elementos encontrados, montando overlay...');
    
    // Atualizar header com info bísica
    if (chatHeader) {
        const contactName = conversation.contact_name || 'Contato';
        const initials = getInitials(contactName);
        const channel = conversation.channel || 'whatsapp';
        
        const channelIcon = {
            'whatsapp': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>',
            'email': '📧',
            'chat': '💬'
        }[channel] || '💬';
        
        const avatarLabel = chatHeader.querySelector('.symbol-label');
        if (avatarLabel) {
            if (conversation.contact_avatar) {
                avatarLabel.innerHTML = `<img src="${escapeHtml(conversation.contact_avatar)}" alt="${escapeHtml(contactName)}" class="h-45px w-45px rounded" style="object-fit: cover;">`;
            } else {
                avatarLabel.textContent = initials;
            }
        }
        
        const nameEl = chatHeader.querySelector('.fw-bold');
        if (nameEl) nameEl.textContent = contactName;
        
        const channelEl = chatHeader.querySelector('.fs-7.text-muted');
        if (channelEl) {
            const channelInfo = getChannelInfo(channel || 'chat');
            channelEl.innerHTML = channelInfo.icon + ' ' + channelInfo.name;
        }
    }
    
    // Ocultar input de mensagem
    if (chatInput) {
        chatInput.style.display = 'none';
    }
    
    // Determinar texto do botão baseado no status da solicitação
    let actionButton = '';
    let statusMessage = '';
    
    // ✅ CORREÇÃO: Garantir que accessInfo existe e tem os campos necessários
    const hasPendingRequest = accessInfo && (accessInfo.has_pending_request === true || accessInfo.has_pending_request === 'true');
    
    console.log('🔒 [showRestrictedAccessView] hasPendingRequest:', hasPendingRequest);
    
    if (hasPendingRequest) {
        statusMessage = `
            <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
                <i class="ki-duotone ki-timer fs-2 me-3 text-warning">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                </i>
                <div>
                    <div class="fw-bold">Solicitação Pendente</div>
                    <div class="fs-7">Você já enviou uma solicitação para participar desta conversa. Aguarde aprovação.</div>
                </div>
            </div>
        `;
    } else {
        actionButton = `
            <button class="btn btn-primary btn-lg" onclick="requestParticipation(${conversationId})">
                <i class="ki-duotone ki-entrance-right fs-2 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                Solicitar Participação
            </button>
        `;
    }
    
    // Mostrar mensagens ofuscadas com overlay
    chatMessages.innerHTML = `
        <div class="restricted-access-container" style="position: relative; height: 100%; overflow: hidden;">
            <!-- Mensagens fake ofuscadas (blur) -->
            <div class="blurred-messages" style="filter: blur(8px); opacity: 0.5; pointer-events: none; height: 100%; padding: 20px;">
                <div class="message message-received mb-3" style="max-width: 70%; background: var(--bs-gray-200); padding: 12px 16px; border-radius: 12px;">
                    <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 80%;"></div>
                    <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 60%; margin-top: 8px;"></div>
                </div>
                <div class="message message-sent mb-3" style="max-width: 70%; background: var(--bs-primary); padding: 12px 16px; border-radius: 12px; margin-left: auto;">
                    <div style="height: 14px; background: rgba(255,255,255,0.5); border-radius: 4px; width: 90%;"></div>
                </div>
                <div class="message message-received mb-3" style="max-width: 70%; background: var(--bs-gray-200); padding: 12px 16px; border-radius: 12px;">
                    <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 70%;"></div>
                    <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 40%; margin-top: 8px;"></div>
                </div>
                <div class="message message-sent mb-3" style="max-width: 70%; background: var(--bs-primary); padding: 12px 16px; border-radius: 12px; margin-left: auto;">
                    <div style="height: 14px; background: rgba(255,255,255,0.5); border-radius: 4px; width: 70%;"></div>
                    <div style="height: 14px; background: rgba(255,255,255,0.5); border-radius: 4px; width: 50%; margin-top: 8px;"></div>
                </div>
                <div class="message message-received mb-3" style="max-width: 70%; background: var(--bs-gray-200); padding: 12px 16px; border-radius: 12px;">
                    <div style="height: 14px; background: var(--bs-gray-400); border-radius: 4px; width: 85%;"></div>
                </div>
            </div>
            
            <!-- Overlay com informaçÁes e botão -->
            <div class="access-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: rgba(var(--bs-body-bg-rgb), 0.85);">
                <div class="text-center p-5" style="max-width: 450px;">
                    <div class="mb-4">
                        <i class="ki-duotone ki-lock-2 fs-4x text-warning">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                            <span class="path4"></span>
                            <span class="path5"></span>
                        </i>
                    </div>
                    
                    <h3 class="fw-bold mb-3">Acesso Restrito</h3>
                    
                    <p class="text-muted mb-4">
                        Esta conversa está atribuída a outro agente. 
                        Para visualizar as mensagens e participar, vocì precisa solicitar participação.
                    </p>
                    
                    ${statusMessage}
                    
                    <div class="d-flex flex-column gap-3 align-items-center">
                        ${actionButton}
                        
                        <div class="text-muted fs-7 mt-3">
                            <i class="ki-duotone ki-information-3 fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            ${conversation.agent_name ? 'Atribuída a: ' + escapeHtml(conversation.agent_name) : 'Conversa atribuída'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Ocultar sidebar de detalhes
    const sidebar = document.getElementById('conversationSidebar');
    if (sidebar) {
        sidebar.classList.remove('open');
    }
    
    console.log('✅ [showRestrictedAccessView] Overlay de acesso restrito exibido com sucesso!');
}

/**
 * Solicitar participação em uma conversa
 */
function requestParticipation(conversationId) {
    Swal.fire({
        title: 'Solicitar Participação',
        html: `
            <div class="text-start">
                <p class="text-muted mb-3">
                    Você está solicitando participar desta conversa. 
                    O agente responsável ou outros participantes precisarão aprovar sua solicitação.
                </p>
                
                <div class="mb-3">
                    <label class="form-label">Motivo (opcional):</label>
                    <textarea id="swal-request-note" class="form-control" rows="3" 
                              placeholder="Explique por que deseja participar desta conversa..."></textarea>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Enviar Solicitação',
        cancelButtonText: 'Cancelar',
        showLoaderOnConfirm: true,
        preConfirm: () => {
            const note = document.getElementById('swal-request-note').value.trim();
            
            return fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/request-participation`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ note: note || null })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao enviar solicitação');
                }
                return data;
            })
            .catch(error => {
                Swal.showValidationMessage(error.message);
            });
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                icon: 'success',
                title: 'Solicitação Enviada!',
                text: 'Aguarde a aprovação do agente responsável.',
                timer: 3000,
                showConfirmButton: false
            });
            
            // Recarregar para mostrar status atualizado
            setTimeout(() => {
                selectConversation(conversationId);
            }, 1000);
        }
    });
}

/**
 * Mostrar banner de solicitaçÁes de participação pendentes
 */
function showPendingRequestsBanner(requests) {
    // Remover banner existente
    hidePendingRequestsBanner();
    
    if (!requests || requests.length === 0) return;
    
    const chatArea = document.querySelector('.chat-area');
    if (!chatArea) return;
    
    const requestsHtml = requests.map(req => `
        <div class="d-flex align-items-center justify-content-between py-2 px-3 border-bottom" data-request-id="${req.id}">
            <div class="d-flex align-items-center gap-2">
                <div class="symbol symbol-35px symbol-circle">
                    ${req.requester_avatar 
                        ? `<img src="${escapeHtml(req.requester_avatar)}" alt="">`
                        : `<span class="symbol-label bg-light-primary text-primary">${getInitials(req.requester_name || 'A')}</span>`
                    }
                </div>
                <div>
                    <div class="fw-semibold fs-7">${escapeHtml(req.requester_name || 'Agente')}</div>
                    <div class="text-muted fs-8">solicitou participar</div>
                </div>
            </div>
            <div class="d-flex gap-1">
                <button class="btn btn-sm btn-icon btn-light-success" title="Aprovar" onclick="approveParticipationRequest(${req.id})">
                    <i class="ki-duotone ki-check fs-4"><span class="path1"></span><span class="path2"></span></i>
                </button>
                <button class="btn btn-sm btn-icon btn-light-danger" title="Recusar" onclick="rejectParticipationRequest(${req.id})">
                    <i class="ki-duotone ki-cross fs-4"><span class="path1"></span><span class="path2"></span></i>
                </button>
            </div>
        </div>
    `).join('');
    
    const bannerHtml = `
        <div id="pendingRequestsBanner" class="pending-requests-banner bg-light-warning border-bottom" style="flex-shrink: 0;">
            <div class="d-flex align-items-center justify-content-between py-2 px-3 bg-warning bg-opacity-10">
                <div class="d-flex align-items-center gap-2">
                    <i class="ki-duotone ki-entrance-right fs-4 text-warning">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <span class="fw-semibold text-warning">${requests.length} solicitação(Áes) de participação</span>
                </div>
                <button class="btn btn-sm btn-icon btn-light" onclick="hidePendingRequestsBanner()">
                    <i class="ki-duotone ki-cross fs-6"><span class="path1"></span><span class="path2"></span></i>
                </button>
            </div>
            <div class="pending-requests-list" style="max-height: 150px; overflow-y: auto;">
                ${requestsHtml}
            </div>
        </div>
    `;
    
    // Inserir após o header
    const chatHeader = document.getElementById('chatHeader');
    if (chatHeader) {
        chatHeader.insertAdjacentHTML('afterend', bannerHtml);
    }
}

/**
 * Ocultar banner de solicitaçÁes pendentes
 */
function hidePendingRequestsBanner() {
    const banner = document.getElementById('pendingRequestsBanner');
    if (banner) {
        banner.remove();
    }
}

/**
 * Aprovar solicitação de participação
 */
function approveParticipationRequest(requestId) {
    fetch(`<?= \App\Helpers\Url::to('/conversations/requests') ?>/${requestId}/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Resposta não é JSON:', text.substring(0, 500));
            throw new Error('Resposta do servidor não é JSON válido');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Aprovado!',
                text: data.message || 'Solicitação aprovada com sucesso.',
                toast: true,
                position: 'top-end',
                timer: 3000,
                showConfirmButton: false
            });
            
            // Remover item do banner
            const requestItem = document.querySelector(`[data-request-id="${requestId}"]`);
            if (requestItem) {
                requestItem.remove();
            }
            
            // Verificar se ainda hí solicitaçÁes
            const banner = document.getElementById('pendingRequestsBanner');
            if (banner) {
                const remainingRequests = banner.querySelectorAll('[data-request-id]');
                if (remainingRequests.length === 0) {
                    hidePendingRequestsBanner();
                } else {
                    // Atualizar contador
                    const counter = banner.querySelector('.fw-semibold.text-warning');
                    if (counter) {
                        counter.textContent = `${remainingRequests.length} solicitação(Áes) de participação`;
                    }
                }
            }
            
            // Recarregar conversa para atualizar participantes
            if (window.currentConversationId) {
                selectConversation(window.currentConversationId);
            }
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: data.message || 'Erro ao aprovar solicitação'
            });
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao aprovar solicitação'
        });
    });
}

/**
 * Recusar solicitação de participação
 */
function rejectParticipationRequest(requestId) {
    Swal.fire({
        title: 'Recusar Solicitação',
        text: 'Tem certeza que deseja recusar esta solicitação de participação?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, Recusar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`<?= \App\Helpers\Url::to('/conversations/requests') ?>/${requestId}/reject`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Resposta não é JSON:', text.substring(0, 500));
                    throw new Error('Resposta do servidor não é JSON válido');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Recusada',
                        text: 'Solicitação recusada.',
                        toast: true,
                        position: 'top-end',
                        timer: 3000,
                        showConfirmButton: false
                    });
                    
                    // Remover item do banner
                    const requestItem = document.querySelector(`[data-request-id="${requestId}"]`);
                    if (requestItem) {
                        requestItem.remove();
                    }
                    
                    // Verificar se ainda hí solicitaçÁes
                    const banner = document.getElementById('pendingRequestsBanner');
                    if (banner) {
                        const remainingRequests = banner.querySelectorAll('[data-request-id]');
                        if (remainingRequests.length === 0) {
                            hidePendingRequestsBanner();
                        }
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message || 'Erro ao recusar solicitação'
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao recusar solicitação'
                });
            });
        }
    });
}

// ============================================
// FIM SISTEMA DE ACESSO RESTRITO
// ============================================

// Atualizar mensagens do chat
function updateChatMessages(messages, isInitialLoad = false) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages || !chatMessages.parentElement) return;
    
    if (!messages || messages.length === 0) {
        if (isInitialLoad) {
            chatMessages.innerHTML = `
                <div class="d-flex align-items-center justify-content-center" style="height: 100%;">
                    <div class="text-center text-muted">
                        <i class="ki-duotone ki-chat fs-3x mb-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        <div class="fw-semibold">Nenhuma mensagem</div>
                        <div class="fs-7">Envie a primeira mensagem</div>
                    </div>
                </div>
            `;
        }
        return;
    }
    
    // Se for carregamento inicial, limpar tudo
    if (isInitialLoad) {
        chatMessages.innerHTML = '';
    }
    
    // Adicionar mensagens
    messages.forEach(msg => {
        const messageDiv = addMessageToChat(msg);
    });
    
    // Observar elementos lazy após adicionar todas as mensagens
    if (chatMessages) {
        observeNewLazyElements(chatMessages);
    }
    
    // Scroll para última mensagem apenas no carregamento inicial
    if (isInitialLoad) {
        setTimeout(() => {
            if (chatMessages && chatMessages.scrollHeight !== undefined) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }, 100);
    }
}

// Configurar scroll infinito
function setupInfiniteScroll() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    // Remover listener anterior se existir
    chatMessages.removeEventListener('scroll', handleScroll);
    
    // Adicionar novo listener
    chatMessages.addEventListener('scroll', handleScroll);
}

// Handler de scroll para paginação infinita
function handleScroll(event) {
    const chatMessages = event.target;
    
    // Se estiver carregando ou não houver mais mensagens, não fazer nada
    if (isLoadingMessages || !hasMoreMessages || !currentConversationId) {
        return;
    }
    
    // Se scroll estiver próximo do topo (50px), carregar mais mensagens
    if (chatMessages.scrollTop <= 50) {
        loadMoreMessages();
    }
}

// Mostrar indicador de que não há mais mensagens
function showNoMoreMessagesIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    // Verificar se já existe o indicador
    const existingIndicator = document.getElementById('noMoreMessagesIndicator');
    if (existingIndicator) return;
    
    const indicator = document.createElement('div');
    indicator.id = 'noMoreMessagesIndicator';
    indicator.className = 'text-center py-3 text-muted';
    indicator.innerHTML = `
        <div class="d-flex align-items-center justify-content-center gap-2">
            <div class="border-bottom flex-grow-1" style="max-width: 100px;"></div>
            <div class="fs-7">
                <i class="ki-duotone ki-check-circle fs-5 text-success me-1">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                Início da conversa
            </div>
            <div class="border-bottom flex-grow-1" style="max-width: 100px;"></div>
        </div>
    `;
    chatMessages.insertBefore(indicator, chatMessages.firstChild);
}

// Carregar mais mensagens antigas
async function loadMoreMessages() {
    if (isLoadingMessages || !hasMoreMessages || !currentConversationId || !oldestMessageId) {
        return;
    }
    
    isLoadingMessages = true;
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) {
        isLoadingMessages = false;
        return;
    }
    
    // Salvar posição atual do scroll
    const scrollHeightBefore = chatMessages.scrollHeight;
    
    // Adicionar indicador de carregamento
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'messages-loading';
    loadingIndicator.id = 'messagesLoadingIndicator';
    loadingIndicator.innerHTML = `
        <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <span class="ms-2">Carregando mensagens antigas...</span>
    `;
    chatMessages.insertBefore(loadingIndicator, chatMessages.firstChild);
    
    try {
        const url = `<?= \App\Helpers\Url::to('/conversations') ?>/${currentConversationId}/messages?limit=50&before_id=${oldestMessageId}`;
        const response = await fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        });
        
        // Ler resposta como texto primeiro para verificar se é JSON
        const responseText = await response.text();
        
        // Verificar se a resposta foi bem-sucedida
        if (!response.ok) {
            console.error('loadMoreMessages: Erro HTTP', response.status, responseText.substring(0, 200));
            hasMoreMessages = false;
            isLoadingMessages = false;
            loadingIndicator.remove();
            return;
        }
        
        // Verificar content-type ou tentar fazer parse do JSON
        const contentType = response.headers.get('content-type') || '';
        let data;
        
        if (!contentType.includes('application/json')) {
            // Se não for JSON, verificar se o texto começa com HTML
            if (responseText.trim().startsWith('<')) {
                console.warn('loadMoreMessages: resposta HTML (provível erro PHP). Encerrando paginação.', responseText.substring(0, 200));
                hasMoreMessages = false;
                isLoadingMessages = false;
                loadingIndicator.remove();
                return;
            }
        }
        
        // Tentar fazer parse do JSON
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('loadMoreMessages: Erro ao fazer parse do JSON:', e);
            console.error('Resposta recebida:', responseText.substring(0, 500));
            hasMoreMessages = false;
            isLoadingMessages = false;
            loadingIndicator.remove();
            return;
        }
        
        if (data.success && data.messages && data.messages.length > 0) {
            // Adicionar mensagens no início do chat
            data.messages.forEach(msg => {
                const messageDiv = addMessageToChat(msg);
                chatMessages.insertBefore(messageDiv, loadingIndicator.nextSibling);
            });
            
            // Atualizar oldestMessageId
            oldestMessageId = data.messages[0].id;
            
            // Atualizar flag hasMoreMessages
            hasMoreMessages = data.has_more !== false;
            
            // Atualizar lastMessageId desta conversa com a mais nova retornada
            const lastIdx = data.messages.length - 1;
            const newest = data.messages[lastIdx];
            if (newest && newest.id && currentConversationId) {
                setLastMessageIdForConversation(currentConversationId, newest.id);
                lastMessageId = getLastMessageIdForConversation(currentConversationId);
            }
            
            // Restaurar posição do scroll
            const scrollHeightAfter = chatMessages.scrollHeight;
            const scrollDiff = scrollHeightAfter - scrollHeightBefore;
            chatMessages.scrollTop = scrollDiff;
            
            // ✅ Se não há mais mensagens, mostrar indicador
            if (!hasMoreMessages) {
                showNoMoreMessagesIndicator();
            }
        } else {
            // Não há mais mensagens
            hasMoreMessages = false;
            showNoMoreMessagesIndicator();
        }
    } catch (error) {
        console.error('Erro ao carregar mensagens antigas:', error);
    } finally {
        // Remover indicador de carregamento
        const indicator = document.getElementById('messagesLoadingIndicator');
        if (indicator) {
            indicator.remove();
        }
        isLoadingMessages = false;
    }
}

// Atualizar sidebar da conversa
function updateConversationSidebar(conversation, tags) {
    // Atualizar informaçÁes bísicas
    const sidebar = document.getElementById('conversationSidebar');
    if (!sidebar) return;
    
    // Atualizar ID da conversa no sidebar
    sidebar.dataset.conversationId = conversation.id;
    sidebar.dataset.contactId = conversation.contact_id || '';
    
    // Atualizar avatar ou iniciais do contato
    const initialsEl = sidebar.querySelector('#sidebar-contact-initials');
    if (initialsEl) {
        // Pegar o elemento pai (symbol-label)
        const symbolLabel = initialsEl.closest('.symbol-label') || initialsEl.parentElement;
        
        if (conversation.contact_avatar) {
            // Substituir por imagem do avatar
            symbolLabel.innerHTML = `<img src="${escapeHtml(conversation.contact_avatar)}" alt="Avatar" class="w-100 h-100 rounded" style="object-fit: cover;">`;
        } else if (conversation.contact_name) {
            // Atualizar iniciais
            const name = conversation.contact_name;
            const parts = name.split(' ');
            const initials = (parts[0].charAt(0) + (parts[1] ? parts[1].charAt(0) : '')).toUpperCase();
            
            // Se já é um elemento de iniciais, apenas atualizar texto
            if (initialsEl.id === 'sidebar-contact-initials') {
                initialsEl.textContent = initials;
            } else {
                // Caso contrírio, recriar elemento de iniciais
                symbolLabel.innerHTML = `<div id="sidebar-contact-initials" class="symbol-label bg-light-primary text-primary fw-bold">${initials}</div>`;
            }
        }
    }
    
    // Atualizar informaçÁes do contato
    const contactNameEl = sidebar.querySelector('[data-field="contact_name"]');
    if (contactNameEl) contactNameEl.textContent = conversation.contact_name || '-';
    
    const contactEmailEl = sidebar.querySelector('[data-field="contact_email"]');
    if (contactEmailEl) contactEmailEl.textContent = conversation.contact_email || '-';
    
    const contactPhoneEls = sidebar.querySelectorAll('[data-field="contact_phone"]');
    contactPhoneEls.forEach(el => {
        el.textContent = conversation.contact_phone || '-';
    });
    
    // Atualizar informaçÁes da conversa
    const conversationStatusEl = sidebar.querySelector('[data-field="status"]');
    if (conversationStatusEl) {
        const statusText = {
            'open': 'Aberta',
            'resolved': 'Resolvida',
            'closed': 'Fechada'
        }[conversation.status] || conversation.status;
        const statusClass = {
            'open': 'success',
            'resolved': 'info',
            'closed': 'dark'
        }[conversation.status] || 'secondary';
        conversationStatusEl.innerHTML = `<span class="badge badge-light-${statusClass}">${statusText}</span>`;
    }
    
    // Atualizar badge de SPAM
    const spamBadgeEl = sidebar.querySelector('#sidebar-spam-badge');
    if (spamBadgeEl) {
        if (conversation.is_spam) {
            spamBadgeEl.style.display = '';
        } else {
            spamBadgeEl.style.display = 'none';
        }
    }
    
    // Carregar sentimento
    if (conversation.id) {
        loadConversationSentiment(conversation.id);
    }
    
    // Carregar performance do agente (se houver análise disponível)
    if (conversation.id) {
        loadAgentPerformance(conversation.id);
    }
    
    const conversationChannelEl = sidebar.querySelector('[data-field="channel"]');
    if (conversationChannelEl) {
        if (conversation.channel === 'whatsapp') {
            // ìcone WhatsApp SVG
            const whatsappIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#25D366" style="vertical-align: middle; margin-right: 4px;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>`;
            conversationChannelEl.innerHTML = whatsappIcon + ' WhatsApp';
            
            // Mostrar informaçÁes do WhatsApp
            const whatsappInfoItem = sidebar.querySelector('#sidebar-whatsapp-info');
            const whatsappPhoneItem = sidebar.querySelector('#sidebar-whatsapp-phone');
            
            if (whatsappInfoItem && conversation.whatsapp_account_name) {
                const accountNameEl = whatsappInfoItem.querySelector('[data-field="whatsapp_account_name"]');
                if (accountNameEl) {
                    accountNameEl.textContent = conversation.whatsapp_account_name;
                }
                whatsappInfoItem.style.display = 'flex';
            }
            
            if (whatsappPhoneItem && conversation.whatsapp_account_phone) {
                const accountPhoneEl = whatsappPhoneItem.querySelector('[data-field="whatsapp_account_phone"]');
                if (accountPhoneEl) {
                    accountPhoneEl.textContent = conversation.whatsapp_account_phone;
                }
                whatsappPhoneItem.style.display = 'flex';
            }
        } else {
            const channelText = {
                'email': '📧 Email',
                'chat': '💬 Chat'
            }[conversation.channel] || conversation.channel;
            conversationChannelEl.textContent = channelText;
            
            // Ocultar informaçÁes WhatsApp se não for WhatsApp
            const whatsappInfoItem = sidebar.querySelector('#sidebar-whatsapp-info');
            const whatsappPhoneItem = sidebar.querySelector('#sidebar-whatsapp-phone');
            if (whatsappInfoItem) whatsappInfoItem.style.display = 'none';
            if (whatsappPhoneItem) whatsappPhoneItem.style.display = 'none';
        }
    }
    
    // Funil/Etapa - Card Destacado
    const funnelSection = sidebar.querySelector('#sidebar-funnel-stage-section');
    const funnelSeparator = sidebar.querySelector('#sidebar-funnel-separator');
    const funnelCard = sidebar.querySelector('#sidebar-funnel-card');
    
    if (funnelSection && funnelCard) {
        if (conversation.funnel_name || conversation.stage_name) {
            // Mostrar seção
            funnelSection.style.display = 'block';
            funnelSeparator.style.display = 'block';
            
            // Atualizar nome do funil
            const funnelNameEl = funnelCard.querySelector('[data-field="funnel_name"]');
            if (funnelNameEl) {
                funnelNameEl.textContent = conversation.funnel_name || '-';
            }
            
            // Atualizar badge da etapa
            const stageBadge = funnelCard.querySelector('#sidebar-stage-badge');
            if (stageBadge) {
                stageBadge.textContent = conversation.stage_name || '-';
                
                // Aplicar cor da etapa (se disponível)
                if (conversation.stage_color) {
                    stageBadge.style.backgroundColor = conversation.stage_color + '20';
                    stageBadge.style.color = conversation.stage_color;
                    stageBadge.style.borderColor = conversation.stage_color;
                    
                    // Aplicar cor no card
                    const cardBody = funnelCard.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.style.borderLeftColor = conversation.stage_color;
                    }
                } else {
                    // Cor padrão
                    stageBadge.className = 'badge badge-primary';
                }
            }
            
            // Atualizar tempo na etapa (futuro - por enquanto placeholder)
            const stageTime = funnelCard.querySelector('#sidebar-stage-time');
            if (stageTime && conversation.updated_at) {
                const now = new Date();
                const updatedAt = new Date(conversation.updated_at);
                const diffMs = now - updatedAt;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                let timeText = '';
                if (diffDays > 0) {
                    timeText = `⏱️ ${diffDays}d nesta etapa`;
                } else if (diffHours > 0) {
                    timeText = `⏱️ ${diffHours}h nesta etapa`;
                } else if (diffMins > 0) {
                    timeText = `⏱️ ${diffMins}min nesta etapa`;
                } else {
                    timeText = `⏱️ Agora mesmo`;
                }
                stageTime.textContent = timeText;
            }
        } else {
            funnelSection.style.display = 'none';
            funnelSeparator.style.display = 'none';
        }
    }
    
    // Atualizar setor
    const departmentEl = sidebar.querySelector('[data-field="department_name"]');
    const departmentItem = sidebar.querySelector('#sidebar-department-item');
    if (departmentEl && departmentItem) {
        if (conversation.department_name) {
            departmentEl.textContent = conversation.department_name;
            departmentItem.style.display = 'flex';
        } else {
            departmentItem.style.display = 'none';
        }
    }
    
    // Atualizar agente
    const agentNameEl = sidebar.querySelector('[data-field="agent_name"]');
    if (agentNameEl) {
        agentNameEl.textContent = conversation.agent_name || 'Não atribuído';
        if (!conversation.agent_name) {
            agentNameEl.classList.add('text-muted');
        } else {
            agentNameEl.classList.remove('text-muted');
        }
    }
    
    // Atualizar data de criação
    const createdAtEl = sidebar.querySelector('[data-field="created_at"]');
    if (createdAtEl && conversation.created_at) {
        const date = new Date(conversation.created_at);
        const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
                              date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        createdAtEl.textContent = formattedDate;
    }
    
    // Atualizar participantes
    const participantsContainer = sidebar.querySelector('#participants-list');
    const addParticipantBtn = sidebar.querySelector('#sidebar-add-participant-btn');
    const leaveConversationBtn = sidebar.querySelector('#sidebar-leave-conversation-btn');
    const loggedUserId = window.LOGGED_USER_ID ?? (parseInt('<?= (int)\App\Helpers\Auth::id() ?>') || null);
    window.LOGGED_USER_ID = loggedUserId;

    // Ações rápidas
    if (conversation.id) {
        loadConversationActions(conversation.id);
    }
    if (participantsContainer && conversation.id) {
        // Mostrar loading
        participantsContainer.innerHTML = '<div class="text-muted fs-7">Carregando...</div>';
        
        // Buscar participantes via AJAX
        fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversation.id}/participants`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao carregar participantes');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.participants) {
                const isCurrentUserParticipant = loggedUserId ? data.participants.some(p => parseInt(p.user_id) === loggedUserId) : false;
                const assignedTo = conversation.assigned_to ?? conversation.agent_id ?? null;
                const isCurrentUserAssigned = loggedUserId && assignedTo && parseInt(assignedTo) === loggedUserId;
                
                const allowManageParticipants = isCurrentUserAssigned || !isCurrentUserParticipant;
                if (data.participants.length > 0) {
                    participantsContainer.innerHTML = data.participants.map(p => {
                        const initials = (p.user_name || 'U').charAt(0).toUpperCase();
                        return `
                            <div class="d-flex align-items-center gap-2 p-2 border rounded mb-2" style="background: var(--bs-gray-100);">
                                <div class="symbol symbol-30px symbol-circle">
                                    <div class="symbol-label bg-light-primary text-primary fw-bold fs-7">
                                        ${initials}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-semibold fs-7">${escapeHtml(p.user_name || 'Usuírio')}</div>
                                    ${p.user_email ? `<div class="text-muted fs-8">${escapeHtml(p.user_email)}</div>` : ''}
                                </div>
                                ${allowManageParticipants ? `
                                    <button type="button" class="btn btn-sm btn-icon btn-light-danger p-0" 
                                            onclick="removeParticipant(${conversation.id}, ${p.user_id})" 
                                            title="Remover participante">
                                        <i class="ki-duotone ki-cross fs-7">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    participantsContainer.innerHTML = '<div class="text-muted fs-7">Nenhum participante adicional</div>';
                }
                
                if (addParticipantBtn) {
                    // Só permite adicionar participantes se for o agente principal ou não for participante comum
                    if (isCurrentUserAssigned || !isCurrentUserParticipant) {
                        addParticipantBtn.style.display = 'block';
                        addParticipantBtn.setAttribute('onclick', `showAddParticipantModal(${conversation.id})`);
                    } else {
                        addParticipantBtn.style.display = 'none';
                    }
                }
                
                if (leaveConversationBtn) {
                    if (isCurrentUserParticipant && !isCurrentUserAssigned) {
                        leaveConversationBtn.style.display = 'block';
                        leaveConversationBtn.setAttribute('onclick', `leaveConversation(${conversation.id})`);
                    } else {
                        leaveConversationBtn.style.display = 'none';
                    }
                }
            } else {
                participantsContainer.innerHTML = '<div class="text-muted fs-7">Erro ao carregar participantes</div>';
                if (leaveConversationBtn) leaveConversationBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar participantes:', error);
            participantsContainer.innerHTML = '<div class="text-muted fs-7">Erro ao carregar participantes</div>';
            if (leaveConversationBtn) leaveConversationBtn.style.display = 'none';
        });
    }
    
    // Atualizar tags
    const tagsContainer = sidebar.querySelector('.conversation-tags-list');
    if (tagsContainer) {
        if (tags && tags.length > 0) {
            tagsContainer.innerHTML = tags.map(tag => `
                <span class="badge badge-lg" style="background-color: ${tag.color}20; color: ${tag.color};">
                    ${escapeHtml(tag.name)}
                </span>
            `).join('');
        } else {
            tagsContainer.innerHTML = '<div class="text-muted fs-7">Nenhuma tag</div>';
        }
    }
    
    // Atualizar botÁes com IDs corretos
    const editContactBtn = sidebar.querySelector('#sidebar-edit-contact-btn');
    if (editContactBtn && conversation.contact_id) {
        editContactBtn.setAttribute('onclick', `editContact(${conversation.contact_id})`);
        editContactBtn.style.display = '';
    }
    
    const manageTagsBtn = sidebar.querySelector('#sidebar-manage-tags-btn');
    if (manageTagsBtn && conversation.id) {
        manageTagsBtn.setAttribute('onclick', `manageTags(${conversation.id})`);
        manageTagsBtn.style.display = '';
    }
    
    // Verificar se conversa está com agente de IA
    const escalateBtn = sidebar.querySelector('#sidebar-escalate-btn');
    if (escalateBtn && conversation.id) {
        // Verificar se conversa está com IA (buscar via API)
        checkIfConversationHasAI(conversation.id).then(hasAI => {
            if (hasAI) {
                escalateBtn.setAttribute('onclick', `escalateFromAI(${conversation.id})`);
                escalateBtn.style.display = '';
            } else {
                escalateBtn.style.display = 'none';
            }
        }).catch(() => {
            escalateBtn.style.display = 'none';
        });
    }
    
    const assignBtn = sidebar.querySelector('#sidebar-assign-btn');
    if (assignBtn && conversation.id) {
        assignBtn.setAttribute('onclick', `assignConversation(${conversation.id})`);
        assignBtn.style.display = '';
    }
    
    const departmentBtn = sidebar.querySelector('#sidebar-department-btn');
    if (departmentBtn && conversation.id) {
        departmentBtn.setAttribute('onclick', `changeDepartment(${conversation.id})`);
        departmentBtn.style.display = '';
    }
    
    const closeBtn = sidebar.querySelector('#sidebar-close-btn');
    const reopenBtn = sidebar.querySelector('#sidebar-reopen-btn');
    if (conversation.id) {
        if (conversation.status === 'open') {
            if (closeBtn) {
                closeBtn.setAttribute('onclick', `closeConversation(${conversation.id})`);
                closeBtn.style.display = '';
            }
            if (reopenBtn) reopenBtn.style.display = 'none';
        } else {
            if (reopenBtn) {
                reopenBtn.setAttribute('onclick', `reopenConversation(${conversation.id})`);
                reopenBtn.style.display = '';
            }
            if (closeBtn) closeBtn.style.display = 'none';
        }
    }
    
    const spamBtn = sidebar.querySelector('#sidebar-spam-btn');
    if (spamBtn && conversation.id) {
        spamBtn.setAttribute('onclick', `markAsSpam(${conversation.id})`);
        spamBtn.style.display = '';
    }
    
    const addNoteBtn = sidebar.querySelector('#sidebar-add-note-btn');
    if (addNoteBtn && conversation.id) {
        addNoteBtn.setAttribute('onclick', `addNote(${conversation.id})`);
        addNoteBtn.style.display = '';
    }
    
    // Carregar status da IA na conversa
    console.log('🔧 Tentando carregar status da IA...', {
        conversationId: conversation.id,
        loadAIAgentStatusExists: typeof loadAIAgentStatus
    });
    if (conversation.id && typeof loadAIAgentStatus === 'function') {
        console.log('✓ Chamando loadAIAgentStatus para conversation.id:', conversation.id);
        loadAIAgentStatus(conversation.id);
    } else {
        console.warn('❌ loadAIAgentStatus não está disponível ou conversation.id está vazio');
    }
    
    // Atualizar timeline
    updateConversationTimeline(conversation.id);

    // Atualizar histórico (aba Histórico)
    loadContactHistory(conversation.contact_id);
    
    // Carregar agentes do contato
    loadContactAgents(conversation.contact_id);
    
    // ✅ Carregar Automação da conversa
    if (typeof window.loadAutomationStatus === 'function') {
        window.loadAutomationStatus(conversation.id);
    }
    
    // ✅ Carregar SLA da conversa
    console.log('🎯 Tentando carregar SLA no updateConversationSidebar, ID:', conversation.id);
    if (typeof window.loadConversationSLA === 'function') {
        console.log('✅ loadConversationSLA encontrada, chamando...');
        window.loadConversationSLA(conversation.id);
    } else {
        console.error('❌ Função loadConversationSLA NÃO encontrada!', 'Type:', typeof window.loadConversationSLA);
    }
    
    // ✅ Verificar se há outras conversas abertas do mesmo contato (para mesclar)
    if (conversation.id && conversation.channel === 'whatsapp') {
        checkOtherOpenConversations(conversation.id);
    } else {
        // Esconder avisos se não for WhatsApp
        const alertEl = document.getElementById('sidebar-multiple-conversations-alert');
        if (alertEl) alertEl.style.display = 'none';
        const chatMergeAlert = document.getElementById('chat-merge-alert');
        if (chatMergeAlert) chatMergeAlert.style.display = 'none';
    }
    
    // ✅ Mostrar números vinculados e "Respondendo via" (se conversa mesclada)
    const replyViaEl = document.getElementById('sidebar-reply-via');
    if (conversation.is_merged && conversation.linked_account_ids) {
        loadLinkedAccounts(conversation.id, conversation.last_customer_account_id);
    } else {
        const linkedEl = document.getElementById('sidebar-linked-accounts');
        if (linkedEl) linkedEl.style.display = 'none';
        if (replyViaEl) replyViaEl.style.display = 'none';
    }
}

// Verificar outras conversas abertas do mesmo contato
async function checkOtherOpenConversations(conversationId) {
    const alertEl = document.getElementById('sidebar-multiple-conversations-alert');
    const infoEl = document.getElementById('sidebar-other-conversations-info');
    const chatMergeAlert = document.getElementById('chat-merge-alert');
    const chatMergeInfo = document.getElementById('chat-merge-alert-info');
    
    // Verificar se já foi dispensado para esta conversa
    const dismissedKey = `merge_dismissed_${conversationId}`;
    const wasDismissed = sessionStorage.getItem(dismissedKey) === 'true';
    
    try {
        const response = await fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/check-others`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success && data.data && data.data.has_others) {
            const convs = data.data.conversations;
            const count = data.data.count;
            
            // Guardar IDs para mesclagem
            window.otherConversationsToMerge = convs.map(c => c.id);
            
            // Montar texto informativo com agente
            const details = convs.map(c => {
                const phone = c.account_phone || c.account_name || 'Sem número';
                const agent = c.agent_name || 'Sem agente';
                return `${phone} (${agent})`;
            }).join(', ');
            const infoText = `${count} conversa${count > 1 ? 's' : ''} em: ${details}`;
            
            // Atualizar sidebar - ✅ SEMPRE MOSTRAR (não depende de permissão)
            if (alertEl && infoEl) {
                infoEl.innerHTML = infoText;
                alertEl.style.display = 'block';
            }
            
            // Atualizar banner do chat - ✅ SEMPRE MOSTRAR (não depende de permissão)
            if (chatMergeAlert && chatMergeInfo && !wasDismissed) {
                chatMergeInfo.textContent = infoText;
                chatMergeAlert.style.display = 'block';
                // Guardar ID da conversa atual para o dismiss
                chatMergeAlert.dataset.conversationId = conversationId;
            }
        } else {
            // Esconder alertas
            if (alertEl) alertEl.style.display = 'none';
            if (chatMergeAlert) chatMergeAlert.style.display = 'none';
        }
    } catch (error) {
        console.error('Erro ao verificar outras conversas:', error);
        if (alertEl) alertEl.style.display = 'none';
        if (chatMergeAlert) chatMergeAlert.style.display = 'none';
    }
}

// Dispensar alerta de mesclar (apenas para sessão atual)
function dismissMergeAlert() {
    const chatMergeAlert = document.getElementById('chat-merge-alert');
    if (chatMergeAlert) {
        const conversationId = chatMergeAlert.dataset.conversationId;
        if (conversationId) {
            sessionStorage.setItem(`merge_dismissed_${conversationId}`, 'true');
        }
        chatMergeAlert.style.display = 'none';
    }
}

// Carregar contas vinculadas (conversa mesclada)
async function loadLinkedAccounts(conversationId, lastCustomerAccountId = null) {
    const linkedEl = document.getElementById('sidebar-linked-accounts');
    const valueEl = linkedEl?.querySelector('[data-field="linked_accounts"]');
    const replyViaEl = document.getElementById('sidebar-reply-via');
    const replyPhoneEl = replyViaEl?.querySelector('[data-field="reply_via_phone"]');
    
    if (!linkedEl || !valueEl) return;
    
    try {
        const response = await fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/linked-accounts`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success && data.data && data.data.length > 0) {
            const accounts = data.data;
            
            // Mostrar todos os números vinculados
            if (accounts.length > 1) {
                valueEl.textContent = accounts.map(a => a.phone_number || a.name).join(', ');
                linkedEl.style.display = 'flex';
            } else {
                linkedEl.style.display = 'none';
            }
            
            // Mostrar por qual número a resposta será enviada
            if (replyViaEl && replyPhoneEl) {
                let replyAccount = null;
                if (lastCustomerAccountId) {
                    replyAccount = accounts.find(a => a.id == lastCustomerAccountId);
                }
                if (!replyAccount) {
                    replyAccount = accounts[0]; // Primeiro = principal
                }
                replyPhoneEl.textContent = replyAccount?.phone_number || replyAccount?.name || '-';
                replyViaEl.style.display = accounts.length > 1 ? 'flex' : 'none';
            }
        } else {
            linkedEl.style.display = 'none';
            if (replyViaEl) replyViaEl.style.display = 'none';
        }
    } catch (error) {
        console.error('Erro ao carregar contas vinculadas:', error);
        linkedEl.style.display = 'none';
        if (replyViaEl) replyViaEl.style.display = 'none';
    }
}

// Abrir modal de mesclagem
function openMergeModal() {
    const conversationId = window.currentConversationId;
    if (!conversationId) {
        toastr.error('Nenhuma conversa selecionada');
        return;
    }
    
    const listEl = document.getElementById('merge-conversations-list');
    if (!listEl) return;
    
    // Mostrar conversas a mesclar
    if (window.otherConversationsToMerge && window.otherConversationsToMerge.length > 0) {
        fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/check-others`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data && data.data.conversations) {
                const convs = data.data.conversations;
                listEl.innerHTML = convs.map(c => `
                    <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                        <div>
                            <div class="fw-bold">${escapeHtml(c.account_name)}</div>
                            <div class="text-muted fs-7">${escapeHtml(c.account_phone)} • ${c.message_count} mensagens</div>
                        </div>
                        <label class="form-check form-check-custom form-check-solid">
                            <input class="form-check-input merge-conv-checkbox" type="checkbox" value="${c.id}" checked>
                        </label>
                    </div>
                `).join('');
            }
        });
    } else {
        listEl.innerHTML = '<div class="text-muted">Nenhuma conversa para mesclar</div>';
    }
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_merge_conversations'));
    modal.show();
}

// Executar mesclagem
async function executeMerge() {
    const conversationId = window.currentConversationId;
    if (!conversationId) {
        toastr.error('Nenhuma conversa selecionada');
        return;
    }
    
    // Pegar IDs marcados
    const checkboxes = document.querySelectorAll('.merge-conv-checkbox:checked');
    const sourceIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (sourceIds.length === 0) {
        toastr.warning('Selecione pelo menos uma conversa para mesclar');
        return;
    }
    
    try {
        const response = await fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/merge`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ source_conversation_ids: sourceIds })
        });
        
        const data = await response.json();
        
        if (data.success) {
            toastr.success(data.message);
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_merge_conversations'));
            if (modal) modal.hide();
            
            // Recarregar conversa e lista
            setTimeout(() => {
                selectConversation(conversationId);
                refreshConversationList();
            }, 500);
        } else {
            // Fechar modal de merge primeiro
            const mergeModal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_merge_conversations'));
            if (mergeModal) mergeModal.hide();
            
            // Mostrar modal de alerta com a mensagem de erro
            Swal.fire({
                icon: 'warning',
                title: 'Não é possível mesclar',
                html: `<div class="fs-5">${data.message || 'Erro ao mesclar conversas'}</div>`,
                confirmButtonText: 'Entendi',
                confirmButtonColor: '#f6c000',
                customClass: {
                    popup: 'swal2-popup-custom',
                    title: 'fw-bold'
                }
            });
        }
    } catch (error) {
        console.error('Erro ao mesclar:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro de conexão',
            text: 'Não foi possível conectar ao servidor. Tente novamente.',
            confirmButtonText: 'Ok',
            confirmButtonColor: '#f1416c'
        });
    }
}

// =====================================================
// TROCA DE NÚMERO DE ENVIO
// =====================================================

// Variável para armazenar a conta selecionada
window.selectedNewAccountId = null;

// Abrir modal de troca de conta
async function openChangeAccountModal() {
    const conversationId = window.currentConversationId;
    if (!conversationId) {
        toastr.error('Nenhuma conversa selecionada');
        return;
    }
    
    const listEl = document.getElementById('change-account-list');
    const currentEl = document.getElementById('change-account-current');
    
    if (!listEl || !currentEl) return;
    
    // Mostrar loading
    listEl.innerHTML = '<div class="text-muted p-3">Carregando números...</div>';
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_change_account'));
    modal.show();
    
    try {
        // Buscar conversa atual e contas disponíveis em paralelo
        const [convResponse, accountsResponse] = await Promise.all([
            fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
            }),
            fetch(`<?= \App\Helpers\Url::to('/api/integration-accounts/whatsapp') ?>`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
            })
        ]);
        
        const convData = await convResponse.json();
        const accountsData = await accountsResponse.json();
        
        const conversation = convData.data || convData.conversation || convData;
        const accounts = accountsData.data || accountsData.accounts || accountsData || [];
        
        // Mostrar conta atual
        const currentAccountId = conversation.integration_account_id || conversation.whatsapp_account_id;
        const currentPhone = conversation.whatsapp_account_phone || conversation.account_phone || 'Não definido';
        const currentName = conversation.whatsapp_account_name || conversation.account_name || '';
        currentEl.innerHTML = `<strong>${escapeHtml(currentPhone)}</strong> ${currentName ? '(' + escapeHtml(currentName) + ')' : ''}`;
        
        // Listar contas disponíveis
        if (!Array.isArray(accounts) || accounts.length === 0) {
            listEl.innerHTML = '<div class="text-muted p-3">Nenhum número disponível</div>';
            return;
        }
        
        window.selectedNewAccountId = null;
        
        // ✅ CORRIGIDO: Comparar por telefone (único) ao invés de ID (pode conflitar entre tabelas)
        const normalizePhone = (phone) => (phone || '').replace(/\D/g, '');
        const currentPhoneNormalized = normalizePhone(currentPhone);
        
        listEl.innerHTML = accounts.map(acc => {
            // Comparar por telefone normalizado para evitar conflito de IDs entre tabelas
            const accPhoneNormalized = normalizePhone(acc.phone_number);
            const isCurrentAccount = currentPhoneNormalized && accPhoneNormalized && currentPhoneNormalized === accPhoneNormalized;
            const statusBadge = acc.status === 'active' 
                ? '<span class="badge badge-success ms-2">Conectado</span>' 
                : '<span class="badge badge-danger ms-2">Desconectado</span>';
            
            return `
                <label class="d-flex align-items-center p-3 border-bottom cursor-pointer hover-bg-light ${isCurrentAccount ? 'bg-light-primary' : ''}" style="cursor: pointer;">
                    <input type="radio" name="new_account" value="${acc.id}" class="form-check-input me-3" 
                           ${isCurrentAccount ? 'checked' : ''} 
                           onchange="window.selectedNewAccountId = ${acc.id}">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${escapeHtml(acc.name || 'Sem nome')}</div>
                        <div class="text-muted fs-7">${escapeHtml(acc.phone_number || '')}</div>
                    </div>
                    ${statusBadge}
                    ${isCurrentAccount ? '<span class="badge badge-light-primary ms-2">Atual</span>' : ''}
                </label>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro ao carregar contas:', error);
        listEl.innerHTML = '<div class="text-danger p-3">Erro ao carregar números</div>';
    }
}

// Confirmar troca de conta
async function confirmChangeAccount() {
    const conversationId = window.currentConversationId;
    const newAccountId = window.selectedNewAccountId;
    
    if (!conversationId) {
        toastr.error('Nenhuma conversa selecionada');
        return;
    }
    
    if (!newAccountId) {
        toastr.warning('Selecione um número');
        return;
    }
    
    try {
        const response = await fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/change-account`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ account_id: newAccountId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            toastr.success(data.message || 'Número alterado com sucesso!');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_change_account'));
            if (modal) modal.hide();
            
            // Recarregar conversa
            selectConversation(conversationId);
        } else {
            toastr.error(data.message || 'Erro ao alterar número');
        }
    } catch (error) {
        console.error('Erro ao alterar conta:', error);
        toastr.error('Erro de conexão');
    }
}

// Atualizar timeline da conversa
function updateConversationTimeline(conversationId) {
    if (!conversationId) return;
    
    const timelineContainer = document.querySelector('#kt_tab_timeline .timeline');
    if (!timelineContainer) return;
    
    // Mostrar loading
    timelineContainer.innerHTML = `
        <div class="text-center py-5">
            <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
            <div class="text-muted fs-7 mt-2">Carregando timeline...</div>
        </div>
    `;
    
    // Buscar atividades da conversa, notas e timeline em paralelo
    Promise.all([
        fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        }).then(r => r.json()),
        fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/notes`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        }).then(r => r.json()).catch(() => ({ success: true, notes: [] })),
        fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/timeline`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        }).then(r => r.json()).catch(() => ({ success: true, events: [] }))
    ])
        .then(([data, notesData, timelineData]) => {
            if (!data.success || !data.conversation) {
                timelineContainer.innerHTML = '<div class="text-muted fs-7 text-center py-5">Erro ao carregar timeline</div>';
                return;
            }
            
            const conv = data.conversation;
            const messages = data.messages || [];
            const notes = notesData.success ? (notesData.notes || []) : [];
            const timelineEvents = timelineData.success ? (timelineData.events || []) : [];
            
            // Combinar todos os eventos em um array para ordenar por data
            const events = [];
            
            // Evento de criação
            if (conv.created_at) {
                events.push({
                    type: 'created',
                    date: conv.created_at,
                    icon: 'ki-message-text-2',
                    color: 'primary',
                    title: 'Conversa criada',
                    description: null,
                    user_name: null
                });
            }
            
            // Atribuição (verificar se não hí evento mais recente de atividades)
            const hasRecentAssignment = timelineEvents.some(e => e.type === 'assigned');
            if (conv.agent_id && conv.agent_name && !hasRecentAssignment) {
                events.push({
                    type: 'assigned',
                    date: conv.updated_at || conv.created_at,
                    icon: 'ki-profile-user',
                    color: 'info',
                    title: `Atribuída a ${escapeHtml(conv.agent_name)}`,
                    description: null,
                    user_name: null
                });
            }
            
            // Adicionar eventos da timeline (atividades)
            timelineEvents.forEach(event => {
                events.push(event);
            });
            
            // Mensagens importantes (primeira e última) - apenas se não houver muitas mensagens
            if (messages.length > 0 && messages.length <= 50) {
                const firstMsg = messages[0];
                const lastMsg = messages[messages.length - 1];
                
                if (firstMsg && firstMsg.id !== lastMsg?.id) {
                    events.push({
                        type: 'first_message',
                        date: firstMsg.created_at,
                        icon: 'ki-message',
                        color: 'success',
                        title: 'Primeira mensagem',
                        description: null,
                        user_name: null
                    });
                }
                
                if (lastMsg) {
                    events.push({
                        type: 'last_message',
                        date: lastMsg.created_at,
                        icon: 'ki-message',
                        color: 'warning',
                        title: 'Última mensagem',
                        description: null,
                        user_name: null
                    });
                }
            }
            
            // Notas internas
            notes.forEach(note => {
                const userInitials = getInitials(note.user_name || 'U');
                events.push({
                    type: 'note',
                    date: note.created_at,
                    icon: 'ki-note-edit',
                    color: 'secondary',
                    title: `Nota por ${escapeHtml(note.user_name || 'Usuírio')}`,
                    description: escapeHtml(note.content),
                    userInitials: userInitials,
                    noteId: note.id,
                    userId: note.user_id,
                    isPrivate: note.is_private,
                    user_name: note.user_name
                });
            });
            
            // Status - verificar se não hí evento mais recente
            const hasRecentStatusChange = timelineEvents.some(e => e.type === 'closed' || e.type === 'reopened');
            if (conv.status === 'closed' && conv.resolved_at && !hasRecentStatusChange) {
                events.push({
                    type: 'closed',
                    date: conv.resolved_at,
                    icon: 'ki-cross-circle',
                    color: 'dark',
                    title: 'Conversa fechada',
                    description: null,
                    user_name: null
                });
            }
            
            // Adicionar evento de reabertura se status for open mas havia evento de fechamento
            if (conv.status === 'open' && timelineEvents.some(e => e.type === 'closed')) {
                const lastClosed = timelineEvents.filter(e => e.type === 'closed').sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                if (lastClosed) {
                    const reopenedEvent = timelineEvents.find(e => e.type === 'reopened' && new Date(e.date) > new Date(lastClosed.date));
                    if (!reopenedEvent) {
                        events.push({
                            type: 'reopened',
                            date: conv.updated_at || new Date().toISOString(),
                            icon: 'ki-entrance-right',
                            color: 'success',
                            title: 'Conversa reaberta',
                            description: null,
                            user_name: null
                        });
                    }
                }
            }
            
            // Ordenar eventos por data (mais recente primeiro)
            events.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Gerar HTML da timeline
            let timelineHtml = '';
            events.forEach((event, index) => {
                const isLast = index === events.length - 1;
                const lineClass = isLast ? '' : 'w-40px';
                
                if (event.type === 'note') {
                    timelineHtml += `
                        <div class="timeline-item">
                            <div class="timeline-line ${lineClass}"></div>
                            <div class="timeline-icon symbol symbol-circle symbol-40px">
                                <div class="symbol-label bg-light-${event.color}">
                                    ${event.userInitials ? `
                                        <div class="symbol-label bg-light-${event.color} text-${event.color} fw-bold fs-7">
                                            ${event.userInitials}
                                        </div>
                                    ` : `
                                        <i class="ki-duotone ${event.icon} fs-2 text-${event.color}">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    `}
                                </div>
                            </div>
                            <div class="timeline-content mb-10">
                                <div class="fw-semibold text-gray-800">${event.title}</div>
                                ${event.description ? `<div class="text-gray-700 fs-7 mt-2 p-3 bg-light rounded">${event.description}</div>` : ''}
                                <div class="text-muted fs-7 mt-1">${formatDateTime(event.date)}</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Determinar se mostra nome do usuírio
                    const showUserName = event.user_name && event.type !== 'note';
                    const userInfo = showUserName ? `<div class="text-muted fs-8 mt-1">por ${escapeHtml(event.user_name)}</div>` : '';
                    
                    // Player de gravação de chamada
                    let recordingPlayer = '';
                    if (event.recording_url) {
                        recordingPlayer = `
                            <div class="mt-2 p-2 bg-light-primary rounded">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="ki-duotone ki-headphones fs-4 text-primary">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    <span class="fs-8 fw-semibold text-primary">Gravação da Chamada</span>
                                </div>
                                <audio controls class="w-100" style="height: 32px;">
                                    <source src="${event.recording_url}" type="audio/mpeg">
                                    <source src="${event.recording_url}" type="audio/wav">
                                    Seu navegador não suporta áudio.
                                </audio>
                            </div>
                        `;
                    }
                    
                    timelineHtml += `
                        <div class="timeline-item">
                            <div class="timeline-line ${lineClass}"></div>
                            <div class="timeline-icon symbol symbol-circle symbol-40px">
                                <div class="symbol-label bg-light-${event.color}">
                                    <i class="ki-duotone ${event.icon} fs-2 text-${event.color}">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        ${event.icon.includes('message-text') ? '<span class="path3"></span>' : ''}
                                        ${event.icon.includes('arrows-circle') ? '<span class="path3"></span><span class="path4"></span>' : ''}
                                        ${event.icon.includes('entrance-right') ? '<span class="path3"></span>' : ''}
                                    </i>
                                </div>
                            </div>
                            <div class="timeline-content mb-10">
                                <div class="fw-semibold text-gray-800">${event.title}</div>
                                ${event.description ? `<div class="text-muted fs-7 mt-1">${event.description}</div>` : ''}
                                ${userInfo}
                                <div class="text-muted fs-7 mt-1">${formatDateTime(event.date)}</div>
                                ${recordingPlayer}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (timelineHtml === '') {
                timelineHtml = '<div class="text-muted fs-7 text-center py-5">Nenhum evento na timeline</div>';
            }
            
            timelineContainer.innerHTML = timelineHtml;
        })
        .catch(error => {
            console.error('Erro ao carregar timeline:', error);
            timelineContainer.innerHTML = '<div class="text-muted fs-7 text-center py-5">Erro ao carregar timeline</div>';
        });
}

// Carregar sentimento da conversa (Accordion)
function loadConversationSentiment(conversationId) {
    if (!conversationId) return;
    
    // Elementos do Accordion de Sentimento
    const sentimentSection = document.getElementById('sidebar-sentiment-section');
    const sentimentLabel = document.getElementById('sentiment-label-accordion');
    const sentimentProgress = document.getElementById('sentiment-progress-accordion');
    const sentimentScore = document.getElementById('sentiment-score-accordion');
    const sentimentBadge = document.getElementById('sentiment-accordion-badge');
    
    if (!sentimentSection) return;
    
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/sentiment`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success || !data.sentiment) {
            sentimentSection.style.display = 'none';
            return;
        }
        
        const sentiment = data.sentiment;
        const score = parseFloat(sentiment.sentiment_score || 0);
        const label = sentiment.sentiment_label || 'neutral';
        
        // Calcular porcentagem para barra de progresso (score de -1 a 1 vira 0 a 100)
        const percentage = ((score + 1) / 2) * 100;
        
        // Determinar cor baseado no sentimento
        let colorClass = 'secondary';
        let labelText = 'Neutro';
        let emoji = '😐';
        if (label === 'positive') {
            colorClass = 'success';
            labelText = 'Positivo';
            emoji = '😊';
        } else if (label === 'negative') {
            colorClass = 'danger';
            labelText = 'Negativo';
            emoji = '😟';
        }
        
        if (sentimentLabel) sentimentLabel.innerHTML = `<span class="badge badge-light-${colorClass}">${labelText}</span>`;
        if (sentimentProgress) {
            sentimentProgress.className = `progress-bar bg-${colorClass}`;
            sentimentProgress.style.width = `${percentage}%`;
        }
        if (sentimentScore) sentimentScore.textContent = `Score: ${score.toFixed(2)}`;
        if (sentimentBadge) {
            sentimentBadge.className = `badge badge-sm badge-light-${colorClass} ms-auto me-3`;
            sentimentBadge.textContent = emoji;
        }
        
        sentimentSection.style.display = 'block';
    })
    .catch(error => {
        console.error('Erro ao carregar sentimento:', error);
        sentimentSection.style.display = 'none';
    });
}

// Carregar performance do agente na conversa (Accordion)
function loadAgentPerformance(conversationId) {
    if (!conversationId) return;
    
    // Elementos do Accordion de Performance
    const performanceSection = document.getElementById('sidebar-performance-section');
    const analyzedState = document.getElementById('performance-analyzed-accordion');
    const pendingState = document.getElementById('performance-pending-accordion');
    const pendingReason = document.getElementById('performance-pending-reason-accordion');
    const overallBadge = document.getElementById('performance-overall-accordion');
    const progressBar = document.getElementById('performance-progress-accordion');
    const detailsEl = document.getElementById('performance-details-accordion');
    const viewLink = document.getElementById('performance-view-link-accordion');
    const accordionBadge = document.getElementById('performance-accordion-badge');
    
    if (!performanceSection) return;
    
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/performance`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            performanceSection.style.display = 'none';
            return;
        }
        
        // Se tem análise, mostrar dados
        if (data.analysis && data.analysis.overall_score) {
            const analysis = data.analysis;
            const score = parseFloat(analysis.overall_score || 0);
            const percentage = (score / 5) * 100;
            
            // Determinar cor baseado na nota
            let colorClass = 'danger';
            let emoji = '😟';
            if (score >= 4.5) {
                colorClass = 'success';
                emoji = '🌟';
            } else if (score >= 3.5) {
                colorClass = 'primary';
                emoji = '😊';
            } else if (score >= 2.5) {
                colorClass = 'warning';
                emoji = '😐';
            }
            
            // Atualizar badge do header do accordion
            if (accordionBadge) {
                accordionBadge.className = `badge badge-sm badge-light-${colorClass} ms-auto me-3`;
                accordionBadge.textContent = `${emoji} ${score.toFixed(1)}`;
            }
            
            // Atualizar badge interno
            if (overallBadge) {
                overallBadge.className = `badge badge-lg badge-light-${colorClass}`;
                overallBadge.textContent = `${emoji} ${score.toFixed(2)}/5.00`;
            }
            
            // Atualizar barra de progresso
            if (progressBar) {
                progressBar.className = `progress-bar bg-${colorClass}`;
                progressBar.style.width = `${percentage}%`;
            }
            
            // Atualizar detalhes
            if (detailsEl) {
                const topStrengths = analysis.strengths ? JSON.parse(analysis.strengths).slice(0, 2) : [];
                const topWeaknesses = analysis.weaknesses ? JSON.parse(analysis.weaknesses).slice(0, 2) : [];
                
                let html = '<div class="fs-8">';
                if (topStrengths.length > 0) {
                    html += `<div class="text-success mb-1">✓ ${topStrengths[0]}</div>`;
                }
                if (topWeaknesses.length > 0) {
                    html += `<div class="text-warning">⚠ ${topWeaknesses[0]}</div>`;
                }
                html += '</div>';
                detailsEl.innerHTML = html;
            }
            
            // Atualizar link
            if (viewLink) {
                viewLink.href = `<?= \App\Helpers\Url::to('/agent-performance/conversation') ?>/${conversationId}`;
            }
            
            // Mostrar estado analisado
            if (analyzedState) analyzedState.style.display = 'block';
            if (pendingState) pendingState.style.display = 'none';
            
        } else {
            // Sem análise ainda, mostrar estado pendente
            const reason = data.pending_reason || 'A análise será processada em breve';
            if (pendingReason) {
                pendingReason.textContent = reason;
            }
            
            if (accordionBadge) {
                accordionBadge.className = 'badge badge-sm badge-light-warning ms-auto me-3';
                accordionBadge.textContent = '⏳';
            }
            
            if (analyzedState) analyzedState.style.display = 'none';
            if (pendingState) pendingState.style.display = 'block';
        }
        
        performanceSection.style.display = 'block';
    })
    .catch(error => {
        console.error('Erro ao carregar performance:', error);
        performanceSection.style.display = 'none';
    });
}

function loadContactHistory(contactId) {
    if (!contactId) return;
    const countEl = document.getElementById('history-conversations-count');
    const avgEl = document.getElementById('history-avg-time');
    const csatEl = document.getElementById('history-satisfaction');
    const listEl = document.getElementById('history-previous-conversations');

    // Placeholders
    if (countEl) countEl.textContent = '-';
    if (avgEl) avgEl.textContent = '-';
    if (csatEl) csatEl.textContent = '-';
    if (listEl) listEl.innerHTML = `<div class="text-center py-5"><p class="text-muted fs-7">Carregando...</p></div>`;

    fetch(`<?= \App\Helpers\Url::to('/contacts') ?>/${contactId}/history`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        console.log('📊 Dados do histórico:', data);
        
        if (!data.success) {
            if (listEl) listEl.innerHTML = `<div class="text-center py-5"><p class="text-muted fs-7">Erro ao carregar histórico</p></div>`;
            if (countEl) countEl.textContent = '-';
            if (avgEl) avgEl.textContent = '-';
            if (csatEl) csatEl.textContent = '--';
            return;
        }
        
        const total = data.total_conversations ?? 0;
        const avgSec = data.avg_duration_seconds;
        const avgMin = data.avg_duration_minutes;
        const avgHours = data.avg_duration_hours;
        const csat = data.csat_score;
        const previous = data.previous_conversations || [];

        // Atualizar contador de conversas
        if (countEl) countEl.textContent = total;
        
        // Atualizar tempo mêdio
        if (avgEl) {
            if (avgSec !== null && avgSec !== undefined && avgSec > 0) {
                avgEl.textContent = formatDuration(avgSec);
            } else if (total === 0) {
                avgEl.textContent = 'Sem dados';
            } else {
                avgEl.textContent = '-';
            }
        }
        
        // Atualizar CSAT (ainda não implementado)
        if (csatEl) csatEl.textContent = csat !== null && csat !== undefined ? csat : '--';

        if (!previous.length) {
            if (listEl) listEl.innerHTML = `<div class="text-center py-5"><p class="text-muted fs-7">Nenhuma conversa anterior</p></div>`;
            return;
        }

        let html = '';
        previous.forEach(conv => {
            const lastMsg = conv.last_message ? escapeHtml(conv.last_message.substring(0, 60)) + (conv.last_message.length > 60 ? '...' : '') : 'Sem mensagens';
            const updatedAt = conv.updated_at || conv.created_at;
            const statusBadgeClass = conv.status === 'closed' || conv.status === 'resolved' ? 'badge-light-success' : 'badge-light-secondary';
            const msgCount = conv.message_count || 0;
            
            html += `
                <div class="d-flex flex-column p-3 border rounded mb-2 bg-light-dark cursor-pointer hover-elevate-up" 
                     onclick="selectConversation(${conv.id})" 
                     style="transition: all 0.2s; cursor: pointer;"
                     title="Clique para abrir esta conversa">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="fw-semibold">
                            <i class="ki-duotone ki-message-text fs-6 text-primary me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            Conversa #${conv.id}
                        </span>
                        <span class="badge ${statusBadgeClass}">${conv.status || ''}</span>
                    </div>
                    <div class="text-muted fs-8">
                        <i class="ki-duotone ki-calendar fs-7 me-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        ${formatDateTime(updatedAt)}
                    </div>
                    <div class="text-muted fs-8 mt-1">
                        <i class="ki-duotone ki-message-text-2 fs-7 me-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        ${msgCount} mensagens
                    </div>
                    <div class="text-muted fs-8 mt-1">${lastMsg}</div>
                </div>
            `;
        });
        if (listEl) listEl.innerHTML = html;
    })
    .catch(error => {
        console.error('❌ Erro ao carregar histórico:', error);
        if (listEl) listEl.innerHTML = `<div class="text-center py-5"><p class="text-muted fs-7">Erro ao carregar histórico</p></div>`;
        if (countEl) countEl.textContent = '-';
        if (avgEl) avgEl.textContent = '-';
        if (csatEl) csatEl.textContent = '--';
    });
}

function formatDuration(seconds) {
    const sec = Math.max(0, Math.round(seconds));
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    if (h > 0) return `${h}h ${m}m`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
}

function formatDateTime(dt) {
    if (!dt) return '-';
    const d = new Date(dt);
    if (isNaN(d.getTime())) return dt;
    return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
           ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

// Função auxiliar para obter iniciais do nome
function getInitials(name) {
    if (!name) return 'U';
    const parts = name.trim().split(' ');
    if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Carregar agentes do contato na sidebar
function loadContactAgents(contactId) {
    if (!contactId) return;
    
    const agentsListEl = document.getElementById('contact-agents-list');
    const manageBtn = document.getElementById('sidebar-manage-contact-agents-btn');
    
    if (!agentsListEl) return;
    
    fetch(`<?= \App\Helpers\Url::to('/contacts') ?>/${contactId}/agents`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success || !data.agents) {
            agentsListEl.innerHTML = '<div class="text-muted fs-7">Nenhum agente atribuído</div>';
            if (manageBtn) manageBtn.style.display = 'none';
            return;
        }
        
        const agents = data.agents || [];
        
        if (agents.length === 0) {
            agentsListEl.innerHTML = '<div class="text-muted fs-7">Nenhum agente atribuído</div>';
            if (manageBtn) manageBtn.style.display = 'none';
            return;
        }
        
        // Renderizar lista de agentes
        let html = '';
        agents.forEach(agent => {
            const isPrimary = agent.is_primary == 1 || agent.is_primary === true;
            const agentName = agent.agent_name || agent.name || 'Agente';
            const agentEmail = agent.agent_email || agent.email || '';
            const initials = getInitials(agentName);
            
            html += `
                <div class="d-flex align-items-center gap-2 p-2 border rounded mb-2" style="background: var(--bs-gray-100);">
                    <div class="symbol symbol-30px symbol-circle">
                        <div class="symbol-label bg-light-primary text-primary fw-bold fs-7">
                            ${initials}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold fs-7">
                            ${escapeHtml(agentName)}
                            ${isPrimary ? '<span class="badge badge-sm badge-primary ms-1">Principal</span>' : ''}
                        </div>
                        ${agentEmail ? `<div class="text-muted fs-8">${escapeHtml(agentEmail)}</div>` : ''}
                    </div>
                </div>
            `;
        });
        
        agentsListEl.innerHTML = html;
        
        // Mostrar botão de gerenciar se tiver permissão
        if (manageBtn) {
            manageBtn.setAttribute('onclick', `manageContactAgents(${contactId})`);
            manageBtn.style.display = '';
        }
    })
    .catch(error => {
        console.error('Erro ao carregar agentes do contato:', error);
        agentsListEl.innerHTML = '<div class="text-muted fs-7">Erro ao carregar agentes</div>';
        if (manageBtn) manageBtn.style.display = 'none';
    });
}

/**
 * Gerenciar agentes do contato (abrir modal)
 */
function manageContactAgents(contactId) {
    if (!contactId) {
        console.error('ID do contato não informado');
        return;
    }
    
    // Definir ID do contato no modal
    document.getElementById('contactAgentsModalContactId').value = contactId;
    
    // Limpar seleção de agente
    document.getElementById('addContactAgentSelect').value = '';
    document.getElementById('addAsPrimaryAgent').checked = false;
    
    // Restaurar todas as opçÁes do select antes de carregar
    const select = document.getElementById('addContactAgentSelect');
    if (select) {
        Array.from(select.options).forEach(option => {
            option.style.display = '';
            option.disabled = false;
        });
    }
    
    // Carregar agentes do contato
    loadContactAgentsInModal(contactId);
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_contact_agents'));
    modal.show();
}

/**
 * Carregar agentes do contato no modal
 */
function loadContactAgentsInModal(contactId) {
    const agentsListEl = document.getElementById('contactAgentsList');
    if (!agentsListEl) return;
    
    agentsListEl.innerHTML = '<div class="text-muted fs-7 text-center py-3">Carregando...</div>';
    
    fetch(`<?= \App\Helpers\Url::to('/contacts') ?>/${contactId}/agents`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success || !data.agents) {
            agentsListEl.innerHTML = '<div class="text-muted fs-7 text-center py-3">Nenhum agente atribuído</div>';
            updateAgentSelect([]);
            return;
        }
        
        const agents = data.agents || [];
        
        if (agents.length === 0) {
            agentsListEl.innerHTML = '<div class="text-muted fs-7 text-center py-3">Nenhum agente atribuído</div>';
            updateAgentSelect([]);
            return;
        }
        
        // Renderizar lista de agentes com açÁes
        renderContactAgentsList(agents, contactId);
        
        // Atualizar select removendo agentes já adicionados
        const agentIds = agents.map(a => a.agent_id || a.id);
        updateAgentSelect(agentIds);
    })
    .catch(error => {
        console.error('Erro ao carregar agentes do contato:', error);
        agentsListEl.innerHTML = '<div class="text-danger fs-7 text-center py-3">Erro ao carregar agentes</div>';
    });
}

/**
 * Atualizar select de agentes, ocultando os que já estão na lista
 */
function updateAgentSelect(excludedAgentIds) {
    const select = document.getElementById('addContactAgentSelect');
    if (!select) return;
    
    // Percorrer todas as opçÁes e mostrar/ocultar conforme necessário
    Array.from(select.options).forEach(option => {
        if (option.value === '') {
            // Manter opção vazia sempre visível
            return;
        }
        
        const isExcluded = excludedAgentIds.includes(parseInt(option.value));
        
        if (isExcluded) {
            // Ocultar opção (mas não remover, para poder restaurar depois)
            option.style.display = 'none';
            option.disabled = true;
        } else {
            // Mostrar opção
            option.style.display = '';
            option.disabled = false;
        }
    });
    
    // Se a opção selecionada foi ocultada, limpar seleção
    if (select.value && excludedAgentIds.includes(parseInt(select.value))) {
        select.value = '';
    }
}

/**
 * Renderizar lista de agentes no modal
 */
function renderContactAgentsList(agents, contactId) {
    const agentsListEl = document.getElementById('contactAgentsList');
    if (!agentsListEl) return;
    
    let html = '';
    
    agents.forEach(agent => {
        const isPrimary = agent.is_primary == 1 || agent.is_primary === true;
        const agentName = agent.agent_name || agent.name || 'Agente';
        const agentEmail = agent.agent_email || agent.email || '';
        const initials = getInitials(agentName);
        const priority = agent.priority || 0;
        const agentId = agent.agent_id || agent.id;
        
        html += `
            <div class="d-flex align-items-center gap-3 p-3 border rounded mb-2" style="background: var(--bs-gray-50);" data-agent-id="${agentId}">
                <div class="symbol symbol-40px symbol-circle">
                    <div class="symbol-label bg-light-primary text-primary fw-bold">
                        ${initials}
                    </div>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <span class="fw-semibold">${escapeHtml(agentName)}</span>
                        ${isPrimary ? '<span class="badge badge-primary">Principal</span>' : ''}
                    </div>
                    ${agentEmail ? `<div class="text-muted fs-7">${escapeHtml(agentEmail)}</div>` : ''}
                    <div class="mt-2">
                        <label class="form-label fs-7 mb-1">Prioridade:</label>
                        <input type="number" 
                               class="form-control form-control-sm d-inline-block" 
                               style="width: 80px;" 
                               value="${priority}" 
                               min="0" 
                               max="100"
                               onchange="updateContactAgentPriority(${contactId}, ${agentId}, this.value)">
                    </div>
                </div>
                <div class="d-flex flex-column gap-2">
                    ${!isPrimary ? `
                        <button class="btn btn-sm btn-light-primary" 
                                onclick="setContactPrimaryAgent(${contactId}, ${agentId})"
                                title="Definir como principal">
                            <i class="ki-duotone ki-star fs-6">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </button>
                    ` : `
                        <button class="btn btn-sm btn-light-success" disabled title="Agente principal">
                            <i class="ki-duotone ki-check fs-6">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </button>
                    `}
                    <button class="btn btn-sm btn-light-danger" 
                            onclick="removeContactAgent(${contactId}, ${agentId}, '${escapeHtml(agentName)}')"
                            title="Remover agente">
                        <i class="ki-duotone ki-trash fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                    </button>
                </div>
            </div>
        `;
    });
    
    agentsListEl.innerHTML = html;
}

/**
 * Mostrar toast/notificação de sucesso ou erro
 */
function showToast(type, message) {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            icon: type === 'success' ? 'success' : 'error',
            title: type === 'success' ? 'Sucesso!' : 'Erro',
            text: message,
            timer: type === 'success' ? 2000 : 3000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    } else {
        alert(message);
    }
}

/**
 * Adicionar agente ao contato a partir do modal
 */
function addContactAgentFromModal() {
    const contactId = document.getElementById('contactAgentsModalContactId').value;
    const agentId = document.getElementById('addContactAgentSelect').value;
    const isPrimary = document.getElementById('addAsPrimaryAgent').checked;
    
    if (!contactId) {
        alert('Erro: ID do contato não encontrado');
        return;
    }
    
    if (!agentId) {
        alert('Por favor, selecione um agente');
        return;
    }
    
    // Verificar se agente já está na lista
    const agentsListEl = document.getElementById('contactAgentsList');
    if (agentsListEl) {
        const existingAgents = agentsListEl.querySelectorAll('[data-agent-id]');
        for (let el of existingAgents) {
            if (el.getAttribute('data-agent-id') == agentId) {
                showToast('error', 'Este agente já está na lista');
                return;
            }
        }
    }
    
    // Desabilitar botão durante requisição
    const addBtn = event.target.closest('button');
    const originalText = addBtn.innerHTML;
    addBtn.disabled = true;
    addBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adicionando...';
    
    const formData = new FormData();
    formData.append('agent_id', agentId);
    formData.append('is_primary', isPrimary ? '1' : '0');
    formData.append('priority', '0');
    
    fetch(`<?= \App\Helpers\Url::to('/contacts') ?>/${contactId}/agents`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Limpar formulírio
            document.getElementById('addContactAgentSelect').value = '';
            document.getElementById('addAsPrimaryAgent').checked = false;
            
            // Recarregar lista (isso tambêm atualizarí o select)
            loadContactAgentsInModal(contactId);
            
            // Recarregar na sidebar tambêm
            loadContactAgents(contactId);
            
            // Mostrar mensagem de sucesso
            showToast('success', 'Agente adicionado com sucesso!');
        } else {
            alert('Erro: ' + (data.message || 'Erro ao adicionar agente'));
        }
    })
    .catch(error => {
        console.error('Erro ao adicionar agente:', error);
        alert('Erro ao adicionar agente');
    })
    .finally(() => {
        addBtn.disabled = false;
        addBtn.innerHTML = originalText;
    });
}

/**
 * Remover agente do contato
 */
function removeContactAgent(contactId, agentId, agentName) {
    if (!confirm(`Tem certeza que deseja remover o agente "${agentName}" deste contato?`)) {
        return;
    }
    
    fetch(`<?= \App\Helpers\Url::to('/contacts') ?>/${contactId}/agents/${agentId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Recarregar lista no modal
            loadContactAgentsInModal(contactId);
            
            // Recarregar na sidebar tambêm
            loadContactAgents(contactId);
            
            // Mostrar mensagem de sucesso
            showToast('success', 'Agente removido com sucesso!');
        } else {
            alert('Erro: ' + (data.message || 'Erro ao remover agente'));
        }
    })
    .catch(error => {
        console.error('Erro ao remover agente:', error);
        alert('Erro ao remover agente');
    });
}

/**
 * Definir agente principal
 */
function setContactPrimaryAgent(contactId, agentId) {
    const formData = new FormData();
    formData.append('agent_id', agentId);
    
    fetch(`<?= \App\Helpers\Url::to('/contacts') ?>/${contactId}/agents/set-primary`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Recarregar lista no modal
            loadContactAgentsInModal(contactId);
            
            // Recarregar na sidebar tambêm
            loadContactAgents(contactId);
            
            // Mostrar mensagem de sucesso
            showToast('success', 'Agente principal definido com sucesso!');
        } else {
            alert('Erro: ' + (data.message || 'Erro ao definir agente principal'));
        }
    })
    .catch(error => {
        console.error('Erro ao definir agente principal:', error);
        alert('Erro ao definir agente principal');
    });
}

/**
 * Atualizar prioridade do agente
 */
function updateContactAgentPriority(contactId, agentId, priority) {
    const priorityValue = parseInt(priority) || 0;
    
    // Validar range
    if (priorityValue < 0 || priorityValue > 100) {
        alert('Prioridade deve estar entre 0 e 100');
        // Recarregar para restaurar valor anterior
        loadContactAgentsInModal(contactId);
        return;
    }
    
    // Atualizar via API (usando mêtodo store que atualiza se já existe)
    const formData = new FormData();
    formData.append('agent_id', agentId);
    formData.append('priority', priorityValue);
    
    fetch(`<?= \App\Helpers\Url::to('/contacts') ?>/${contactId}/agents`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Recarregar lista para atualizar ordem
            loadContactAgentsInModal(contactId);
            
            // Mostrar mensagem de sucesso
            showToast('success', 'Prioridade atualizada!');
        } else {
            alert('Erro: ' + (data.message || 'Erro ao atualizar prioridade'));
            // Recarregar para restaurar valor anterior
            loadContactAgentsInModal(contactId);
        }
    })
    .catch(error => {
        console.error('Erro ao atualizar prioridade:', error);
        alert('Erro ao atualizar prioridade');
        // Recarregar para restaurar valor anterior
        loadContactAgentsInModal(contactId);
    });
}


// Delegação de eventos para conversation-item (resolve problema de função não definida em onclick)
document.addEventListener('click', function(e) {
    const conversationItem = e.target.closest('.conversation-item[data-onclick="selectConversation"]');
    if (conversationItem) {
        const conversationId = parseInt(conversationItem.getAttribute('data-conversation-id'));
        if (!isNaN(conversationId)) {
            selectConversation(conversationId);
        }
    }
});

// Auto-scroll para última mensagem
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Restaurar estado do sidebar
    const sidebarOpen = localStorage.getItem('conversationSidebarOpen') === 'true';
    if (sidebarOpen) {
        document.getElementById('conversationSidebar')?.classList.add('open');
    }
    
    // Corrigir z-index dos modais e backdrops
    console.log('Configurando correção de z-index para modais');
    fixModalZIndex();
    
    // Observar quando modais são abertos
    document.addEventListener('shown.bs.modal', function(e) {
        console.log('Modal aberto, corrigindo z-index');
        setTimeout(fixModalZIndex, 100);
    });
    
    // Listener para checkboxes de canais no modal de filtros avançados
    const channelCheckboxes = document.querySelectorAll('input[name="channels[]"]');
    channelCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateWhatsAppAccountsFilter);
    });
    
    // Inicializar seletor rípido de templates
    initTemplateQuickSelect();
    
    // Inicializar busca de mensagens
    const messageSearchInput = document.getElementById('messageSearch');
    if (messageSearchInput) {
        messageSearchInput.addEventListener('keyup', function(e) {
            searchMessagesInConversation(e);
        });
    }
    
    // Handler do formulírio de escalação
    const escalateForm = document.getElementById('escalateForm');
    if (escalateForm) {
        escalateForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const conversationId = document.getElementById('escalateConversationId').value;
            const agentId = document.getElementById('escalateAgent').value;
            
            if (!conversationId) {
                const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                                   document.body.classList.contains('dark-mode') ||
                                   window.matchMedia('(prefers-color-scheme: dark)').matches;
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'ID da conversa não encontrado',
                    colorScheme: isDarkMode ? 'dark' : 'light'
                });
                return;
            }
            
            const btn = escalateForm.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Escalando...';
            
            try {
                const formData = new FormData();
                if (agentId) {
                    formData.append('agent_id', agentId);
                }
                
                const response = await fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/escalate`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                                   document.body.classList.contains('dark-mode') ||
                                   window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('kt_modal_escalate')).hide();
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: data.message || 'Conversa escalada com sucesso',
                        colorScheme: isDarkMode ? 'dark' : 'light',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recarregar detalhes da conversa
                    if (currentConversationId) {
                        selectConversation(currentConversationId);
                    }
                    
                    // Recarregar lista de conversas (preservando filtros)
                    const urlParams = new URLSearchParams(window.location.search);
                    refreshConversationList(urlParams);
                } else {
                    throw new Error(data.message || 'Erro ao escalar conversa');
                }
            } catch (error) {
                const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                                   document.body.classList.contains('dark-mode') ||
                                   window.matchMedia('(prefers-color-scheme: dark)').matches;
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: error.message || 'Erro ao escalar conversa',
                    colorScheme: isDarkMode ? 'dark' : 'light'
                });
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    }
    
    // Se houver conversa selecionada no carregamento inicial, atualizar sidebar
    const selectedConversationId = parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    const selectedConversation = parsePhpJson('<?= json_encode($selectedConversation ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    
    // Verificar se acesso é restrito (passado pelo PHP)
    const accessRestricted = <?= !empty($accessRestricted) ? 'true' : 'false' ?>;
    
    if (selectedConversationId) {
        // IMPORTANTE: Definir currentConversationId para que funcionalidades como Assistente IA funcionem
        currentConversationId = parseInt(selectedConversationId);
        window.currentConversationId = currentConversationId; // Garantir que window tambêm é atualizado
        
        // Marcar conversa como ativa na lista
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        const conversationItem = document.querySelector(`[data-conversation-id="${selectedConversationId}"]`);
        if (conversationItem) {
            conversationItem.classList.add('active');
        }
        
        // Se acesso é restrito, não carregar dados adicionais
        if (accessRestricted) {
            console.log('🔒 Acesso restrito - não carregando dados adicionais');
            return; // Não fazer mais nada
        }
        
        // Se já temos dados da conversa do PHP, usar diretamente
        if (selectedConversation) {
            // Buscar tags da conversa
            fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${selectedConversationId}/tags`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tags = data.success && data.tags ? data.tags : [];
                // Atualizar sidebar com dados da conversa
                updateConversationSidebar(selectedConversation, tags);
                // Atualizar timeline
                updateConversationTimeline(selectedConversationId);
            })
            .catch(error => {
                console.error('Erro ao carregar tags:', error);
                // Mesmo sem tags, atualizar sidebar
                updateConversationSidebar(selectedConversation, []);
                updateConversationTimeline(selectedConversationId);
            });
        } else {
            // Se não temos dados completos, buscar via AJAX
            fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${selectedConversationId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.conversation) {
                    const tags = data.tags || [];
                    // Atualizar sidebar com dados da conversa
                    updateConversationSidebar(data.conversation, tags);
                    // Atualizar timeline
                    updateConversationTimeline(selectedConversationId);
                }
            })
            .catch(error => {
                console.error('Erro ao carregar conversa:', error);
            });
        }
    }
    
    // Suportar navegação pelo histórico do navegador
    window.addEventListener('popstate', function(event) {
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('id');
        if (conversationId) {
            selectConversation(parseInt(conversationId));
        } else {
            // Se não tem ID, limpar chat e resetar currentConversationId
            currentConversationId = null;
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center" style="height: 100%;">
                        <div class="text-center text-muted">
                            <i class="ki-duotone ki-chat fs-3x mb-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <div class="fw-semibold">Selecione uma conversa</div>
                            <div class="fs-7">Escolha uma conversa da lista para começar</div>
                        </div>
                    </div>
                `;
            }
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
        }
    });
});

// Auto-expand textarea
document.getElementById('messageInput')?.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
});

// Enviar mensagem (Enter)
document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Colar imagem (clipboard) como anexo (fica na fila para permitir legenda antes de enviar)
document.getElementById('messageInput')?.addEventListener('paste', function(e) {
    const clipboard = e.clipboardData || window.clipboardData;
    if (!clipboard || !clipboard.items) return;
    
    const hasText = !!clipboard.getData('text');
    const imageFiles = [];
    
    for (const item of clipboard.items) {
        if (item.type && item.type.startsWith('image/')) {
            const file = item.getAsFile();
            if (file) {
                const ext = (file.type && file.type.split('/')[1]) || 'png';
                const namedFile = new File([file], `pasted-image-${Date.now()}.${ext}`, { type: file.type });
                imageFiles.push(namedFile);
            }
        }
    }
    
    if (imageFiles.length > 0) {
        // Se só veio imagem, evita colar base64 no textarea
        if (!hasText) {
            e.preventDefault();
        }
        imageFiles.forEach(file => addPendingAttachment(file));
    }
});

// Drag & drop de arquivos/imagens para a área do input
(function() {
    const input = document.getElementById('messageInput');
    const container = input ? input.closest('.position-relative') : null;
    const dropTarget = container || input;
    if (!dropTarget) return;
    
    ['dragenter', 'dragover'].forEach(evt => {
        dropTarget.addEventListener(evt, function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropTarget.classList.add('border', 'border-dashed', 'border-primary', 'rounded');
        });
    });
    
    ['dragleave', 'drop'].forEach(evt => {
        dropTarget.addEventListener(evt, function(e) {
            dropTarget.classList.remove('border', 'border-dashed', 'border-primary', 'rounded');
        });
    });
    
    dropTarget.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const files = Array.from(e.dataTransfer?.files || []);
        if (!files.length) return;
        files.forEach(file => addPendingAttachment(file));
    });
})();

// Busca com debounce para AJAX
let conversationsSearchDebounce = null;

document.getElementById('kt_conversations_search')?.addEventListener('input', function(e) {
    // Limpar debounce anterior
    if (conversationsSearchDebounce) {
        clearTimeout(conversationsSearchDebounce);
    }
    
    // Debounce: aguardar 500ms após parar de digitar
    conversationsSearchDebounce = setTimeout(() => {
        applyFilters();
    }, 500);
});

// Função para atualizar contador de filtros ativos (definir ANTES de usar)
function updateActiveFiltersCount() {
    const countBadge = document.getElementById('activeFiltersCount');
    const filterBtn = document.getElementById('filterToggleBtn');
    if (!countBadge) return;
    
    let count = 0;
    
    // Contar filtros ativos
    const status = document.getElementById('filter_status')?.value;
    if (status && status !== 'open') count++;
    
    if (document.getElementById('filter_channel')?.value) count++;
    if (document.getElementById('filter_department')?.value) count++;
    if (document.getElementById('filter_tag')?.value) count++;
    if (document.getElementById('filter_agent')?.value) count++;
    if (document.getElementById('filter_funnel')?.value) count++;
    if (document.getElementById('filter_stage')?.value) count++;
    
    if (count > 0) {
        countBadge.textContent = count;
        countBadge.classList.remove('d-none');
        if (filterBtn) filterBtn.classList.add('filter-active');
    } else {
        countBadge.classList.add('d-none');
        // Só remove filter-active se o painel estiver fechado
        const panel = document.getElementById('filtersPanel');
        if (filterBtn && panel && panel.classList.contains('d-none')) {
            filterBtn.classList.remove('filter-active');
        }
    }
}

// Event listeners para filtros dropdown
document.getElementById('filter_status')?.addEventListener('change', function() {
    applyFilters();
    updateActiveFiltersCount();
});
document.getElementById('filter_channel')?.addEventListener('change', function() {
    applyFilters();
    updateActiveFiltersCount();
});
document.getElementById('filter_department')?.addEventListener('change', function() {
    applyFilters();
    updateActiveFiltersCount();
});
document.getElementById('filter_tag')?.addEventListener('change', function() {
    // Sincronizar aba ativa com filtro de tag
    const tagId = this.value;
    document.querySelectorAll('.conversation-tab').forEach(t => t.classList.remove('active'));
    if (tagId) {
        const matchingTab = document.querySelector(`.conversation-tab[data-tag-id="${tagId}"]`);
        if (matchingTab) {
            matchingTab.classList.add('active');
            localStorage.setItem('activeConversationTab', tagId);
        }
    } else {
        const allTab = document.querySelector('.conversation-tab[data-tab-id="all"]');
        if (allTab) allTab.classList.add('active');
        localStorage.setItem('activeConversationTab', 'all');
    }
    applyFilters();
    updateActiveFiltersCount();
});
document.getElementById('filter_agent')?.addEventListener('change', function() {
    applyFilters();
    updateActiveFiltersCount();
});
document.getElementById('filter_funnel')?.addEventListener('change', () => {
    const funnelId = document.getElementById('filter_funnel')?.value || '';
    const stageSelect = document.getElementById('filter_stage');
    if (stageSelect) {
        stageSelect.innerHTML = '<option value="">Etapa</option>';
        stageSelect.disabled = true;
    }
    if (funnelId) {
        fetch(`<?= \App\Helpers\Url::to("/funnels") ?>/${funnelId}/stages/json`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success && data.stages && stageSelect) {
                const options = ['<option value="">Etapa</option>'].concat(
                    data.stages.map(s => `<option value="${s.id}">${s.name}</option>`)
                );
                stageSelect.innerHTML = options.join('');
                stageSelect.disabled = false;
            }
        })
        .catch(() => {
            if (stageSelect) {
                stageSelect.innerHTML = '<option value="">Erro ao carregar etapas</option>';
                stageSelect.disabled = false;
            }
        });
    }
    applyFilters();
    updateActiveFiltersCount();
});
document.getElementById('filter_stage')?.addEventListener('change', function() {
    applyFilters();
    updateActiveFiltersCount();
});

document.getElementById('kt_conversations_search')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        if (conversationsSearchDebounce) {
            clearTimeout(conversationsSearchDebounce);
        }
        applyFilters();
    }
});

// Filtros
document.querySelectorAll('#filter_status, #filter_channel, #filter_department, #filter_tag').forEach(select => {
    if (select) {
        select.addEventListener('change', function() {
            applyFilters();
            updateActiveFiltersCount();
        });
    }
});

// Carregar funis para o filtro ao iniciar a pígina
function loadFunnelsFilter() {
    const funnelSelect = document.getElementById('filter_funnel');
    if (!funnelSelect) return;
    
    // Helper local para escape HTML (caso escapeHtml global não esteja disponível ainda)
    const safeEscape = (text) => {
        if (typeof escapeHtml === 'function') return escapeHtml(text);
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    };
    
    fetch('<?= \App\Helpers\Url::to("/funnels") ?>', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.funnels && data.funnels.length > 0) {
            let options = '<option value="">Funil</option>';
            data.funnels.forEach(funnel => {
                options += `<option value="${funnel.id}">${safeEscape(funnel.name)}</option>`;
            });
            funnelSelect.innerHTML = options;
            console.log('✓ Funis carregados:', data.funnels.length);
        } else {
            funnelSelect.innerHTML = '<option value="">Nenhum funil</option>';
            console.log('⚠️ Nenhum funil encontrado');
        }
    })
    .catch(error => {
        console.error('❌ Erro ao carregar funis:', error);
        funnelSelect.innerHTML = '<option value="">Erro ao carregar</option>';
    });
}

// Carregar funis quando a pígina carregar
document.addEventListener('DOMContentLoaded', function() {
    loadFunnelsFilter();
    updateActiveFiltersCount(); // Atualizar contador inicial
    
    // Se houver filtros ativos, abrir o painel automaticamente
    const activeCount = document.getElementById('activeFiltersCount');
    if (activeCount && !activeCount.classList.contains('d-none')) {
        const panel = document.getElementById('filtersPanel');
        if (panel) panel.classList.remove('d-none');
    }
    
    // ✅ CORREÇÃO: Inicializar estado da lista se PHP já renderizou conversas
    const conversationsListEl = document.querySelector('.conversations-list-items');
    if (conversationsListEl) {
        const phpRenderedItems = conversationsListEl.querySelectorAll('.conversation-item');
        if (phpRenderedItems.length > 0) {
            // Marcar como carregado para que o spinner não apague as conversas do PHP
            conversationsListEl.dataset.loaded = '1';
            
            // ✅ CORREÇÃO: Definir offset com base na quantidade REAL de conversas já renderizadas pelo PHP
            // O PHP pode enviar quantidade diferente do conversationPageSize (ex: PHP=70, JS=50)
            conversationOffset = phpRenderedItems.length;
            
            // Mostrar botão "Carregar mais" se houver conversas suficientes (pode haver mais páginas)
            // Usa conversationPageSize como referência mínima para determinar se há mais
            const loadMoreBtn = document.getElementById('loadMoreConversationsBtn');
            if (loadMoreBtn && phpRenderedItems.length >= conversationPageSize) {
                loadMoreBtn.style.display = '';
                conversationHasMore = true;
            } else if (loadMoreBtn && phpRenderedItems.length < conversationPageSize) {
                // Menos conversas que o page size = não há mais páginas
                conversationHasMore = false;
                loadMoreBtn.style.display = 'none';
            }
            
            console.log(`✅ Lista PHP inicializada com ${phpRenderedItems.length} conversas, offset=${conversationOffset}, hasMore=${conversationHasMore}`);
        }
        
        // Scroll infinito
        conversationsListEl.addEventListener('scroll', () => {
            if (conversationsListEl.scrollTop + conversationsListEl.clientHeight >= conversationsListEl.scrollHeight - 80) {
                loadMoreConversations();
            }
        });
    }
    
    // Botão "Carregar mais"
    const loadMoreBtn = document.getElementById('loadMoreConversationsBtn');
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loadMoreConversations();
        });
    }
});

// Tambêm carregar imediatamente se DOM já estiver pronto
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(() => {
        loadFunnelsFilter();
        updateActiveFiltersCount(); // Atualizar contador inicial
    }, 100);
}

function applyFilters() {
    const search = document.getElementById('kt_conversations_search')?.value || '';
    const status = document.getElementById('filter_status')?.value || '';
    const channel = document.getElementById('filter_channel')?.value || '';
    const department = document.getElementById('filter_department')?.value || '';
    const tag = document.getElementById('filter_tag')?.value || '';
    const agent = document.getElementById('filter_agent')?.value || '';
    const funnel = document.getElementById('filter_funnel')?.value || '';
    const stage = document.getElementById('filter_stage')?.value || '';
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    
    // Tratar status especial "unanswered" e "spam"
    if (status === 'unanswered') {
        params.append('unanswered', '1');
    } else if (status === 'spam') {
        params.append('status', 'spam');
    } else if (status) {
        params.append('status', status);
    }
    
    if (channel) params.append('channel', channel);
    if (department) params.append('department_id', department);
    if (tag) params.append('tag_id', tag);
    if (funnel) params.append('funnel_id', funnel);
    if (stage) params.append('funnel_stage_id', stage);
    
    console.log('👔 Filtros aplicados:', {funnel, stage, search, status, channel, department, tag, agent});
    
    // ✅ CORREÇÃO: Resetar paginação ao aplicar filtros
    conversationOffset = 0;
    conversationHasMore = true;
    isLoadingConversations = false;
    
    // Resetar cache para forçar novo carregamento
    window.lastConversationListSignature = null;
    const conversationsList = document.querySelector('.conversations-list-items');
    if (conversationsList) {
        conversationsList.dataset.loaded = '0';
    }
    
    // Tratar filtro de agente
    if (agent === 'unassigned') {
        // Para "Não atribuídas", enviar agent_id=0 ou null (será tratado no backend)
        params.append('agent_id', '0');
    } else if (agent) {
        params.append('agent_id', agent);
    }
    
    // Manter filtros avançados da URL (incluindo arrays multi-select)
    const urlParams = new URLSearchParams(window.location.search);
    
    // Preservar filtros multi-select (arrays)
    ['channels[]', 'tag_ids[]', 'whatsapp_account_ids[]'].forEach(key => {
        urlParams.getAll(key).forEach(value => {
            params.append(key, value);
        });
    });
    
    // Preservar filtros avançados simples (não preservar unanswered, funnel_id, funnel_stage_id pois já foram tratados acima)
    ['answered', 'date_from', 'date_to', 'pinned', 'order_by', 'order_dir'].forEach(key => {
        if (urlParams.has(key) && !params.has(key)) {
            params.append(key, urlParams.get(key));
        }
    });
    
    // Preservar ID da conversa selecionada se houver
    const activeConversationId = window.currentConversationId || urlParams.get('id');
    if (activeConversationId) {
        params.set('id', activeConversationId);
    }
    
    // Atualizar URL sem recarregar pígina
    const newUrl = '<?= \App\Helpers\Url::to('/conversations') ?>' + (params.toString() ? '?' + params.toString() : '');
    window.history.pushState({ filters: params.toString() }, '', newUrl);
    
    // Buscar conversas via AJAX
    refreshConversationList(params);
}

function refreshConversationList(params = null, append = false) {
    console.debug('[TAGS_DEBUG] refreshConversationList start', params instanceof URLSearchParams ? Object.fromEntries(params.entries()) : params);
    const conversationsList = document.querySelector('.conversations-list-items');
    if (!conversationsList) {
        console.error('Elemento .conversations-list-items não encontrado!');
        return;
    }
    
    // Se params não foi fornecido, usar filtros da URL atual preservando TODOS os parâmetros
    if (!params) {
        params = new URLSearchParams(window.location.search);
    }

    // Persistir últimos parâmetros para uso no "Carregar mais"
    lastConversationsParams = params instanceof URLSearchParams ? new URLSearchParams(params.toString()) : new URLSearchParams(window.location.search);
    
    // ✅ CORREÇÃO: NUNCA mostrar spinner quando é append (carregar mais)
    // O spinner só deve aparecer quando é um carregamento completo (não append)
    if (!append) {
        const isFirstLoad = conversationsList.dataset.loaded !== '1';
        
        // Verificar se há filtros aplicados (não é apenas polling)
        const hasFilters = params && params instanceof URLSearchParams && (
            params.has('search') ||
            params.has('status') ||
            params.has('channel') ||
            params.has('department_id') ||
            params.has('tag_id') ||
            params.has('agent_id') ||
            params.has('unanswered') ||
            params.has('channels[]') ||
            params.has('tag_ids[]') ||
            params.has('whatsapp_account_ids[]') ||
            params.has('answered') ||
            params.has('date_from') ||
            params.has('date_to') ||
            params.has('pinned') ||
            params.has('funnel_id') ||
            params.has('funnel_stage_id')
        );
        
        const shouldShowSpinner = isFirstLoad || (hasFilters && conversationsList.dataset.loaded !== '1');
        
        // Mostrar loading apenas no primeiro carregamento OU quando filtros aplicados e ainda não renderizado
        if (shouldShowSpinner) {
            conversationsList.innerHTML = `
                <div class="d-flex align-items-center justify-content-center py-10">
                    <div class="text-center">
                        <span class="spinner-border spinner-border-sm text-primary mb-3" role="status"></span>
                        <div class="text-muted fs-7">Carregando conversas...</div>
                    </div>
                </div>
            `;
            conversationsList.dataset.rendering = '1';
        }
    }
    
    // Construir URL preservando TODOS os filtros
    let url = '<?= \App\Helpers\Url::to('/conversations') ?>';
    let effectiveParams;
    if (params instanceof URLSearchParams) {
        effectiveParams = new URLSearchParams(params.toString());
    } else if (params && typeof params === 'string') {
        effectiveParams = new URLSearchParams(params);
    } else if (params) {
        effectiveParams = new URLSearchParams(params.toString());
    } else {
        effectiveParams = new URLSearchParams(window.location.search);
    }

    // ✅ CORREÇÃO: Usar paginação incremental correta
    // Se não é append, resetar offset (primeiro carregamento ou novos filtros)
    if (!append) {
        conversationOffset = 0;
        isLoadingConversations = false;
        conversationHasMore = true;
    }
    
    // ✅ Usar limit dinâmico (conversationPageSize = 50) e offset incremental
    effectiveParams.set('limit', conversationPageSize);
    effectiveParams.set('offset', conversationOffset);
    lastConversationsParams = new URLSearchParams(effectiveParams.toString());

    const paramsString = effectiveParams.toString();
    if (paramsString) {
        url += '?' + paramsString;
    }
    
    // Adicionar header para retornar JSON (sem sobrescrever filtros existentes) + cache buster
    url += (url.includes('?') ? '&' : '?') + 'format=json&_ts=' + Date.now();
    
    console.log('Buscando conversas na URL:', url);
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        // Verificar se a resposta é JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.error('Resposta não é JSON:', text.substring(0, 500));
                console.error('URL:', url);
                console.error('Status:', response.status);
                throw new Error('Resposta não é JSON. Status: ' + response.status);
            });
        }
        return response.json();
    })
    .then(data => {
        if (!data.success || !data.conversations) {
            console.error('Erro na resposta:', data);
            conversationsList.innerHTML = `
                <div class="text-center py-10">
                    <div class="text-muted">Erro ao carregar conversas</div>
                    <div class="text-muted fs-7">${data.message || 'Erro desconhecido'}</div>
                </div>
            `;
            return;
        }
        
        const conversations = data.conversations;
        console.debug('[TAGS_DEBUG] conversas:', conversations.length, 'primeira tags_data:', conversations[0]?.tags_data);
        
        // Calcular assinatura para evitar re-render quando não houver mudanças
        // ✅ CORREÇÃO: Não pular re-render quando é append (carregar mais)
        const signature = JSON.stringify(conversations.map(c => [
            c.id,
            c.pinned,
            c.pinned_at,
            c.updated_at,
            c.status,
            c.unread_count,
            c.tags_data ? JSON.stringify(c.tags_data) : null
        ]));
        if (!append && window.lastConversationListSignature === signature) {
            // Se a lista já estava renderizada e não é append, evita ficar preso no spinner
            conversationsList.dataset.rendering = '0';
            conversationsList.dataset.loaded = conversationsList.dataset.loaded || '1';
            return;
        }
        if (!append) {
            window.lastConversationListSignature = signature;
        }
        
        // ✅ CORREÇÃO: Usar window.currentConversationId como fonte primária da conversa ativa
        // Isso garante que ao trocar de aba no mobile, a conversa aberta continue marcada corretamente
        const urlParams = new URLSearchParams(window.location.search);
        const selectedConversationId = window.currentConversationId || (urlParams.get('id') ? parseInt(urlParams.get('id')) : null);
        
        // ✅ CORREÇÃO: Se não há conversas E é append, significa que chegou ao fim
        // Não apagar a lista existente, apenas indicar que não há mais
        if (conversations.length === 0) {
            if (append) {
                // Era append (carregar mais), mas não veio nada = fim da lista
                // Não fazer nada, manter conversas existentes
                console.log('✅ Fim da lista alcançado (append sem novas conversas)');
                conversationHasMore = false;
                isLoadingConversations = false;
                
                // Ocultar botão "Carregar mais"
                const loadMoreBtn = document.getElementById('loadMoreConversationsBtn');
                if (loadMoreBtn) {
                    loadMoreBtn.style.display = 'none';
                }
                return;
            } else {
                // Era carregamento inicial/filtro e não há conversas
                conversationsList.innerHTML = `
                    <div class="text-center py-10">
                        <i class="ki-duotone ki-message-text fs-3x text-gray-400 mb-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <h5>Nenhuma conversa encontrada</h5>
                        <p class="text-muted">Tente ajustar os filtros de busca</p>
                    </div>
                `;
                return;
            }
        }
        
        // Renderizar conversas usando função consolidada
        let html = '';
        conversations.forEach(conv => {
            html += renderConversationItemHtml(conv, selectedConversationId);
        });
        
        // Renderização (suporta append para "Carregar mais")
        if (append) {
            conversationsList.insertAdjacentHTML('beforeend', html);
        } else {
            conversationsList.innerHTML = html;
        }
        conversationsList.dataset.loaded = '1';
        conversationsList.dataset.rendering = '0';
        
        // ✅ CORREÇÃO MOBILE: Garantir que a conversa aberta permaneça marcada como active
        // Após re-render, reforçar o estado active baseado no currentConversationId global
        if (window.currentConversationId) {
            const currentActiveItem = conversationsList.querySelector(`[data-conversation-id="${window.currentConversationId}"]`);
            if (currentActiveItem && !currentActiveItem.classList.contains('active')) {
                // Remover active de qualquer outro item e aplicar no correto
                conversationsList.querySelectorAll('.conversation-item.active').forEach(i => i.classList.remove('active'));
                currentActiveItem.classList.add('active');
            }
        }
        
        // ✅ CORREÇÃO: Controlar flag de "tem mais conversas" (usa conversationPageSize = 50)
        conversationHasMore = conversations.length >= conversationPageSize;
        isLoadingConversations = false;
        
        // ✅ CORREÇÃO: Atualizar offset para a próxima página
        // Incrementar pelo número de conversas recebidas (não pelo pageSize, que pode diferir)
        if (append) {
            conversationOffset += conversations.length;
        } else {
            conversationOffset = conversations.length;
        }
        console.log(`✅ Offset atualizado para ${conversationOffset}, hasMore=${conversationHasMore}`);
        
        const loadMoreBtn = document.getElementById('loadMoreConversationsBtn');
        if (loadMoreBtn) {
            // Atualizar spinner do botão
            const spinner = loadMoreBtn.querySelector('.spinner-border');
            if (spinner) {
                spinner.style.display = 'none';
            }
            
            // Mostrar/ocultar botão baseado em se há mais conversas
            if (conversationHasMore) {
                loadMoreBtn.style.display = '';
                loadMoreBtn.disabled = false;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
    })
    .catch(error => {
        console.error('❌ Erro ao buscar conversas:', error);
        
        // ✅ CORREÇÃO CRÍTICA: Resetar flags para desbloquear futuras tentativas
        isLoadingConversations = false;
        conversationHasMore = true; // Permitir tentar novamente
        
        // Se era append, mostrar erro sem limpar lista existente
        if (append) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-center py-5 text-danger';
            errorDiv.innerHTML = `
                <div>⚠️ Erro ao carregar mais conversas</div>
                <div class="fs-7 mt-2">${error.message || 'Erro desconhecido'}</div>
                <button class="btn btn-sm btn-light mt-3" onclick="loadMoreConversations()">Tentar novamente</button>
            `;
            conversationsList.appendChild(errorDiv);
        } else {
            // Primeiro carregamento com erro - mostrar tela de erro
            conversationsList.innerHTML = `
                <div class="text-center py-10">
                    <div class="text-danger">Erro ao carregar conversas</div>
                    <div class="text-muted fs-7 mt-2">${error.message || 'Erro desconhecido'}</div>
                    <button class="btn btn-sm btn-light mt-3" onclick="location.reload()">Recarregar página</button>
                </div>
            `;
        }
        
        // Resetar botão "Carregar mais"
        const loadMoreBtn = document.getElementById('loadMoreConversationsBtn');
        if (loadMoreBtn) {
            const spinner = loadMoreBtn.querySelector('.spinner-border');
            if (spinner) {
                spinner.style.display = 'none';
            }
            loadMoreBtn.disabled = false;
        }
    });
}

function loadMoreConversations() {
    // ✅ CORREÇÃO: Usar paginação incremental em vez de recarregar tudo
    if (isLoadingConversations || !conversationHasMore) {
        console.log('loadMoreConversations: já está carregando ou não há mais conversas');
        return;
    }
    
    isLoadingConversations = true;
    // ✅ CORREÇÃO: NÃO incrementar offset aqui. O offset já aponta para a próxima página
    // (definido no init do PHP ou após cada append bem sucedido)
    
    const params = lastConversationsParams ? new URLSearchParams(lastConversationsParams.toString()) : new URLSearchParams(window.location.search);
    
    // Mostrar spinner no botão
    const loadMoreBtn = document.getElementById('loadMoreConversationsBtn');
    if (loadMoreBtn) {
        const spinner = loadMoreBtn.querySelector('.spinner-border');
        if (spinner) {
            spinner.style.display = 'inline-block';
        }
        loadMoreBtn.disabled = true;
    }
    
    console.log(`📄 Carregando mais conversas: offset=${conversationOffset}, limit=${conversationPageSize}`);
    refreshConversationList(params, true);  // ✅ append=true para não zerar a lista
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Agora';
    if (diffMins < 60) return `${diffMins}min`;
    if (diffHours < 24) return `${diffHours}h`;
    if (diffDays < 7) return `${diffDays}d`;
    
    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
}

// =============================================
// TOGGLE DO PAINEL DE FILTROS
// =============================================
function toggleFiltersDropdown() {
    const panel = document.getElementById('filtersPanel');
    const btn = document.getElementById('filterToggleBtn');
    
    if (panel.classList.contains('d-none')) {
        panel.classList.remove('d-none');
        btn.classList.add('filter-active');
    } else {
        panel.classList.add('d-none');
        btn.classList.remove('filter-active');
    }
}

function openAdvancedFilters() {
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_advanced_filters'));
    modal.show();
    
    // Verificar se WhatsApp está selecionado e mostrar/ocultar filtro de integraçÁes
    updateWhatsAppAccountsFilter();
    
    // Atualizar etapas baseado nos funis selecionados
    updateStagesFilter();
    
    // Adicionar listeners para atualizar etapas quando funis mudarem
    const funnelCheckboxes = document.querySelectorAll('input[name="funnel_ids[]"]');
    funnelCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateStagesFilter);
    });
}

// Atualizar filtro de etapas baseado nos funis selecionados
function updateStagesFilter() {
    const funnelCheckboxes = document.querySelectorAll('input[name="funnel_ids[]"]:checked');
    const stagesContainer = document.getElementById('stages_filter_container');
    
    if (!stagesContainer) return;
    
    const selectedFunnelIds = Array.from(funnelCheckboxes).map(cb => parseInt(cb.value));
    
    if (selectedFunnelIds.length === 0) {
        // Se nenhum funil selecionado, mostrar todas as etapas de todos os funis
        stagesContainer.style.display = 'block';
        return;
    }
    
    // Carregar etapas dos funis selecionados
    Promise.all(selectedFunnelIds.map(funnelId => {
        return fetch(`<?= \App\Helpers\Url::to("/funnels") ?>/${funnelId}/stages/json`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.stages) {
                // Buscar nome do funil do checkbox
                const funnelCheckbox = document.querySelector(`input[name="funnel_ids[]"][value="${funnelId}"]`);
                const funnelName = funnelCheckbox ? funnelCheckbox.closest('label').querySelector('.form-check-label').textContent.trim() : `Funil #${funnelId}`;
                return { funnelId, stages: data.stages, funnelName };
            }
            return null;
        })
        .catch(error => {
            console.error(`Erro ao carregar etapas do funil ${funnelId}:`, error);
            return null;
        });
    }))
    .then(results => {
        const validResults = results.filter(r => r !== null);
        if (validResults.length === 0) {
            stagesContainer.style.display = 'none';
            return;
        }
        
        // Obter etapas já selecionadas
        const selectedStageIds = Array.from(document.querySelectorAll('input[name="funnel_stage_ids[]"]:checked'))
            .map(cb => parseInt(cb.value));
        
        // Construir HTML das etapas
        let stagesHtml = '';
        validResults.forEach(({ funnelId, stages, funnelName }) => {
            stagesHtml += `<div class="mb-3">`;
            stagesHtml += `<div class="fw-semibold fs-7 text-muted mb-1">${escapeHtml(funnelName)}:</div>`;
            stages.forEach(stage => {
                const isChecked = selectedStageIds.includes(stage.id);
                const colorStyle = stage.color ? `style="background-color: ${stage.color}20; color: ${stage.color};"` : '';
                const badgeHtml = stage.color 
                    ? `<span class="badge badge-sm" ${colorStyle}>${escapeHtml(stage.name)}</span>`
                    : escapeHtml(stage.name);
                stagesHtml += `
                    <label class="form-check form-check-custom form-check-solid mb-2 ms-3">
                        <input class="form-check-input" type="checkbox" name="funnel_stage_ids[]" value="${stage.id}" id="filter_stage_${stage.id}" ${isChecked ? 'checked' : ''}>
                        <span class="form-check-label">${badgeHtml}</span>
                    </label>
                `;
            });
            stagesHtml += `</div>`;
        });
        
        const stagesList = stagesContainer.querySelector('.border.rounded.p-3');
        if (stagesList) {
            stagesList.innerHTML = stagesHtml;
        }
        
        stagesContainer.style.display = 'block';
    });
}

// Atualizar visibilidade do filtro de integraçÁes WhatsApp
function updateWhatsAppAccountsFilter() {
    const whatsappCheckbox = document.getElementById('filter_channel_whatsapp');
    const whatsappOfficialCheckbox = document.getElementById('filter_channel_whatsapp_official');
    const whatsappFilter = document.getElementById('whatsapp_accounts_filter');
    
    if (whatsappFilter) {
        // Mostrar se WhatsApp ou WhatsApp Oficial estiver selecionado
        const isWhatsAppSelected = (whatsappCheckbox && whatsappCheckbox.checked) || 
                                   (whatsappOfficialCheckbox && whatsappOfficialCheckbox.checked);
        
        if (isWhatsAppSelected) {
            whatsappFilter.style.display = 'block';
        } else {
            whatsappFilter.style.display = 'none';
            // Desmarcar todas as integraçÁes quando ocultar
            const checkboxes = whatsappFilter.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
    }
}

// Adicionar listeners para atualizar visibilidade quando canais WhatsApp mudarem
document.addEventListener('DOMContentLoaded', function() {
    const whatsappCheckbox = document.getElementById('filter_channel_whatsapp');
    const whatsappOfficialCheckbox = document.getElementById('filter_channel_whatsapp_official');
    
    if (whatsappCheckbox) {
        whatsappCheckbox.addEventListener('change', updateWhatsAppAccountsFilter);
    }
    if (whatsappOfficialCheckbox) {
        whatsappOfficialCheckbox.addEventListener('change', updateWhatsAppAccountsFilter);
    }
});

function applyAdvancedFilters() {
    const form = document.getElementById('advancedFiltersForm');
    const formData = new FormData(form);
    
    const params = new URLSearchParams();
    
    // Filtros bísicos (manter)
    const search = document.getElementById('kt_conversations_search')?.value || '';
    const status = document.getElementById('filter_status')?.value || '';
    const channel = document.getElementById('filter_channel')?.value || '';
    const department = document.getElementById('filter_department')?.value || '';
    const tag = document.getElementById('filter_tag')?.value || '';
    const agent = document.getElementById('filter_agent')?.value || '';
    
    if (search) params.append('search', search);
    
    // Tratar status especial "unanswered" e "spam"
    if (status === 'unanswered') {
        params.append('unanswered', '1');
    } else if (status === 'spam') {
        params.append('status', 'spam');
    } else if (status) {
        params.append('status', status);
    }
    
    if (channel) params.append('channel', channel);
    if (department) params.append('department_id', department);
    if (tag) params.append('tag_id', tag);
    
    // Canais (multi-select)
    const channels = formData.getAll('channels[]');
    if (channels.length > 0) {
        channels.forEach(ch => params.append('channels[]', ch));
    }
    
    // Tags (multi-select)
    const tagIds = formData.getAll('tag_ids[]');
    if (tagIds.length > 0) {
        tagIds.forEach(tagId => params.append('tag_ids[]', tagId));
    }
    
    // Agentes (multi-select) - substituir filtro simples se houver seleção múltipla
    const agentIds = formData.getAll('agent_ids[]');
    if (agentIds.length > 0) {
        // Usar multiselect de agentes (substitui filtro simples)
        agentIds.forEach(agentId => params.append('agent_ids[]', agentId));
    } else {
        // Se não houver multiselect, usar filtro simples
        if (agent === 'unassigned') {
            params.append('agent_id', '0');
        } else if (agent) {
            params.append('agent_id', agent);
        }
    }
    
    // IntegraçÁes WhatsApp (multi-select)
    const whatsappAccountIds = formData.getAll('whatsapp_account_ids[]');
    if (whatsappAccountIds.length > 0) {
        whatsappAccountIds.forEach(accId => params.append('whatsapp_account_ids[]', accId));
    }
    
    // Funis (multi-select)
    const funnelIds = formData.getAll('funnel_ids[]');
    if (funnelIds.length > 0) {
        funnelIds.forEach(funnelId => params.append('funnel_ids[]', funnelId));
    }
    
    // Etapas (multi-select)
    const funnelStageIds = formData.getAll('funnel_stage_ids[]');
    if (funnelStageIds.length > 0) {
        funnelStageIds.forEach(stageId => params.append('funnel_stage_ids[]', stageId));
    }
    
    // Filtros avançados
    const responseStatus = formData.get('response_status');
    if (responseStatus === 'unanswered') {
        params.append('unanswered', '1');
    } else if (responseStatus === 'answered') {
        params.append('answered', '1');
    }
    
    const dateFrom = formData.get('date_from');
    if (dateFrom) params.append('date_from', dateFrom);
    
    const dateTo = formData.get('date_to');
    if (dateTo) params.append('date_to', dateTo);
    
    const pinned = formData.get('pinned');
    if (pinned !== null && pinned !== '') {
        params.append('pinned', pinned);
    }
    
    const orderBy = formData.get('order_by');
    if (orderBy) params.append('order_by', orderBy);
    
    const orderDir = formData.get('order_dir');
    if (orderDir) params.append('order_dir', orderDir);
    
    // Preservar ID da conversa selecionada se houver
    const urlParams = new URLSearchParams(window.location.search);
    const currentConversationId = urlParams.get('id');
    if (currentConversationId) {
        params.append('id', currentConversationId);
    }
    
    // Fechar modal e aplicar filtros
    bootstrap.Modal.getInstance(document.getElementById('kt_modal_advanced_filters')).hide();
    window.location.href = '<?= \App\Helpers\Url::to('/conversations') ?>' + (params.toString() ? '?' + params.toString() : '');
}

function clearAllFilters() {
    // Redirecionar para a pígina com status=open como padrão
    window.location.href = '<?= \App\Helpers\Url::to('/conversations') ?>?status=open';
}

function togglePin(conversationId, isPinned) {
    // Fechar o dropdown imediatamente
    closeAllDropdowns();
    
    const url = isPinned 
        ? `<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/unpin`
        : `<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/pin`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar UI sem recarregar pígina
            const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (conversationItem) {
                const newPinnedState = !isPinned;
                ensureActionsDropdown(conversationItem, newPinnedState, conversationId);
                sortConversationList();
            }
            
            // Toast de sucesso
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: data.message || (isPinned ? 'Conversa desfixada' : 'Conversa fixada'),
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } else {
            alert('Erro ao ' + (isPinned ? 'desfixar' : 'fixar') + ' conversa: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao ' + (isPinned ? 'desfixar' : 'fixar') + ' conversa');
    });
}

// Função auxiliar para fechar todos os dropdowns
function closeAllDropdowns() {
    const dropdowns = document.querySelectorAll('.dropdown.show');
    dropdowns.forEach(dropdown => {
        const toggleBtn = dropdown.querySelector('[data-bs-toggle="dropdown"]');
        if (toggleBtn) {
            const bsDropdown = bootstrap.Dropdown.getInstance(toggleBtn);
            if (bsDropdown) {
                bsDropdown.hide();
            }
        }
    });
}

// Função para corrigir z-index de modais e backdrops
function fixModalZIndex() {
    // Remover backdrops duplicados
    const backdrops = document.querySelectorAll('.modal-backdrop');
    if (backdrops.length > 1) {
        console.warn('Múltiplos backdrops encontrados, removendo duplicados:', backdrops.length);
        // Manter apenas o último
        for (let i = 0; i < backdrops.length - 1; i++) {
            backdrops[i].remove();
        }
    }
    
    // Remover z-index inline para deixar Bootstrap gerenciar
    backdrops.forEach(backdrop => {
        backdrop.style.removeProperty('z-index');
    });
    
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        // Não remover z-index de modais que precisam ficar acima do header
        if (modal.id === 'kt_modal_mockup_generator' || modal.id === 'kt_modal_image_lightbox') return;
        modal.style.removeProperty('z-index');
        const dialog = modal.querySelector('.modal-dialog');
        if (dialog) dialog.style.removeProperty('z-index');
        const content = modal.querySelector('.modal-content');
        if (content) content.style.removeProperty('z-index');
    });
}

// Marcar conversa como lida
function markConversationAsRead(conversationId) {
    // Fechar o dropdown imediatamente
    closeAllDropdowns();
    
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/mark-read`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remover badge de não lido
            const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (conversationItem) {
                const badge = conversationItem.querySelector('.conversation-item-badge');
                if (badge) badge.remove();
            }
            
            // Atualizar contador global
            if (typeof updateUnreadCount === 'function') {
                updateUnreadCount();
            }
            
            // Toast de sucesso
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Conversa marcada como lida',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } else {
            alert('Erro ao marcar como lida: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao marcar conversa como lida');
    });
}

// Armazenar conversas marcadas como não lidas manualmente
window.manuallyMarkedAsUnread = window.manuallyMarkedAsUnread || new Set();

// Marcar conversa como não lida
function markConversationAsUnread(conversationId) {
    // Fechar o dropdown imediatamente
    closeAllDropdowns();
    
    console.log("Marcando conversa como não lida:", conversationId);
    
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/mark-unread`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log("Resposta mark-unread:", data);
        
        if (data.success) {
            // Adicionar á lista de conversas marcadas manualmente
            window.manuallyMarkedAsUnread.add(conversationId);
            console.log("Conversas marcadas como não lidas:", Array.from(window.manuallyMarkedAsUnread));
            
            // Forçar atualização do badge
            const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (conversationItem) {
                const meta = conversationItem.querySelector('.conversation-item-meta');
                if (meta) {
                    // Remover badge existente
                    const existingBadge = meta.querySelector('.conversation-item-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // Adicionar novo badge
                    const badge = document.createElement('span');
                    badge.className = 'conversation-item-badge';
                    badge.textContent = data.unread_count || '1';
                    badge.setAttribute('data-manual-unread', 'true');
                    meta.appendChild(badge);
                    
                    console.log("Badge adicionado para conversa:", conversationId, "unread_count:", data.unread_count);
                }
            }
            
            // Atualizar contador global
            if (typeof updateUnreadCount === 'function') {
                updateUnreadCount();
            }
            
            // Toast de sucesso
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Conversa marcada como não lida',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } else {
            alert('Erro ao marcar como não lida: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao marcar conversa como não lida');
    });
}

// Mostrar modal de agendar mensagem
function showScheduleMessageModal() {
    // Usar variível JavaScript global que é atualizada dinamicamente
    const conversationId = currentConversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    if (!conversationId) {
        alert('Selecione uma conversa primeiro');
        return;
    }
    
    const modal = document.getElementById('kt_modal_schedule_message');
    if (!modal) {
        console.error('Modal de agendar mensagem não encontrado');
        return;
    }
    
    // Limpar formulírio
    const form = modal.querySelector('#scheduleMessageForm');
    if (form) form.reset();
    
    // Definir conversation_id
    const conversationIdInput = modal.querySelector('#schedule_conversation_id');
    if (conversationIdInput) {
        conversationIdInput.value = conversationId;
    }
    
    // Definir data/hora mínima (hoje, agora)
    const dateInput = modal.querySelector('#schedule_message_date');
    const timeInput = modal.querySelector('#schedule_message_time');
    if (dateInput) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        dateInput.value = dateStr;
        dateInput.min = dateStr;
    }
    if (timeInput) {
        const now = new Date();
        const timeStr = now.toTimeString().slice(0, 5);
        timeInput.value = timeStr;
    }
    
    // Abrir modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Mostrar modal de agendar lembrete
function showReminderModal(conversationId) {
    const modal = document.getElementById('kt_modal_reminder');
    if (!modal) {
        console.error('Modal de lembrete não encontrado');
        return;
    }
    
    // Limpar formulírio
    const form = modal.querySelector('#reminderForm');
    if (form) form.reset();
    
    // Definir conversation_id
    const conversationIdInput = modal.querySelector('#reminder_conversation_id');
    if (conversationIdInput) {
        conversationIdInput.value = conversationId;
    }
    
    // Definir data/hora mínima (hoje, agora)
    const dateInput = modal.querySelector('#reminder_date');
    const timeInput = modal.querySelector('#reminder_time');
    if (dateInput) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        dateInput.value = dateStr;
        dateInput.min = dateStr;
    }
    if (timeInput) {
        const now = new Date();
        const timeStr = now.toTimeString().slice(0, 5);
        timeInput.value = timeStr;
    }
    
    // Abrir modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Buscar mensagens dentro da conversa
let messageSearchTimeout = null;
// Variíveis globais para navegação de busca
let messageSearchResults = [];
let currentSearchIndex = -1;
let currentSearchTerm = '';
let messageSearchFilters = {
    message_type: null,
    sender_type: null,
    sender_id: null,
    ai_agent_id: null,
    date_from: null,
    date_to: null,
    has_attachments: null
};

// Função para destacar texto encontrado
function highlightSearchTerm(text, searchTerm) {
    if (!searchTerm) return escapeHtml(text);
    
    const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
    return escapeHtml(text).replace(regex, '<mark class="bg-warning text-dark" style="padding: 2px 4px; border-radius: 3px;">$1</mark>');
}

// Função para escapar caracteres especiais em regex
function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function searchMessagesInConversation(event) {
    const searchInput = event.target;
    const searchTerm = searchInput.value.trim();
    const resultsDiv = document.getElementById('messageSearchResults');
    
    // Obter ID da conversa da URL ou variível global
    let conversationId = currentConversationId;
    if (!conversationId) {
        const urlParams = new URLSearchParams(window.location.search);
        conversationId = urlParams.get('id') ? parseInt(urlParams.get('id')) : null;
    }
    
    // Limpar timeout anterior
    if (messageSearchTimeout) {
        clearTimeout(messageSearchTimeout);
    }
    
    // Verificar se hí filtros ativos
    const hasActiveFilters = Object.values(messageSearchFilters).some(v => v !== null && v !== '');
    
    // Se campo vazio e não hí filtros, esconder resultados
    if (!searchTerm && !hasActiveFilters) {
        resultsDiv.classList.add('d-none');
        messageSearchResults = [];
        currentSearchIndex = -1;
        currentSearchTerm = '';
        return;
    }
    
    // Aguardar 300ms antes de buscar (debounce)
    messageSearchTimeout = setTimeout(() => {
        if (!conversationId) {
            resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-500"><i class="ki-duotone ki-information-5 fs-2x mb-2"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i><br>Nenhuma conversa selecionada</div>';
            resultsDiv.classList.remove('d-none');
            return;
        }
        
        // Construir URL com filtros
        const params = new URLSearchParams();
        if (searchTerm) {
            params.append('q', searchTerm);
        }
        
        // Adicionar filtros ativos
        Object.keys(messageSearchFilters).forEach(key => {
            const value = messageSearchFilters[key];
            if (value !== null && value !== '' && value !== false) {
                // Para booleanos, enviar apenas se true
                if (typeof value === 'boolean' && value === true) {
                    params.append(key, '1');
                } else {
                    params.append(key, value);
                }
            }
        });
        
        const url = `<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/search-messages?${params.toString()}`;
        
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages && data.messages.length > 0) {
                // Salvar resultados para navegação
                messageSearchResults = data.messages;
                currentSearchTerm = searchTerm;
                currentSearchIndex = -1;
                
                const total = data.messages.length;
                let html = `
                    <div class="p-2 border-bottom bg-light-primary d-flex justify-content-between align-items-center">
                        <small class="text-gray-700 fw-semibold">${total} mensagem(ns) encontrada(s)</small>
                        <div class="d-flex gap-2 align-items-center">
                            <button class="btn btn-sm btn-icon btn-light-primary" onclick="navigateSearchResults(-1)" title="Anterior (↑)" id="searchPrevBtn" style="padding: 2px 6px;">
                                <i class="ki-duotone ki-up fs-6">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </button>
                            <small class="text-gray-700 fw-semibold" id="searchCounter">-</small>
                            <button class="btn btn-sm btn-icon btn-light-primary" onclick="navigateSearchResults(1)" title="Próximo (↓)" id="searchNextBtn" style="padding: 2px 6px;">
                                <i class="ki-duotone ki-down fs-6">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </button>
                        </div>
                    </div>
                `;
                
                data.messages.forEach((msg, index) => {
                    const content = msg.content || '';
                    // Encontrar posição do termo no conteúdo para mostrar contexto relevante
                    const searchLower = searchTerm.toLowerCase();
                    const contentLower = content.toLowerCase();
                    const termIndex = contentLower.indexOf(searchLower);
                    
                    let preview = '';
                    if (termIndex >= 0) {
                        // Mostrar contexto ao redor do termo encontrado
                        const start = Math.max(0, termIndex - 30);
                        const end = Math.min(content.length, termIndex + searchTerm.length + 30);
                        preview = content.substring(start, end);
                        if (start > 0) preview = '...' + preview;
                        if (end < content.length) preview = preview + '...';
                    } else {
                        preview = content.length > 80 ? content.substring(0, 80) + '...' : content;
                    }
                    
                    const time = msg.created_at ? new Date(msg.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                    const senderType = msg.sender_type || 'contact';
                    let senderBadge = '';
                    if (msg.ai_agent_id) {
                        senderBadge = '<span class="badge badge-light-warning badge-sm ms-2"><i class="ki-duotone ki-robot fs-7 me-1"><span class="path1"></span><span class="path2"></span></i>IA</span>';
                    } else if (senderType === 'agent') {
                        senderBadge = '<span class="badge badge-light-primary badge-sm ms-2">Agente</span>';
                    } else {
                        senderBadge = '<span class="badge badge-light-info badge-sm ms-2">Contato</span>';
                    }
                    html += `
                        <div class="message-search-result p-3 border-bottom cursor-pointer hover-bg-light-primary" 
                             data-message-id="${msg.id}" 
                             data-index="${index}"
                             onclick="selectSearchResult(${index}, true)">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <div class="d-flex align-items-center">
                                    <span class="fw-semibold text-gray-800">${escapeHtml(msg.sender_name || 'Remetente')}</span>
                                    ${senderBadge}
                                </div>
                                <span class="text-gray-500 small">${time}</span>
                            </div>
                            <div class="text-gray-600 small mt-1">${highlightSearchTerm(preview, searchTerm)}</div>
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
                updateSearchCounter();
            } else {
                resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-500"><i class="ki-duotone ki-magnifier fs-2x mb-2"><span class="path1"></span><span class="path2"></span></i><br>Nenhuma mensagem encontrada</div>';
                messageSearchResults = [];
                currentSearchIndex = -1;
            }
            resultsDiv.classList.remove('d-none');
        })
        .catch(error => {
            console.error('Erro ao buscar mensagens:', error);
            resultsDiv.innerHTML = '<div class="p-3 text-center text-danger"><i class="ki-duotone ki-information-5 fs-2x mb-2"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i><br>Erro ao buscar mensagens</div>';
            resultsDiv.classList.remove('d-none');
            messageSearchResults = [];
            currentSearchIndex = -1;
        });
    }, 300);
}

// Selecionar resultado da busca
function selectSearchResult(index, closeDropdown = false) {
    if (!messageSearchResults || index < 0 || index >= messageSearchResults.length) return;
    
    const msg = messageSearchResults[index];
    currentSearchIndex = index;
    
    // Scroll até a mensagem
    scrollToMessage(msg.id);
    
    // Atualizar contador e destacar item
    updateSearchCounter();
    highlightSearchResultItem(index);
    
    // Fechar dropdown apenas se solicitado (ex: clique direto)
    if (closeDropdown) {
        document.getElementById('messageSearchResults').classList.add('d-none');
        document.getElementById('messageSearch').blur();
    }
}

// Navegar entre resultados (próximo/anterior)
function navigateSearchResults(direction) {
    if (!messageSearchResults || messageSearchResults.length === 0) return;
    
    // Atualizar índice
    currentSearchIndex += direction;
    
    // Limites
    if (currentSearchIndex < 0) {
        currentSearchIndex = messageSearchResults.length - 1;
    } else if (currentSearchIndex >= messageSearchResults.length) {
        currentSearchIndex = 0;
    }
    
    // Selecionar resultado
    selectSearchResult(currentSearchIndex);
    
    // Atualizar contador
    updateSearchCounter();
    
    // Destacar item no dropdown
    highlightSearchResultItem(currentSearchIndex);
}

// Atualizar contador de busca
function updateSearchCounter() {
    const counter = document.getElementById('searchCounter');
    if (counter && messageSearchResults.length > 0) {
        const current = currentSearchIndex >= 0 ? currentSearchIndex + 1 : '-';
        counter.textContent = `${current} / ${messageSearchResults.length}`;
    }
}

// Destacar item selecionado no dropdown
function highlightSearchResultItem(index) {
    const resultsDiv = document.getElementById('messageSearchResults');
    if (!resultsDiv) return;
    
    // Remover destaque anterior
    resultsDiv.querySelectorAll('.message-search-result').forEach(item => {
        item.classList.remove('bg-light-primary');
    });
    
    // Destacar item atual
    const currentItem = resultsDiv.querySelector(`[data-index="${index}"]`);
    if (currentItem) {
        currentItem.classList.add('bg-light-primary');
        // Scroll do item para dentro da view
        currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// Adicionar navegação por teclado
document.addEventListener('DOMContentLoaded', function() {
    const messageSearchInput = document.getElementById('messageSearch');
    if (messageSearchInput) {
        messageSearchInput.addEventListener('keydown', function(e) {
            const resultsDiv = document.getElementById('messageSearchResults');
            if (!resultsDiv || resultsDiv.classList.contains('d-none')) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateSearchResults(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateSearchResults(-1);
            } else if (e.key === 'Enter' && currentSearchIndex >= 0) {
                e.preventDefault();
                selectSearchResult(currentSearchIndex, true);
            } else if (e.key === 'Escape') {
                resultsDiv.classList.add('d-none');
                messageSearchInput.blur();
            }
        });
    }
    
    // Inicializar lazy loading
    initLazyLoading();
});

// Inicializar lazy loading de imagens e vídeos
function initLazyLoading() {
    // Verificar se Intersection Observer está disponível
    if (!('IntersectionObserver' in window)) {
        // Fallback: carregar todas as imagens/vídeos imediatamente
        document.querySelectorAll('.lazy-image[data-src]').forEach(img => {
            img.src = img.dataset.src;
            img.classList.add('loaded');
        });
        document.querySelectorAll('.lazy-video-container').forEach(container => {
            loadVideo(container);
        });
        return;
    }
    
    // Configurar Intersection Observer para imagens
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const container = img.closest('.lazy-image-container');
                const spinner = container ? container.querySelector('.lazy-loading-spinner') : null;
                
                if (spinner) spinner.style.display = 'block';
                img.classList.add('loading');
                
                const imageUrl = img.dataset.src;
                const tempImg = new Image();
                
                tempImg.onload = function() {
                    img.src = imageUrl;
                    img.classList.remove('loading');
                    img.classList.add('loaded');
                    if (spinner) spinner.style.display = 'none';
                    observer.unobserve(img);
                };
                
                tempImg.onerror = function() {
                    img.classList.remove('loading');
                    if (spinner) spinner.style.display = 'none';
                    img.style.opacity = '0.5';
                    observer.unobserve(img);
                };
                
                tempImg.src = imageUrl;
            }
        });
    }, {
        rootMargin: '50px' // Começar a carregar 50px antes de ficar visível
    });
    
    // Observar todas as imagens lazy
    document.querySelectorAll('.lazy-image[data-src]').forEach(img => {
        imageObserver.observe(img);
    });
    
    // Configurar Intersection Observer para vídeos
    const videoObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const container = entry.target;
                loadVideo(container);
                observer.unobserve(container);
            }
        });
    }, {
        rootMargin: '100px' // Vídeos começam a carregar mais cedo
    });
    
    // Observar todos os containers de vídeo lazy
    document.querySelectorAll('.lazy-video-container').forEach(container => {
        videoObserver.observe(container);
        
        // Adicionar clique no placeholder para carregar imediatamente
        const placeholder = container.querySelector('.lazy-video-placeholder');
        if (placeholder) {
            placeholder.addEventListener('click', function() {
                loadVideo(container);
            });
        }
    });
}

// Carregar vídeo quando ficar visível ou ao clicar
function loadVideo(container) {
    const video = container.querySelector('video');
    const placeholder = container.querySelector('.lazy-video-placeholder');
    const src = container.dataset.src;
    const type = container.dataset.type;
    
    if (!video || !src) return;
    
    // Se já foi carregado, não fazer nada
    if (video.classList.contains('loaded')) return;
    
    // Carregar vídeo
    const source = video.querySelector('source');
    if (source) {
        source.src = src;
        if (type) source.type = type;
    }
    
    video.load();
    video.classList.add('loaded');
    
    if (placeholder) {
        placeholder.classList.add('loaded');
    }
    
    // Quando vídeo estiver pronto, mostrar
    video.addEventListener('loadeddata', function() {
        video.style.display = 'block';
        if (placeholder) {
            placeholder.style.display = 'none';
        }
    }, { once: true });
}

// Função para observar novos elementos adicionados dinamicamente
function observeNewLazyElements(container) {
    if (!container) return;
    
    // Observar novas imagens
    const newImages = container.querySelectorAll('.lazy-image[data-src]:not(.lazy-observed)');
    if (newImages.length > 0 && 'IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const container = img.closest('.lazy-image-container');
                    const spinner = container ? container.querySelector('.lazy-loading-spinner') : null;
                    
                    if (spinner) spinner.style.display = 'block';
                    img.classList.add('loading');
                    
                    const imageUrl = img.dataset.src;
                    const tempImg = new Image();
                    
                    tempImg.onload = function() {
                        img.src = imageUrl;
                        img.classList.remove('loading');
                        img.classList.add('loaded');
                        if (spinner) spinner.style.display = 'none';
                        observer.unobserve(img);
                    };
                    
                    tempImg.onerror = function() {
                        img.classList.remove('loading');
                        if (spinner) spinner.style.display = 'none';
                        img.style.opacity = '0.5';
                        observer.unobserve(img);
                    };
                    
                    tempImg.src = imageUrl;
                }
            });
        }, { rootMargin: '50px' });
        
        newImages.forEach(img => {
            img.classList.add('lazy-observed');
            imageObserver.observe(img);
        });
    }
    
    // Observar novos vídeos
    const newVideos = container.querySelectorAll('.lazy-video-container:not(.lazy-observed)');
    if (newVideos.length > 0 && 'IntersectionObserver' in window) {
        const videoObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const container = entry.target;
                    loadVideo(container);
                    observer.unobserve(container);
                }
            });
        }, { rootMargin: '100px' });
        
        newVideos.forEach(container => {
            container.classList.add('lazy-observed');
            videoObserver.observe(container);
            
            const placeholder = container.querySelector('.lazy-video-placeholder');
            if (placeholder) {
                placeholder.addEventListener('click', function() {
                    loadVideo(container);
                });
            }
        });
    }
}

// Fechar resultados ao clicar fora
document.addEventListener('click', function(event) {
    const searchInput = document.getElementById('messageSearch');
    const resultsDiv = document.getElementById('messageSearchResults');
    if (searchInput && resultsDiv && !searchInput.contains(event.target) && !resultsDiv.contains(event.target)) {
        resultsDiv.classList.add('d-none');
    }
});

// Mostrar modal de filtros de busca
function showMessageSearchFilters() {
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_message_search_filters'));
    modal.show();
    
    // Preencher filtros atuais
    document.getElementById('filterMessageType').value = messageSearchFilters.message_type || '';
    document.getElementById('filterSenderType').value = messageSearchFilters.sender_type || '';
    document.getElementById('filterDateFrom').value = messageSearchFilters.date_from || '';
    document.getElementById('filterDateTo').value = messageSearchFilters.date_to || '';
    document.getElementById('filterHasAttachments').checked = messageSearchFilters.has_attachments === true;
    document.getElementById('filterSenderId').value = messageSearchFilters.sender_id || '';
    
    // Mostrar/ocultar campo de agente específico baseado no tipo de remetente
    updateSenderIdFilterVisibility();
    
    // Adicionar listener para atualizar visibilidade quando mudar tipo de remetente
    const senderTypeSelect = document.getElementById('filterSenderType');
    if (senderTypeSelect) {
        senderTypeSelect.removeEventListener('change', updateSenderIdFilterVisibility);
        senderTypeSelect.addEventListener('change', updateSenderIdFilterVisibility);
    }
}

// Atualizar visibilidade do filtro de agente específico
function updateSenderIdFilterVisibility() {
    const senderType = document.getElementById('filterSenderType')?.value;
    const senderIdContainer = document.getElementById('filterSenderIdContainer');
    
    if (senderType === 'agent' && senderIdContainer) {
        senderIdContainer.style.display = 'block';
    } else {
        if (senderIdContainer) {
            senderIdContainer.style.display = 'none';
            document.getElementById('filterSenderId').value = '';
        }
    }
}

// Aplicar filtros de busca
function applyMessageSearchFilters() {
    // Obter valores dos filtros
    const senderType = document.getElementById('filterSenderType').value || null;
    const senderId = document.getElementById('filterSenderId').value || null;
    
    messageSearchFilters = {
        message_type: document.getElementById('filterMessageType').value || null,
        sender_type: senderType,
        sender_id: (senderType === 'agent' && senderId) ? parseInt(senderId) : null,
        date_from: document.getElementById('filterDateFrom').value || null,
        date_to: document.getElementById('filterDateTo').value || null,
        has_attachments: document.getElementById('filterHasAttachments').checked || null
    };
    
    // Se filtro de IA, ajustar sender_type
    if (senderType === 'ai') {
        messageSearchFilters.sender_type = 'agent';
        messageSearchFilters.ai_agent_id = true; // Flag especial para filtrar por IA
    }
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('kt_modal_message_search_filters')).hide();
    
    // Atualizar indicador visual de filtros ativos
    updateFiltersIndicator();
    
    // Se houver termo de busca, refazer busca com filtros
    const searchInput = document.getElementById('messageSearch');
    if (searchInput && searchInput.value.trim()) {
        searchMessagesInConversation({ target: searchInput });
    } else {
        // Se não houver termo, mostrar que filtros estão ativos
        const hasActiveFilters = Object.values(messageSearchFilters).some(v => v !== null && v !== '');
        if (hasActiveFilters) {
            // Mostrar mensagem informando que filtros estão ativos
            const resultsDiv = document.getElementById('messageSearchResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-500"><i class="ki-duotone ki-filter fs-2x mb-2"><span class="path1"></span><span class="path2"></span></i><br>Digite um termo de busca para aplicar os filtros</div>';
                resultsDiv.classList.remove('d-none');
            }
        }
    }
}

// Limpar filtros de busca
function clearMessageSearchFilters() {
    messageSearchFilters = {
        message_type: null,
        sender_type: null,
        sender_id: null,
        ai_agent_id: null,
        date_from: null,
        date_to: null,
        has_attachments: null
    };
    
    // Limpar formulírio
    document.getElementById('filterMessageType').value = '';
    document.getElementById('filterSenderType').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterHasAttachments').checked = false;
    document.getElementById('filterSenderId').value = '';
    
    // Ocultar campo de agente específico
    const senderIdContainer = document.getElementById('filterSenderIdContainer');
    if (senderIdContainer) {
        senderIdContainer.style.display = 'none';
    }
    
    // Atualizar indicador
    updateFiltersIndicator();
    
    // Refazer busca se houver termo
    const searchInput = document.getElementById('messageSearch');
    if (searchInput && searchInput.value.trim()) {
        searchMessagesInConversation({ target: searchInput });
    }
}

// Atualizar indicador visual de filtros ativos
function updateFiltersIndicator() {
    const filtersBtn = document.getElementById('messageSearchFiltersBtn');
    if (!filtersBtn) return;
    
    const hasActiveFilters = Object.values(messageSearchFilters).some(v => v !== null && v !== '');
    
    if (hasActiveFilters) {
        filtersBtn.classList.add('btn-primary');
        filtersBtn.classList.remove('btn-light-primary');
        filtersBtn.setAttribute('title', 'Filtros ativos - Clique para editar');
    } else {
        filtersBtn.classList.remove('btn-primary');
        filtersBtn.classList.add('btn-light-primary');
        filtersBtn.setAttribute('title', 'Filtros avançados');
    }
}

/**
 * Formatar data para exibição (HOJE, ONTEM, ou data formatada) - JavaScript
 */
function formatDateLabel(dateString) {
    if (!dateString) return '';
    
    const date = new Date(dateString);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const dateOnly = date.toISOString().split('T')[0];
    const todayOnly = today.toISOString().split('T')[0];
    const yesterdayOnly = yesterday.toISOString().split('T')[0];
    
    if (dateOnly === todayOnly) {
        return 'HOJE';
    } else if (dateOnly === yesterdayOnly) {
        return 'ONTEM';
    } else {
        // Formato: "DIA X" (ex: "15 de Janeiro de 2025")
        const months = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        
        return `${day} de ${month} de ${year}`;
    }
}

/**
 * Verificar se duas datas são de dias diferentes - JavaScript
 */
function isDifferentDay(date1, date2) {
    if (!date1 || !date2) return false;
    
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    
    return d1.toISOString().split('T')[0] !== d2.toISOString().split('T')[0];
}

/**
 * Renderizar separador de data - JavaScript
 */
function renderDateSeparator(dateString) {
    const label = formatDateLabel(dateString);
    const separator = document.createElement('div');
    separator.className = 'date-separator';
    separator.setAttribute('data-date', dateString);
    separator.innerHTML = `
        <span class="date-separator-line"></span>
        <span class="date-separator-label">${escapeHtml(label)}</span>
        <span class="date-separator-line"></span>
    `;
    return separator;
}

// Adicionar mensagem ao chat dinamicamente
function addMessageToChat(message) {
    console.group('📝 addMessageToChat');
    console.log('Mensagem recebida:', message);
    console.table({
        'ID': message.id,
        'sender_type': message.sender_type,
        'direction': message.direction,
        'type': message.type,
        'message_type': message.message_type
    });
    
    const isIncoming = message.direction === 'incoming';
    console.log(`Serí renderizada como: ${isIncoming ? '⬅️ INCOMING (esquerda)' : '➡️ OUTGOING (direita)'}`);
    console.groupEnd();
    
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return null;

    // Evitar duplicação: se já existe mensagem com o mesmo ID, verificar se precisa reposicionar
    if (message.id) {
        const existing = chatMessages.querySelector(`[data-message-id="${message.id}"]`);
        if (existing) {
            // Verificar se precisa reposicionar baseado no timestamp
            const messageTimestamp = message.created_at ? new Date(message.created_at).getTime() : Date.now();
            const existingTimestamp = existing.getAttribute('data-timestamp');
            
            if (existingTimestamp) {
                const existingTime = parseInt(existingTimestamp);
                if (!isNaN(existingTime) && Math.abs(messageTimestamp - existingTime) > 1000) {
                    // Timestamp diferente, atualizar e reposicionar
                    existing.setAttribute('data-timestamp', messageTimestamp);
                    existing.remove(); // Remover do DOM para reposicionar
                } else {
                    // Mesma mensagem, não precisa reposicionar
                    return existing;
                }
            } else {
                // Mensagem existe mas sem timestamp, apenas retornar
                return existing;
            }
        }
    }
    
    const messageDiv = document.createElement('div');
    
    if (message.type === 'system') {
        messageDiv.className = 'chat-message system';
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble">
                    <i class="ki-duotone ki-information fs-5 me-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    ${escapeHtml(message.content)}
                </div>
            </div>
        `;
    } else if (message.type === 'note') {
        // Notas internas ficam alinhadas á direita como mensagens enviadas
        messageDiv.className = 'chat-message note outgoing';
        const senderName = message.sender_name || 'Sistema';
        
        // Verificar se o conteúdo é HTML (notas de sistema como ligações)
        // Notas de ligação começam com emojis específicos
        const content = message.content || '';
        const isCallNote = content.startsWith('📞') || content.startsWith('✅') || content.startsWith('📴') || content.startsWith('❌') || content.startsWith('🎙');
        const hasHtmlTags = content.indexOf('<strong>') !== -1 || content.indexOf('<br') !== -1 || content.indexOf('<a ') !== -1;
        const isHtmlContent = isCallNote || hasHtmlTags;
        
        const noteContent = isHtmlContent ? content : nl2br(escapeHtml(content));
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble">
                    <div class="note-header">
                        <i class="ki-duotone ki-note fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Nota Interna • ${escapeHtml(senderName)}
                    </div>
                    ${noteContent}
                </div>
                <div class="message-time">${formatTime(message.created_at)}</div>
            </div>
        `;
    } else {
        const isIncoming = message.direction === 'incoming';
        messageDiv.className = `chat-message ${isIncoming ? 'incoming' : 'outgoing'}`;
        
        // Adicionar ID da mensagem como atributo
        if (message.id) {
            messageDiv.setAttribute('data-message-id', message.id);
            lastMessageId = Math.max(lastMessageId || 0, message.id);
            if (currentConversationId) {
                setLastMessageIdForConversation(currentConversationId, message.id);
            }
        }
        
        // Verificar se é mensagem de IA
        const isAIMessage = message.ai_agent_id !== null && message.ai_agent_id !== undefined;
        const aiAgentName = message.ai_agent_name || 'Assistente IA';
        
        // Obter iniciais do agente de IA
        let aiAgentInitials = '';
        if (isAIMessage && aiAgentName) {
            const parts = aiAgentName.split(' ');
            aiAgentInitials = (parts[0].charAt(0) + (parts[1] ? parts[1].charAt(0) : '')).toUpperCase();
        }
        
        let avatarHtml = '';
        if (isIncoming) {
            if (currentContactAvatar) {
                avatarHtml = `<img src="${escapeHtml(currentContactAvatar)}" alt="Avatar" class="message-avatar" style="object-fit: cover;">`;
            } else {
                const initials = getInitials(message.sender_name || 'NN');
                avatarHtml = `<div class="message-avatar">${initials}</div>`;
            }
        } else if (isAIMessage) {
            // Avatar do agente de IA para mensagens de IA
            avatarHtml = `<div class="message-avatar ai-agent-avatar" title="${escapeHtml(aiAgentName)}">${aiAgentInitials || '🤖'}</div>`;
        }
        
        // Badge de IA se for mensagem de agente de IA
        let aiBadgeHtml = '';
        if (isAIMessage && !isIncoming) {
            aiBadgeHtml = `
                <div class="ai-message-badge" title="Mensagem enviada por ${escapeHtml(aiAgentName)}">
                    <div class="ai-avatar-mini">${aiAgentInitials || '🤖'}</div>
                    <i class="ki-duotone ki-robot fs-7">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                    </i>
                    <span class="ai-badge-text">${escapeHtml(aiAgentName)}</span>
                </div>
            `;
        }
        
        // Função helper para renderizar status
        function renderMessageStatusHtml(message) {
            if (!message || message.direction === 'incoming') {
                return '';
            }
            
            const status = message.status || 'sent';
            const readAt = message.read_at || null;
            const deliveredAt = message.delivered_at || null;
            const errorMessage = message.error_message || null;
            
            // Se houver erro
            if (status === 'failed' || errorMessage) {
                const errorText = escapeHtml(errorMessage || 'Erro ao enviar');
                
                // Verificar se é erro de número sem WhatsApp (no LID found)
                const isNoWhatsApp = errorMessage && (
                    errorMessage.toLowerCase().includes('no lid found') ||
                    errorMessage.toLowerCase().includes('not a valid whatsapp') ||
                    errorMessage.toLowerCase().includes('invalid whatsapp')
                );
                
                if (isNoWhatsApp) {
                    return `<div class="message-error-container">
                        <span class="message-status message-status-error" title="${errorText}">
                            <i class="ki-duotone ki-cross-circle fs-6">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <span class="message-status-label">Erro</span>
                        </span>
                        <div class="message-error-alert mt-2">
                            <i class="ki-duotone ki-information-3 fs-5 me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            <span>Esse número não possui WhatsApp vinculado!</span>
                        </div>
                    </div>`;
                }
                
                return `<span class="message-status message-status-error" title="${errorText}">
                    <i class="ki-duotone ki-cross-circle fs-6">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <span class="message-status-label">Erro</span>
                </span>`;
            }
            
            // Se foi lida
            if (readAt) {
                const readDate = new Date(readAt).toLocaleString('pt-BR');
                return `<span class="message-status" title="Lida em ${readDate}">
                    <i class="ki-duotone ki-double-check fs-6" style="color: #0088cc;">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <span class="message-status-label">Lida</span>
                </span>`;
            }
            
            // Se foi entregue
            if (deliveredAt) {
                const deliveredDate = new Date(deliveredAt).toLocaleString('pt-BR');
                return `<span class="message-status" title="Entregue em ${deliveredDate}">
                    <i class="ki-duotone ki-double-check fs-6 text-white">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <span class="message-status-label">Entregue</span>
                </span>`;
            }
            
            // Enviado (padrão)
            return `<span class="message-status" title="Enviado">
                <i class="ki-duotone ki-check fs-6 text-white">
                    <span class="path1"></span>
                </i>
                <span class="message-status-label">Enviado</span>
            </span>`;
        }
        
        let statusHtml = renderMessageStatusHtml(message);
        
        // Renderizar anexos se houver
        let attachmentsHtml = '';
        if (message.attachments && Array.isArray(message.attachments) && message.attachments.length > 0) {
            message.attachments.forEach(att => {
                attachmentsHtml += renderAttachmentHtml(att);
            });
        }
        
        // Verificar se é mensagem citada/reply
        const hasQuote = message.quoted_message_id || (message.content && message.content.startsWith('↩️'));
        let quotedHtml = '';
        let actualContent = message.content || '';
        
        if (hasQuote) {
            let quotedText = '';
            let quotedSender = 'Remetente';
            let quotedMessageId = null;
            
            // Priorizar campos separados (novo formato)
            if (message.quoted_message_id) {
                quotedMessageId = message.quoted_message_id;
                quotedSender = message.quoted_sender_name || 'Remetente';
                quotedText = message.quoted_text || '';
                // Limitar texto citado
                if (quotedText.length > 100) {
                    quotedText = quotedText.substring(0, 100) + '...';
                }
                // Content não foi modificado no novo formato
                actualContent = message.content || '';
            } else {
                // Formato antigo (↩️ no content)
                const lines = actualContent.split('\n', 2);
                quotedText = lines[0].substring(2); // Remove "↩️ "
                quotedSender = message.quoted_sender_name || 'Remetente';
                actualContent = lines[1] || '';
                quotedMessageId = null;
            }
            
            // Criar onclick handler para quoted message
            const quotedOnclick = quotedMessageId 
                ? "scrollToMessage(" + quotedMessageId + ")" 
                : "console.log('Sem ID para scroll')";
            const quotedTitle = quotedMessageId ? 'Clique para ver a mensagem original' : 'Mensagem original não disponível';
            const quotedDataId = quotedMessageId || '';
            
            quotedHtml = `
                <div class="quoted-message" onclick="${quotedOnclick}" title="${quotedTitle}" data-quoted-id="${quotedDataId}">
                    <div class="quoted-message-header">${escapeHtml(quotedSender)}</div>
                    <div class="quoted-message-content">${escapeHtml(quotedText.length > 60 ? quotedText.substring(0, 60) + '...' : quotedText)}</div>
                </div>
            `;
        }
        
        // Adicionar botÁes de ação
        const msgId = message.id || 0;
        // Escapar corretamente para JavaScript: remover quebras de linha, escapar aspas e barras
        const escapeForJs = (str) => {
            return (str || '')
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\r?\n/g, ' ')
                .replace(/\t/g, ' ');
        };
        const senderName = escapeForJs(message.sender_name || 'Remetente');
        const msgContent = escapeForJs((message.content || '').substring(0, 100));
        
        const replyBtn = `
            <div class="message-actions">
                <button class="message-actions-btn" onclick="replyToMessage(${msgId}, '${senderName}', '${msgContent}')" title="Responder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 10 4 15 9 20"></polyline>
                        <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
                    </svg>
                </button>
                <button class="message-actions-btn reaction-trigger-btn" onclick="toggleReactionPicker(event, ${msgId})" title="Reagir">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                </button>
                <button class="message-actions-btn" onclick="forwardMessage(${msgId})" title="Encaminhar">
                    <i class="ki-duotone ki-arrow-right fs-6">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </button>
            </div>
        `;
        
        // Verificar se é apenas íudio (sem texto e sem outros anexos)
        const isAudioOnly = attachmentsHtml && attachmentsHtml.includes('audio-attachment') && !actualContent && !quotedHtml;
        const bubbleClass = isAudioOnly ? 'message-bubble audio-only' : 'message-bubble';
        
        // Verificar se o conteúdo é apenas um nome de arquivo técnico (não exibir)
        const trimmedContent = actualContent ? actualContent.trim() : '';
        
        // Detectar nomes de arquivo técnicos gerados automaticamente
        // Padrões: audio_*, document_*, image_*, video_*, IMG_*, VID_*, etc.
        const isTechnicalFilename = trimmedContent && /^(audio|document|video|image|img|vid|file|sticker|ptt)_[A-Za-z0-9_-]+\.[a-z0-9]+$/i.test(trimmedContent);
        
        // Também detectar se é apenas o nome do arquivo igual ao anexo
        let hasMatchingAttachment = false;
        if (message.attachments && Array.isArray(message.attachments)) {
            hasMatchingAttachment = message.attachments.some(att => {
                const attFilename = att.original_name || att.filename || att.name || '';
                return trimmedContent === attFilename;
            });
        }
        
        const isMediaPlaceholder = ['Documento', 'Imagem', 'Vídeo', 'Áudio', 'Mensagem de voz', 'Figurinha', 'Mídia'].includes(trimmedContent);
        const shouldShowContent = actualContent && !isTechnicalFilename && !hasMatchingAttachment && !isMediaPlaceholder;
        
        // Renderizar reações se existirem
        let reactionsHtml = '';
        if (message.reactions && Array.isArray(message.reactions) && message.reactions.length > 0) {
            reactionsHtml = renderReactionsHtml(message.reactions);
        }
        
        messageDiv.innerHTML = `
            ${avatarHtml}
            <div class="message-content">
                ${replyBtn}
                ${aiBadgeHtml}
                <div class="${bubbleClass} ${isAIMessage ? 'ai-message' : ''}">
                    ${quotedHtml}
                    ${attachmentsHtml}
                    ${shouldShowContent ? '<div class="' + ((attachmentsHtml || quotedHtml) ? 'mt-2' : '') + '">' + nl2br(escapeHtml(actualContent)) + '</div>' : ''}
                </div>
                ${reactionsHtml}
                <div class="message-time">
                    ${formatTime(message.created_at)}${statusHtml}
                </div>
            </div>
        `;
    }
    
    // Armazenar timestamp no elemento para ordenação
    const messageTimestamp = message.created_at ? new Date(message.created_at).getTime() : Date.now();
    messageDiv.setAttribute('data-timestamp', messageTimestamp);
    
    // Verificar se precisa adicionar separador de data antes da mensagem
    const allMessages = Array.from(chatMessages.children);
    let needsDateSeparator = false;
    let dateSeparatorPosition = null;
    
    // Encontrar posição correta para inserir (ordem crescente por timestamp)
    let insertPosition = null;
    let previousMessageDate = null;
    
    for (let i = 0; i < allMessages.length; i++) {
        const existingMsg = allMessages[i];
        
        // Verificar se é separador de data
        if (existingMsg.classList.contains('date-separator')) {
            const separatorDate = existingMsg.getAttribute('data-date');
            if (separatorDate && message.created_at) {
                // Verificar se a mensagem pertence a um dia diferente do separador
                if (isDifferentDay(separatorDate, message.created_at)) {
                    const separatorTime = new Date(separatorDate).getTime();
                    const messageTime = new Date(message.created_at).getTime();
                    if (messageTime < separatorTime) {
                        // Mensagem é anterior ao separador, inserir antes dele
                        insertPosition = existingMsg;
                        dateSeparatorPosition = existingMsg;
                        break;
                    }
                }
            }
            continue;
        }
        
        const existingTimestamp = existingMsg.getAttribute('data-timestamp');
        
        if (existingTimestamp) {
            const existingTime = parseInt(existingTimestamp);
            if (!isNaN(existingTime)) {
                // Comparar timestamps: se nova mensagem é mais antiga ou igual, inserir antes
                if (messageTimestamp <= existingTime) {
                    insertPosition = existingMsg;
                    
                    // Verificar se precisa de separador de data
                    const existingDate = existingMsg.getAttribute('data-date') || 
                                       (existingMsg.querySelector('.message-time') ? 
                                        new Date(existingTime).toISOString() : null);
                    
                    if (existingDate && message.created_at && isDifferentDay(existingDate, message.created_at)) {
                        needsDateSeparator = true;
                        dateSeparatorPosition = existingMsg;
                    }
                    break;
                } else {
                    // Guardar data da mensagem anterior para verificar separador
                    const existingDate = existingMsg.getAttribute('data-date') || 
                                       (existingMsg.querySelector('.message-time') ? 
                                        new Date(existingTime).toISOString() : null);
                    if (existingDate) {
                        previousMessageDate = existingDate;
                    }
                }
            }
        } else {
            // Se mensagem existente não tem timestamp, tentar pelo ID (fallback)
            const existingId = existingMsg.getAttribute('data-message-id');
            const newId = message.id;
            if (existingId && newId && !existingId.startsWith('temp_') && !newId.toString().startsWith('temp_')) {
                const existingIdNum = parseInt(existingId);
                const newIdNum = parseInt(newId);
                if (!isNaN(existingIdNum) && !isNaN(newIdNum) && newIdNum <= existingIdNum) {
                    insertPosition = existingMsg;
                    break;
                }
            }
        }
    }
    
    // Verificar se precisa de separador antes da primeira mensagem ou entre mensagens
    if (!needsDateSeparator && message.created_at) {
        if (insertPosition) {
            // Verificar se a mensagem anterior é de um dia diferente
            const prevElement = insertPosition.previousElementSibling;
            if (prevElement && !prevElement.classList.contains('date-separator')) {
                const prevDate = prevElement.getAttribute('data-date') || 
                               (prevElement.querySelector('.message-time') ? 
                                new Date(parseInt(prevElement.getAttribute('data-timestamp') || 0)).toISOString() : null);
                if (prevDate && isDifferentDay(prevDate, message.created_at)) {
                    needsDateSeparator = true;
                    dateSeparatorPosition = insertPosition;
                }
            } else if (!prevElement) {
                // Não hí elemento anterior, primeira mensagem
                needsDateSeparator = true;
                dateSeparatorPosition = insertPosition;
            }
        } else if (allMessages.length === 0) {
            // Primeira mensagem - sempre adicionar separador
            needsDateSeparator = true;
            dateSeparatorPosition = null;
        } else {
            // Última mensagem - verificar se é de dia diferente da anterior
            const lastMsg = allMessages[allMessages.length - 1];
            if (lastMsg && !lastMsg.classList.contains('date-separator')) {
                const lastDate = lastMsg.getAttribute('data-date') || 
                               (lastMsg.querySelector('.message-time') ? 
                                new Date(parseInt(lastMsg.getAttribute('data-timestamp') || 0)).toISOString() : null);
                if (lastDate && isDifferentDay(lastDate, message.created_at)) {
                    needsDateSeparator = true;
                    dateSeparatorPosition = null; // Inserir antes da mensagem
                }
            }
        }
    }
    
    // Adicionar separador de data se necessário
    if (needsDateSeparator && message.created_at) {
        const dateSeparator = renderDateSeparator(message.created_at);
        if (dateSeparatorPosition) {
            chatMessages.insertBefore(dateSeparator, dateSeparatorPosition);
        } else if (insertPosition) {
            chatMessages.insertBefore(dateSeparator, insertPosition);
        } else {
            chatMessages.appendChild(dateSeparator);
        }
    }
    
    // Inserir mensagem na posição correta ou no final
    if (insertPosition) {
        chatMessages.insertBefore(messageDiv, insertPosition);
    } else {
        chatMessages.appendChild(messageDiv);
    }
    
    // Adicionar atributo data-date para facilitar comparaçÁes futuras
    if (message.created_at) {
        messageDiv.setAttribute('data-date', message.created_at);
    }
    
    // Atualizar último ID de mensagem conhecido
    if (message.id) {
        lastMessageId = Math.max(lastMessageId || 0, message.id);
    }
    
    // Scroll para última mensagem apenas se estiver no final do chat
    const isAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 100;
    if (isAtBottom && chatMessages && chatMessages.scrollHeight !== undefined) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Observar novos elementos lazy (imagens e vídeos) na mensagem recêm-adicionada
    observeNewLazyElements(messageDiv);
    
    return messageDiv;
}

function formatTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) {
        return 'Agora';
    } else if (diff < 3600000) {
        return Math.floor(diff / 60000) + 'min';
    } else {
        return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }
}

function getInitials(name) {
    const parts = name.split(' ');
    return parts.length > 1 
        ? (parts[0][0] + parts[1][0]).toUpperCase()
        : name.substring(0, 2).toUpperCase();
}

function nl2br(text) {
    return text.replace(/\n/g, '<br>');
}

// Variível global para armazenar mensagem sendo respondida
let replyingToMessage = null;

// Função para responder uma mensagem
function replyToMessage(messageId, senderName, messageText) {
    replyingToMessage = {
        id: messageId,
        sender_name: senderName,
        text: messageText
    };
    
    // Mostrar preview
    const preview = document.getElementById('replyPreview');
    const header = document.getElementById('replyPreviewHeader');
    const text = document.getElementById('replyPreviewText');
    
    if (preview && header && text) {
        header.textContent = senderName;
        text.textContent = messageText.length > 60 ? messageText.substring(0, 60) + '...' : messageText;
        preview.classList.remove('d-none');
    }
    
    // Focar no input
    const input = document.getElementById('messageInput');
    if (input) {
        input.focus();
    }
}

// Cancelar reply
function cancelReply() {
    replyingToMessage = null;
    const preview = document.getElementById('replyPreview');
    if (preview) {
        preview.classList.add('d-none');
    }
}

// Encaminhar mensagem
async function forwardMessage(messageId) {
    if (!messageId) return;
    
    // Usar variível JavaScript global que é atualizada dinamicamente
    const conversationId = currentConversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    if (!conversationId) {
        alert('Selecione uma conversa primeiro');
        return;
    }
    
    // Buscar lista de conversas para encaminhamento
    try {
        const response = await fetch(`<?= \App\Helpers\Url::to("/conversations/for-forwarding") ?>?exclude=${conversationId}`);
        
        // Verificar se a resposta é JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Resposta não é JSON:', text.substring(0, 200));
            throw new Error('Resposta invílida do servidor. Verifique o console para mais detalhes.');
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Erro ao carregar conversas');
        }
        
        if (!data.conversations) {
            data.conversations = [];
        }
        
        // Criar HTML do modal
        let conversationsHtml = '';
        if (data.conversations.length === 0) {
            conversationsHtml = '<div class="text-center text-muted p-4">Nenhuma conversa disponível para encaminhamento</div>';
        } else {
            conversationsHtml = '<div class="forward-conversations-list" style="max-height: 400px; overflow-y: auto;">';
            data.conversations.forEach(conv => {
                const channelInfo = getChannelInfo(conv.channel);
                const channelIcon = channelInfo.icon;
                const lastMsg = conv.last_message ? (conv.last_message.length > 50 ? conv.last_message.substring(0, 50) + '...' : conv.last_message) : 'Sem mensagens';
                conversationsHtml += `
                    <div class="forward-conversation-item" onclick="selectForwardConversation(${conv.id}, ${messageId})" style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s;">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <div class="fw-bold">${escapeHtml(conv.contact_name)}</div>
                                <div class="text-muted small" style="display: flex; align-items: center; gap: 4px;">${channelIcon} <span>${escapeHtml(lastMsg)}</span></div>
                            </div>
                            <i class="ki-duotone ki-arrow-right fs-4 text-muted">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </div>
                    </div>
                `;
            });
            conversationsHtml += '</div>';
        }
        
        // Mostrar modal
        Swal.fire({
            title: 'Encaminhar Mensagem',
            html: `
                <div class="text-start">
                    <p class="mb-3">Selecione a conversa para onde deseja encaminhar:</p>
                    ${conversationsHtml}
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Cancelar',
            cancelButtonText: 'Fechar',
            confirmButtonColor: '#6c757d',
            width: '500px',
            customClass: {
                popup: 'forward-modal'
            },
            didOpen: () => {
                // Adicionar hover effect
                document.querySelectorAll('.forward-conversation-item').forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        this.style.background = 'rgba(255,255,255,0.05)';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.background = '';
                    });
                });
            }
        });
        
    } catch (error) {
        console.error('Erro ao carregar conversas:', error);
        alert('Erro ao carregar lista de conversas: ' + error.message);
    }
}

// Selecionar conversa para encaminhamento
async function selectForwardConversation(targetConversationId, messageId) {
const conversationId = parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    
    if (!conversationId || !targetConversationId || !messageId) {
        alert('Dados inválidos');
        return;
    }
    
    // Fechar modal
    Swal.close();
    
    // Detectar tema dark
    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                      document.body.classList.contains('dark-mode') ||
                      window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    // Mostrar loading
    Swal.fire({
        title: 'Encaminhando...',
        text: 'Aguarde enquanto encaminhamos a mensagem',
        allowOutsideClick: false,
        colorScheme: isDarkMode ? 'dark' : 'light',
        customClass: {
            popup: isDarkMode ? 'swal2-dark' : '',
            title: isDarkMode ? 'text-white' : '',
            htmlContainer: isDarkMode ? 'text-white' : ''
        },
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    try {
        const response = await fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/forward`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                message_id: messageId,
                target_conversation_id: targetConversationId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Mensagem Encaminhada',
                text: 'A mensagem foi encaminhada com sucesso!',
                timer: 2000,
                showConfirmButton: false,
                colorScheme: isDarkMode ? 'dark' : 'light',
                customClass: {
                    popup: isDarkMode ? 'swal2-dark' : '',
                    title: isDarkMode ? 'text-white' : '',
                    htmlContainer: isDarkMode ? 'text-white' : ''
                }
            });
        } else {
            throw new Error(data.message || 'Erro ao encaminhar mensagem');
        }
    } catch (error) {
        console.error('Erro ao encaminhar:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao encaminhar mensagem: ' + error.message,
            colorScheme: isDarkMode ? 'dark' : 'light',
            customClass: {
                popup: isDarkMode ? 'swal2-dark' : '',
                title: isDarkMode ? 'text-white' : '',
                htmlContainer: isDarkMode ? 'text-white' : ''
            }
        });
    }
}

// Scroll até mensagem específica
function scrollToMessage(messageId) {
    console.log('🔧 scrollToMessage chamado com messageId:', messageId, 'tipo:', typeof messageId);
    
    if (!messageId || messageId === 'null' || messageId === null || messageId === '') {
        console.warn('⚠️ scrollToMessage: ID de mensagem inválido:', messageId);
        return;
    }
    
    // Converter para número se for string
    const numericId = parseInt(messageId);
    if (isNaN(numericId)) {
        console.error('❌ scrollToMessage: ID não é um número válido:', messageId);
        return;
    }
    
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) {
        console.error('❌ scrollToMessage: Container de mensagens não encontrado');
        return;
    }
    
    console.log('🔧 scrollToMessage: Procurando mensagem com ID:', numericId);
    
    // Tentar encontrar a mensagem
    const messageElement = chatMessages.querySelector(`[data-message-id="${numericId}"]`);
    
    console.log('🔧 scrollToMessage: Elemento encontrado:', messageElement);
    
    if (messageElement) {
        console.log('✓ scrollToMessage: Mensagem encontrada, fazendo scroll...');
        
        // Remover highlight anterior se houver
        chatMessages.querySelectorAll('.message-highlight').forEach(el => {
            el.classList.remove('message-highlight');
        });
        
        // Adicionar classe de highlight
        messageElement.classList.add('message-highlight');
        
        // Calcular posição relativa ao container do chat
        const elementTop = messageElement.offsetTop;
        const elementHeight = messageElement.offsetHeight;
        const containerHeight = chatMessages.clientHeight;
        
        // Scroll suave até a mensagem (centralizada no container)
        const targetScroll = elementTop - (containerHeight / 2) + (elementHeight / 2);
        
        chatMessages.scrollTo({
            top: Math.max(0, targetScroll),
            behavior: 'smooth'
        });
        
        // Remover highlight após 3 segundos
            setTimeout(() => {
            messageElement.classList.remove('message-highlight');
            }, 3000);
        
        console.log('✓ scrollToMessage: Scroll executado com sucesso');
        
        // Remover destaque após 3 segundos
        setTimeout(() => {
            messageElement.style.backgroundColor = '';
            messageElement.style.border = '';
            messageElement.style.borderRadius = '';
        }, 3000);
    } else {
        // Mensagem não encontrada - pode estar em outra pígina ou não carregada
        console.warn('⚠️ scrollToMessage: Mensagem não encontrada com ID:', numericId);
        const allMessages = chatMessages.querySelectorAll('[data-message-id]');
        console.log('📊 scrollToMessage: Total de mensagens no DOM:', allMessages.length);
        console.log('📊 scrollToMessage: IDs disponíveis:', Array.from(allMessages).map(el => el.getAttribute('data-message-id')));
        
        // Tentar carregar mais mensagens ou mostrar aviso
        if (typeof Swal !== 'undefined' && Swal.fire) {
            Swal.fire({
                icon: 'info',
                title: 'Mensagem não encontrada',
                text: 'A mensagem pode estar em outra pígina do histórico. Tente rolar para cima para encontrí-la.',
                timer: 3000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        } else {
            // Fallback se SweetAlert não estiver disponível
            alert('Mensagem não encontrada. A mensagem pode estar em outra pígina do histórico.');
        }
    }
}

// Variíveis para gravação de íudio
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let recordingCanceled = false;
let currentStream = null;

// Gravar íudio
async function toggleAudioRecording() {
    const btn = document.getElementById('recordAudioBtn');
    // Usar variível JavaScript global que é atualizada dinamicamente
    const conversationId = currentConversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    
    if (!conversationId) {
        alert('Selecione uma conversa primeiro');
        return;
    }
    
    if (!isRecording) {
        // Iniciar gravação
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            currentStream = stream;

            // Tentar preferir OGG/Opus; se não suportar, cair para WebM/Opus
            let mimeType = '';
            const preferred = 'audio/ogg;codecs=opus';
            const fallback = 'audio/webm;codecs=opus';
            if (MediaRecorder.isTypeSupported(preferred)) {
                mimeType = preferred;
            } else if (MediaRecorder.isTypeSupported(fallback)) {
                mimeType = fallback;
            }

            mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = async () => {
                // Se cancelado, não enviar
                if (recordingCanceled) {
                    recordingCanceled = false;
                    audioChunks = [];
                } else {
                    const recordedType = mediaRecorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: recordedType });
                    await sendAudioMessage(audioBlob, conversationId);
                }
                
                // Parar stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
            };
            
            mediaRecorder.start();
            isRecording = true;
            
            // Atualizar botão
            btn.classList.remove('btn-light-primary', 'btn-danger');
            btn.classList.add('btn-success');
            btn.title = 'Parar e enviar íudio';
            btn.innerHTML = `
                <i class="ki-duotone ki-send fs-3">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            `;
            
            // Mostrar indicador de gravação
            showRecordingIndicator();
            showCancelRecordingButton();
            
        } catch (error) {
            console.error('Erro ao acessar microfone:', error);
            alert('Erro ao acessar o microfone. Verifique as permissÁes.');
        }
    } else {
        stopRecordingAndSend();
    }
}

function stopRecordingAndSend() {
    const btn = document.getElementById('recordAudioBtn');
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    isRecording = false;
    btn.classList.remove('btn-success', 'btn-danger');
    btn.classList.add('btn-light-primary');
    btn.title = 'Gravar íudio';
    btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
    `;
    hideRecordingIndicator();
    hideCancelRecordingButton();
}

function cancelRecording() {
    if (!isRecording) return;
    recordingCanceled = true;
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    isRecording = false;
    const btn = document.getElementById('recordAudioBtn');
    btn.classList.remove('btn-success', 'btn-danger');
    btn.classList.add('btn-light-primary');
    btn.title = 'Gravar íudio';
    btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
    `;
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
    }
    hideRecordingIndicator();
    hideCancelRecordingButton();
}

function showCancelRecordingButton() {
    const cancelBtn = document.getElementById('cancelRecordingBtn');
    if (cancelBtn) {
        cancelBtn.classList.remove('d-none');
    }
}

function hideCancelRecordingButton() {
    const cancelBtn = document.getElementById('cancelRecordingBtn');
    if (cancelBtn) {
        cancelBtn.classList.add('d-none');
    }
}

// Mostrar indicador de gravação
function showRecordingIndicator() {
    const input = document.getElementById('messageInput');
    if (input) {
        input.placeholder = '🎤 Gravando... Clique no microfone para parar';
        input.disabled = true;
    }
}

// Esconder indicador de gravação
function hideRecordingIndicator() {
    const input = document.getElementById('messageInput');
    if (input) {
        input.placeholder = 'Digite sua mensagem...';
        input.disabled = false;
    }
}

// Enviar mensagem de íudio
async function sendAudioMessage(audioBlob, conversationId) {
    try {
        // Converter para formato compatível (webm para ogg ou mp3 seria ideal, mas vamos usar webm)
        const formData = new FormData();
        formData.append('attachments[]', audioBlob, 'audio-' + Date.now() + '.webm');
        formData.append('content', '');
        
        const response = await fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/messages`, {
            method: 'POST',
            body: formData
        });
        
        // Garantir que temos JSON; se não, capturar texto para debug
        // IMPORTANTE: Ler o texto primeiro e depois tentar fazer parse JSON para evitar "body stream already read"
        const responseText = await response.text();
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (jsonErr) {
            throw new Error(`Resposta não é JSON. HTTP ${response.status}. Corpo: ${responseText.substring(0, 500)}`);
        }
        
        if (data.success && data.message) {
            addMessageToChat(data.message);
        } else {
            throw new Error(data.message || 'Erro ao enviar íudio');
        }
    } catch (error) {
        console.error('Erro ao enviar íudio:', error);
        alert('Erro ao enviar íudio: ' + error.message);
    }
}

// Enviar mensagem
function sendMessage() {
    const input = document.getElementById('messageInput');
    const isNote = document.getElementById('noteToggle').checked;
    let message = input.value.trim();
    const hasAttachments = pendingAttachments.length > 0;
    
    // Não permitir enviar vazio sem anexos
    if (!message && !hasAttachments) {
        return;
    }
    
    // Obter conversationId da variível global atualizada ou do PHP
    let conversationId = window.currentConversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    // Fallback: tentar pegar da conversa ativa no DOM
    if (!conversationId) {
        const activeItem = document.querySelector('.conversation-item.active');
        if (activeItem) {
            conversationId = parseInt(activeItem.getAttribute('data-conversation-id'));
            window.currentConversationId = conversationId;
        }
    }
    if (!conversationId) {
        console.error('Nenhuma conversa selecionada');
        alert('Por favor, selecione uma conversa primeiro');
        return;
    }

    // Capturar contexto de reply antes de limpar estado
    const replyContext = replyingToMessage ? {
        id: replyingToMessage.id,
        sender: replyingToMessage.sender,
        text: replyingToMessage.text
    } : null;
    
    // Preparar mensagem com reply se houver
    // IMPORTANTE: Enviar apenas o texto digitado pelo usuário
    // O backend processa o quoted_message_id separadamente
    let finalMessage = message; // Texto que será enviado ao backend (apenas o digitado)
    
    // Adicionar nome do agente em negrito se toggle estiver ativo
    const agentNameToggle = document.getElementById('agentNameToggle');
    if (agentNameToggle && agentNameToggle.classList.contains('active')) {
        const agentName = '<?= htmlspecialchars(\App\Helpers\Auth::user()["name"] ?? "Agente", ENT_QUOTES) ?>';
        finalMessage = `*${agentName}*\n\n${message}`;
    }
    
    // Para preview otimista, formatar com reply se houver
    let previewMessage = message;
    if (replyContext) {
        previewMessage = `↩️ ${replyContext.text}\n\n${message}`;
    }
    
    // Mostrar loading
    const btn = event.target.closest('button') || document.querySelector('button[onclick="sendMessage()"]');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
    
    // Adicionar mensagem otimisticamente (antes da resposta do servidor)
    const tempId = 'temp_' + Date.now();
    const tempMessage = {
        id: tempId,
        content: previewMessage, // Usar preview formatado para exibição
        direction: 'outgoing',
        type: isNote ? 'note' : 'message',
        created_at: new Date().toISOString(),
        sender_name: 'Você',
        quoted_message_id: replyContext ? replyContext.id : null,
        quoted_sender_name: replyContext ? replyContext.sender : null,
        quoted_text: replyContext ? replyContext.text : null
    };
    const messageDiv = addMessageToChat(tempMessage);
    if (messageDiv) {
        messageDiv.setAttribute('data-temp-id', tempId);
    }
    
    // Preparar payload (FormData para suportar anexos e legenda)
    const formData = new FormData();
    formData.append('message', finalMessage);
    formData.append('is_note', isNote ? '1' : '0');
    if (replyContext) {
        formData.append('quoted_message_id', replyContext.id);
    }
    if (pendingAttachments.length) {
        pendingAttachments.forEach(att => {
            formData.append('attachments[]', att.file);
        });
    }
    
    // Limpar input e reply (anexos serão limpos após sucesso)
    input.value = '';
    input.style.height = 'auto';
    document.getElementById('noteToggle').checked = false;
    cancelReply();
    
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/messages`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                try {
                    const json = JSON.parse(text);
                    throw new Error(json.message || 'Erro ao enviar mensagem');
                } catch (e) {
                    if (e instanceof Error && e.message !== 'Erro ao enviar mensagem') {
                        throw e;
                    }
                    throw new Error(`Erro ${response.status}: ${text.substring(0, 100)}`);
                }
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Remover mensagem temporíria e adicionar a real
            const tempMsg = document.querySelector(`[data-temp-id="${tempMessage.id}"]`);
            if (tempMsg) tempMsg.remove();
            
            if (data.message) {
                addMessageToChat(data.message);
            }
            
            // Atualizar lista de conversas
            updateConversationInList(conversationId, message);
        } else {
            // Remover mensagem temporíria em caso de erro
            const tempMsg = document.querySelector(`[data-temp-id="${tempMessage.id}"]`);
            if (tempMsg) tempMsg.remove();
            
            alert('Erro ao enviar mensagem: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        // Remover mensagem temporíria em caso de erro
        const tempMsg = document.querySelector(`[data-temp-id="${tempMessage.id}"]`);
        if (tempMsg) tempMsg.remove();
        
        alert('Erro ao enviar mensagem');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        // Limpar anexos apenas depois da resposta (sucesso ou erro já removeu temp)
        pendingAttachments = [];
        renderPendingAttachments();
    });
}

function updateConversationInList(conversationId, lastMessage) {
    const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (conversationItem) {
        const preview = conversationItem.querySelector('.conversation-item-preview');
        const time = conversationItem.querySelector('.conversation-item-time');
        if (preview) {
            const maxChars = 37;
            preview.textContent = lastMessage.substring(0, maxChars) + (lastMessage.length > maxChars ? '...' : '');
        }
        if (time) {
            // Usar formatTime para tempo relativo (Agora, 1min, etc)
            const timestamp = new Date().toISOString();
            setTimeText(time, formatTime(timestamp));
            // Atualizar data-updated-at
            conversationItem.setAttribute('data-updated-at', timestamp);
            // Atualizar dataset para SLA (mensagem do agente)
            conversationItem.dataset.lastAgentMessageAt = timestamp;
        }
        
        // Atualizar indicador SLA em tempo real
        if (window.SLAIndicator) {
            const convData = window.SLAIndicator.getConversationData(conversationId);
            if (convData) {
                window.SLAIndicator.updateConversation(conversationId, convData);
            }
        }
        
        // Garantir dropdown de açÁes
        ensureActionsDropdown(conversationItem, conversationItem.classList.contains('pinned'), conversationId);
        
        // Resortear lista após atualizar
        sortConversationList();
    }
}

// Modal de Templates
function showTemplatesModal() {
    const modalElement = document.getElementById('kt_modal_templates');
    if (!modalElement) {
        console.error('Modal de templates não encontrado');
        return;
    }
    
    // Verificar se já existe uma instância do modal
    let modal = bootstrap.Modal.getInstance(modalElement);
    
    // Se não existe, criar nova instância
    if (!modal) {
        modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    }
    
    // Limpar qualquer listener anterior e adicionar novo
    const loadTemplatesHandler = function() {
        loadTemplates();
        modalElement.removeEventListener('shown.bs.modal', loadTemplatesHandler);
    };
    
    modalElement.addEventListener('shown.bs.modal', loadTemplatesHandler, { once: true });
    
    // Mostrar modal
    modal.show();
}

// Modal de Templates Pessoais
function showPersonalTemplatesModal() {
    const modalElement = document.getElementById('kt_modal_personal_templates');
    if (!modalElement) {
        console.error('Modal de templates pessoais não encontrado');
        return;
    }
    
    // Verificar se já existe uma instância do modal
    let modal = bootstrap.Modal.getInstance(modalElement);
    
    // Se não existe, criar nova instância
    if (!modal) {
        modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    }
    
    // Fechar modal de templates se estiver aberto
    const templatesModal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_templates'));
    if (templatesModal) {
        templatesModal.hide();
    }
    
    // Limpar qualquer listener anterior e adicionar novo
    const loadPersonalTemplatesHandler = function() {
        loadPersonalTemplates();
        modalElement.removeEventListener('shown.bs.modal', loadPersonalTemplatesHandler);
    };
    
    modalElement.addEventListener('shown.bs.modal', loadPersonalTemplatesHandler, { once: true });
    
    // Mostrar modal
    modal.show();
}

// Carregar templates pessoais
function loadPersonalTemplates() {
    const templatesList = document.getElementById('personalTemplatesList');
    if (!templatesList) return;
    
    templatesList.innerHTML = `
        <tr>
            <td colspan="4" class="text-center text-muted py-10">
                <span class="spinner-border spinner-border-sm text-primary mb-3" role="status"></span>
                <div>Carregando templates...</div>
            </td>
        </tr>
    `;
    
    fetch('<?= \App\Helpers\Url::to("/message-templates/personal") ?>', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.templates) {
            renderPersonalTemplates(data.templates);
        } else {
            templatesList.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-10">
                        <i class="ki-duotone ki-information-5 fs-3x mb-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <div>Você ainda não tem templates pessoais.</div>
                        <button class="btn btn-sm btn-primary mt-3" onclick="showCreatePersonalTemplateModal()">
                            <i class="ki-duotone ki-plus fs-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Criar Primeiro Template
                        </button>
                    </td>
                </tr>
            `;
        }
    })
    .catch(error => {
        console.error('Erro ao carregar templates pessoais:', error);
        templatesList.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-danger py-10">
                    <div>Erro ao carregar templates pessoais</div>
                </td>
            </tr>
        `;
    });
}

// Renderizar templates pessoais
function renderPersonalTemplates(templates) {
    const templatesList = document.getElementById('personalTemplatesList');
    if (!templatesList) return;
    
    if (templates.length === 0) {
        templatesList.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-10">
                    <div>Você ainda não tem templates pessoais.</div>
                    <button class="btn btn-sm btn-primary mt-3" onclick="showCreatePersonalTemplateModal()">
                        <i class="ki-duotone ki-plus fs-5">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Criar Primeiro Template
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    templates.forEach(template => {
        const category = template.category || 'Geral';
        const contentPreview = (template.content || '').substring(0, 100);
        html += `
            <tr data-template-id="${template.id}">
                <td>
                    <div class="fw-semibold text-gray-800">${escapeHtml(template.name)}</div>
                    ${template.description ? `<div class="text-muted fs-7">${escapeHtml(template.description)}</div>` : ''}
                </td>
                <td>
                    <span class="badge badge-light-primary">${escapeHtml(category)}</span>
                </td>
                <td>
                    <div class="text-gray-600 fs-7" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(template.content || '')}">
                        ${escapeHtml(contentPreview)}${template.content && template.content.length > 100 ? '...' : ''}
                    </div>
                </td>
                <td class="text-end">
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-sm btn-light-primary" onclick="editPersonalTemplate(${template.id})" title="Editar">
                            <i class="ki-duotone ki-notepad-edit fs-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </button>
                        <button class="btn btn-sm btn-light-danger" onclick="deletePersonalTemplate(${template.id})" title="Excluir">
                            <i class="ki-duotone ki-trash fs-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    templatesList.innerHTML = html;
    
    // Adicionar busca em tempo real - remover listener anterior se existir e adicionar novo
    const searchInput = document.getElementById('personalTemplateSearch');
    if (searchInput) {
        // Clonar elemento para remover todos os listeners
        const newInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newInput, searchInput);
        
        // Adicionar novo listener
        newInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = templatesList.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }
}

// Mostrar modal de criar template pessoal
function showCreatePersonalTemplateModal() {
    const modalElement = document.getElementById('kt_modal_personal_template_form');
    if (!modalElement) {
        console.error('Modal de formulírio de template pessoal não encontrado');
        return;
    }
    
    // Resetar formulírio
    const formTitle = document.getElementById('personalTemplateFormTitle');
    const form = document.getElementById('personalTemplateForm');
    const templateId = document.getElementById('personalTemplateId');
    const templateActive = document.getElementById('personalTemplateActive');
    
    if (formTitle) formTitle.textContent = 'Novo Template Pessoal';
    if (form) form.reset();
    if (templateId) templateId.value = '';
    if (templateActive) templateActive.checked = true;
    
    // Verificar se já existe uma instância do modal
    let modal = bootstrap.Modal.getInstance(modalElement);
    
    // Se não existe, criar nova instância
    if (!modal) {
        modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    }
    
    // Fechar modal de templates pessoais se estiver aberto
    const personalTemplatesModal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_personal_templates'));
    if (personalTemplatesModal) {
        personalTemplatesModal.hide();
    }
    
    // Mostrar modal
    modal.show();
}

// Editar template pessoal
function editPersonalTemplate(templateId) {
    fetch(`<?= \App\Helpers\Url::to("/message-templates") ?>/${templateId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.template) {
            const template = data.template;
            document.getElementById('personalTemplateFormTitle').textContent = 'Editar Template Pessoal';
            document.getElementById('personalTemplateId').value = template.id;
            document.getElementById('personalTemplateName').value = template.name || '';
            document.getElementById('personalTemplateCategory').value = template.category || '';
            document.getElementById('personalTemplateDescription').value = template.description || '';
            document.getElementById('personalTemplateContent').value = template.content || '';
            document.getElementById('personalTemplateActive').checked = template.is_active !== false;
            
            const modal = new bootstrap.Modal(document.getElementById('kt_modal_personal_template_form'));
            modal.show();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'Template não encontrado',
                colorScheme: isDarkMode ? 'dark' : 'light',
                customClass: {
                    popup: isDarkMode ? 'swal2-dark' : '',
                    title: isDarkMode ? 'text-white' : '',
                    htmlContainer: isDarkMode ? 'text-white' : ''
                }
            });
        }
    })
    .catch(error => {
        console.error('Erro ao carregar template:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao carregar template',
            colorScheme: isDarkMode ? 'dark' : 'light',
            customClass: {
                popup: isDarkMode ? 'swal2-dark' : '',
                title: isDarkMode ? 'text-white' : '',
                htmlContainer: isDarkMode ? 'text-white' : ''
            }
        });
    });
}

// Deletar template pessoal
function deletePersonalTemplate(templateId) {
    Swal.fire({
        icon: 'warning',
        title: 'Confirmar Exclusão',
        text: 'Tem certeza que deseja excluir este template pessoal? Esta ação não pode ser desfeita.',
        showCancelButton: true,
        confirmButtonText: 'Sim, excluir',
        cancelButtonText: 'Cancelar',
        colorScheme: isDarkMode ? 'dark' : 'light',
        customClass: {
            popup: isDarkMode ? 'swal2-dark' : '',
            title: isDarkMode ? 'text-white' : '',
            htmlContainer: isDarkMode ? 'text-white' : '',
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-light'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`<?= \App\Helpers\Url::to("/message-templates") ?>/${templateId}`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: 'Template excluído com sucesso',
                        timer: 2000,
                        showConfirmButton: false,
                        colorScheme: isDarkMode ? 'dark' : 'light',
                        customClass: {
                            popup: isDarkMode ? 'swal2-dark' : '',
                            title: isDarkMode ? 'text-white' : '',
                            htmlContainer: isDarkMode ? 'text-white' : ''
                        }
                    });
                    loadPersonalTemplates();
                    loadTemplates(); // Recarregar templates no modal principal tambêm
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message || 'Erro ao excluir template',
                        colorScheme: isDarkMode ? 'dark' : 'light',
                        customClass: {
                            popup: isDarkMode ? 'swal2-dark' : '',
                            title: isDarkMode ? 'text-white' : '',
                            htmlContainer: isDarkMode ? 'text-white' : ''
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao excluir template:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao excluir template',
                    colorScheme: isDarkMode ? 'dark' : 'light',
                    customClass: {
                        popup: isDarkMode ? 'swal2-dark' : '',
                        title: isDarkMode ? 'text-white' : '',
                        htmlContainer: isDarkMode ? 'text-white' : ''
                    }
                });
            });
        }
    });
}

// Submeter formulírio de template pessoal
document.addEventListener('DOMContentLoaded', function() {
    const personalTemplateForm = document.getElementById('personalTemplateForm');
    if (personalTemplateForm) {
        personalTemplateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('personalTemplateSubmitBtn');
            const indicator = submitBtn.querySelector('.indicator-label');
            const progress = submitBtn.querySelector('.indicator-progress');
            
            submitBtn.disabled = true;
            indicator.classList.add('d-none');
            progress.classList.remove('d-none');
            
            const formData = new FormData(this);
            const data = {
                name: formData.get('name'),
                category: formData.get('category') || null,
                description: formData.get('description') || null,
                content: formData.get('content'),
                is_active: formData.get('is_active') === '1',
                is_personal: true
            };
            
            const templateId = formData.get('id');
            const url = templateId 
                ? `<?= \App\Helpers\Url::to("/message-templates") ?>/${templateId}`
                : '<?= \App\Helpers\Url::to("/message-templates") ?>';
            const method = templateId ? 'POST' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: templateId ? 'Template atualizado com sucesso!' : 'Template criado com sucesso!',
                        timer: 2000,
                        showConfirmButton: false,
                        colorScheme: isDarkMode ? 'dark' : 'light',
                        customClass: {
                            popup: isDarkMode ? 'swal2-dark' : '',
                            title: isDarkMode ? 'text-white' : '',
                            htmlContainer: isDarkMode ? 'text-white' : ''
                        }
                    });
                    
                    bootstrap.Modal.getInstance(document.getElementById('kt_modal_personal_template_form')).hide();
                    loadPersonalTemplates();
                    loadTemplates(); // Recarregar templates no modal principal tambêm
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: result.message || 'Erro ao salvar template',
                        colorScheme: isDarkMode ? 'dark' : 'light',
                        customClass: {
                            popup: isDarkMode ? 'swal2-dark' : '',
                            title: isDarkMode ? 'text-white' : '',
                            htmlContainer: isDarkMode ? 'text-white' : ''
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao salvar template:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao salvar template',
                    colorScheme: isDarkMode ? 'dark' : 'light',
                    customClass: {
                        popup: isDarkMode ? 'swal2-dark' : '',
                        title: isDarkMode ? 'text-white' : '',
                        htmlContainer: isDarkMode ? 'text-white' : ''
                    }
                });
            })
            .finally(() => {
                submitBtn.disabled = false;
                indicator.classList.remove('d-none');
                progress.classList.add('d-none');
            });
        });
    }
});

function loadTemplates() {
    const templatesList = document.getElementById('templatesList');
    if (!templatesList) return;
    
    // Mostrar loading
    templatesList.innerHTML = `
        <tr>
            <td colspan="4" class="text-center text-muted py-10">
                <span class="spinner-border spinner-border-sm text-primary mb-3" role="status"></span>
                <div>Carregando templates...</div>
            </td>
        </tr>
    `;
    
    // Buscar templates disponíveis para a conversa atual (inclui pessoais + globais)
    const conversationId = currentConversationId;
    const url = '<?= \App\Helpers\Url::to('/message-templates/available') ?>' + 
                (conversationId ? `?conversation_id=${conversationId}` : '');
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.templates) {
            renderTemplates(data.templates);
        } else {
            templatesList.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-10">
                        <i class="ki-duotone ki-information-5 fs-3x mb-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <div>Nenhum template disponível</div>
                    </td>
                </tr>
            `;
        }
    })
    .catch(error => {
        console.error('Erro ao carregar templates:', error);
        templatesList.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-danger py-10">
                    <div>Erro ao carregar templates</div>
                </td>
            </tr>
        `;
    });
}

function renderTemplates(templates) {
    const templatesList = document.getElementById('templatesList');
    if (!templatesList) return;
    
    if (templates.length === 0) {
        templatesList.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-10">
                    <div>Nenhum template disponível</div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Separar templates pessoais e globais
    const personalTemplates = templates.filter(t => t.user_id !== null && t.user_id !== undefined);
    const globalTemplates = templates.filter(t => t.user_id === null || t.user_id === undefined);
    
    let html = '';
    
    // Templates pessoais primeiro
    if (personalTemplates.length > 0) {
        html += `
            <tr class="table-group">
                <td colspan="4" class="bg-light-primary fw-bold py-2">
                    <i class="ki-duotone ki-user fs-6 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Meus Templates (${personalTemplates.length})
                </td>
            </tr>
        `;
        personalTemplates.forEach(template => {
            const category = template.category || 'Geral';
            html += `
                <tr data-template-id="${template.id}" data-type="personal">
                    <td>
                        <div class="fw-semibold text-gray-800">${escapeHtml(template.name)}</div>
                        ${template.description ? `<div class="text-muted fs-7">${escapeHtml(template.description)}</div>` : ''}
                    </td>
                    <td>
                        <span class="badge badge-light-primary">${escapeHtml(category)}</span>
                    </td>
                    <td>
                        <span class="badge badge-light-warning badge-sm">
                            <i class="ki-duotone ki-user fs-7 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Pessoal
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light-primary me-2" onclick="previewTemplate(${template.id})" title="Preview">
                            <i class="ki-duotone ki-eye fs-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="useTemplate(${template.id})" title="Usar template">
                            <i class="ki-duotone ki-check fs-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Usar
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    // Templates globais depois
    if (globalTemplates.length > 0) {
        html += `
            <tr class="table-group">
                <td colspan="4" class="bg-light-info fw-bold py-2">
                    <i class="ki-duotone ki-global fs-6 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Templates Globais (${globalTemplates.length})
                </td>
            </tr>
        `;
        globalTemplates.forEach(template => {
            const category = template.category || 'Geral';
            html += `
                <tr data-template-id="${template.id}" data-type="global">
                    <td>
                        <div class="fw-semibold text-gray-800">${escapeHtml(template.name)}</div>
                        ${template.description ? `<div class="text-muted fs-7">${escapeHtml(template.description)}</div>` : ''}
                    </td>
                    <td>
                        <span class="badge badge-light-info">${escapeHtml(category)}</span>
                    </td>
                    <td>
                        <span class="badge badge-light-secondary badge-sm">
                            <i class="ki-duotone ki-global fs-7 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Global
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light-primary me-2" onclick="previewTemplate(${template.id})" title="Preview">
                            <i class="ki-duotone ki-eye fs-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="useTemplate(${template.id})" title="Usar template">
                            <i class="ki-duotone ki-check fs-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Usar
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    templatesList.innerHTML = html;
    
    // Adicionar busca em tempo real
    const searchInput = document.getElementById('templateSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = templatesList.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }
}

function previewTemplate(templateId) {
    if (!currentConversationId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione uma conversa primeiro para visualizar o preview com variíveis',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    fetch(`<?= \App\Helpers\Url::to('/message-templates') ?>/${templateId}/preview`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            conversation_id: currentConversationId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                               document.body.classList.contains('dark-mode') ||
                               window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            Swal.fire({
                title: 'Preview do Template',
                html: `
                    <div class="text-start">
                        <div class="alert alert-info mb-4" style="white-space: pre-wrap; text-align: left;">${escapeHtml(data.processed_content || data.content)}</div>
                        ${data.variables_used ? `
                            <div class="text-muted fs-7">
                                <strong>Variíveis utilizadas:</strong> ${data.variables_used.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Usar este Template',
                cancelButtonText: 'Fechar',
                buttonsStyling: false,
                colorScheme: isDarkMode ? 'dark' : 'light',
                customClass: {
                    confirmButton: 'btn btn-primary',
                    cancelButton: 'btn btn-light',
                    popup: isDarkMode ? 'swal2-dark' : '',
                    title: isDarkMode ? 'text-white' : '',
                    htmlContainer: isDarkMode ? 'text-white' : ''
                },
                width: '700px'
            }).then((result) => {
                if (result.isConfirmed) {
                    useTemplate(templateId);
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: data.message || 'Erro ao processar template'
            });
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao carregar preview do template'
        });
    });
}

function useTemplate(templateId) {
    if (!currentConversationId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione uma conversa primeiro',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    fetch(`<?= \App\Helpers\Url::to('/message-templates') ?>/${templateId}/process`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            conversation_id: currentConversationId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = data.processed_content || data.content;
                messageInput.focus();
                
                // Fechar modal de templates
                const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_templates'));
                if (modal) {
                    modal.hide();
                }
            }
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: data.message || 'Erro ao processar template'
            });
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao processar template'
        });
    });
}

function loadTemplates() {
    const tbody = document.getElementById('templatesList');
    if (!tbody) {
        console.error('Elemento templatesList não encontrado');
        return;
    }
    
    // Mostrar loading
    tbody.innerHTML = `
        <tr>
            <td colspan="3" class="text-center text-muted py-10">
                <span class="spinner-border spinner-border-sm text-primary mb-3" role="status"></span>
                <div>Carregando templates...</div>
            </td>
        </tr>
    `;
    
    fetch('<?= \App\Helpers\Url::to("/message-templates/available") ?>')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success || !data.templates || data.templates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted py-10">
                            Nenhum template disponível
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            data.templates.forEach(template => {
                html += `
                    <tr data-template-id="${template.id}">
                        <td>
                            <div class="fw-semibold text-gray-800">${escapeHtml(template.name)}</div>
                            <div class="text-muted fs-7">${escapeHtml(template.content.substring(0, 80))}${template.content.length > 80 ? '...' : ''}</div>
                            <div class="template-preview mt-2 p-3 bg-light rounded d-none" id="preview-${template.id}" style="white-space: pre-wrap; font-size: 13px; border-left: 3px solid var(--bs-primary);">
                                <div class="fw-semibold mb-2 text-primary">Preview:</div>
                                <div class="preview-content text-gray-700"></div>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-light-primary">${escapeHtml(template.category || 'Geral')}</span>
                        </td>
                        <td class="text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-sm btn-light-info" onclick="previewTemplate(${template.id})" title="Ver preview">
                                    <i class="ki-duotone ki-eye fs-5">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                    </i>
                                </button>
                                <button class="btn btn-sm btn-light-primary" onclick="useTemplate(${template.id})">
                                    <i class="ki-duotone ki-check fs-5">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    Usar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Busca de templates - remover listener anterior se existir e adicionar novo
            const templateSearchInput = document.getElementById('templateSearch');
            if (templateSearchInput) {
                // Clonar elemento para remover todos os listeners
                const newInput = templateSearchInput.cloneNode(true);
                templateSearchInput.parentNode.replaceChild(newInput, templateSearchInput);
                
                // Adicionar novo listener
                newInput.addEventListener('input', function(e) {
                    const search = e.target.value.toLowerCase();
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(search) ? '' : 'none';
                    });
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar templates:', error);
            const tbody = document.getElementById('templatesList');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger py-10">
                            Erro ao carregar templates: ${error.message || 'Erro desconhecido'}
                        </td>
                    </tr>
                `;
            }
        });
}

// Preview de template com variíveis preenchidas
function previewTemplate(templateId) {
const conversationId = parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    const previewDiv = document.getElementById(`preview-${templateId}`);
    const previewContent = previewDiv ? previewDiv.querySelector('.preview-content') : null;
    
    if (!previewDiv || !previewContent) return;
    
    // Alternar visibilidade do preview
    const isVisible = !previewDiv.classList.contains('d-none');
    
    if (isVisible) {
        // Esconder preview
        previewDiv.classList.add('d-none');
        return;
    }
    
    // Mostrar loading
    previewContent.innerHTML = '<div class="text-muted"><i class="ki-duotone ki-loader fs-6"><span class="path1"></span><span class="path2"></span></i> Carregando preview...</div>';
    previewDiv.classList.remove('d-none');
    
    // Buscar preview do template
    fetch(`<?= \App\Helpers\Url::to("/message-templates") ?>/${templateId}/preview`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            conversation_id: conversationId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.preview) {
            // Mostrar preview formatado
            previewContent.innerHTML = escapeHtml(data.preview).replace(/\n/g, '<br>');
        } else {
            previewContent.innerHTML = '<div class="text-danger">Erro ao gerar preview</div>';
        }
    })
    .catch(error => {
        console.error('Erro ao gerar preview:', error);
        previewContent.innerHTML = '<div class="text-danger">Erro ao carregar preview</div>';
    });
}

function useTemplate(templateId) {
    const conversationId = currentConversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    
    if (!conversationId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione uma conversa primeiro',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    fetch(`<?= \App\Helpers\Url::to("/message-templates") ?>/${templateId}/process`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            conversation_id: conversationId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.processed_content) {
            const input = document.getElementById('messageInput');
            input.value = data.processed_content;
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 150) + 'px';
            input.focus();
            
            bootstrap.Modal.getInstance(document.getElementById('kt_modal_templates')).hide();
        } else {
            alert('Erro ao processar template: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar template');
    });
}

// Seletor rípido de templates
let templateQuickSelectData = [];
let templateQuickSelectIndex = -1;
let templateQuickSelectDebounce = null;

function initTemplateQuickSelect() {
    const messageInput = document.getElementById('messageInput');
    const templateQuickSelect = document.getElementById('templateQuickSelect');
    const templateQuickSearch = document.getElementById('templateQuickSearch');
    const templateQuickList = document.getElementById('templateQuickList');
    
    if (!messageInput || !templateQuickSelect || !templateQuickSearch || !templateQuickList) return;
    
    // Detectar digitação de {{ no campo de mensagem
    messageInput.addEventListener('input', function(e) {
        const value = e.target.value;
        const cursorPos = e.target.selectionStart;
        const textBeforeCursor = value.substring(0, cursorPos);
        
        // Verificar se digitou {{ antes do cursor
        if (textBeforeCursor.endsWith('{{')) {
            showTemplateQuickSelect();
        } else if (textBeforeCursor.includes('{{') && !textBeforeCursor.includes('}}')) {
            // Se já tem {{ mas não fechou, manter aberto
            const lastOpen = textBeforeCursor.lastIndexOf('{{');
            const textAfterOpen = textBeforeCursor.substring(lastOpen + 2);
            if (!textAfterOpen.includes('}}')) {
                filterTemplateQuickSelect(textAfterOpen);
            } else {
                hideTemplateQuickSelect();
            }
        } else {
            hideTemplateQuickSelect();
        }
    });
    
    // Fechar ao perder foco (com delay para permitir cliques)
    messageInput.addEventListener('blur', function() {
        setTimeout(() => {
            if (!templateQuickSelect.matches(':hover') && !templateQuickSearch.matches(':focus')) {
                hideTemplateQuickSelect();
            }
        }, 200);
    });
    
    // Busca no dropdown
    templateQuickSearch.addEventListener('input', function(e) {
        filterTemplateQuickSelect(e.target.value);
    });
    
    // Navegação com teclado
    messageInput.addEventListener('keydown', function(e) {
        if (!templateQuickSelect.classList.contains('d-none')) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateTemplateQuickSelect(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateTemplateQuickSelect(-1);
            } else if (e.key === 'Enter' && templateQuickSelectIndex >= 0) {
                e.preventDefault();
                selectTemplateQuickItem(templateQuickSelectIndex);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideTemplateQuickSelect();
            }
        }
    });
    
    // Clique no botão de templates tambêm abre o quick select
    const templateBtn = document.querySelector('button[onclick="showTemplatesModal()"]');
    if (templateBtn) {
        templateBtn.addEventListener('click', function(e) {
            // Se segurar Shift, abre quick select ao invês do modal
            if (e.shiftKey) {
                e.preventDefault();
                e.stopPropagation();
                showTemplateQuickSelect();
                return false;
            }
        });
    }
}

function showTemplateQuickSelect() {
    const templateQuickSelect = document.getElementById('templateQuickSelect');
    const templateQuickList = document.getElementById('templateQuickList');
    
    if (!templateQuickSelect || !templateQuickList) return;
    
    templateQuickSelect.classList.remove('d-none');
    templateQuickSelectIndex = -1;
    
    // Carregar templates se ainda não carregou
    if (templateQuickSelectData.length === 0) {
        loadTemplateQuickSelect();
    } else {
        renderTemplateQuickSelect(templateQuickSelectData);
    }
}

function hideTemplateQuickSelect() {
    const templateQuickSelect = document.getElementById('templateQuickSelect');
    if (templateQuickSelect) {
        templateQuickSelect.classList.add('d-none');
        templateQuickSelectIndex = -1;
    }
}

function loadTemplateQuickSelect() {
    const templateQuickList = document.getElementById('templateQuickList');
    if (!templateQuickList) return;
    
    templateQuickList.innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="ki-duotone ki-loader fs-3x mb-3">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
            <div>Carregando templates...</div>
        </div>
    `;
    
    fetch('<?= \App\Helpers\Url::to("/message-templates/available") ?>')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.templates) {
                // Separar e ordenar: pessoais primeiro, depois globais
                const personalTemplates = data.templates.filter(t => t.user_id !== null && t.user_id !== undefined);
                const globalTemplates = data.templates.filter(t => t.user_id === null || t.user_id === undefined);
                templateQuickSelectData = [...personalTemplates, ...globalTemplates];
                renderTemplateQuickSelect(templateQuickSelectData);
            } else {
                templateQuickList.innerHTML = `
                    <div class="text-center text-muted py-5">
                        Nenhum template disponível
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar templates:', error);
            templateQuickList.innerHTML = `
                <div class="text-center text-danger py-5">
                    Erro ao carregar templates
                </div>
            `;
        });
}

function renderTemplateQuickSelect(templates) {
    const templateQuickList = document.getElementById('templateQuickList');
    const templateQuickSearch = document.getElementById('templateQuickSearch');
    if (!templateQuickList) return;
    
    const searchTerm = templateQuickSearch ? templateQuickSearch.value.toLowerCase() : '';
    
    // Separar templates pessoais e globais
    const personalTemplates = templates.filter(t => t.user_id !== null && t.user_id !== undefined);
    const globalTemplates = templates.filter(t => t.user_id === null || t.user_id === undefined);
    
    // Filtrar ambos os grupos
    const filteredPersonal = personalTemplates.filter(t => {
        if (!searchTerm) return true;
        const name = (t.name || '').toLowerCase();
        const content = (t.content || '').toLowerCase();
        const category = (t.category || '').toLowerCase();
        return name.includes(searchTerm) || content.includes(searchTerm) || category.includes(searchTerm);
    });
    
    const filteredGlobal = globalTemplates.filter(t => {
        if (!searchTerm) return true;
        const name = (t.name || '').toLowerCase();
        const content = (t.content || '').toLowerCase();
        const category = (t.category || '').toLowerCase();
        return name.includes(searchTerm) || content.includes(searchTerm) || category.includes(searchTerm);
    });
    
    const filteredTemplates = [...filteredPersonal, ...filteredGlobal];
    
    if (filteredTemplates.length === 0) {
        templateQuickList.innerHTML = `
            <div class="text-center text-muted py-5">
                Nenhum template encontrado
            </div>
        `;
        return;
    }
    
    let html = '';
    let currentIndex = 0;
    
    // Templates pessoais primeiro
    if (filteredPersonal.length > 0) {
        html += `
            <div class="template-quick-group-header">
                <i class="ki-duotone ki-user fs-7 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                Meus Templates (${filteredPersonal.length})
            </div>
        `;
        filteredPersonal.forEach((template) => {
            const preview = (template.content || '').substring(0, 60);
            html += `
                <div class="template-quick-item ${currentIndex === templateQuickSelectIndex ? 'selected' : ''}" 
                     data-template-id="${template.id}" 
                     data-index="${currentIndex}"
                     onclick="selectTemplateQuickItem(${currentIndex})"
                     onmouseenter="highlightTemplateQuickItem(${currentIndex})">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="template-quick-item-name">${escapeHtml(template.name || 'Sem nome')}</div>
                        <span class="badge badge-light-warning badge-sm ms-2">
                            <i class="ki-duotone ki-user fs-7">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </span>
                    </div>
                    <div class="template-quick-item-preview">${escapeHtml(preview)}${template.content && template.content.length > 60 ? '...' : ''}</div>
                    ${template.category ? `<span class="template-quick-item-category">${escapeHtml(template.category)}</span>` : ''}
                </div>
            `;
            currentIndex++;
        });
    }
    
    // Templates globais depois
    if (filteredGlobal.length > 0) {
        html += `
            <div class="template-quick-group-header">
                <i class="ki-duotone ki-global fs-7 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                Templates Globais (${filteredGlobal.length})
            </div>
        `;
        filteredGlobal.forEach((template) => {
            const preview = (template.content || '').substring(0, 60);
            html += `
                <div class="template-quick-item ${currentIndex === templateQuickSelectIndex ? 'selected' : ''}" 
                     data-template-id="${template.id}" 
                     data-index="${currentIndex}"
                     onclick="selectTemplateQuickItem(${currentIndex})"
                     onmouseenter="highlightTemplateQuickItem(${currentIndex})">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="template-quick-item-name">${escapeHtml(template.name || 'Sem nome')}</div>
                        <span class="badge badge-light-secondary badge-sm ms-2">
                            <i class="ki-duotone ki-global fs-7">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </span>
                    </div>
                    <div class="template-quick-item-preview">${escapeHtml(preview)}${template.content && template.content.length > 60 ? '...' : ''}</div>
                    ${template.category ? `<span class="template-quick-item-category">${escapeHtml(template.category)}</span>` : ''}
                </div>
            `;
            currentIndex++;
        });
    }
    
    templateQuickList.innerHTML = html;
    
    // Scroll para item selecionado
    if (templateQuickSelectIndex >= 0) {
        const selectedItem = templateQuickList.querySelector(`[data-index="${templateQuickSelectIndex}"]`);
        if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    }
}

function filterTemplateQuickSelect(searchTerm) {
    if (templateQuickSelectDebounce) {
        clearTimeout(templateQuickSelectDebounce);
    }
    
    templateQuickSelectDebounce = setTimeout(() => {
        templateQuickSelectIndex = -1;
        renderTemplateQuickSelect(templateQuickSelectData);
    }, 150);
}

function navigateTemplateQuickSelect(direction) {
    const templateQuickList = document.getElementById('templateQuickList');
    if (!templateQuickList) return;
    
    const items = templateQuickList.querySelectorAll('.template-quick-item');
    if (items.length === 0) return;
    
    templateQuickSelectIndex += direction;
    
    if (templateQuickSelectIndex < 0) {
        templateQuickSelectIndex = items.length - 1;
    } else if (templateQuickSelectIndex >= items.length) {
        templateQuickSelectIndex = 0;
    }
    
    // Atualizar visual
    items.forEach((item, index) => {
        if (index === templateQuickSelectIndex) {
            item.classList.add('selected');
            item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
            item.classList.remove('selected');
        }
    });
}

function highlightTemplateQuickItem(index) {
    templateQuickSelectIndex = index;
    const templateQuickList = document.getElementById('templateQuickList');
    if (!templateQuickList) return;
    
    const items = templateQuickList.querySelectorAll('.template-quick-item');
    items.forEach((item, i) => {
        if (i === index) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

function selectTemplateQuickItem(index) {
    const templateQuickList = document.getElementById('templateQuickList');
    if (!templateQuickList) return;
    
    const items = templateQuickList.querySelectorAll('.template-quick-item');
    if (index < 0 || index >= items.length) return;
    
    const item = items[index];
    const templateId = item.getAttribute('data-template-id');
    
    if (templateId) {
        useTemplateQuick(templateId);
    }
}

function useTemplateQuick(templateId) {
    const messageInput = document.getElementById('messageInput');
    if (!messageInput) return;
    
    if (!currentConversationId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Selecione uma conversa primeiro para usar templates',
            confirmButtonText: 'OK'
        });
        hideTemplateQuickSelect();
        return;
    }
    
    // Buscar e processar template
    fetch(`<?= \App\Helpers\Url::to("/message-templates") ?>/${templateId}/process`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            conversation_id: currentConversationId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.processed_content) {
            // Substituir {{ pelo conteúdo do template
            const currentValue = messageInput.value;
            const cursorPos = messageInput.selectionStart;
            const textBeforeCursor = currentValue.substring(0, cursorPos);
            const textAfterCursor = currentValue.substring(cursorPos);
            
            // Encontrar último {{ antes do cursor
            const lastOpen = textBeforeCursor.lastIndexOf('{{');
            if (lastOpen >= 0) {
                const newValue = currentValue.substring(0, lastOpen) + data.processed_content + textAfterCursor;
                messageInput.value = newValue;
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
                
                // Posicionar cursor após o conteúdo inserido
                const newCursorPos = lastOpen + data.processed_content.length;
                messageInput.setSelectionRange(newCursorPos, newCursorPos);
            } else {
                // Se não encontrou {{, apenas inserir o conteúdo
                messageInput.value = data.processed_content;
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
            }
            
            messageInput.focus();
            hideTemplateQuickSelect();
        } else {
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                               document.body.classList.contains('dark-mode') ||
                               window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: data.message || 'Erro ao processar template',
                colorScheme: isDarkMode ? 'dark' : 'light',
                customClass: {
                    popup: isDarkMode ? 'swal2-dark' : '',
                    title: isDarkMode ? 'text-white' : '',
                    htmlContainer: isDarkMode ? 'text-white' : ''
                }
            });
            hideTemplateQuickSelect();
        }
    })
    .catch(error => {
        console.error('Erro ao processar template:', error);
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                           document.body.classList.contains('dark-mode') ||
                           window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao processar template',
            colorScheme: isDarkMode ? 'dark' : 'light',
            customClass: {
                popup: isDarkMode ? 'swal2-dark' : '',
                title: isDarkMode ? 'text-white' : '',
                htmlContainer: isDarkMode ? 'text-white' : ''
            }
        });
        hideTemplateQuickSelect();
    });
}

// Toggle nome do agente
function toggleAgentName() {
    const toggle = document.getElementById('agentNameToggle');
    const icon = document.getElementById('agentNameToggleIcon');
    
    if (toggle.classList.contains('active')) {
        toggle.classList.remove('active');
        toggle.classList.remove('btn-primary');
        toggle.classList.add('btn-light-primary');
        icon.classList.remove('text-primary');
        localStorage.setItem('agentNameEnabled', 'false');
    } else {
        toggle.classList.add('active');
        toggle.classList.remove('btn-light-primary');
        toggle.classList.add('btn-primary');
        icon.classList.add('text-primary');
        localStorage.setItem('agentNameEnabled', 'true');
    }
}

// Carregar estado inicial do toggle do nome do agente
document.addEventListener('DOMContentLoaded', function() {
    const defaultEnabled = <?= json_encode(\App\Services\SettingService::get('chat_agent_name_enabled', false)) ?>;
    const savedState = localStorage.getItem('agentNameEnabled');
    const isEnabled = savedState !== null ? savedState === 'true' : defaultEnabled;
    
    const toggle = document.getElementById('agentNameToggle');
    const icon = document.getElementById('agentNameToggleIcon');
    
    if (isEnabled && toggle) {
        toggle.classList.add('active');
        toggle.classList.remove('btn-light-primary');
        toggle.classList.add('btn-primary');
        if (icon) icon.classList.add('text-primary');
    }
});

// Modal de Variíveis
function showVariablesModal() {
    const modalElement = document.getElementById('kt_modal_variables');
    if (!modalElement) {
        console.error('Modal de variíveis não encontrado');
        return;
    }
    
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Carregar variíveis disponíveis
    loadVariables();
}

function loadVariables() {
    const variablesList = document.getElementById('variablesList');
    if (!variablesList) return;
    
    // Mostrar loading
    variablesList.innerHTML = `
        <div class="col-12 text-center py-10">
            <span class="spinner-border spinner-border-sm text-primary mb-3" role="status"></span>
            <div class="text-muted">Carregando variíveis...</div>
        </div>
    `;
    
    fetch('<?= \App\Helpers\Url::to('/message-templates/variables') ?>', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        // Verificar se a resposta é JSON antes de fazer parse
        const contentType = response.headers.get('content-type') || '';
        const text = await response.text();
        
        if (!contentType.includes('application/json')) {
            console.error('Resposta não é JSON. Content-Type:', contentType);
            console.error('Resposta completa:', text.substring(0, 500));
            throw new Error('Resposta não é JSON. Verifique o console para mais detalhes.');
        }
        
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error('Erro ao fazer parse do JSON:', e);
            console.error('Texto recebido:', text.substring(0, 500));
            throw new Error('Resposta não é JSON válido. Verifique o console para mais detalhes.');
        }
    })
    .then(data => {
        if (data.success && data.variables) {
            renderVariables(data.variables);
        } else {
            variablesList.innerHTML = `
                <div class="col-12 text-center text-muted py-10">
                    <div>Nenhuma variível disponível</div>
                    ${data.message ? `<div class="fs-7 mt-2">${escapeHtml(data.message)}</div>` : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Erro ao carregar variíveis:', error);
        variablesList.innerHTML = `
            <div class="col-12 text-center text-danger py-10">
                <div>Erro ao carregar variíveis</div>
                <div class="fs-7 mt-2">${escapeHtml(error.message || 'Erro desconhecido')}</div>
                <div class="fs-8 mt-3 text-muted">Verifique o console para mais detalhes</div>
            </div>
        `;
    });
}

function renderVariables(variables) {
    const variablesList = document.getElementById('variablesList');
    if (!variablesList) return;
    
    let html = '';
    
    // Variíveis de contato
    if (variables.contact) {
        html += ''
            + '<div class="col-12">'
            + '  <h5 class="fw-bold mb-3">'
            + '    <i class="ki-duotone ki-user fs-4 text-primary me-2">'
            + '      <span class="path1"></span>'
            + '      <span class="path2"></span>'
            + '    </i>'
            + '    Contato'
            + '  </h5>'
            + '</div>';

        Object.keys(variables.contact).forEach(key => {
            const varName = `{{contact.${key}}}`;
            const label = escapeHtml(varName);
            const desc = escapeHtml(variables.contact[key]);
            html += ''
                + '<div class="col-md-6">'
                + '  <div class="card card-flush shadow-sm hover-shadow-lg cursor-pointer" onclick="insertVariable(\''
                + varName.replace(/'/g, "\\'")
                + '\')">'
                + '    <div class="card-body p-4">'
                + '      <div class="d-flex justify-content-between align-items-center">'
                + '        <div>'
                + '          <div class="fw-semibold text-gray-800">' + label + '</div>'
                + '          <div class="text-muted fs-7">' + desc + '</div>'
                + '        </div>'
                + '        <i class="ki-duotone ki-copy fs-4 text-primary">'
                + '          <span class="path1"></span>'
                + '          <span class="path2"></span>'
                + '        </i>'
                + '      </div>'
                + '    </div>'
                + '  </div>'
                + '</div>';
        });
    }
    
    // Variíveis de agente
    if (variables.agent) {
        html += ''
            + '<div class="col-12 mt-5">'
            + '  <h5 class="fw-bold mb-3">'
            + '    <i class="ki-duotone ki-profile-user fs-4 text-success me-2">'
            + '      <span class="path1"></span>'
            + '      <span class="path2"></span>'
            + '    </i>'
            + '    Agente'
            + '  </h5>'
            + '</div>';
        
        Object.keys(variables.agent).forEach(key => {
            const varName = `{{agent.${key}}}`;
            const label = escapeHtml(varName);
            const desc = escapeHtml(variables.agent[key]);
            html += ''
                + '<div class="col-md-6">'
                + '  <div class="card card-flush shadow-sm hover-shadow-lg cursor-pointer" onclick="insertVariable(\''
                + varName.replace(/'/g, "\\'")
                + '\')">'
                + '    <div class="card-body p-4">'
                + '      <div class="d-flex justify-content-between align-items-center">'
                + '        <div>'
                + '          <div class="fw-semibold text-gray-800">' + label + '</div>'
                + '          <div class="text-muted fs-7">' + desc + '</div>'
                + '        </div>'
                + '        <i class="ki-duotone ki-copy fs-4 text-success">'
                + '          <span class="path1"></span>'
                + '          <span class="path2"></span>'
                + '        </i>'
                + '      </div>'
                + '    </div>'
                + '  </div>'
                + '</div>';
        });
    }
    
    // Variíveis de conversa
    if (variables.conversation) {
        html += ''
            + '<div class="col-12 mt-5">'
            + '  <h5 class="fw-bold mb-3">'
            + '    <i class="ki-duotone ki-message-text fs-4 text-info me-2">'
            + '      <span class="path1"></span>'
            + '      <span class="path2"></span>'
            + '      <span class="path3"></span>'
            + '    </i>'
            + '    Conversa'
            + '  </h5>'
            + '</div>';
        
        Object.keys(variables.conversation).forEach(key => {
            const varName = `{{conversation.${key}}}`;
            const label = escapeHtml(varName);
            const desc = escapeHtml(variables.conversation[key]);
            html += ''
                + '<div class="col-md-6">'
                + '  <div class="card card-flush shadow-sm hover-shadow-lg cursor-pointer" onclick="insertVariable(\''
                + varName.replace(/'/g, "\\'")
                + '\')">'
                + '    <div class="card-body p-4">'
                + '      <div class="d-flex justify-content-between align-items-center">'
                + '        <div>'
                + '          <div class="fw-semibold text-gray-800">' + label + '</div>'
                + '          <div class="text-muted fs-7">' + desc + '</div>'
                + '        </div>'
                + '        <i class="ki-duotone ki-copy fs-4 text-info">'
                + '          <span class="path1"></span>'
                + '          <span class="path2"></span>'
                + '        </i>'
                + '      </div>'
                + '    </div>'
                + '  </div>'
                + '</div>';
        });
    }
    
    // Variíveis de data/hora
    html += ''
        + '<div class="col-12 mt-5">'
        + '  <h5 class="fw-bold mb-3">'
        + '    <i class="ki-duotone ki-time fs-4 text-warning me-2">'
        + '      <span class="path1"></span>'
        + '      <span class="path2"></span>'
        + '    </i>'
        + '    Data e Hora'
        + '  </h5>'
        + '</div>';
    
    const dateVariables = {
        'date': 'Data atual (dd/mm/yyyy)',
        'time': 'Hora atual (HH:mm)',
        'datetime': 'Data e hora atuais'
    };
    
    Object.keys(dateVariables).forEach(key => {
        const varName = `{{${key}}}`;
        const label = escapeHtml(varName);
        const desc = escapeHtml(dateVariables[key]);
        html += ''
            + '<div class="col-md-4">'
            + '  <div class="card card-flush shadow-sm hover-shadow-lg cursor-pointer" onclick="insertVariable(\''
            + varName.replace(/'/g, "\\'")
            + '\')">'
            + '    <div class="card-body p-4">'
            + '      <div class="d-flex justify-content-between align-items-center">'
            + '        <div>'
            + '          <div class="fw-semibold text-gray-800">' + label + '</div>'
            + '          <div class="text-muted fs-7">' + desc + '</div>'
            + '        </div>'
            + '        <i class="ki-duotone ki-copy fs-4 text-warning">'
            + '          <span class="path1"></span>'
            + '          <span class="path2"></span>'
            + '        </i>'
            + '      </div>'
            + '    </div>'
            + '  </div>'
            + '</div>';
    });
    
    variablesList.innerHTML = html;
}

function insertVariable(variable) {
    const messageInput = document.getElementById('messageInput');
    if (!messageInput) return;
    
    const startPos = messageInput.selectionStart;
    const endPos = messageInput.selectionEnd;
    const text = messageInput.value;
    
    // Inserir variível na posição do cursor
    const newText = text.substring(0, startPos) + variable + text.substring(endPos);
    messageInput.value = newText;
    
    // Reposicionar cursor após a variível inserida
    const newPos = startPos + variable.length;
    messageInput.setSelectionRange(newPos, newPos);
    messageInput.focus();
    
    // Mostrar feedback visual
    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                       document.body.classList.contains('dark-mode') ||
                       window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    Swal.fire({
        icon: 'success',
        title: 'Variível inserida!',
        text: `Variível ${variable} inserida no campo de mensagem`,
        timer: 1500,
        showConfirmButton: false,
        colorScheme: isDarkMode ? 'dark' : 'light',
        customClass: {
            popup: isDarkMode ? 'swal2-dark' : '',
            title: isDarkMode ? 'text-white' : '',
            htmlContainer: isDarkMode ? 'text-white' : ''
        }
    });
    
    // Fechar modal após inserir
    const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_variables'));
    if (modal) {
        setTimeout(() => modal.hide(), 500);
    }
}

function renderVariables(variables) {
    const variablesList = document.getElementById('variablesList');
    if (!variablesList) return;
    
    let html = '';
    
    // Variíveis de contato
    if (variables.contact) {
        html += `
            <div class="col-12">
                <h5 class="fw-bold mb-3">
                    <i class="ki-duotone ki-user fs-4 text-primary me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Contato
                </h5>
            </div>
        `;
        Object.keys(variables.contact).forEach(key => {
            const varName = `{{contact.${key}}}`;
            html += `
                <div class="col-md-6">
                    <div class="card card-flush shadow-sm hover-shadow-lg cursor-pointer transition-all" onclick="insertVariable('${varName}')" style="cursor: pointer;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <code class="text-primary fw-bold fs-6 d-block mb-1">${escapeHtml(varName)}</code>
                                    <div class="text-muted fs-7">${escapeHtml(variables.contact[key])}</div>
                                </div>
                                <i class="ki-duotone ki-copy fs-4 text-primary">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    // Variíveis de agente
    if (variables.agent) {
        html += `
            <div class="col-12 mt-5">
                <h5 class="fw-bold mb-3">
                    <i class="ki-duotone ki-profile-user fs-4 text-success me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    Agente
                </h5>
            </div>
        `;
        Object.keys(variables.agent).forEach(key => {
            const varName = `{{agent.${key}}}`;
            html += `
                <div class="col-md-6">
                    <div class="card card-flush shadow-sm hover-shadow-lg cursor-pointer transition-all" onclick="insertVariable('${varName}')" style="cursor: pointer;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <code class="text-success fw-bold fs-6 d-block mb-1">${escapeHtml(varName)}</code>
                                    <div class="text-muted fs-7">${escapeHtml(variables.agent[key])}</div>
                                </div>
                                <i class="ki-duotone ki-copy fs-4 text-success">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    // Variíveis de conversa
    if (variables.conversation) {
        html += `
            <div class="col-12 mt-5">
                <h5 class="fw-bold mb-3">
                    <i class="ki-duotone ki-message-text fs-4 text-info me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    Conversa
                </h5>
            </div>
        `;
        Object.keys(variables.conversation).forEach(key => {
            const varName = `{{conversation.${key}}}`;
            html += `
                <div class="col-md-6">
                    <div class="card card-flush shadow-sm hover-shadow-lg cursor-pointer transition-all" onclick="insertVariable('${varName}')" style="cursor: pointer;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <code class="text-info fw-bold fs-6 d-block mb-1">${escapeHtml(varName)}</code>
                                    <div class="text-muted fs-7">${escapeHtml(variables.conversation[key])}</div>
                                </div>
                                <i class="ki-duotone ki-copy fs-4 text-info">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    // Variíveis de data/hora
    html += `
        <div class="col-12 mt-5">
            <h5 class="fw-bold mb-3">
                <i class="ki-duotone ki-time fs-4 text-warning me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                Data e Hora
            </h5>
        </div>
    `;
    
    const dateVariables = {
        'date': 'Data atual (dd/mm/yyyy)',
        'time': 'Hora atual (HH:mm)',
        'datetime': 'Data e hora atuais'
    };
    
    Object.keys(dateVariables).forEach(key => {
        const varName = `{{${key}}}`;
        html += `
            <div class="col-md-4">
                <div class="card card-flush shadow-sm hover-shadow-lg cursor-pointer transition-all" onclick="insertVariable('${varName}')" style="cursor: pointer;">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <code class="text-warning fw-bold fs-6 d-block mb-1">${escapeHtml(varName)}</code>
                                <div class="text-muted fs-7">${escapeHtml(dateVariables[key])}</div>
                            </div>
                            <i class="ki-duotone ki-copy fs-4 text-warning">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    variablesList.innerHTML = html;
}

function insertVariable(variable) {
    const messageInput = document.getElementById('messageInput');
    if (!messageInput) return;
    
    const startPos = messageInput.selectionStart;
    const endPos = messageInput.selectionEnd;
    const text = messageInput.value;
    
    // Inserir variível na posição do cursor
    const newText = text.substring(0, startPos) + variable + text.substring(endPos);
    messageInput.value = newText;
    
    // Reposicionar cursor após a variível inserida
    const newPos = startPos + variable.length;
    messageInput.setSelectionRange(newPos, newPos);
    messageInput.focus();
    
    // Ajustar altura do textarea
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
    
    // Mostrar feedback visual
    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                       document.body.classList.contains('dark-mode') ||
                       window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    Swal.fire({
        icon: 'success',
        title: 'Variível inserida!',
        text: `Variível ${variable} inserida no campo de mensagem`,
        timer: 1500,
        showConfirmButton: false,
        colorScheme: isDarkMode ? 'dark' : 'light',
        customClass: {
            popup: isDarkMode ? 'swal2-dark' : '',
            title: isDarkMode ? 'text-white' : '',
            htmlContainer: isDarkMode ? 'text-white' : ''
        }
    });
    
    // Fechar modal após inserir
    const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_variables'));
    if (modal) {
        setTimeout(() => modal.hide(), 500);
    }
}

// Função copyVariable mantida para compatibilidade, mas insertVariable é preferida
function copyVariable(variable) {
    insertVariable(variable);
}

// Verificar se conversa está com agente de IA
async function checkIfConversationHasAI(conversationId) {
    try {
        const response = await fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        });
        const data = await response.json();
        if (data.success && data.conversation) {
            // Verificar se existe conversa de IA ativa
            return data.conversation.has_ai_agent === true || data.conversation.ai_agent_id !== null;
        }
        return false;
    } catch (error) {
        console.error('Erro ao verificar agente de IA:', error);
        return false;
    }
}

// Escalar conversa de IA para humano
function escalateFromAI(conversationId) {
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_escalate'));
    document.getElementById('escalateConversationId').value = conversationId;
    document.getElementById('escalateAgent').value = '';
    modal.show();
}

// Modal de Atribuição
function assignConversation(conversationId) {
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_assign'));
    modal.show();
    
    // Resetar formulírio
    document.getElementById('assignForm').reset();

    // Resetar estado do botão de submit
    const submitBtn = document.querySelector('#assignForm button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Atribuir';
    }
    
    // Salvar ID da conversa no formulírio
    document.getElementById('assignForm').dataset.conversationId = conversationId;
}

// Submeter atribuição
document.getElementById('assignForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const conversationId = this.dataset.conversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    const agentId = document.getElementById('assignAgent').value;
    const departmentId = document.getElementById('assignDepartment').value;
    const internalNote = document.getElementById('assignInternalNote').value.trim();
    
    if (agentId === '' || agentId === null || agentId === undefined) {
        alert('Selecione um agente');
        return;
    }
    
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Atribuindo...';
    
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/assign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: JSON.stringify({
            agent_id: agentId === '0' ? 0 : parseInt(agentId, 10),
            department_id: departmentId ? parseInt(departmentId) : null,
            internal_note: internalNote || null
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Erro na resposta:', text);
                throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('kt_modal_assign')).hide();
            
            // Recarregar conversa para atualizar dados
            if (currentConversationId == conversationId) {
                // Recarregar conversa completa (inclui agentes do contato)
                selectConversation(conversationId);
            } else {
            window.location.reload();
            }
        } else {
            alert('Erro ao atribuir conversa: ' + (data.message || 'Erro desconhecido'));
            btn.disabled = false;
            btn.innerHTML = 'Atribuir';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atribuir conversa');
        btn.disabled = false;
        btn.innerHTML = 'Atribuir';
    });
});

// Submeter mudança de setor
document.getElementById('changeDepartmentForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const conversationId = document.getElementById('changeDepartmentConversationId').value || 
                          window.currentConversationId || 
                          parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    const departmentId = document.getElementById('changeDepartmentSelect').value || null;
    
    const btn = this.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
    
    const formData = new FormData();
    if (departmentId) {
        formData.append('department_id', departmentId);
    } else {
        formData.append('department_id', '');
    }
    
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/update-department`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('kt_modal_change_department')).hide();
            
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                               document.body.classList.contains('dark-mode') ||
                               window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: data.message || 'Setor atualizado com sucesso',
                colorScheme: isDarkMode ? 'dark' : 'light',
                timer: 2000,
                showConfirmButton: false
            });
            
            // Recarregar detalhes da conversa
            if (window.currentConversationId) {
                if (typeof selectConversation === 'function') {
                    selectConversation(window.currentConversationId);
                }
            }
            
            // Recarregar lista de conversas (preservando filtros)
            const urlParams = new URLSearchParams(window.location.search);
            if (typeof refreshConversationList === 'function') {
                refreshConversationList(urlParams);
            } else {
                window.location.reload();
            }
        } else {
            throw new Error(data.message || 'Erro ao atualizar setor');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                           document.body.classList.contains('dark-mode') ||
                           window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: error.message || 'Erro ao atualizar setor',
            colorScheme: isDarkMode ? 'dark' : 'light'
        });
        
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
});

// Modal de Tags
function manageTags(conversationId) {
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_tags'));
    modal.show();
    
    // Salvar ID da conversa
    document.getElementById('kt_modal_tags').dataset.conversationId = conversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    
    // Carregar tags
    loadTagsForConversation();
}

function loadTagsForConversation() {
    const conversationId = document.getElementById('kt_modal_tags').dataset.conversationId;
    
    // Carregar tags da conversa
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/tags`)
        .then(response => response.json())
        .then(data => {
            // Iniciar seleção com as tags atuais
            selectedTags = data.success && data.tags ? [...data.tags] : [];
            updateSelectedTagsDisplay();
        })
        .catch(error => {
            console.error('Erro ao carregar tags da conversa:', error);
            selectedTags = [];
            updateSelectedTagsDisplay();
        });
    
    // Carregar todas as tags disponíveis
    fetch('<?= \App\Helpers\Url::to("/tags/all") ?>')
        .then(response => response.json())
        .then(data => {
            const availableTagsDiv = document.getElementById('availableTags');
            
            if (!data.success || !data.tags || data.tags.length === 0) {
                availableTagsDiv.innerHTML = '<div class="text-muted">Nenhuma tag disponível</div>';
                return;
            }
            
            let html = '';
            data.tags.forEach(tag => {
                html += `
                    <span class="badge badge-lg" style="background-color: ${tag.color}20; color: ${tag.color}; cursor: pointer;" 
                          onclick="addTagToList(${tag.id}, '${escapeHtml(tag.name)}', '${tag.color}')" title="Clique para adicionar">
                        ${escapeHtml(tag.name)}
                        <i class="ki-duotone ki-plus fs-7 ms-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                    </span>
                `;
            });
            
            availableTagsDiv.innerHTML = html;
            
            // Busca de tags
            document.getElementById('tagSearch').addEventListener('input', function(e) {
                const search = e.target.value.toLowerCase();
                const tags = availableTagsDiv.querySelectorAll('span');
                tags.forEach(tag => {
                    const text = tag.textContent.toLowerCase();
                    tag.style.display = text.includes(search) ? '' : 'none';
                });
            });
        })
        .catch(error => {
            console.error('Erro ao carregar tags:', error);
            document.getElementById('availableTags').innerHTML = '<div class="text-danger">Erro ao carregar tags</div>';
        });
}

let selectedTags = [];

function addTagToList(tagId, tagName, tagColor) {
    if (selectedTags.find(t => t.id === tagId)) {
        return; // Jí está selecionada
    }
    
    selectedTags.push({ id: tagId, name: tagName, color: tagColor });
    updateSelectedTagsDisplay();
}

function removeTagFromList(tagId, tagName) {
    selectedTags = selectedTags.filter(t => t.id !== tagId);
    updateSelectedTagsDisplay();
}

function updateSelectedTagsDisplay() {
    const currentTagsDiv = document.getElementById('currentTags');
    const uniqueTags = selectedTags.filter((tag, index, self) =>
        index === self.findIndex(t => t.id === tag.id)
    );
    
    if (uniqueTags.length > 0) {
        let html = '<div class="w-100 mb-2"><strong>Tags Selecionadas:</strong></div>';
        uniqueTags.forEach(tag => {
            html += `
                <span class="badge badge-lg" 
                      style="background-color: ${tag.color}20; color: ${tag.color}; cursor: pointer;" 
                      onclick="removeTagFromList(${tag.id}, '${escapeHtml(tag.name)}')" title="Clique para remover">
                    ${escapeHtml(tag.name)}
                    <i class="ki-duotone ki-cross fs-7 ms-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </span>
            `;
        });
        currentTagsDiv.innerHTML = html;
    } else {
        currentTagsDiv.innerHTML = '<div class="w-100 text-muted">Nenhuma tag selecionada</div>';
    }
}

function saveTags() {
    const conversationId = document.getElementById('kt_modal_tags').dataset.conversationId;
    
    // Carregar tags atuais para comparar
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/tags`)
        .then(response => response.json())
        .then(data => {
            const currentTagIds = data.success && data.tags ? data.tags.map(t => t.id) : [];
            const selectedTagIds = selectedTags.map(t => t.id);
            
            // Tags para adicionar (estão em selectedTags mas não nas atuais)
            const toAdd = selectedTagIds.filter(id => !currentTagIds.includes(id));
            
            // Tags para remover (estão nas atuais mas não em selectedTags)
            const toRemove = currentTagIds.filter(id => !selectedTagIds.includes(id));
            
            // Executar operaçÁes
            const promises = [
                ...toAdd.map(tagId => 
                    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/tags`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ tag_id: tagId })
                    })
                ),
                ...toRemove.map(tagId => 
                    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/tags/remove`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ tag_id: tagId })
                    })
                )
            ];
            
            Promise.all(promises)
                .then(() => {
                    // Buscar tags atualizadas para refletir no sidebar
                    return fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/tags`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        }
                    }).then(r => r.json());
                })
                .then(updated => {
                    const tags = updated.success && updated.tags ? updated.tags : [];
                    
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('kt_modal_tags')).hide();
                    selectedTags = [];
                    
                    // Atualizar sidebar (tags) sem refresh
                    if (typeof updateConversationSidebar === 'function') {
                        updateConversationSidebar({ id: conversationId }, tags);
                    }
                    
                    // Atualizar modelos locais em memória (selected/current conversation)
                    if (window.selectedConversation && window.selectedConversation.id == conversationId) {
                        window.selectedConversation.tags = tags;
                    }
                    if (window.currentConversation && window.currentConversation.id == conversationId) {
                        window.currentConversation.tags = tags;
                    }
                    
                    // Atualizar lista de conversas (tags nos itens) sem refresh
                    if (typeof refreshConversationList === 'function') {
                        const urlParams = new URLSearchParams(window.location.search);
                        // Cache buster para evitar lista cacheada
                        urlParams.set('_ts', Date.now().toString());
                        console.debug('[TAGS_DEBUG] saveTags -> refreshConversationList', Object.fromEntries(urlParams.entries()));
                        refreshConversationList(urlParams);
                    } else {
                        // Fallback: atualizar item atual se existir
                        const item = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                        if (item) {
                            const tagsContainer = item.querySelector('.conversation-item-tags');
                            if (tagsContainer) {
                                const tagsHtml = tags.slice(0, 2).map(t => 
                                    `<span class="badge badge-sm" style="background-color: ${t.color || '#009ef7'}20; color: ${t.color || '#009ef7'};">${escapeHtml(t.name)}</span>`
                                ).join('');
                                tagsContainer.innerHTML = tagsHtml || '';
                                console.debug('[TAGS_DEBUG] saveTags fallback updated item', { conversationId, tagsCount: tags.length });
                            }
                        }
                    }
                    
                    // Atualizar listagem na UI (opcional): recarregar participantes/modal
                    loadTagsForConversation();
                    
                    // Sucesso visual
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Tags atualizadas',
                            timer: 1400,
                            showConfirmButton: false
                        });
                    } else {
                        alert('Tags atualizadas com sucesso');
                    }
                })
                .catch(error => {
                    console.error('Erro ao salvar tags:', error);
                    alert('Erro ao salvar tags');
                });
        });
}

// Função helper para escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Modal de Participantes
function showAddParticipantModal(conversationId) {
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_participants'));
    modal.show();
    
    // Salvar ID da conversa
    document.getElementById('kt_modal_participants').dataset.conversationId = conversationId || window.currentConversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    window.currentConversationId = document.getElementById('kt_modal_participants').dataset.conversationId || window.currentConversationId;
    
    // Carregar participantes e usuírios disponíveis
    loadParticipantsForConversation(window.currentConversationId);
}

function loadParticipantsForConversation(conversationIdParam = null) {
    const modalElement = document.getElementById('kt_modal_participants');
    const conversationId = conversationIdParam || (modalElement ? modalElement.dataset.conversationId : null) || window.currentConversationId;
    
    if (!conversationId || conversationId === 'undefined' || conversationId === 'null') {
        console.error('loadParticipantsForConversation: conversationId inválido:', conversationId);
        return;
    }
    
    // Garantir que o dataset fique sincronizado para as próximas chamadas
    if (modalElement) {
        modalElement.dataset.conversationId = conversationId;
    }

    console.log('loadParticipantsForConversation: conversationId =', conversationId);
    
    // Tambêm carregar convites pendentes
    if (typeof loadPendingInvitesForConversation === 'function') {
        loadPendingInvitesForConversation(conversationId);
    }
    
    // Carregar participantes atuais
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/participants`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
        .then(response => {
            // Primeiro, pegar o texto da resposta
            return response.text().then(text => {
                console.log('=== RESPOSTA BRUTA (getParticipants) ===');
                console.log('Status:', response.status);
                console.log('Primeiros 300 chars:', text.substring(0, 300));
                
                if (!response.ok) {
                    console.error('❌ Resposta com erro:', text);
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Tentar fazer parse do JSON
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('❌ Erro ao fazer parse do JSON:', e);
                    console.error('Texto completo:', text);
                    throw new Error('Resposta não é JSON válido');
                }
            });
        })
        .then(data => {
            const currentParticipantsDiv = document.getElementById('currentParticipants');
            
            if (data.success && data.participants && data.participants.length > 0) {
                let html = '<div class="w-100 mb-3"><strong>Participantes Atuais:</strong></div>';
                data.participants.forEach(p => {
                    const initials = (p.user_name || 'U').charAt(0).toUpperCase();
                    html += `
                        <div class="d-flex align-items-center gap-2 p-2 border rounded mb-2" style="background: var(--bs-gray-100);">
                            <div class="symbol symbol-30px symbol-circle">
                                <div class="symbol-label bg-light-primary text-primary fw-bold fs-7">
                                    ${initials}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold fs-7">${escapeHtml(p.user_name || 'Usuírio')}</div>
                                ${p.user_email ? `<div class="text-muted fs-8">${escapeHtml(p.user_email)}</div>` : ''}
                            </div>
                            <button type="button" class="btn btn-sm btn-icon btn-light-danger p-0" 
                                    onclick="removeParticipant(${conversationId}, ${p.user_id})" 
                                    title="Remover participante">
                                <i class="ki-duotone ki-cross fs-7">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                            </button>
                        </div>
                    `;
                });
                currentParticipantsDiv.innerHTML = html;
            } else {
                currentParticipantsDiv.innerHTML = '<div class="w-100 text-muted">Nenhum participante adicional</div>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar participantes:', error);
            const currentParticipantsDiv = document.getElementById('currentParticipants');
            if (currentParticipantsDiv) {
                currentParticipantsDiv.innerHTML = '<div class="text-danger">Erro ao carregar participantes</div>';
            }
        });
    
    // Carregar agentes disponíveis para a conversa
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/available-agents`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('participantUserSelect');
            
            if (!data.success || !data.agents || data.agents.length === 0) {
                if (select) {
                    select.innerHTML = '<option value="">Nenhum agente disponível</option>';
                }
                return;
            }
            
            if (select) {
                select.innerHTML = '<option value="">Selecione um agente...</option>';
                data.agents.forEach(agent => {
                    const emailLabel = agent.email ? ' (' + escapeHtml(agent.email) + ')' : '';
                    select.innerHTML += `<option value="${agent.id}">${escapeHtml(agent.name || agent.email || 'Agente')}${emailLabel}</option>`;
                });
            }
        })
        .catch(error => {
            console.error('Erro ao carregar agentes:', error);
            const select = document.getElementById('participantUserSelect');
            if (select) {
                select.innerHTML = '<option value="">Erro ao carregar agentes</option>';
            }
        });
}

function removeParticipant(conversationId, userId, skipConfirm = false) {
    if (!skipConfirm && !confirm('Tem certeza que deseja remover este participante?')) {
        return;
    }
    
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/participants/${userId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        // Primeiro, pegar o texto da resposta
        return response.text().then(text => {
            console.log('=== RESPOSTA BRUTA (removeParticipant) ===');
            console.log('Status:', response.status);
            console.log('Content-Type:', response.headers.get('Content-Type'));
            console.log('Primeiros 500 chars:', text.substring(0, 500));
            
            if (!response.ok) {
                console.error('❌ Resposta com erro:', text);
                throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
            }
            
            // Tentar fazer parse do JSON
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error('❌ Erro ao fazer parse do JSON:', e);
                console.error('Texto completo da resposta:', text);
                throw new Error('Resposta não é JSON válido: ' + text.substring(0, 200));
            }
        });
    })
    .then(data => {
        if (data.success) {
            // Recarregar participantes
            loadParticipantsForConversation(conversationId);
            // Recarregar a conversa inteira para atualizar sidebar
            if (window.currentConversationId == conversationId) {
                if (typeof selectConversation === 'function') {
                    selectConversation(conversationId);
                }
            }
            // Atualizar apenas a seção de participantes do sidebar, se existir (sempre tenta)
            if (typeof updateConversationSidebar === 'function') {
                updateConversationSidebar({ id: conversationId }, []);
            }
            // Sucesso visual
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Participante removido',
                    timer: 1400,
                    showConfirmButton: false
                });
            } else {
                alert('Participante removido com sucesso');
            }
        } else {
            alert('Erro ao remover participante: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao remover participante:', error);
        alert('Erro ao remover participante: ' + error.message);
    });
}

function leaveConversation(conversationIdParam = null) {
    const conversationId = conversationIdParam || window.currentConversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    const loggedUserId = window.LOGGED_USER_ID ?? (parseInt('<?= (int)\App\Helpers\Auth::id() ?>') || null);
    
    if (!conversationId) {
        alert('ID da conversa não encontrado');
        return;
    }
    if (!loggedUserId) {
        alert('ID do usuário não encontrado');
        return;
    }
    
    if (!confirm('Deseja sair desta conversa?')) {
        return;
    }
    
    removeParticipant(conversationId, loggedUserId, true);
}

// Ações rápidas no sidebar
function loadConversationActions(conversationId) {
    const section = document.getElementById('sidebar-quick-actions-section');
    const container = document.getElementById('sidebar-action-buttons');
    if (!section || !container) return;
    container.innerHTML = '<div class="text-muted fs-7">Carregando ações...</div>';
    section.style.display = 'block';

    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/actions`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success || !data.buttons) {
            container.innerHTML = '<div class="text-muted fs-7">Nenhuma ação disponível</div>';
            return;
        }
        if (data.buttons.length === 0) {
            container.innerHTML = '<div class="text-muted fs-7">Nenhuma ação disponível</div>';
            return;
        }

        const html = data.buttons.map(btn => {
            const color = btn.color || '#009ef7';
            const icon = btn.icon || 'ki-bolt';
            const desc = btn.description ? `<div class="text-muted fs-8">${escapeHtml(btn.description)}</div>` : '';
            return `
                <button class="btn w-100 text-start" style="background:${color}20; color:${color}; border-color:${color}30;" 
                        onclick="runActionButton(${btn.id}, ${conversationId}, this)">
                    <i class="ki-duotone ${icon} fs-4 me-2">
                        <span class="path1"></span><span class="path2"></span>
                    </i>
                    <span class="fw-semibold">${escapeHtml(btn.name)}</span>
                    ${desc}
                </button>
            `;
        }).join('');
        container.innerHTML = html;
    })
    .catch(err => {
        console.error('Erro ao carregar ações:', err);
        container.innerHTML = '<div class="text-danger fs-7">Erro ao carregar ações</div>';
    });
}

function runActionButton(buttonId, conversationId, btnEl) {
    if (!buttonId || !conversationId) return;
    const originalHtml = btnEl ? btnEl.innerHTML : '';
    if (btnEl) {
        btnEl.disabled = true;
        btnEl.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Executando...';
    }
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${conversationId}/actions/${buttonId}/run`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Erro ao executar ação');
        }
        // Recarregar a página para refletir todas as alterações (etapa, participantes, tags, etc)
        if (typeof Swal !== 'undefined') {
            Swal.fire({ icon: 'success', title: 'Ação executada', timer: 900, showConfirmButton: false })
                .then(() => window.location.reload());
        } else {
            window.location.reload();
        }
    })
    .catch(err => {
        console.error('Erro ao executar ação:', err);
        if (typeof Swal !== 'undefined') {
            Swal.fire({ icon: 'error', title: 'Erro', text: err.message });
        } else {
            alert(err.message);
        }
    })
    .finally(() => {
        if (btnEl) {
            btnEl.disabled = false;
            btnEl.innerHTML = originalHtml;
        }
    });
}

/**
 * Adicionar participante diretamente à conversa (sem necessidade de aceitar convite)
 */
function sendParticipantInvite() {
    const modalElement = document.getElementById('kt_modal_participants');
    const conversationId = modalElement.dataset.conversationId || window.currentConversationId;
    const userId = document.getElementById('participantUserSelect').value;
    
    if (!conversationId || conversationId === 'undefined' || conversationId === 'null') {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'ID da conversa não encontrado'
        });
        return;
    }
    
    if (!userId) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Por favor, selecione um agente'
        });
        return;
    }
    
    const btn = document.getElementById('addParticipantBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adicionando...';
    
    // Usar endpoint de participantes (adiciona diretamente)
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/participants`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ 
            user_id: parseInt(userId),
            role: 'collaborator' // ou 'observer'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Limpar select
            document.getElementById('participantUserSelect').value = '';
            
            // Recarregar participantes
            loadParticipantsForConversation(conversationId);
            
            Swal.fire({
                icon: 'success',
                title: 'Participante Adicionado!',
                text: data.message || 'O agente foi adicionado com sucesso à conversa.',
                timer: 3000,
                showConfirmButton: false
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: data.message || 'Erro ao adicionar participante'
            });
        }
    })
    .catch(error => {
        console.error('Erro ao adicionar participante:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao comunicar com o servidor. Tente novamente.'
        });
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="ki-duotone ki-send fs-5 me-1"><span class="path1"></span><span class="path2"></span></i> Adicionar';
    });
}

/**
 * Carregar convites pendentes de uma conversa específica
 */
function loadPendingInvitesForConversation(conversationId) {
    const section = document.getElementById('pendingInvitesSection');
    const list = document.getElementById('pendingInvitesList');
    
    if (!section || !list) return;
    
    fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/mentions`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.mentions && data.mentions.length > 0) {
            // Filtrar apenas pendentes
            const pending = data.mentions.filter(m => m.status === 'pending');
            
            if (pending.length > 0) {
                section.style.display = 'block';
                list.innerHTML = pending.map(m => `
                    <div class="d-flex align-items-center gap-2 p-2 border border-warning rounded mb-2" style="background: rgba(255, 193, 7, 0.1);">
                        <div class="symbol symbol-30px symbol-circle">
                            <div class="symbol-label bg-light-warning text-warning fw-bold fs-7">
                                ${(m.mentioned_user_name || 'U').charAt(0).toUpperCase()}
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold fs-7">${escapeHtml(m.mentioned_user_name || 'Agente')}</div>
                            <div class="text-muted fs-8">
                                <i class="ki-duotone ki-timer fs-8 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                                Aguardando resposta...
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-icon btn-light-danger p-0" 
                                onclick="cancelInvite(${m.id}, ${conversationId})" 
                                title="Cancelar convite">
                            <i class="ki-duotone ki-cross fs-7">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </button>
                    </div>
                `).join('');
            } else {
                section.style.display = 'none';
                list.innerHTML = '';
            }
        } else {
            section.style.display = 'none';
            list.innerHTML = '';
        }
    })
    .catch(error => {
        console.error('Erro ao carregar convites pendentes:', error);
        section.style.display = 'none';
    });
}

/**
 * Cancelar um convite pendente
 */
function cancelInvite(mentionId, conversationId) {
    Swal.fire({
        title: 'Cancelar Convite?',
        text: 'O agente não receberí mais este convite.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, cancelar',
        cancelButtonText: 'Não'
    }).then(result => {
        if (result.isConfirmed) {
            fetch(`<?= \App\Helpers\Url::to("/conversations/invites") ?>/${mentionId}/cancel`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadPendingInvitesForConversation(conversationId);
                    Swal.fire({
                        icon: 'success',
                        title: 'Convite cancelado',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.message || 'Erro ao cancelar convite'
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao cancelar convite:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao cancelar convite'
                });
            });
        }
    });
}

// Função legada para compatibilidade (redireciona para convite)
function addParticipant() {
    sendParticipantInvite();
}

// Helpers de anexos (fila antes de enviar)
const ALLOWED_ATTACHMENT_TYPES = [
    'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
    'video/mp4', 'video/webm', 'video/ogg', 'video/quicktime', 'video/x-m4v',
    'audio/mp3', 'audio/wav', 'audio/ogg',
    'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'text/plain', 'text/csv'
];

function getMaxAttachmentSize(file) {
    const type = (file && file.type) ? file.type : '';
    const name = (file && file.name) ? file.name : '';
    const ext = name.includes('.') ? name.split('.').pop().toLowerCase() : '';

    if (type.startsWith('video/') || ['mp4', 'webm', 'ogg', 'mov', 'm4v'].includes(ext)) {
        return 64 * 1024 * 1024; // 64MB
    }
    if (type.startsWith('audio/') || ['mp3', 'wav', 'ogg', 'webm'].includes(ext)) {
        return 16 * 1024 * 1024; // 16MB
    }
    if (type.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
        return 16 * 1024 * 1024; // 16MB
    }
    return 100 * 1024 * 1024; // 100MB (documentos)
}

function renderPendingAttachments() {
    const container = document.getElementById('pendingAttachmentsContainer');
    if (!container) return;
    if (!pendingAttachments.length) {
        container.innerHTML = '';
        return;
    }
    let html = '';
    pendingAttachments.forEach((item, idx) => {
        const url = item.file.type.startsWith('image/') ? URL.createObjectURL(item.file) : null;
        html += `
            <div class="d-flex align-items-center gap-3 p-2 rounded border" data-attachment-idx="${idx}" style="background: rgba(255,255,255,0.03);">
                ${url ? `<div class="rounded overflow-hidden" style="width:64px;height:64px;background:#111;"><img src="${url}" style="width:64px;height:64px;object-fit:cover;" onload="if (window.URL && window.URL.revokeObjectURL) { window.URL.revokeObjectURL(this.src); }"></div>` : `
                <div class="d-flex align-items-center justify-content-center rounded" style="width:64px;height:64px;background:#111;">
                    <i class="ki-duotone ki-file fs-2"></i>
                </div>`}
                <div class="flex-grow-1 min-w-0">
                    <div class="fw-semibold text-truncate">${escapeHtml(item.file.name)}</div>
                    <div class="text-muted fs-7">${formatFileSize(item.file.size)}</div>
                </div>
                <button type="button" class="btn btn-sm btn-icon btn-light-danger" title="Remover" onclick="removePendingAttachment(${idx})">
                    <i class="ki-duotone ki-cross fs-2"><span class="path1"></span><span class="path2"></span></i>
                </button>
            </div>
        `;
    });
    container.innerHTML = html;
}

function removePendingAttachment(idx) {
    pendingAttachments = pendingAttachments.filter((_, i) => i !== idx);
    renderPendingAttachments();
}

function addPendingAttachment(file) {
    const maxSize = getMaxAttachmentSize(file);
    if (file.size > maxSize) {
        alert('Arquivo muito grande. Tamanho máximo: ' + Math.floor(maxSize / 1024 / 1024) + 'MB');
        return;
    }
    const isAllowed = ALLOWED_ATTACHMENT_TYPES.includes(file.type) ||
        /\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mov|m4v|mp3|wav|pdf|doc|docx|xls|xlsx|txt|csv)$/i.test(file.name);
    if (!isAllowed) {
        alert('Tipo de arquivo não permitido');
        return;
    }
    pendingAttachments.push({ file });
    renderPendingAttachments();
}

// Upload de arquivo (file picker) adiciona à fila
function attachFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
    
    input.onchange = function(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            addPendingAttachment(file);
        });
    };
    
    input.click();
}

// Upload imediato legado (mantido para compatibilidade, não usado no fluxo atual)
function uploadFile(file) {
    // Usar variível JavaScript global que é atualizada dinamicamente
    const conversationId = currentConversationId || parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    
    if (!conversationId) {
        alert('Selecione uma conversa primeiro');
        return;
    }

    const uploadId = 'upload_' + Date.now();
    const chatMessages = document.getElementById('chatMessages');
    const uploadDiv = document.createElement('div');
    uploadDiv.id = uploadId;
    uploadDiv.className = 'chat-message outgoing';
    
    // Construir HTML inicial
    let initialHtml = '<div class="message-content">';
    initialHtml += '<div class="message-bubble">';
    initialHtml += '<div class="d-flex align-items-center gap-2">';
    initialHtml += '<i class="ki-duotone ki-file-up fs-3">';
    initialHtml += '<span class="path1"></span><span class="path2"></span><span class="path3"></span>';
    initialHtml += '</i>';
    initialHtml += '<div class="flex-grow-1">';
    initialHtml += '<div class="fw-semibold">' + escapeHtml(file.name) + '</div>';
    initialHtml += '<div class="progress progress-sm mt-2">';
    initialHtml += '<div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>';
    initialHtml += '</div>'; // progress
    initialHtml += '</div>'; // flex-grow-1
    initialHtml += '</div>'; // d-flex
    initialHtml += '</div>'; // message-bubble
    initialHtml += '</div>'; // message-content
    
    uploadDiv.innerHTML = initialHtml;
    chatMessages.appendChild(uploadDiv);

    if (chatMessages && chatMessages.scrollHeight !== undefined) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    const maxSize = getMaxAttachmentSize(file);
    if (file.size > maxSize) {
        uploadDiv.innerHTML = '<div class="message-content"><div class="message-bubble text-danger">Arquivo muito grande. Tamanho máximo: ' + Math.floor(maxSize / 1024 / 1024) + 'MB</div></div>';
        return;
    }

    const allowedTypes = [
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
        'video/mp4', 'video/webm', 'video/ogg',
        'audio/mp3', 'audio/wav', 'audio/ogg',
        'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'text/plain', 'text/csv'
    ];

    const isAllowed = allowedTypes.includes(file.type) ||
        /\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mp3|wav|pdf|doc|docx|xls|xlsx|txt|csv)$/i.test(file.name);

    if (!isAllowed) {
        uploadDiv.innerHTML = '<div class="message-content"><div class="message-bubble text-danger">Tipo de arquivo não permitido</div></div>';
        return;
    }

    const formData = new FormData();
    formData.append('attachments[]', file);
    formData.append('content', '');

    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = uploadDiv.querySelector('.attachment-preview img');
            if (img) img.src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // Atualizar HTML para imagem
        let imgHtml = '<div class="attachment-preview mb-2">';
        imgHtml += '<img src="" alt="' + escapeHtml(file.name) + '" style="max-width: 200px; max-height: 200px; border-radius: 8px; display: block;">';
        imgHtml += '</div>';
        imgHtml += '<div class="fw-semibold fs-7">' + escapeHtml(file.name) + '</div>';
        imgHtml += '<div class="progress progress-sm mt-2" style="height: 4px;">';
        imgHtml += '<div class="progress-bar progress-bar-striped progress-bar-animated" role="width: 0%"></div>';
        imgHtml += '</div>';
        
        const bubble = uploadDiv.querySelector('.message-bubble');
        if(bubble) bubble.innerHTML = imgHtml;
        
    } else {
        // Atualizar HTML para arquivo
        let fileHtml = '<div class="d-flex align-items-center gap-2">';
        fileHtml += '<i class="ki-duotone ki-file-up fs-3">';
        fileHtml += '<span class="path1"></span><span class="path2"></span><span class="path3"></span>';
        fileHtml += '</i>';
        fileHtml += '<div class="flex-grow-1">';
        fileHtml += '<div class="fw-semibold">' + escapeHtml(file.name) + '</div>';
        fileHtml += '<div class="text-muted fs-7">' + formatFileSize(file.size) + '</div>';
        fileHtml += '</div>';
        fileHtml += '</div>';
        fileHtml += '<div class="progress progress-sm mt-2" style="height: 4px;">';
        fileHtml += '<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>';
        fileHtml += '</div>';
        
        const bubble = uploadDiv.querySelector('.message-bubble');
        if(bubble) bubble.innerHTML = fileHtml;
    }

    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            const progressBar = uploadDiv.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = percentComplete + '%';
            }
        }
    });

    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success && data.message) {
                    uploadDiv.remove();
                    addMessageToChat(data.message);
                    if (data.message.id) {
                        lastMessageId = Math.max(lastMessageId || 0, data.message.id);
                    }
                } else {
                    uploadDiv.innerHTML = '<div class="message-content"><div class="message-bubble text-danger">Erro: ' + escapeHtml(data.message || 'Erro desconhecido') + '</div></div>';
                }
            } catch (e) {
                console.error('Erro ao processar resposta:', e);
                uploadDiv.innerHTML = '<div class="message-content"><div class="message-bubble text-danger">Erro ao processar resposta do servidor</div></div>';
            }
        } else {
            uploadDiv.innerHTML = '<div class="message-content"><div class="message-bubble text-danger">Erro ao enviar arquivo (' + xhr.status + ')</div></div>';
        }
    };

    xhr.onerror = function() {
        uploadDiv.innerHTML = '<div class="message-content"><div class="message-bubble text-danger">Erro de conexão. Tente novamente.</div></div>';
    };

    xhr.open('POST', `<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/messages`);
    xhr.send(formData);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

/**
 * Toggle do picker de reações para uma mensagem
 */
function toggleReactionPicker(event, messageId) {
    event.stopPropagation();
    
    // Fechar picker anterior se existir
    const existing = document.querySelector('.reaction-picker');
    if (existing) {
        const existingMsgId = existing.getAttribute('data-msg-id');
        existing.remove();
        if (existingMsgId == messageId) return; // Toggle off
    }
    
    const btn = event.currentTarget;
    const actionsDiv = btn.closest('.message-actions');
    
    const emojis = ['👍', '👎', '❤️', '🔥', '😂', '😮', '😢', '😍', '🎉', '🤔', '👏', '🙏', '💯', '✅', '👀'];
    
    const picker = document.createElement('div');
    picker.className = 'reaction-picker';
    picker.setAttribute('data-msg-id', messageId);
    
    emojis.forEach(emoji => {
        const emojiBtn = document.createElement('button');
        emojiBtn.className = 'reaction-picker-emoji';
        emojiBtn.textContent = emoji;
        emojiBtn.onclick = function(e) {
            e.stopPropagation();
            sendReaction(messageId, emoji);
            picker.remove();
        };
        picker.appendChild(emojiBtn);
    });
    
    actionsDiv.style.position = 'relative';
    actionsDiv.appendChild(picker);
    
    // Fechar ao clicar fora
    setTimeout(() => {
        document.addEventListener('click', function closePicker(e) {
            if (!picker.contains(e.target)) {
                picker.remove();
                document.removeEventListener('click', closePicker);
            }
        });
    }, 10);
}

/**
 * Enviar reação de agente para uma mensagem
 */
async function sendReaction(messageId, emoji) {
    try {
        const response = await fetch(`<?= \App\Helpers\Url::to('/conversations/messages') ?>/${messageId}/react`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emoji: emoji })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Atualizar reações na UI
            const msgElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (msgElement) {
                // Remover reações antigas
                const oldReactions = msgElement.querySelector('.message-reactions');
                if (oldReactions) oldReactions.remove();
                
                // Renderizar novas reações
                if (data.reactions && data.reactions.length > 0) {
                    const reactionsHtml = renderReactionsHtml(data.reactions);
                    const bubble = msgElement.querySelector('.message-bubble');
                    if (bubble) {
                        bubble.insertAdjacentHTML('afterend', reactionsHtml);
                    }
                }
            }
        } else {
            console.error('[Reaction] Erro:', data.message);
        }
    } catch (err) {
        console.error('[Reaction] Erro na requisição:', err);
    }
}

/**
 * Renderizar reações de uma mensagem
 */
function renderReactionsHtml(reactions) {
    if (!reactions || !Array.isArray(reactions) || reactions.length === 0) return '';
    
    // Agrupar reações por emoji
    const grouped = {};
    reactions.forEach(r => {
        const emoji = r.emoji;
        if (!grouped[emoji]) {
            grouped[emoji] = { count: 0, names: [] };
        }
        grouped[emoji].count++;
        grouped[emoji].names.push(r.sender_name || (r.from === 'agent' ? 'Agente' : 'Contato'));
    });
    
    let html = '<div class="message-reactions">';
    for (const emoji in grouped) {
        const data = grouped[emoji];
        const tooltip = data.names.join(', ');
        html += `<span class="reaction-badge" title="${escapeHtml(tooltip)}">`;
        html += `${emoji}`;
        if (data.count > 1) {
            html += ` <span class="reaction-count">${data.count}</span>`;
        }
        html += `</span>`;
    }
    html += '</div>';
    return html;
}

/**
 * Abrir lightbox de imagem
 */
function openImageLightbox(imageUrl, imageTitle) {
    console.log('🖼️ Abrindo lightbox:', imageUrl, imageTitle);
    
    const imgElement = document.getElementById('kt_lightbox_image_src');
    const titleElement = document.getElementById('kt_lightbox_image_title');
    const downloadBtn = document.getElementById('kt_lightbox_download_btn');
    
    if (imgElement) {
        imgElement.src = imageUrl;
        imgElement.alt = imageTitle || 'Imagem';
    }
    
    if (titleElement) {
        titleElement.textContent = imageTitle || 'Imagem';
    }
    
    if (downloadBtn) {
        downloadBtn.href = imageUrl;
        downloadBtn.download = imageTitle || 'imagem';
    }
    
    // Abrir modal
    const modalElement = document.getElementById('kt_modal_image_lightbox');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }
}

function renderAttachmentHtml(attachment) {
    if (!attachment) return '';
    
    const type = attachment.type || 'document';
    const mimeType = attachment.mime_type || attachment.mimetype || '';
    
    // Renderizar contato compartilhado (vCard)
    if (type === 'contact') {
        const displayName = escapeHtml(attachment.display_name || 'Contato');
        const phones = attachment.phones || [];
        const emails = attachment.emails || [];
        const org = escapeHtml(attachment.organization || '');
        const initial = displayName.charAt(0).toUpperCase();
        
        let phonesHtml = '';
        phones.forEach(phone => {
            const num = escapeHtml(phone.formatted || phone.number || '');
            if (num) {
                phonesHtml += `<div class="d-flex align-items-center gap-1 mt-1">
                    <i class="ki-duotone ki-phone fs-7 text-success"><span class="path1"></span><span class="path2"></span></i>
                    <span class="fs-7 text-gray-700">${num}</span>
                </div>`;
            }
        });
        
        let emailsHtml = '';
        emails.forEach(email => {
            emailsHtml += `<div class="d-flex align-items-center gap-1 mt-1">
                <i class="ki-duotone ki-sms fs-7 text-primary"><span class="path1"></span><span class="path2"></span></i>
                <span class="fs-7 text-gray-700">${escapeHtml(email)}</span>
            </div>`;
        });
        
        return `<div class="attachment-item mb-2">
            <div class="d-flex align-items-start gap-3 p-3 border rounded" style="background: rgba(255,255,255,0.05); max-width: 300px;">
                <div style="flex-shrink:0; width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center;">
                    <span style="color:#fff; font-size:18px; font-weight:600;">${initial}</span>
                </div>
                <div class="flex-grow-1" style="min-width:0;">
                    <div class="fw-bold" style="font-size:14px;">${displayName}</div>
                    ${org ? `<div class="text-muted fs-8">${org}</div>` : ''}
                    ${phonesHtml}
                    ${emailsHtml}
                </div>
            </div>
        </div>`;
    }
    
    // Renderizar localização
    if (type === 'location' && attachment.latitude && attachment.longitude) {
        const lat = attachment.latitude;
        const lng = attachment.longitude;
        const name = escapeHtml(attachment.name || 'Localização');
        const address = escapeHtml(attachment.address || '');
        const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
        
        return `<div class="attachment-item mb-2">
            <a href="${mapsUrl}" target="_blank" class="d-flex align-items-center gap-2 p-2 border rounded" style="text-decoration: none; color: inherit; background: rgba(255,255,255,0.05);" onclick="event.stopPropagation();">
                <i class="ki-duotone ki-geolocation fs-2 text-danger">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                <div class="flex-grow-1">
                    <div class="fw-semibold">${name}</div>
                    ${address ? `<div class="text-muted fs-7">${address}</div>` : ''}
                    <div class="text-muted fs-7">${lat}, ${lng}</div>
                </div>
                <i class="ki-duotone ki-arrow-top-right fs-4 text-primary">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </a>
        </div>`;
    }
    
    // Construir URL correta do anexo
    let url = attachment.url || '';
    if (!url && attachment.path) {
        // Se não tem URL mas tem path, construir URL
        if (attachment.path.startsWith('http')) {
            url = attachment.path;
        } else {
            url = `<?= \App\Helpers\Url::to('/attachments') ?>/${encodeURIComponent(attachment.path)}`;
        }
    }
    const name = escapeHtml(attachment.original_name || attachment.name || attachment.filename || 'Anexo');
    const size = attachment.size ? formatFileSize(attachment.size) : '';
    
    let html = '<div class="attachment-item mb-2">';
    
    if (type === 'image') {
        // Placeholder base64 simples
        const placeholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2YwZjBmMCIvPjwvc3ZnPg==';
        html += `<a href="javascript:void(0);" onclick="openImageLightbox('${url.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}'); event.stopPropagation(); return false;" class="d-inline-block lazy-image-container" data-src="${url}" style="position: relative;">
            <img src="${placeholder}" alt="${name}" data-src="${url}" class="lazy-image" style="max-width: 300px; max-height: 300px; border-radius: 8px; cursor: pointer; background: #f0f0f0; min-width: 100px; min-height: 100px;">
            <div class="lazy-loading-spinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>
        </a>`;
    } else if (type === 'video') {
        html += `<div class="lazy-video-container" data-src="${url}" data-type="${mimeType || 'video/mp4'}" onclick="event.stopPropagation();">
            <div class="lazy-video-placeholder" style="max-width: 300px; max-height: 200px; border-radius: 8px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; cursor: pointer; min-height: 200px;">
                <i class="ki-duotone ki-play fs-2x text-primary"><span class="path1"></span><span class="path2"></span></i>
            </div>
            <video controls style="max-width: 300px; max-height: 200px; border-radius: 8px; display: none;" preload="none">
                <source src="" type="${mimeType || 'video/mp4'}">
                Seu navegador não suporta vídeo.
            </video>
        </div>`;
    } else if (type === 'audio' || (mimeType && mimeType.startsWith('audio/'))) {
        // Renderização de íudio estilo WhatsApp com largura adequada
        // ✓ CORRIGIDO: Usar URL direta se começar com / (áudios TTS), senão usar rota de attachments
        let audioUrl = url;
        if (!audioUrl && attachment.path) {
            if (attachment.path.startsWith('assets/') || attachment.path.startsWith('/assets/')) {
                // Arquivo público (TTS, etc) - acesso direto
                audioUrl = '<?= \App\Helpers\Url::to('/') ?>' + attachment.path.replace(/^\//, '');
            } else {
                // Arquivo de upload - usar rota de attachments
                audioUrl = `<?= \App\Helpers\Url::to('/attachments') ?>/${encodeURIComponent(attachment.path)}`;
            }
        }
        
        // ✓ NOVO: Verificar se hí transcrição ou texto original (TTS)
        let transcriptionHtml = '';
        const showTranscription = <?= json_encode(\App\Services\ConversationSettingsService::getSettings()['audio_transcription']['show_transcription_in_chat'] ?? true) ?>;
        
        if (showTranscription) {
            // Verificar se é íudio TTS (tem texto original) ou íudio transcrito
            const ttsOriginalText = attachment.tts_original_text;
            const transcription = attachment.transcription;
            
            if (ttsOriginalText) {
                // üudio gerado pela IA - exibir texto original
                const textContent = escapeHtml(ttsOriginalText);
                transcriptionHtml = `
                    <div class="audio-transcription mt-2" style="padding: 8px; background: rgba(52, 211, 153, 0.1); border-radius: 6px; border-left: 3px solid #34d399;">
                        <div class="d-flex align-items-center gap-1 mb-1">
                            <i class="ki-duotone ki-message-text-2 fs-7 text-success"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>
                            <span class="text-success fs-8 fw-semibold">Conteúdo do íudio:</span>
                        </div>
                        <div class="fs-7" style="color: rgba(0,0,0,0.7);">${nl2br(textContent)}</div>
                    </div>
                `;
            } else if (transcription && transcription.text) {
                // üudio do cliente - exibir transcrição
                const transcriptionText = escapeHtml(transcription.text);
                transcriptionHtml = `
                    <div class="audio-transcription mt-2" style="padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px; border-left: 3px solid #3b82f6;">
                        <div class="d-flex align-items-center gap-1 mb-1">
                            <i class="ki-duotone ki-text fs-7 text-muted"><span class="path1"></span><span class="path2"></span></i>
                            <span class="text-muted fs-8 fw-semibold">Transcrição:</span>
                        </div>
                        <div class="fs-7" style="color: rgba(0,0,0,0.7);">${nl2br(transcriptionText)}</div>
                    </div>
                `;
            }
        }
        
        html += `<div class="attachment audio-attachment">
            <div class="d-flex align-items-center gap-2">
                <div class="me-1" style="flex-shrink: 0;">
                    <i class="ki-duotone ki-music fs-4 text-primary" style="min-width: 20px; font-size: 18px !important;">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
                <div class="flex-grow-1" style="min-width: 300px;">
                    <audio controls style="width: 100%; outline: none;" preload="metadata" onclick="event.stopPropagation();">
                        <source src="${audioUrl}" type="${mimeType || 'audio/ogg; codecs=opus'}">
                        Seu navegador não suporta o elemento de íudio.
                    </audio>
                    ${transcriptionHtml}
                </div>
            </div>
        </div>`;
    } else {
        // Para documentos, usar URL direta se o arquivo estiver em assets/
        const attachmentPath = attachment.path || '';
        let downloadUrl;
        let viewUrl = '';
        if (attachmentPath.startsWith('assets/')) {
            downloadUrl = `<?= \App\Helpers\Url::to('/') ?>${attachmentPath}`;
            viewUrl = downloadUrl;
        } else {
            downloadUrl = `<?= \App\Helpers\Url::to('/attachments') ?>/${encodeURIComponent(attachmentPath)}/download`;
            viewUrl = `<?= \App\Helpers\Url::to('/attachments') ?>/${encodeURIComponent(attachmentPath)}`;
        }
        
        // Detectar extensão e se é PDF
        const fileName = attachment.original_name || attachment.name || attachment.filename || 'Anexo';
        const ext = (fileName.split('.').pop() || '').toLowerCase();
        const isPdf = (ext === 'pdf' || (mimeType && mimeType.indexOf('pdf') !== -1));
        
        // Ícone contextual
        let iconClass = 'ki-file';
        if (isPdf) iconClass = 'ki-document';
        else if (['doc','docx','odt','rtf'].includes(ext)) iconClass = 'ki-notepad';
        else if (['xls','xlsx','ods','csv'].includes(ext)) iconClass = 'ki-chart-simple';
        else if (['ppt','pptx','odp'].includes(ext)) iconClass = 'ki-screen';
        else if (['zip','rar','7z','gz','tar'].includes(ext)) iconClass = 'ki-archive';
        else if (['psd','ai','cdr','eps','indd'].includes(ext)) iconClass = 'ki-design-2';
        
        // Botão de preview PDF
        const pdfPreviewBtn = isPdf ? `<a href="${viewUrl}" target="_blank" class="pdf-preview-btn" title="Visualizar PDF" onclick="event.stopPropagation();">
            <i class="ki-duotone ki-eye fs-4 text-info">
                <span class="path1"></span>
                <span class="path2"></span>
                <span class="path3"></span>
            </i>
        </a>` : '';
        
        html += `<div class="d-flex align-items-center gap-2 p-2 border rounded doc-link" style="background: rgba(255,255,255,0.05);" onclick="event.stopPropagation();">
            <i class="ki-duotone ${iconClass} fs-2" style="flex-shrink:0;">
                <span class="path1"></span>
                <span class="path2"></span>
            </i>
            <div class="flex-grow-1 document-box">
                <div class="fw-semibold doc-filename" title="${name}">${name}</div>
                ${size ? `<div class="text-muted fs-7">${size}</div>` : ''}
            </div>
            ${pdfPreviewBtn}
            <a href="${downloadUrl}" target="_blank" title="Baixar arquivo" onclick="event.stopPropagation();" style="flex-shrink:0; text-decoration:none;">
                <i class="ki-duotone ki-arrow-down fs-4 text-primary">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
            </a>
        </div>`;
    }
    
    html += '</div>';
    return html;
}

// Emoji picker completo com busca e categorias
function toggleEmoji() {
    const emojiCategories = {
        'Rostos e Emoções': {
            keywords: ['feliz', 'triste', 'rosto', 'emoção', 'alegre', 'sorriso', 'chorar', 'raiva', 'amor', 'coração'],
            emojis: ['😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃', '😉', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '😚', '😙', '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵', '🥶', '😵', '🤯', '🤠', '🥳', '😎', '🤓', '🧐', '😕', '😟', '🙁', '☹️', '😮', '😯', '😲', '😳', '🥺', '😦', '😧', '😨', '😰', '😥', '😢', '😭', '😱', '😖', '😣', '😞', '😓', '😩', '😫', '🥱', '😤', '😡', '😠', '🤬', '😈', '👿', '💀', '☠️', '💩', '🤡', '👹', '👺', '👻', '👽', '👾', '🤖']
        },
        'Gestos e Mãos': {
            keywords: ['mão', 'ok', 'polegar', 'dedo', 'palmas', 'oração', 'gesto', 'apontar'],
            emojis: ['👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋']
        },
        'Pessoas': {
            keywords: ['pessoa', 'homem', 'mulher', 'família', 'bebê', 'criança', 'adulto'],
            emojis: ['👶', '🧒', '👦', '👧', '🧑', '👨', '👩', '🧔', '👨‍🦰', '👨‍🦱', '👨‍🦳', '👨‍🦲', '👩‍🦰', '🧑‍🦰', '👩‍🦱', '🧑‍🦱', '👩‍🦳', '🧑‍🦳', '👩‍🦲', '🧑‍🦲', '👱', '👱‍♂️', '👱‍♀️', '🧓', '👴', '👵', '🙍', '🙍‍♂️', '🙍‍♀️', '🙎', '🙎‍♂️', '🙎‍♀️', '🙅', '🙅‍♂️', '🙅‍♀️', '🙆', '🙆‍♂️', '🙆‍♀️', '💁', '💁‍♂️', '💁‍♀️', '🙋', '🙋‍♂️', '🙋‍♀️', '🧏', '🧏‍♂️', '🧏‍♀️', '🙇', '🙇‍♂️', '🙇‍♀️', '🤦', '🤦‍♂️', '🤦‍♀️', '🤷', '🤷‍♂️', '🤷‍♀️', '👨‍⚕️', '👩‍⚕️', '👨‍🎓', '👩‍🎓', '👨‍🏫', '👩‍🏫', '👨‍⚖️', '👩‍⚖️', '👨‍🌾', '👩‍🌾', '👨‍🍳', '👩‍🍳', '👨‍🔧', '👩‍🔧', '👨‍🏭', '👩‍🏭', '👨‍💼', '👩‍💼', '👨‍🔬', '👩‍🔬', '👨‍💻', '👩‍💻', '👨‍🎤', '👩‍🎤', '👨‍🎨', '👩‍🎨', '👨‍✈️', '👩‍✈️', '👨‍🚀', '👩‍🚀', '👨‍🚒', '👩‍🚒', '👮', '👮‍♂️', '👮‍♀️', '🕵️', '🕵️‍♂️', '🕵️‍♀️', '💂', '💂‍♂️', '💂‍♀️']
        },
        'Animais e Natureza': {
            keywords: ['animal', 'cachorro', 'gato', 'natureza', 'planta', 'flor', 'árvore', 'bicho'],
            emojis: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐽', '🐸', '🐵', '🙈', '🙉', '🙊', '🐒', '🐔', '🐧', '🐦', '🐤', '🐣', '🐥', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋', '🐌', '🐞', '🐜', '🦟', '🦗', '🕷️', '🕸️', '🦂', '🐢', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟', '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🐃', '🐂', '🐄', '🐎', '🐖', '🐏', '🐑', '🦙', '🐐', '🦌', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐓', '🦃', '🦚', '🦜', '🦢', '🦩', '🕊️', '🐇', '🦝', '🦨', '🦡', '🦦', '🦥', '🐁', '🐀', '🐿️', '🦔', '🌵', '🎄', '🌲', '🌳', '🌴', '🌱', '🌿', '☘️', '🍀', '🎍', '🎋', '🍃', '🍂', '🍁', '🍄', '🌾', '💐', '🌷', '🌹', '🥀', '🌺', '🌸', '🌼', '🌻', '🌞', '🌝', '🌛', '🌜', '🌚', '🌕', '🌖', '🌗', '🌘', '🌑', '🌒', '🌓', '🌔', '🌙', '🌎', '🌍', '🌏', '🪐', '💫', '⭐', '🌟', '✨', '⚡', '☄️', '💥', '🔥', '🌪️', '🌈', '☀️', '🌤️', '⛅', '🌥️', '☁️', '🌦️', '🌧️', '⛈️', '🌩️', '🌨️', '❄️', '☃️', '⛄', '🌬️', '💨', '💧', '💦', '☔', '☂️', '🌊', '🌫️']
        },
        'Comida e Bebida': {
            keywords: ['comida', 'bebida', 'fruta', 'legume', 'carne', 'doce', 'bolo', 'café', 'pizza'],
            emojis: ['🍏', '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶️', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐', '🥯', '🍞', '🥖', '🥨', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🫓', '🥪', '🥙', '🧆', '🌮', '🌯', '🫔', '🥗', '🥘', '🫕', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯', '🥛', '🍼', '🫖', '☕', '🍵', '🧃', '🥤', '🧋', '🍶', '🍺', '🍻', '🥂', '🍷', '🥃', '🍸', '🍹', '🧉', '🍾', '🧊', '🥄', '🍴', '🍽️', '🥣', '🥡', '🥢', '🧂']
        },
        'Atividades e Esportes': {
            keywords: ['esporte', 'futebol', 'basquete', 'jogo', 'música', 'arte', 'celebração'],
            emojis: ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥅', '⛳', '🪁', '🏹', '🎣', '🤿', '🥊', '🥋', '🎽', '🛹', '🛼', '🛷', '⛸️', '🥌', '🎿', '⛷️', '🏂', '🪂', '🏋️', '🤼', '🤸', '🤺', '⛹️', '🤾', '🏌️', '🏇', '🧘', '🏊', '🤽', '🚣', '🧗', '🚵', '🚴', '🏆', '🥇', '🥈', '🥉', '🏅', '🎖️', '🏵️', '🎗️', '🎫', '🎟️', '🎪', '🤹', '🎭', '🩰', '🎨', '🎬', '🎤', '🎧', '🎼', '🎹', '🥁', '🪘', '🎷', '🎺', '🎸', '🪕', '🎻', '🎲', '♟️', '🎯', '🎳', '🎮', '🎰', '🧩']
        },
        'Viagem e Lugares': {
            keywords: ['carro', 'avião', 'viagem', 'transporte', 'cidade', 'casa', 'prédio', 'hotel'],
            emojis: ['🚗', '🚕', '🚙', '🚌', '🚎', '🏎️', '🚓', '🚑', '🚒', '🚐', '🛻', '🚚', '🚛', '🚜', '🦯', '🦽', '🦼', '🛴', '🚲', '🛵', '🏍️', '🛺', '🚨', '🚔', '🚍', '🚘', '🚖', '🚡', '🚠', '🚟', '🚃', '🚋', '🚞', '🚝', '🚄', '🚅', '🚈', '🚂', '🚆', '🚇', '🚊', '🚉', '✈️', '🛫', '🛬', '🛩️', '💺', '🛰️', '🚀', '🛸', '🚁', '🛶', '⛵', '🚤', '🛥️', '🛳️', '⛴️', '🚢', '⚓', '⛽', '🚧', '🚦', '🚥', '🚏', '🗺️', '🗿', '🗽', '🗼', '🏰', '🏯', '🏟️', '🎡', '🎢', '🎠', '⛲', '⛱️', '🏖️', '🏝️', '🏜️', '🌋', '⛰️', '🏔️', '🗻', '🏕️', '⛺', '🛖', '🏠', '🏡', '🏘️', '🏚️', '🏗️', '🏭', '🏢', '🏬', '🏣', '🏤', '🏥', '🏦', '🏨', '🏪', '🏫', '🏩', '💒', '🏛️', '⛪', '🕌', '🕍', '🛕', '🕋', '⛩️', '🛤️', '🛣️', '🗾', '🎑', '🏞️', '🌅', '🌄', '🌠', '🎇', '🎆', '🌇', '🌆', '🏙️', '🌃', '🌌', '🌉', '🌁']
        },
        'Objetos': {
            keywords: ['relógio', 'telefone', 'computador', 'livro', 'lápis', 'ferramenta', 'dinheiro'],
            emojis: ['⌚', '📱', '📲', '💻', '⌨️', '🖥️', '🖨️', '🖱️', '🖲️', '🕹️', '🗜️', '💽', '💾', '💿', '📀', '📼', '📷', '📸', '📹', '🎥', '📽️', '🎞️', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🧭', '⏱️', '⏲️', '⏰', '🕰️', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯️', '🪔', '🧯', '🛢️', '💸', '💵', '💴', '💶', '💷', '💰', '💳', '💎', '⚖️', '🪜', '🧰', '🪛', '🔧', '🔨', '⚒️', '🛠️', '⛏️', '🪚', '🔩', '⚙️', '🪤', '🧱', '⛓️', '🧲', '🔫', '💣', '🧨', '🪓', '🔪', '🗡️', '⚔️', '🛡️', '🚬', '⚰️', '🪦', '⚱️', '🏺', '🔮', '📿', '🧿', '💈', '⚗️', '🔭', '🔬', '🕳️', '🩹', '🩺', '💊', '💉', '🩸', '🧬', '🦠', '🧫', '🧪', '🌡️', '🧹', '🪠', '🧺', '🧻', '🚽', '🚰', '🚿', '🛁', '🛀', '🧼', '🪒', '🧽', '🪣', '🧴', '🛎️', '🔑', '🗝️', '🚪', '🪑', '🛋️', '🛏️', '🛌', '🧸', '🪆', '🖼️', '🪞', '🪟', '🛍️', '🛒', '🎁', '🎈', '🎏', '🎀', '🪄', '🪅', '🎊', '🎉', '🎎', '🏮', '🎐', '🧧', '✉️', '📩', '📨', '📧', '💌', '📥', '📤', '📦', '🏷️', '🪧', '📪', '📫', '📬', '📭', '📮', '📯', '📜', '📃', '📄', '📑', '🧾', '📊', '📈', '📉', '🗒️', '🗓️', '📆', '📅', '🗑️', '📇', '🗃️', '🗳️', '🗄️', '📋', '📁', '📂', '🗂️', '🗞️', '📰', '📓', '📔', '📒', '📕', '📗', '📘', '📙', '📚', '📖', '🔖', '🧷', '🔗', '📎', '🖇️', '📐', '📏', '🧮', '📌', '📍', '✂️', '🖊️', '🖋️', '✒️', '🖌️', '🖍️', '📝', '✏️', '🔍', '🔎', '🔏', '🔐', '🔒', '🔓']
        },
        'Símbolos': {
            keywords: ['coração', 'estrela', 'símbolo', 'seta', 'check', 'x', 'aviso', 'proibido'],
            emojis: ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮️', '✝️', '☪️', '🕉️', '☸️', '✡️', '🔯', '🕎', '☯️', '☦️', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛️', '🉑', '☢️', '☣️', '📴', '📳', '🈶', '🈚', '🈸', '🈺', '🈷️', '✴️', '🆚', '💮', '🉐', '㊙️', '㊗️', '🈴', '🈵', '🈹', '🈲', '🅰️', '🅱️', '🆎', '🆑', '🅾️', '🆘', '❌', '⭕', '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨️', '🚷', '🚯', '🚳', '🚱', '🔞', '📵', '🚭', '❗', '❕', '❓', '❔', '‼️', '⁉️', '🔅', '🔆', '〽️', '⚠️', '🚸', '🔱', '⚜️', '🔰', '♻️', '✅', '🈯', '💹', '❇️', '✳️', '❎', '🌐', '💠', 'Ⓜ️', '🌀', '💤', '🏧', '🚾', '♿', '🅿️', '🛗', '🈳', '🈂️', '🛂', '🛃', '🛄', '🛅', '🚹', '🚺', '🚼', '⚧️', '🚻', '🚮', '🎦', '📶', '🈁', '🔣', 'ℹ️', '🔤', '🔡', '🔠', '🆖', '🆗', '🆙', '🆒', '🆕', '🆓', '0️⃣', '1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟', '🔢', '#️⃣', '*️⃣', '⏏️', '▶️', '⏸️', '⏯️', '⏹️', '⏺️', '⏭️', '⏮️', '⏩', '⏪', '⏫', '⏬', '◀️', '🔼', '🔽', '➡️', '⬅️', '⬆️', '⬇️', '↗️', '↘️', '↙️', '↖️', '↕️', '↔️', '↪️', '↩️', '⤴️', '⤵️', '🔀', '🔁', '🔂', '🔄', '🔃', '🎵', '🎶', '➕', '➖', '➗', '✖️', '♾️', '💲', '💱', '™️', '©️', '®️', '〰️', '➰', '➿', '🔚', '🔙', '🔛', '🔝', '🔜', '✔️', '☑️', '🔘', '🔴', '🟠', '🟡', '🟢', '🔵', '🟣', '⚫', '⚪', '🟤', '🔺', '🔻', '🔸', '🔹', '🔶', '🔷', '🔳', '🔲', '▪️', '▫️', '◾', '◽', '◼️', '◻️', '🟥', '🟧', '🟨', '🟩', '🟦', '🟪', '⬛', '⬜', '🟫', '🔈', '🔇', '🔉', '🔊', '🔔', '🔕', '📣', '📢', '👁️‍🗨️', '💬', '💭', '🗯️', '♠️', '♣️', '♥️', '♦️', '🃏', '🎴', '🀄', '🕐', '🕑', '🕒', '🕓', '🕔', '🕕', '🕖', '🕗', '🕘', '🕙', '🕚', '🕛', '🕜', '🕝', '🕞', '🕟', '🕠', '🕡', '🕢', '🕣', '🕤', '🕥', '🕦', '🕧']
        },
        'Bandeiras': {
            keywords: ['bandeira', 'país', 'brasil', 'eua', 'portugal', 'flag'],
            emojis: ['🏳️', '🏴', '🏴‍☠️', '🏁', '🚩', '🏳️‍🌈', '🏳️‍⚧️', '🇧🇷', '🇺🇸', '🇵🇹', '🇦🇷', '🇨🇱', '🇨🇴', '🇲🇽', '🇪🇸', '🇫🇷', '🇬🇧', '🇮🇹', '🇩🇪', '🇯🇵', '🇨🇳', '🇰🇷', '🇷🇺', '🇮🇳', '🇨🇦', '🇦🇺', '🇿🇦', '🇪🇬', '🇳🇬', '🇰🇪', '🇦🇪', '🇸🇦', '🇮🇱', '🇹🇷', '🇬🇷', '🇳🇱', '🇧🇪', '🇨🇭', '🇸🇪', '🇳🇴', '🇩🇰', '🇫🇮', '🇵🇱', '🇦🇹', '🇨🇿', '🇭🇺', '🇷🇴', '🇧🇬', '🇷🇸', '🇭🇷', '🇸🇮', '🇸🇰', '🇱🇹', '🇱🇻', '🇪🇪', '🇮🇸', '🇮🇪', '🇵🇹', '🇱🇺', '🇲🇹', '🇨🇾', '🇳🇿', '🇵🇭', '🇹🇭', '🇻🇳', '🇮🇩', '🇲🇾', '🇸🇬', '🇵🇰', '🇧🇩', '🇱🇰', '🇳🇵', '🇦🇫', '🇮🇷', '🇮🇶', '🇸🇾', '🇱🇧', '🇯🇴', '🇵🇸', '🇰🇼', '🇶🇦', '🇧🇭', '🇴🇲', '🇾🇪', '🇲🇦', '🇹🇳', '🇩🇿', '🇱🇾', '🇸🇩', '🇪🇹', '🇸🇴', '🇩🇯', '🇪🇷', '🇹🇿', '🇺🇬', '🇷🇼', '🇧🇮', '🇲🇼', '🇿🇲', '🇿🇼', '🇧🇼', '🇳🇦', '🇦🇴', '🇲🇿', '🇲🇬', '🇲🇺', '🇸🇨', '🇰🇲', '🇲🇱', '🇸🇳', '🇬🇲', '🇬🇳', '🇬🇼', '🇸🇱', '🇱🇷', '🇨🇮', '🇬🇭', '🇧🇫', '🇧🇯', '🇹🇬', '🇳🇪', '🇨🇲', '🇬🇶', '🇬🇦', '🇨🇬', '🇨🇩', '🇨🇫', '🇹🇩', '🇸🇹', '🇦🇴']
        }
    };
    
    // Carregar últimos emojis usados do localStorage
    const recentEmojis = JSON.parse(localStorage.getItem('recentEmojis') || '[]');
    
    // Criar HTML do seletor com busca
    let html = `
        <div class="emoji-picker-container">
            <div class="mb-4">
                <div class="position-relative">
                    <i class="ki-duotone ki-magnifier fs-3 position-absolute top-50 translate-middle-y ms-4 text-gray-500">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                    <input type="text" 
                           id="emojiSearch" 
                           class="form-control form-control-solid ps-12" 
                           placeholder="Buscar emoji... (ex: feliz, coração, Brasil)" 
                           style="font-size: 14px;" />
                    <button class="btn btn-sm btn-icon btn-light position-absolute top-50 translate-middle-y end-0 me-2" 
                            id="clearSearch" 
                            style="display: none;"
                            title="Limpar busca">
                        <i class="ki-duotone ki-cross fs-3">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </button>
                </div>
            </div>
            <div id="emojiCategories" style="max-height: 650px; overflow-y: auto; padding: 10px;">
    `;
    
    // Adicionar seção de últimos utilizados (se houver)
    if (recentEmojis.length > 0) {
        html += `
            <div class="emoji-category mb-5 pb-3" data-category="recent">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h6 class="text-primary fw-bold mb-0">
                        <i class="ki-duotone ki-time fs-5 me-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        Últimos Utilizados
                        <span class="badge badge-light-primary badge-sm ms-2">${recentEmojis.length}</span>
                    </h6>
                    <button class="btn btn-sm btn-icon btn-light-danger" onclick="clearRecentEmojis()" title="Limpar histórico">
                        <i class="ki-duotone ki-trash fs-6">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                            <span class="path4"></span>
                            <span class="path5"></span>
                        </i>
                    </button>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    ${recentEmojis.map(emoji => 
                        `<span class="btn btn-sm btn-icon btn-light-primary emoji-item" 
                               onclick="insertEmoji('${emoji}')" 
                               data-emoji="${emoji}"
                               style="font-size: 26px; cursor: pointer; width: 48px; height: 48px; padding: 0; display: inline-flex; align-items: center; justify-content: center;" 
                               title="${emoji}">${emoji}</span>`
                    ).join('')}
                </div>
                <div class="separator separator-dashed my-5"></div>
            </div>
        `;
    }
    
    // Adicionar categorias
    for (const [category, data] of Object.entries(emojiCategories)) {
        html += `
            <div class="emoji-category mb-5 pb-3" data-keywords="${data.keywords.join(',').toLowerCase()}">
                <h6 class="text-gray-700 fw-bold mb-4">${category}</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${data.emojis.map(emoji => 
                        `<span class="btn btn-sm btn-icon btn-light emoji-item" 
                               onclick="insertEmoji('${emoji}')" 
                               data-emoji="${emoji}"
                               style="font-size: 26px; cursor: pointer; width: 48px; height: 48px; padding: 0; display: inline-flex; align-items: center; justify-content: center;" 
                               title="${emoji}">${emoji}</span>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    html += `
            </div>
        </div>
        <style>
            .emoji-picker-modal {
                min-height: 800px !important;
                max-height: 90vh !important;
                height: auto !important;
                padding: 20px !important;
            }
            .emoji-picker-content {
                max-height: calc(90vh - 180px) !important;
                overflow-y: visible !important;
                padding: 0 !important;
            }
            .emoji-picker-container {
                padding: 0;
            }
            .emoji-item {
                transition: all 0.2s;
                margin: 2px;
            }
            .emoji-item:hover {
                transform: scale(1.35);
                background-color: #f1f1f2 !important;
                z-index: 10;
                position: relative;
                box-shadow: 0 0 8px rgba(0,0,0,0.1);
            }
            .emoji-category.hidden {
                display: none !important;
            }
            .emoji-category[data-category="recent"] {
                background-color: #f8f9fa;
                padding: 18px;
                border-radius: 8px;
                border: 1px dashed #e1e3ea;
            }
            .emoji-category[data-category="recent"] .emoji-item {
                background-color: #fff !important;
            }
            .emoji-category[data-category="recent"] .emoji-item:hover {
                background-color: #e8f4ff !important;
            }
            .emoji-category h6 {
                position: sticky;
                top: -10px;
                background: white;
                z-index: 5;
                padding: 10px 0;
                margin-top: 0;
                font-size: 14px;
            }
            #emojiCategories {
                scrollbar-width: thin;
                scrollbar-color: #cbd5e0 #f1f1f2;
            }
            #emojiCategories::-webkit-scrollbar {
                width: 8px;
            }
            #emojiCategories::-webkit-scrollbar-track {
                background: #f1f1f2;
                border-radius: 4px;
            }
            #emojiCategories::-webkit-scrollbar-thumb {
                background: #cbd5e0;
                border-radius: 4px;
            }
            #emojiCategories::-webkit-scrollbar-thumb:hover {
                background: #a0aec0;
            }
        </style>
    `;
    
    Swal.fire({
        title: 'Selecione um emoji',
        html: html,
        width: '700px',
        showConfirmButton: false,
        showCloseButton: true,
        customClass: {
            popup: 'emoji-picker-modal',
            htmlContainer: 'emoji-picker-content'
        },
        didOpen: () => {
            // Implementar busca de emoji
            const searchInput = document.getElementById('emojiSearch');
            const clearSearchBtn = document.getElementById('clearSearch');
            const categories = document.querySelectorAll('.emoji-category');
            
            // Função de filtro
            function filterEmojis() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                // Mostrar/esconder botão de limpar
                clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
                
                if (!searchTerm) {
                    // Mostrar todas as categorias e emojis
                    categories.forEach(cat => {
                        cat.classList.remove('hidden');
                        cat.querySelectorAll('.emoji-item').forEach(emoji => {
                            emoji.style.display = '';
                        });
                    });
                    return;
                }
                
                // Filtrar categorias e emojis
                categories.forEach(cat => {
                    const categoryType = cat.getAttribute('data-category');
                    const keywords = cat.getAttribute('data-keywords') || '';
                    const emojis = cat.querySelectorAll('.emoji-item');
                    
                    // Para categoria "Últimos Utilizados", sempre mostrar mas filtrar os emojis
                    if (categoryType === 'recent') {
                        emojis.forEach(emoji => {
                            emoji.style.display = ''; // Sempre mostrar na busca
                        });
                        cat.classList.remove('hidden');
                    } else {
                        // Para outras categorias, verificar keywords
                        if (keywords.includes(searchTerm)) {
                            cat.classList.remove('hidden');
                            emojis.forEach(emoji => {
                                emoji.style.display = '';
                            });
                        } else {
                            // Esconder categoria se não houver correspondência
                            cat.classList.add('hidden');
                        }
                    }
                });
            }
            
            // Listener de busca
            searchInput.addEventListener('input', filterEmojis);
            
            // Botão de limpar busca
            clearSearchBtn.addEventListener('click', function() {
                searchInput.value = '';
                filterEmojis();
                searchInput.focus();
            });
            
            // Focus no campo de busca
            searchInput.focus();
        }
    });
}

function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    const cursorPos = input.selectionStart;
    const textBefore = input.value.substring(0, cursorPos);
    const textAfter = input.value.substring(cursorPos);
    
    input.value = textBefore + emoji + textAfter;
    input.focus();
    input.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
    
    // Ajustar altura
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 150) + 'px';
    
    // Salvar emoji nos recentes (localStorage)
    saveRecentEmoji(emoji);
    
    Swal.close();
}

// Função para salvar emoji recente
function saveRecentEmoji(emoji) {
    // Carregar lista atual de emojis recentes
    let recentEmojis = JSON.parse(localStorage.getItem('recentEmojis') || '[]');
    
    // Remover emoji se já existir (para evitar duplicatas)
    recentEmojis = recentEmojis.filter(e => e !== emoji);
    
    // Adicionar emoji no início da lista
    recentEmojis.unshift(emoji);
    
    // Limitar a 30 emojis recentes
    if (recentEmojis.length > 30) {
        recentEmojis = recentEmojis.slice(0, 30);
    }
    
    // Salvar de volta no localStorage
    localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));
}

// Função para limpar emojis recentes
function clearRecentEmojis() {
    Swal.fire({
        title: 'Limpar histórico?',
        text: 'Deseja remover todos os emojis recentes?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, limpar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#f1416c',
        cancelButtonColor: '#gray-400'
    }).then((result) => {
        if (result.isConfirmed) {
            localStorage.removeItem('recentEmojis');
            Swal.fire({
                icon: 'success',
                title: 'Histórico limpo!',
                text: 'Os emojis recentes foram removidos.',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                // Reabrir o seletor de emoji sem os recentes
                toggleEmoji();
            });
        }
    });
}

// ============================================================================
// SISTEMA DE NAVEGAÇâO MOBILE
// ============================================================================

// Detectar se está em mobile
function isMobile() {
    return window.innerWidth <= 767;
}

function isTablet() {
    return window.innerWidth >= 768 && window.innerWidth <= 991;
}

// Gerenciar views mobile
function showListView() {
    const listView = document.getElementById('conversationsListView');
    const chatView = document.getElementById('chatAreaView');
    const sidebarView = document.getElementById('conversationSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (isMobile()) {
        window.mobileViewState = 'list';
        // Mobile: mostrar apenas lista
        if (listView) listView.classList.add('mobile-active');
        if (chatView) chatView.classList.remove('mobile-active');
        if (sidebarView) sidebarView.classList.remove('mobile-active');
        if (overlay) overlay.classList.remove('active');
    }
}

function showChatView() {
    const listView = document.getElementById('conversationsListView');
    const chatView = document.getElementById('chatAreaView');
    const sidebarView = document.getElementById('conversationSidebar');
    const backBtn = document.getElementById('chatHeaderBackBtn');
    
    if (isMobile()) {
        window.mobileViewState = 'chat';
        // Mobile: mostrar apenas chat
        if (listView) listView.classList.remove('mobile-active');
        if (chatView) chatView.classList.add('mobile-active');
        if (sidebarView) sidebarView.classList.remove('mobile-active');
        if (backBtn) backBtn.classList.remove('d-none');
    }
}

function showDetailsView() {
    const listView = document.getElementById('conversationsListView');
    const chatView = document.getElementById('chatAreaView');
    const sidebarView = document.getElementById('conversationSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (isMobile() || isTablet()) {
        window.mobileViewState = 'sidebar';
        // Mobile/Tablet: mostrar sidebar como drawer
        if (listView) listView.classList.remove('mobile-active');
        if (chatView) chatView.classList.remove('mobile-active');
        if (sidebarView) {
            sidebarView.classList.add('mobile-active');
            sidebarView.classList.add('open');
        }
        if (overlay) overlay.classList.add('active');
    }
}

// Toggle sidebar de detalhes (adaptado para mobile)
function toggleConversationSidebar() {
    const sidebar = document.getElementById('conversationSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (!sidebar) return;
    
    if (isMobile() || isTablet()) {
        // Mobile/Tablet: usar sistema de views
        if (sidebar.classList.contains('open')) {
            closeConversationSidebar();
        } else {
            showDetailsView();
        }
    } else {
        // Desktop: toggle normal
        sidebar.classList.toggle('open');
        localStorage.setItem('conversationSidebarOpen', sidebar.classList.contains('open'));
    }
}

function closeConversationSidebar() {
    const sidebar = document.getElementById('conversationSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (sidebar) {
        sidebar.classList.remove('open');
        if (isMobile() || isTablet()) {
            sidebar.classList.remove('mobile-active');
            // Voltar para chat view
            showChatView();
        }
    }
    if (overlay) overlay.classList.remove('active');
    localStorage.setItem('conversationSidebarOpen', 'false');
}

// Inicializar navegação mobile ao carregar
document.addEventListener('DOMContentLoaded', function() {
    window.mobileViewState = window.mobileViewState || 'list';
    // Detectar tamanho da tela e ajustar views
    function handleResize() {
        if (!isMobile() && !isTablet()) {
            // Desktop: mostrar tudo lado a lado
            const listView = document.getElementById('conversationsListView');
            const chatView = document.getElementById('chatAreaView');
            const sidebarView = document.getElementById('conversationSidebar');
            const backBtn = document.getElementById('chatHeaderBackBtn');
            
            if (listView) listView.classList.add('mobile-active');
            if (chatView) chatView.classList.add('mobile-active');
            if (backBtn) backBtn.classList.add('d-none');
            
            // Restaurar estado do sidebar se estava aberto
            const sidebarWasOpen = localStorage.getItem('conversationSidebarOpen') === 'true';
            if (sidebarView && sidebarWasOpen) {
                sidebarView.classList.add('open');
            }
        } else if (isMobile()) {
            // Mobile: mostrar apenas lista inicialmente
            showListView();
        }
    }
    
    // Executar ao carregar
    handleResize();
    
    // Executar ao redimensionar
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(handleResize, 250);
    });
    
    // Se já tem conversa selecionada, mostrar chat view em mobile
    const selectedConversationId = <?= json_encode($selectedConversationId ?? null) ?>;
    if (selectedConversationId && isMobile()) {
        setTimeout(() => {
            showChatView();
            // Mostrar botão voltar
            const backBtn = document.getElementById('chatHeaderBackBtn');
            if (backBtn) backBtn.style.display = 'flex';
        }, 100);
    }
    
    // Interceptar cliques em conversation-item para mobile
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', function(e) {
            // Se não for clique em checkbox ou botão de ação
            if (!e.target.closest('.conversation-item-actions') &&
                !e.target.closest('.dropdown')) {
                const conversationId = this.getAttribute('data-conversation-id');
                if (conversationId && isMobile()) {
                    // Aguardar um pouco para selectConversation processar
                    setTimeout(() => {
                        showChatView();
                        const backBtn = document.getElementById('chatHeaderBackBtn');
                        if (backBtn) backBtn.style.display = 'flex';
                    }, 100);
                }
            }
        });
    });
});

// Modificar selectConversation para usar navegação mobile
// Aguardar que a função seja definida
document.addEventListener('DOMContentLoaded', function() {
    // Aguardar um pouco para garantir que selectConversation foi definida
    setTimeout(function() {
        if (typeof selectConversation === 'function') {
            const originalSelectConversation = selectConversation;
            window.selectConversation = function(conversationId) {
                // Chamar função original
                originalSelectConversation(conversationId);
                
                // Em mobile, mostrar chat view após selecionar
                if (isMobile()) {
                    setTimeout(() => {
                        showChatView();
                    }, 300);
                }
            };
        }
    }, 500);
});

// Sistema de Polling já declarado acima (antes de selectConversation)

// WebSocket - Atualizar em tempo real
if (typeof window.wsClient !== 'undefined') {
    window.wsClient.on('new_message', (data) => {
        console.log('Handler new_message acionado:', data);
        const currentConversationId = window.currentConversationId ?? parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
        
        // Disparar evento personalizado para o sistema de SLA
        console.log('[WebSocket/Poll] Disparando evento realtime:new_message para SLA');
        document.dispatchEvent(new CustomEvent('realtime:new_message', { detail: data }));
        
        // Atualizar lista de conversas
        const conversationItem = document.querySelector(`[data-conversation-id="${data.conversation_id}"]`);
        if (conversationItem) {
            const preview = conversationItem.querySelector('.conversation-item-preview');
            const time = conversationItem.querySelector('.conversation-item-time');
            const badge = conversationItem.querySelector('.conversation-item-badge');
            const pinned = conversationItem.classList.contains('pinned');
            
            if (preview) {
                const content = data.message.content || '';
                const maxChars = 37;
                preview.textContent = content.substring(0, maxChars) + (content.length > maxChars ? '...' : '');
            }
            if (time) {
                const ts = data.message.created_at || new Date().toISOString();
                setTimeText(time, formatTime(ts));
                conversationItem.setAttribute('data-updated-at', ts);
            }
            
            // Atualizar badge de não lidas (se não for a conversa atual)
            if (currentConversationId != data.conversation_id) {
                const currentCount = badge ? parseInt(badge.textContent) || 0 : 0;
                if (badge) {
                    badge.textContent = currentCount + 1;
                } else {
                    const badgeHtml = `<span class="conversation-item-badge">1</span>`;
                    const meta = conversationItem.querySelector('.conversation-item-meta');
                    if (meta) meta.insertAdjacentHTML('beforeend', badgeHtml);
                }
            }
            
            // Garantir dropdown de açÁes
            ensureActionsDropdown(conversationItem, pinned, data.conversation_id);
            
            // Atualizar indicador SLA em tempo real
            if (window.SLAIndicator && data.message) {
                // Atualizar dados relevantes para SLA
                if (data.message.sender_type === 'contact') {
                    conversationItem.dataset.lastContactMessageAt = data.message.created_at;
                } else if (data.message.sender_type === 'agent') {
                    conversationItem.dataset.lastAgentMessageAt = data.message.created_at;
                }
                // Forçar atualização do indicador
                const convData = window.SLAIndicator.getConversationData(data.conversation_id);
                if (convData) {
                    window.SLAIndicator.updateConversation(data.conversation_id, convData);
                }
            }

            // Reordenar lista após atualização (respeita timestamp e pinned)
            sortConversationList();
        } else {
            // Se não existe na lista, fazer refresh para forçar render (preservando filtros)
            console.log('new_message: conversa não encontrada na lista, atualizando lista');
            const urlParams = new URLSearchParams(window.location.search);
            refreshConversationList(urlParams);
        }
        
        // Se é a conversa atual, adicionar mensagem dinamicamente
        if (currentConversationId == data.conversation_id && data.message) {
            console.group('🔧 DEBUG: Nova mensagem via WebSocket/Polling');
            console.log('Dados completos:', data);
            console.table({
                'ID': data.message.id,
                'Conteúdo': data.message.content?.substring(0, 50),
                'sender_type': data.message.sender_type,
                'direction': data.message.direction,
                'message_type': data.message.message_type,
                'type': data.message.type
            });
            
            // Validação de campos críticos
            if (!data.message.direction) {
                console.error('❌ ERRO: Campo "direction" está AUSENTE!');
            } else if (data.message.direction === 'outgoing' && data.message.sender_type === 'contact') {
                console.error('❌ ERRO: Mensagem do contato (sender_type=contact) mas direction=outgoing (deveria ser incoming)');
            } else if (data.message.direction === 'incoming' && data.message.sender_type === 'contact') {
                console.log('✓ CORRETO: Mensagem do contato com direction=incoming');
            }
            
            console.groupEnd();
            addMessageToChat(data.message);
            
            // Remover badge se existir (mensagem já foi marcada como lida no backend)
            if (badge) badge.remove();
        } else {
            // Se não é a conversa atual, atualizar lista completa e contagens das abas
            setTimeout(() => {
                refreshConversationBadges();
                refreshConversationTabs();
            }, 1000);
        }
    });
    
    // Atualizar status de mensagem via WebSocket
    window.wsClient.on('message_status_updated', (data) => {
        const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
        if (messageElement) {
            const statusElement = messageElement.querySelector('.message-status');
            if (statusElement) {
                // Buscar mensagem atualizada do servidor
                const convId = parseInt(data.conversation_id);
                const msgId = parseInt(data.message_id) || 0;
                if (!isNaN(convId)) {
                    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>/${convId}?last_message_id=${msgId}`)
                        .then(res => res.json())
                        .then(result => {
                            if (result.success && result.conversation && result.conversation.messages) {
                                const updatedMessage = result.conversation.messages.find(m => m.id == data.message_id);
                                if (updatedMessage) {
                                    // Atualizar status
                                    const newStatusHtml = renderMessageStatusHtml(updatedMessage);
                                    if (newStatusHtml) {
                                        statusElement.outerHTML = newStatusHtml;
                                    }
                                }
                            }
                        })
                        .catch(err => console.error('Erro ao atualizar status:', err));
                }
            }
        }
    });
    
    // Handler para conversa atualizada (marca como lida, etc)
    window.wsClient.on('conversation_updated', (data) => {
        if (data && data.conversation_id) {
            // Disparar evento personalizado para o sistema de SLA
            document.dispatchEvent(new CustomEvent('realtime:conversation_updated', { detail: data }));
            
            // Atualiza badge/preview/tempo
            applyConversationUpdate(data.conversation || { id: data.conversation_id, unread_count: data.unread_count });
            // Move para topo se não for a conversa atual (feito no handler abaixo)
        }
    });

    // Handler para novas conversas criadas
    window.wsClient.on('new_conversation', (data) => {
        console.log('Nova conversa recebida (WS/Poll):', data);
        
        // Disparar evento personalizado para o sistema de SLA
        document.dispatchEvent(new CustomEvent('realtime:new_conversation', { detail: data }));
        
        try {
            // Adicionar nova conversa á lista sem recarregar a pígina
            if (data.conversation) {
                // ✅ VERIFICAR PERMISSÃO DE FUNIL antes de adicionar
                if (!canViewConversationByFunnel(data.conversation)) {
                    console.log('🚫 Nova conversa bloqueada por permissões de funil - convId:', data.conversation.id);
                    return; // Não adicionar à lista
                }
                
                addConversationToList(data.conversation);
            } else {
                console.warn('new_conversation sem campo conversation', data);
            }
        } catch (err) {
            console.error('Erro ao adicionar nova conversa na lista:', err);
            // Fallback: recarregar lista por AJAX (preservando filtros)
            const urlParams = new URLSearchParams(window.location.search);
            refreshConversationList(urlParams);
        }
    });
    
    // Handler para conversa movida de etapa/funil (evento específico do KanbanAgent)
    window.wsClient.on('conversation_moved', (data) => {
        console.log('[Realtime] Conversa movida de etapa:', data);
        
        if (!data || !data.conversation_id) return;
        
        // Verificar se é a conversa atualmente aberta
        const currentConversationId = window.currentConversationId ?? parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
        
        if (currentConversationId == data.conversation_id) {
            console.log('[Realtime] Atualizando sidebar - conversa movida:', data);
            
            // Atualizar informações do sidebar em tempo real
            const funnelNameEl = document.querySelector('#sidebar-funnel-card [data-field="funnel_name"]');
            const stageBadge = document.querySelector('#sidebar-stage-badge');
            const stageTime = document.querySelector('#sidebar-stage-time');
            
            if (funnelNameEl && data.funnel_name) {
                funnelNameEl.textContent = data.funnel_name;
            }
            
            if (stageBadge && data.stage_name) {
                stageBadge.textContent = data.stage_name;
                
                // Aplicar cor da etapa (se disponível)
                if (data.stage_color) {
                    stageBadge.style.backgroundColor = data.stage_color + '20';
                    stageBadge.style.color = data.stage_color;
                    stageBadge.style.borderColor = data.stage_color;
                    
                    // Aplicar cor no card
                    const cardBody = document.querySelector('#sidebar-funnel-card .card-body');
                    if (cardBody) {
                        cardBody.style.borderLeftColor = data.stage_color;
                    }
                } else {
                    // Cor padrão
                    stageBadge.className = 'badge badge-primary';
                }
            }
            
            if (stageTime) {
                stageTime.textContent = '⏱️ Agora mesmo';
            }
        }
        
        // Verificar se a conversa está na lista atual
        const conversationItem = document.querySelector(`[data-conversation-id="${data.conversation_id}"]`);
        
        // Verificar filtros atuais
        const urlParams = new URLSearchParams(window.location.search);
        const currentFunnelFilter = urlParams.get('funnel_id');
        const currentStageFilter = urlParams.get('stage_id');
        
        // Se há filtro ativo e a conversa não pertence mais, remover
        if (conversationItem) {
            if ((currentFunnelFilter && String(data.new_stage_id || '') && data.new_funnel_id && String(data.new_funnel_id) !== currentFunnelFilter) ||
                (currentStageFilter && String(data.new_stage_id) !== currentStageFilter)) {
                console.log('[Realtime] Conversa', data.conversation_id, 'movida para fora do filtro, removendo');
                conversationItem.remove();
                return;
            }
            
            // Atualizar dados da etapa na UI
            conversationItem.dataset.stageId = data.new_stage_id || '';
            if (data.new_funnel_id) {
                conversationItem.dataset.funnelId = data.new_funnel_id;
            }
        }
        
        // Recarregar lista para garantir consistência (principalmente para sidebar)
        if (data.old_stage_id !== data.new_stage_id) {
            const urlParams = new URLSearchParams(window.location.search);
            refreshConversationList(urlParams);
        }
    });
    
    window.wsClient.on('conversation_updated', (data) => {
        // Usar variível global para refletir a conversa selecionada após navegação AJAX
        const currentConversationId = window.currentConversationId ?? parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
        
        // Se é a conversa atual
        if (currentConversationId == data.conversation_id) {
            // Atualizar sidebar se houver mudanças de funil/etapa (dados podem vir via polling)
            const conversation = data.conversation || data;
            
            if (conversation.funnel_name || conversation.stage_name || conversation.funnel_stage_id) {
                console.log('[Realtime] Atualizando sidebar via conversation_updated:', conversation);
                
                const funnelNameEl = document.querySelector('#sidebar-funnel-card [data-field="funnel_name"]');
                const stageBadge = document.querySelector('#sidebar-stage-badge');
                const stageTime = document.querySelector('#sidebar-stage-time');
                
                if (funnelNameEl && conversation.funnel_name) {
                    funnelNameEl.textContent = conversation.funnel_name;
                }
                
                if (stageBadge && conversation.stage_name) {
                    stageBadge.textContent = conversation.stage_name;
                    
                    // Aplicar cor da etapa (se disponível)
                    if (conversation.stage_color) {
                        stageBadge.style.backgroundColor = conversation.stage_color + '20';
                        stageBadge.style.color = conversation.stage_color;
                        stageBadge.style.borderColor = conversation.stage_color;
                        
                        // Aplicar cor no card
                        const cardBody = document.querySelector('#sidebar-funnel-card .card-body');
                        if (cardBody) {
                            cardBody.style.borderLeftColor = conversation.stage_color;
                        }
                    } else {
                        // Cor padrão
                        stageBadge.className = 'badge badge-primary';
                    }
                }
                
                if (stageTime) {
                    stageTime.textContent = '⏱️ Agora mesmo';
                }
            }
            
            // Recarregar página apenas se necessário (mudanças de status, atribuição)
            if (data.changes && (data.changes.status || data.changes.agent_id || data.changes.department_id)) {
                window.location.reload();
            }
            return; // Não atualizar badge se for a conversa atual
        }
        
        // Atualizar item e mover para topo (lista refletindo última atividade)
        // Se a conversa ainda não existe na lista (ex.: criada agora), criar e adicionar
        const existingItem = document.querySelector(`[data-conversation-id="${data.conversation_id}"]`);
        if (!existingItem) {
            // ✅ VERIFICAR PERMISSÃO DE FUNIL antes de adicionar
            const conversationToAdd = data.conversation || {
                id: data.conversation_id,
                last_message: data.last_message || '',
                last_message_at: data.updated_at || new Date().toISOString(),
                updated_at: data.updated_at || new Date().toISOString(),
                contact_name: data.contact_name || 'Contato',
                channel: data.channel || 'whatsapp',
                unread_count: data.unread_count || 0,
                tags_data: null,
                pinned: 0,
                funnel_id: data.funnel_id || null,
                funnel_stage_id: data.funnel_stage_id || null
            };
            
            if (!canViewConversationByFunnel(conversationToAdd)) {
                console.log('🚫 Conversa atualizada bloqueada por permissões de funil - convId:', data.conversation_id);
                return; // Não adicionar à lista
            }
            
            addConversationToList(conversationToAdd);
        } else {
            applyConversationUpdate(data.conversation || { id: data.conversation_id, unread_count: data.unread_count });
            // moveConversationToTop removido - applyConversationUpdate já ordena via sortConversationList()
        }
    });
    
    // Inscrever na conversa atual
const currentConversationId = parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    if (currentConversationId) {
        // Se a conversa foi aberta diretamente por URL, remover badge na lista
        removeConversationBadge(currentConversationId);

        // Sempre inscrever no WebSocket (quando disponível) e manter polling como fallback
        if (window.wsClient && typeof window.wsClient.subscribe === 'function') {
            try {
                window.wsClient.subscribe(currentConversationId);
            } catch (e) {
                console.error('Erro ao inscrever conversa inicial no WebSocket:', e);
            }
        }
        // Manter polling ativo para garantir entrega imediata mesmo com WS
        startPolling(currentConversationId);
    }
    // Inscrever todas as conversas visíveis (modo polling)
    subscribeVisibleConversations();
    
    // Sistema de atualização periódica da lista de conversas (para badges de não lidas)
    // Apenas se WebSocket não estiver disponível ou se estiver em modo polling/auto
    if (!window.realtimeConfig || window.realtimeConfig.connectionType !== 'websocket') {
        // Intervalo de 60 segundos (mais eficiente que 10s, badges não precisam ser tão tempo-real)
        console.log('[Badges] Iniciando polling de badges a cada 60 segundos');
        let conversationListUpdateInterval = setInterval(() => {
            refreshConversationBadges();
        }, 60000); // 60 segundos ao invés de 10
    } else {
        console.log('[Badges] WebSocket ativo, polling de badges desabilitado');
    }
    
    // Atualizar tempos relativos a cada 30 segundos
    let timeUpdateInterval = setInterval(() => {
        updateConversationTimes();
    }, 30000); // 30 segundos
    
    // Carregar funcionalidades do Assistente IA quando modal for aberto
    const aiAssistantModal = document.getElementById('kt_modal_ai_assistant');
    if (aiAssistantModal) {
        aiAssistantModal.addEventListener('show.bs.modal', function() {
            loadAIAssistantFeatures();
        });
    }
} else {
    // Se WebSocket não estiver disponível, usar polling
const currentConversationId = parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
    if (currentConversationId) {
        startPolling(currentConversationId);
    }
    
    // Sistema de atualização periódica da lista de conversas (para badges de não lidas)
    // Intervalo de 60 segundos (mais eficiente que 10s)
    console.log('[Badges] Iniciando polling de badges a cada 60 segundos (modo fallback)');
    let conversationListUpdateInterval = setInterval(() => {
        refreshConversationBadges();
    }, 60000); // 60 segundos ao invés de 10

    // Atualizar tempos relativos a cada 30 segundos (modo polling)
    let timeUpdateInterval = setInterval(() => {
        updateConversationTimes();
    }, 30000); // 30 segundos
}

// Fallback global (sempre ativo): ouvir evento disparado pelo RealtimeClient (polling)
if (!window.__realtimeGlobalNewConvListener) {
    window.__realtimeGlobalNewConvListener = true;
    window.addEventListener('realtime:new_conversation', (e) => {
        console.log('Nova conversa recebida (evento global):', e.detail);
        
        // ✅ VERIFICAR PERMISSÃO DE FUNIL antes de adicionar
        const conversation = e.detail.conversation || e.detail;
        if (!canViewConversationByFunnel(conversation)) {
            console.log('🚫 Nova conversa bloqueada por permissões de funil (evento global) - convId:', conversation.id);
            return; // Não adicionar à lista
        }
        
        // Verificar se a conversa passa pelos filtros ativos antes de adicionar
        const urlParams = new URLSearchParams(window.location.search);
        
        // Se hí filtros ativos, recarregar lista preservando filtros para incluir a nova conversa
        if (urlParams.toString().length > 0) {
            console.log('Filtros ativos detectados. Recarregando lista filtrada para incluir nova conversa.');
            refreshConversationList(urlParams);
            return;
        }
        
        try {
            addConversationToList(conversation);
        } catch (err) {
            console.error('Erro ao adicionar nova conversa (evento global):', err);
            // Preservar filtros ao recarregar
            refreshConversationList(urlParams);
        }
    });
}

/**
 * Adicionar nova conversa á lista dinamicamente (sem recarregar tudo)
 */
function addConversationToList(conv) {
    const conversationsList = document.querySelector('.conversations-list-items');
    if (!conversationsList) {
        console.error('Elemento .conversations-list-items não encontrado!');
        return;
    }

    // Verificar se a conversa já existe na lista
    const existingItem = document.querySelector(`[data-conversation-id="${conv.id}"]`);
    if (existingItem) {
        // Se já existe, apenas atualizar (applyConversationUpdate já ordena via sortConversationList)
        applyConversationUpdate(conv);
        return;
    }

    // Verificar se hí mensagem vazia ou estado de "sem conversas"
    const emptyState = conversationsList.querySelector('.text-center');
    if (emptyState) {
        conversationsList.innerHTML = '';
    }

    // Usar função consolidada para renderizar
    // ✅ CORREÇÃO: Usar window.currentConversationId como fonte primária
    const urlParams = new URLSearchParams(window.location.search);
    const selectedConversationId = window.currentConversationId || (urlParams.get('id') ? parseInt(urlParams.get('id')) : null);
    const conversationHtml = renderConversationItemHtml(conv, selectedConversationId);
    
    // Adicionar ao topo da lista
    conversationsList.insertAdjacentHTML('afterbegin', conversationHtml);
    console.log('Conversa adicionada ao topo:', conv.id);
    
    // Inscrever na nova conversa para receber atualizaçÁes
    if (typeof window.wsClient !== 'undefined') {
        if (window.wsClient.connected && window.wsClient.currentMode === 'websocket') {
            window.wsClient.subscribe(conv.id);
        }
    }
    
    // Resortear lista (respeitando pinned e updated_at)
    sortConversationList();
    
    console.log('Nova conversa adicionada á lista:', conv.id);
}

/**
 * Atualizar badges de não lidas nas conversas da lista (sem recarregar toda a lista)
 */
function refreshConversationBadges() {
    // Buscar lista atualizada de conversas - PRESERVAR TODOS OS FILTROS DA URL
    const urlParams = new URLSearchParams(window.location.search);
    
    // Criar params preservando TODOS os filtros da URL atual
    const params = new URLSearchParams();
    
    // Preservar todos os parâmetros da URL atual (incluindo arrays)
    urlParams.forEach((value, key) => {
        // Pular limit e offset - vamos forçar valores otimizados
        if (key === 'limit' || key === 'offset') {
            return;
        }
        
        // Para arrays (channels[], tag_ids[], whatsapp_account_ids[]), adicionar cada valor
        if (key.endsWith('[]')) {
            // Se já existe, adicionar mais um valor
            params.append(key, value);
        } else {
            // Parâmetros simples
            params.set(key, value);
        }
    });
    
    // ✅ ESCALABILIDADE: Limitar máximo de conversas para não sobrecarregar
    // Mesmo se usuário carregou 150+ conversas, só atualiza badges das primeiras 70
    params.set('limit', 70);  // Máximo 70 conversas
    params.set('offset', 0);  // Sempre da primeira página
    
    // Garantir que filtros bísicos tambêm sejam preservados se não estiverem na URL
    const filters = {
        status: urlParams.get('status') || '',
        channel: urlParams.get('channel') || '',
        search: urlParams.get('search') || '',
        department_id: urlParams.get('department_id') || '',
        tag_id: urlParams.get('tag_id') || '',
        agent_id: urlParams.get('agent_id') || '',
        unanswered: urlParams.get('unanswered') || '',
        answered: urlParams.get('answered') || '',
        date_from: urlParams.get('date_from') || '',
        date_to: urlParams.get('date_to') || '',
        pinned: urlParams.get('pinned') || '',
        order_by: urlParams.get('order_by') || '',
        order_dir: urlParams.get('order_dir') || ''
    };
    
    // Adicionar filtros bísicos apenas se não estiverem já nos params
    Object.keys(filters).forEach(key => {
        if (filters[key] && !params.has(key)) {
            params.append(key, filters[key]);
        }
    });
    
    // Adicionar format=json aos params
    params.append('format', 'json');
    
    fetch(`<?= \App\Helpers\Url::to('/conversations') ?>?${params.toString()}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
            throw new Error('Resposta não é JSON (refreshConversationBadges)');
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.conversations) {
            // Obter IDs das conversas que devem estar na lista (segundo o filtro atual)
            const validConversationIds = new Set(data.conversations.map(c => c.id));
            
            // Remover conversas que NâO passam pelo filtro atual
            const allConversationItems = document.querySelectorAll('.conversation-item[data-conversation-id]');
            allConversationItems.forEach(item => {
                const conversationId = parseInt(item.getAttribute('data-conversation-id'));
                const currentConversationId = window.currentConversationId ?? parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
                
                // Não remover a conversa atual
                if (conversationId === currentConversationId) {
                    return;
                }
                
                // Se a conversa não está na lista vílida, removì-la
                if (!validConversationIds.has(conversationId)) {
                    item.remove();
                }
            });
            
            // Atualizar badges de não lidas em cada conversa da lista
            data.conversations.forEach(conv => {
                const conversationItem = document.querySelector(`[data-conversation-id="${conv.id}"]`);
                // Se a conversa passou pelo filtro, mas ainda não está renderizada, adicionar agora
                if (!conversationItem) {
                    addConversationToList(conv);
                    return;
                }
                if (conversationItem) {
                    const badge = conversationItem.querySelector('.conversation-item-badge');
                    const unreadCount = conv.unread_count || 0;
                    const currentConversationId = window.currentConversationId ?? parsePhpJson('<?= json_encode($selectedConversationId ?? null, JSON_HEX_APOS | JSON_HEX_QUOT) ?>');
                    
                    // Não atualizar badge se for a conversa atual (já está sendo gerenciada separadamente)
                    if (currentConversationId == conv.id) {
                        return;
                    }
                    
                    if (unreadCount > 0) {
                        if (badge) {
                            badge.textContent = unreadCount;
                        } else {
                            // Criar badge se não existir
                            const badgeHtml = `<span class="conversation-item-badge">${unreadCount}</span>`;
                            const meta = conversationItem.querySelector('.conversation-item-meta');
                            if (meta) {
                                meta.insertAdjacentHTML('beforeend', badgeHtml);
                            }
                        }
                        // A ordenação correta será feita por sortConversationList() abaixo
                    } else {
                        // Remover badge se não houver mensagens não lidas
                        if (badge) {
                            badge.remove();
                        }
                    }
                    
                    // Atualizar preview e tempo se necessário
                    if (conv.last_message) {
                        const preview = conversationItem.querySelector('.conversation-item-preview');
                        if (preview) {
                            const maxChars = 37;
                            const content = conv.last_message.length > maxChars
                                ? conv.last_message.substring(0, maxChars) + '...'
                                : conv.last_message;
                            preview.textContent = content;
                        }
                    }
                    
                    // Atualizar datasets de SLA e datas
                    if (conv.last_contact_message_at) {
                        conversationItem.dataset.lastContactMessageAt = conv.last_contact_message_at;
                    }
                    if (conv.last_agent_message_at) {
                        conversationItem.dataset.lastAgentMessageAt = conv.last_agent_message_at;
                    }
                    // Reaplicar estado visual de SLA (borda verde quando última msg é do agente)
                    applySlaVisualState(conversationItem, conv);
                    
                    // Atualizar meta e resortear
                    updateConversationMeta(conversationItem, conv);
                    // Garantir dropdown de açÁes após updates
                    ensureActionsDropdown(conversationItem, conv.pinned === 1 || conv.pinned === true, conv.id);
                    sortConversationList();
                }
            });

            // Atualizar todos os indicadores SLA após atualizar a lista
            if (window.SLAIndicator) {
                console.log('[refreshConversationBadges] Atualizando todos os indicadores SLA');
                window.SLAIndicator.updateAllIndicators();
            }

            // Reinscrever conversas visíveis para receber eventos de polling/new_message
            subscribeVisibleConversations();
            
            // Manter o chat visível no mobile durante polling
            const chatView = document.getElementById('chatAreaView');
            if (isMobile() && window.mobileViewState === 'chat' && chatView && !chatView.classList.contains('mobile-active')) {
                showChatView();
            }
        }
    })
    .catch(error => {
        // Silenciar erros de atualização (não crítico)
        console.debug('Erro ao atualizar lista de conversas:', error);
    });
}

/**
 * Assistente IA - FunçÁes
 */

let aiAssistantFeatures = [];
let currentAIAgent = null;

function showAIAssistantModal() {
    // Verificar disponibilidade antes de abrir o modal
    checkAIAssistantAvailability().then(availability => {
        if (!availability.available) {
            // Mostrar erros de forma amigível
            const issues = availability.issues || [];
            
            if (issues.length > 0) {
                const mainIssue = issues[0];
                let message = `<strong>${escapeHtml(mainIssue.title)}</strong><br>${escapeHtml(mainIssue.message)}`;
                
                if (issues.length > 1) {
                    message += '<br><br><strong>Outros problemas encontrados:</strong><ul class="text-start mt-2">';
                    issues.slice(1).forEach(issue => {
                        message += `<li>${escapeHtml(issue.title)}: ${escapeHtml(issue.message)}</li>`;
                    });
                    message += '</ul>';
                }
                
                // Detectar tema dark
                const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                                  document.body.classList.contains('dark-mode') ||
                                  window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (mainIssue.action_url) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Assistente IA não disponível',
                        html: message,
                        confirmButtonText: mainIssue.action === 'configure_api_key' ? 'Ir para ConfiguraçÁes' : 'OK',
                        showCancelButton: true,
                        cancelButtonText: 'Cancelar',
                        buttonsStyling: false,
                        colorScheme: isDarkMode ? 'dark' : 'light',
                        customClass: {
                            confirmButton: 'btn btn-primary',
                            cancelButton: 'btn btn-light',
                            popup: isDarkMode ? 'swal2-dark' : '',
                            title: isDarkMode ? 'text-white' : '',
                            htmlContainer: isDarkMode ? 'text-white' : ''
                        }
                    }).then((result) => {
                        if (result.isConfirmed && mainIssue.action_url) {
                            window.location.href = mainIssue.action_url;
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Assistente IA não disponível',
                        html: message,
                        confirmButtonText: 'OK',
                        buttonsStyling: false,
                        colorScheme: isDarkMode ? 'dark' : 'light',
                        customClass: {
                            confirmButton: 'btn btn-primary',
                            popup: isDarkMode ? 'swal2-dark' : '',
                            title: isDarkMode ? 'text-white' : '',
                            htmlContainer: isDarkMode ? 'text-white' : ''
                        }
                    });
                }
                return;
            }
        }
        
        // Se hí warnings, mostrar mas continuar
        if (availability.warnings && availability.warnings.length > 0) {
            const warning = availability.warnings[0];
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                              document.body.classList.contains('dark-mode') ||
                              window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            Swal.fire({
                icon: 'warning',
                title: warning.title,
                text: warning.message,
                confirmButtonText: 'Continuar',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                buttonsStyling: false,
                colorScheme: isDarkMode ? 'dark' : 'light',
                customClass: {
                    confirmButton: 'btn btn-primary',
                    cancelButton: 'btn btn-light',
                    popup: isDarkMode ? 'swal2-dark' : '',
                    title: isDarkMode ? 'text-white' : '',
                    htmlContainer: isDarkMode ? 'text-white' : ''
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    openAIAssistantModal();
                }
            });
            return;
        }
        
        // Tudo OK, abrir modal
        openAIAssistantModal();
    }).catch(error => {
        console.error('Erro ao verificar disponibilidade:', error);
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                          document.body.classList.contains('dark-mode') ||
                          window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Não foi possível verificar a disponibilidade do Assistente IA. Tente novamente.',
            confirmButtonText: 'OK',
            buttonsStyling: false,
            colorScheme: isDarkMode ? 'dark' : 'light',
            customClass: {
                confirmButton: 'btn btn-primary',
                popup: isDarkMode ? 'swal2-dark' : '',
                title: isDarkMode ? 'text-white' : '',
                htmlContainer: isDarkMode ? 'text-white' : ''
            }
        });
    });
}

function openAIAssistantModal() {
    if (!currentConversationId) {
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                          document.body.classList.contains('dark-mode') ||
                          window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        Swal.fire({
            icon: 'info',
            title: 'Selecione uma conversa',
            text: 'Por favor, selecione uma conversa antes de usar o Assistente IA',
            confirmButtonText: 'OK',
            buttonsStyling: false,
            colorScheme: isDarkMode ? 'dark' : 'light',
            customClass: {
                confirmButton: 'btn btn-primary',
                popup: isDarkMode ? 'swal2-dark' : '',
                title: isDarkMode ? 'text-white' : '',
                htmlContainer: isDarkMode ? 'text-white' : ''
            }
        });
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('kt_modal_ai_assistant'));
    modal.show();
    
    // Resetar estado
    const resultsDiv = document.getElementById('aiResponseResults');
    if (resultsDiv) {
        resultsDiv.classList.add('d-none');
    }
    
    // Carregar funcionalidades disponíveis
    loadAIAssistantFeatures();
}

function checkAIAssistantAvailability() {
    const featureKey = 'generate_response'; // Funcionalidade padrão
    const url = `<?= \App\Helpers\Url::to('/ai-assistant/check-availability') ?>?conversation_id=${currentConversationId || ''}&feature_key=${featureKey}`;
    
    return fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success && !data.available) {
            // Retornar dados mesmo se não disponível para mostrar erros
            return data;
        }
        return data;
    });
}

function loadAIAssistantFeatures() {
    const loading = document.getElementById('aiAssistantLoading');
    const content = document.getElementById('aiAssistantContent');
    const error = document.getElementById('aiAssistantError');
    
    loading.classList.remove('d-none');
    content.classList.add('d-none');
    error.classList.add('d-none');
    
    fetch('<?= \App\Helpers\Url::to('/ai-assistant/features') ?>', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.classList.add('d-none');
        
        if (data.success && data.features) {
            aiAssistantFeatures = data.features;
            renderAIFeatures(data.features);
            content.classList.remove('d-none');
            
            // Obter agente selecionado para contexto atual
            loadSelectedAgent();
        } else {
            showAIError(data.message || 'Erro ao carregar funcionalidades');
        }
    })
    .catch(error => {
        loading.classList.add('d-none');
        showAIError('Erro ao carregar funcionalidades: ' + error.message);
    });
}

function renderAIFeatures(features) {
    const otherFeaturesContainer = document.getElementById('aiOtherFeatures');
    if (!otherFeaturesContainer) return;
    
    otherFeaturesContainer.innerHTML = '';
    
    // Mapear ícones para nomes mais amigíveis
    const iconMap = {
        'ki-file-down': '📁',
        'ki-tag': '🏷️',
        'ki-heart': '❤️',
        'ki-translate': '🌐',
        'ki-pencil': '✏️',
        'ki-arrow-right': '➡️',
        'ki-information': 'ℹ️'
    };
    
    features.forEach(feature => {
        // Pular "Gerar Resposta" pois já tem card dedicado
        if (feature.feature_key === 'generate_response') {
            return;
        }
        
        const icon = feature.icon || 'ki-abstract-26';
        const emoji = iconMap[icon] || '🤖';
        const cardHtml = `
            <div class="col-md-6 col-lg-4">
                <div class="card card-flush h-100 shadow-sm hover-shadow-lg transition-all">
                    <div class="card-body d-flex flex-column p-6">
                        <div class="mb-4">
                            <div class="symbol symbol-50px mb-3">
                                <div class="symbol-label bg-light-primary">
                                    <span class="fs-2x">${emoji}</span>
                                </div>
                            </div>
                            <h5 class="fw-bold mb-2">${escapeHtml(feature.name)}</h5>
                            <p class="text-muted fs-7 mb-0">${escapeHtml(feature.description || '')}</p>
                        </div>
                        <button class="btn btn-sm btn-primary w-100 mt-auto" onclick="executeAIFeature('${feature.feature_key}')">
                            <i class="ki-duotone ki-play fs-5 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Executar
                        </button>
                    </div>
                </div>
            </div>
        `;
        otherFeaturesContainer.insertAdjacentHTML('beforeend', cardHtml);
    });
}

function loadSelectedAgent() {
    if (!currentConversationId) return;
    
    const agentInfo = document.getElementById('aiAgentInfo');
    if (agentInfo) {
        agentInfo.innerHTML = '<span class="spinner-border spinner-border-sm text-primary me-2" role="status" style="width: 12px; height: 12px;"></span>Carregando agente...';
    }
    
    fetch(`<?= \App\Helpers\Url::to('/ai-assistant/selected-agent') ?>?conversation_id=${currentConversationId}&feature_key=generate_response`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.agent) {
            currentAIAgent = data.agent;
            if (agentInfo) {
                agentInfo.innerHTML = `
                    <i class="ki-duotone ki-abstract-26 fs-6 text-primary me-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                        <span class="path4"></span>
                    </i>
                    <span class="fw-semibold">${escapeHtml(data.agent.name)}</span>
                    ${data.agent.model ? `<span class="text-muted ms-2">(${escapeHtml(data.agent.model)})</span>` : ''}
                `;
            }
        } else {
            if (agentInfo) {
                agentInfo.innerHTML = '<span class="text-muted">Agente padrão</span>';
            }
        }
    })
    .catch(error => {
        console.error('Erro ao carregar agente:', error);
        if (agentInfo) {
            agentInfo.innerHTML = '<span class="text-muted">Agente padrão</span>';
        }
    });
}

function generateAIResponse() {
    if (!currentConversationId) {
        alert('Selecione uma conversa primeiro');
        return;
    }
    
    const tone = document.getElementById('aiResponseTone')?.value || 'professional';
    const count = parseInt(document.getElementById('aiResponseCount')?.value || '3');
    const resultsDiv = document.getElementById('aiResponseResults');
    const suggestionsDiv = document.getElementById('aiResponseSuggestions');
    const generateBtn = document.getElementById('aiGenerateBtn');
    
    // Desabilitar botão e mostrar loading
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.querySelector('.indicator-label').classList.add('d-none');
        generateBtn.querySelector('.indicator-progress').classList.remove('d-none');
    }
    
    // Mostrar loading nas sugestÁes
    suggestionsDiv.innerHTML = `
        <div class="text-center py-10">
            <div class="mb-4">
                <span class="spinner-border spinner-border-lg text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></span>
            </div>
            <div class="fw-semibold fs-5 mb-2">Gerando respostas inteligentes...</div>
            <div class="text-muted">Analisando o contexto da conversa</div>
        </div>
    `;
    resultsDiv.classList.remove('d-none');
    
    // Scroll para resultados
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    fetch('<?= \App\Helpers\Url::to('/ai-assistant/generate-response') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            conversation_id: currentConversationId,
            count: count,
            tone: tone
        })
    })
    .then(response => response.json())
    .then(data => {
        // Reabilitar botão
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.querySelector('.indicator-label').classList.remove('d-none');
            generateBtn.querySelector('.indicator-progress').classList.add('d-none');
        }
        
        if (data.success && data.responses) {
            let html = '';
            data.responses.forEach((response, index) => {
                const toneEmoji = {
                    'professional': '💼',
                    'friendly': '😊',
                    'formal': '👔'
                }[tone] || '💬';
                
                html += `
                    <div class="card card-flush shadow-sm mb-4 hover-shadow-lg transition-all" style="animation: fadeIn 0.3s ease-in ${index * 0.1}s both;">
                        <div class="card-body p-6">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div class="d-flex align-items-center">
                                    <span class="badge badge-light-primary badge-lg me-2">${toneEmoji} Sugestão ${index + 1}</span>
                                    ${response.tokens_used ? `<span class="badge badge-light-info badge-sm">${response.tokens_used.toLocaleString('pt-BR')} tokens</span>` : ''}
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-icon btn-light-primary" onclick="useAIResponse(${index})" title="Usar esta resposta">
                                        <i class="ki-duotone ki-check fs-3">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>
                                    <button class="btn btn-sm btn-icon btn-light" onclick="copyToClipboard('${escapeHtml(response.text).replace(/'/g, "\\'")}')" title="Copiar resposta">
                                        <i class="ki-duotone ki-copy fs-3">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-4" style="white-space: pre-wrap; line-height: 1.7;">${escapeHtml(response.text)}</div>
                            <div class="d-flex align-items-center text-muted fs-7">
                                <i class="ki-duotone ki-abstract-26 fs-6 me-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                    <span class="path4"></span>
                                </i>
                                <span class="fw-semibold me-2">${escapeHtml(response.agent_name || 'Assistente IA')}</span>
                                ${response.cost ? `<span class="text-muted">• R$ ${response.cost.toFixed(4).replace('.', ',')}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            suggestionsDiv.innerHTML = html;
            
            // Armazenar respostas para uso posterior
            window.aiGeneratedResponses = data.responses;
            
            // Scroll suave para primeira sugestão
            setTimeout(() => {
                const firstCard = suggestionsDiv.querySelector('.card');
                if (firstCard) {
                    firstCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        } else {
            suggestionsDiv.innerHTML = `
                <div class="alert alert-danger d-flex align-items-center">
                    <i class="ki-duotone ki-information-5 fs-2x me-3">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <div>
                        <div class="fw-bold">Erro ao gerar respostas</div>
                        <div class="fs-7">${escapeHtml(data.message || 'Ocorreu um erro inesperado')}</div>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        // Reabilitar botão
        if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.querySelector('.indicator-label').classList.remove('d-none');
            generateBtn.querySelector('.indicator-progress').classList.add('d-none');
        }
        
        suggestionsDiv.innerHTML = `
            <div class="alert alert-danger d-flex align-items-center">
                <i class="ki-duotone ki-information-5 fs-2x me-3">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                </i>
                <div>
                    <div class="fw-bold">Erro ao gerar respostas</div>
                    <div class="fs-7">${escapeHtml(error.message || 'Erro de conexão')}</div>
                </div>
            </div>
        `;
    });
}

function useAIResponse(index, responseId = null) {
    if (!window.aiGeneratedResponses || !window.aiGeneratedResponses[index]) {
        return;
    }
    
    const response = window.aiGeneratedResponses[index];
    
    // Mostrar preview antes de usar
    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                       document.body.classList.contains('dark-mode') ||
                       window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    // Construir HTML de forma segura
    const agentName = escapeHtml(response.agent_name || 'Assistente IA');
    const responseText = escapeHtml(response.text || '');
    const tokensText = response.tokens_used ? ' • ' + response.tokens_used.toLocaleString('pt-BR') + ' tokens' : '';
    const costText = response.cost ? ' • R$ ' + response.cost.toFixed(4).replace('.', ',') : '';
    
    const htmlContent = '<div class="text-start">' +
        '<div class="alert alert-info mb-4" style="white-space: pre-wrap; text-align: left;">' + responseText + '</div>' +
        '<div class="text-muted fs-7">' +
        '<i class="ki-duotone ki-abstract-26 fs-6 me-1">' +
        '<span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span>' +
        '</i>' +
        agentName + tokensText + costText +
        '</div>' +
        '</div>';
    
    Swal.fire({
        title: 'Preview da Resposta',
        html: htmlContent,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Usar esta Resposta',
        cancelButtonText: 'Cancelar',
        buttonsStyling: false,
        colorScheme: isDarkMode ? 'dark' : 'light',
        customClass: {
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-light',
            popup: isDarkMode ? 'swal2-dark' : '',
            title: isDarkMode ? 'text-white' : '',
            htmlContainer: isDarkMode ? 'text-white' : ''
        },
        width: '600px'
    }).then((result) => {
        if (result.isConfirmed) {
            const messageInput = document.getElementById('messageInput');
            
            if (messageInput) {
                messageInput.value = response.text;
                messageInput.focus();
                
                // Marcar como usada se tiver ID
                if (responseId) {
                    fetch('<?= \App\Helpers\Url::to('/ai-assistant/mark-as-used') ?>', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            response_id: responseId
                        })
                    }).catch(err => console.error('Erro ao marcar resposta como usada:', err));
                }
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_ai_assistant'));
                if (modal) {
                    modal.hide();
                }
            }
        }
    });
}

function loadAIResponseHistory() {
    if (!currentConversationId) {
        return;
    }
    
    const historyDiv = document.getElementById('aiResponseHistory');
    const historyContent = document.getElementById('aiResponseHistoryContent');
    const resultsDiv = document.getElementById('aiResponseResults');
    
    if (!historyDiv || !historyContent) return;
    
    // Mostrar seção de histórico e esconder resultados atuais
    historyDiv.classList.remove('d-none');
    if (resultsDiv) {
        resultsDiv.classList.add('d-none');
    }
    
    // Scroll para histórico
    historyDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    fetch(`<?= \App\Helpers\Url::to('/ai-assistant/response-history') ?>?conversation_id=${currentConversationId}&limit=20`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.history) {
            const history = data.history;
            
            if (history.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-10">
                        <i class="ki-duotone ki-time fs-3x text-muted mb-4">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        <div class="text-muted">Nenhuma resposta no histórico ainda</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            history.forEach(item => {
                const date = new Date(item.created_at);
                const formattedDate = date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const toneEmoji = {
                    'professional': '💼',
                    'friendly': '😊',
                    'formal': '👔'
                }[item.tone] || '💬';
                
                html += `
                    <div class="card card-flush shadow-sm mb-4">
                        <div class="card-body p-6">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex align-items-center">
                                    <span class="badge badge-light-primary badge-sm me-2">${toneEmoji} ${escapeHtml(item.tone || 'N/A')}</span>
                                    ${item.is_favorite ? '<span class="badge badge-light-warning badge-sm me-2">⭐ Favorita</span>' : ''}
                                    ${item.used_at ? '<span class="badge badge-light-success badge-sm">✓ Usada</span>' : ''}
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-icon btn-light-${item.is_favorite ? 'warning' : 'gray'}" 
                                            onclick="toggleFavoriteResponse(${item.id}, this)" 
                                            title="${item.is_favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                                        <i class="ki-duotone ki-star fs-5 ${item.is_favorite ? 'text-warning' : ''}">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>
                                    <button class="btn btn-sm btn-icon btn-light-primary" 
                                            onclick="useHistoryResponse(${item.id}, '${escapeHtml(item.response_text).replace(/'/g, "\\'")}')" 
                                            title="Usar esta resposta">
                                        <i class="ki-duotone ki-check fs-5">
                                            <span class="path1"></span>
                                            <span class="path2"></span>
                                        </i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3" style="white-space: pre-wrap; line-height: 1.7;">${escapeHtml(item.response_text)}</div>
                            <div class="d-flex justify-content-between align-items-center text-muted fs-7">
                                <div>
                                    <i class="ki-duotone ki-time fs-6 me-1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    ${formattedDate}
                                </div>
                                <div>
                                    ${escapeHtml(item.agent_name || 'Assistente IA')}
                                    ${item.tokens_used ? ` • ${item.tokens_used.toLocaleString('pt-BR')} tokens` : ''}
                                    ${item.cost ? ` • R$ ${parseFloat(item.cost).toFixed(4).replace('.', ',')}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyContent.innerHTML = html;
        } else {
            historyContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="ki-duotone ki-information-5 fs-2 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    Erro ao carregar histórico
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Erro ao carregar histórico:', error);
        historyContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="ki-duotone ki-information-5 fs-2 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                </i>
                Erro ao carregar histórico
            </div>
        `;
    });
}

function hideAIResponseHistory() {
    const historyDiv = document.getElementById('aiResponseHistory');
    const resultsDiv = document.getElementById('aiResponseResults');
    
    if (historyDiv) {
        historyDiv.classList.add('d-none');
    }
    if (resultsDiv) {
        resultsDiv.classList.remove('d-none');
    }
}

function toggleFavoriteResponse(responseId, buttonElement) {
    fetch('<?= \App\Helpers\Url::to('/ai-assistant/toggle-favorite') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            response_id: responseId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recarregar histórico
            loadAIResponseHistory();
        } else {
            alert('Erro ao atualizar favorito: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar favorito');
    });
}

function useHistoryResponse(responseId, responseText) {
    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                       document.body.classList.contains('dark-mode') ||
                       window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    Swal.fire({
        title: 'Preview da Resposta',
        html: `
            <div class="text-start">
                <div class="alert alert-info mb-4" style="white-space: pre-wrap; text-align: left;">${escapeHtml(responseText)}</div>
            </div>
        `,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Usar esta Resposta',
        cancelButtonText: 'Cancelar',
        buttonsStyling: false,
        colorScheme: isDarkMode ? 'dark' : 'light',
        customClass: {
            confirmButton: 'btn btn-primary',
            cancelButton: 'btn btn-light',
            popup: isDarkMode ? 'swal2-dark' : '',
            title: isDarkMode ? 'text-white' : '',
            htmlContainer: isDarkMode ? 'text-white' : ''
        },
        width: '600px'
    }).then((result) => {
        if (result.isConfirmed) {
            const messageInput = document.getElementById('messageInput');
            
            if (messageInput) {
                messageInput.value = responseText;
                messageInput.focus();
                
                // Marcar como usada
                fetch('<?= \App\Helpers\Url::to('/ai-assistant/mark-as-used') ?>', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        response_id: responseId
                    })
                }).catch(err => console.error('Erro ao marcar resposta como usada:', err));
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_ai_assistant'));
                if (modal) {
                    modal.hide();
                }
            }
        }
    });
}

function executeAIFeature(featureKey) {
    if (!currentConversationId) {
        alert('Selecione uma conversa primeiro');
        return;
    }
    
    const feature = aiAssistantFeatures.find(f => f.feature_key === featureKey);
    if (!feature) {
        alert('Funcionalidade não encontrada');
        return;
    }
    
    // Mostrar loading
    const loadingHtml = `
        <div class="text-center py-10">
            <span class="spinner-border spinner-border-lg text-primary mb-3" role="status"></span>
            <div class="text-muted">Processando...</div>
        </div>
    `;
    
    // Criar modal temporírio para mostrar resultado
    const resultModal = document.createElement('div');
    resultModal.className = 'modal fade';
    resultModal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered mw-700px">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="fw-bold">${escapeHtml(feature.name)}</h2>
                    <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                        <i class="ki-duotone ki-cross fs-1">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                    </div>
                </div>
                <div class="modal-body">
                    ${loadingHtml}
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(resultModal);
    const bsModal = new bootstrap.Modal(resultModal);
    bsModal.show();
    
    fetch('<?= \App\Helpers\Url::to('/ai-assistant/execute-feature') ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            conversation_id: currentConversationId,
            feature_key: featureKey
        })
    })
    .then(response => response.json())
    .then(data => {
        const modalBody = resultModal.querySelector('.modal-body');
        if (data.success && data.result) {
            // Renderizar resultado baseado no tipo de funcionalidade
            modalBody.innerHTML = renderAIResult(featureKey, data.result, data, currentConversationId);
        } else {
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="ki-duotone ki-information-5 fs-2 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    ${escapeHtml(data.message || 'Erro ao executar funcionalidade')}
                </div>
            `;
        }
    })
    .catch(error => {
        const modalBody = resultModal.querySelector('.modal-body');
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                <i class="ki-duotone ki-information-5 fs-2 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                </i>
                Erro: ${escapeHtml(error.message)}
            </div>
        `;
    });
    
    // Remover modal quando fechar
    resultModal.addEventListener('hidden.bs.modal', function() {
        resultModal.remove();
    });
}

function showAIError(message) {
    const error = document.getElementById('aiAssistantError');
    const errorMessage = document.getElementById('aiAssistantErrorMessage');
    
    if (error && errorMessage) {
        errorMessage.textContent = message;
        error.classList.remove('d-none');
    }
}

/**
 * Renderizar resultado do Assistente IA com formatação especial e açÁes rípidas
 */
function renderAIResult(featureKey, result, data, conversationId) {
    const agentInfo = `
        <div class="mt-3 d-flex align-items-center justify-content-between">
            <div class="text-muted fs-7">
                <i class="ki-duotone ki-abstract-26 fs-6">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                    <span class="path4"></span>
                </i>
                ${escapeHtml(data.agent_used?.name || 'Assistente IA')}
                ${data.tokens_used ? `<span class="ms-2">• ${data.tokens_used} tokens</span>` : ''}
                ${data.cost ? `<span class="ms-2">• R$ ${data.cost.toFixed(4)}</span>` : ''}
            </div>
        </div>
    `;
    
    switch (featureKey) {
        case 'suggest_tags':
            // Extrair tags do resultado (pode ser lista separada por vírgula)
            const tagsText = result.trim();
            const suggestedTags = tagsText.split(/[,;]/).map(t => t.trim()).filter(t => t);
            
            return `
                <div class="card">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">Tags Sugeridas</h5>
                        <div class="mb-4">
                            ${suggestedTags.map(tag => `
                                <span class="badge badge-lg me-2 mb-2" style="background-color: #009ef720; color: #009ef7;">
                                    ${escapeHtml(tag)}
                                </span>
                            `).join('')}
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="applySuggestedTags(${conversationId}, ${JSON.stringify(suggestedTags).replace(/"/g, '&quot;')})">
                                <i class="ki-duotone ki-check fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Aplicar Tags
                            </button>
                            <button class="btn btn-sm btn-light" onclick="copyToClipboard('${escapeHtml(tagsText).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-copy fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Copiar
                            </button>
                        </div>
                        ${agentInfo}
                    </div>
                </div>
            `;
            
        case 'translate':
            return `
                <div class="card">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">Tradução</h5>
                        <div class="alert alert-light-primary d-flex align-items-start p-4 mb-4">
                            <i class="ki-duotone ki-translate fs-2x text-primary me-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <div class="flex-grow-1" style="white-space: pre-wrap;">${escapeHtml(result)}</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="useTranslatedText('${escapeHtml(result).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-check fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Usar Tradução
                            </button>
                            <button class="btn btn-sm btn-light" onclick="copyToClipboard('${escapeHtml(result).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-copy fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Copiar
                            </button>
                        </div>
                        ${agentInfo}
                    </div>
                </div>
            `;
            
        case 'improve_grammar':
            return `
                <div class="card">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">Texto Melhorado</h5>
                        <div class="alert alert-light-success d-flex align-items-start p-4 mb-4">
                            <i class="ki-duotone ki-pencil fs-2x text-success me-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <div class="flex-grow-1" style="white-space: pre-wrap;">${escapeHtml(result)}</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" onclick="useImprovedText('${escapeHtml(result).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-check fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Usar Texto Melhorado
                            </button>
                            <button class="btn btn-sm btn-light" onclick="copyToClipboard('${escapeHtml(result).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-copy fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Copiar
                            </button>
                        </div>
                        ${agentInfo}
                    </div>
                </div>
            `;
            
        case 'analyze_sentiment':
            // Detectar sentimento no resultado
            const sentimentLower = result.toLowerCase();
            let sentimentBadge = 'secondary';
            let sentimentIcon = 'ki-information';
            if (sentimentLower.includes('positivo') || sentimentLower.includes('positive')) {
                sentimentBadge = 'success';
                sentimentIcon = 'ki-like';
            } else if (sentimentLower.includes('negativo') || sentimentLower.includes('negative')) {
                sentimentBadge = 'danger';
                sentimentIcon = 'ki-dislike';
            } else if (sentimentLower.includes('neutro') || sentimentLower.includes('neutral')) {
                sentimentBadge = 'warning';
                sentimentIcon = 'ki-information';
            }
            
            return `
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-4">
                            <span class="badge badge-${sentimentBadge} badge-lg me-3">
                                <i class="ki-duotone ${sentimentIcon} fs-6 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Anílise de Sentimento
                            </span>
                        </div>
                        <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(result)}</div>
                        ${agentInfo}
                    </div>
                </div>
            `;
            
        case 'summarize':
            return `
                <div class="card">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">
                            <i class="ki-duotone ki-file-down fs-2 text-primary me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Resumo da Conversa
                        </h5>
                        <div class="alert alert-light-primary p-4 mb-4" style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(result)}</div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-light" onclick="copyToClipboard('${escapeHtml(result).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-copy fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Copiar Resumo
                            </button>
                        </div>
                        ${agentInfo}
                    </div>
                </div>
            `;
            
        case 'extract_info':
            return `
                <div class="card">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">
                            <i class="ki-duotone ki-information fs-2 text-primary me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            InformaçÁes Extraídas
                        </h5>
                        <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(result)}</div>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-light" onclick="copyToClipboard('${escapeHtml(result).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-copy fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Copiar
                            </button>
                        </div>
                        ${agentInfo}
                    </div>
                </div>
            `;
            
        case 'suggest_next_steps':
            return `
                <div class="card">
                    <div class="card-body">
                        <h5 class="fw-bold mb-4">
                            <i class="ki-duotone ki-arrow-right fs-2 text-primary me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Próximos Passos Sugeridos
                        </h5>
                        <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(result)}</div>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-light" onclick="copyToClipboard('${escapeHtml(result).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-copy fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Copiar
                            </button>
                        </div>
                        ${agentInfo}
                    </div>
                </div>
            `;
            
        default:
            return `
                <div class="card">
                    <div class="card-body">
                        <div style="white-space: pre-wrap;">${escapeHtml(result)}</div>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-light" onclick="copyToClipboard('${escapeHtml(result).replace(/'/g, "\\'")}')">
                                <i class="ki-duotone ki-copy fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                Copiar
                            </button>
                        </div>
                        ${agentInfo}
                    </div>
                </div>
            `;
    }
}

/**
 * Aplicar tags sugeridas na conversa
 */
async function applySuggestedTags(conversationId, tags) {
    if (!conversationId || !tags || tags.length === 0) {
        alert('Nenhuma tag para aplicar');
        return;
    }
    
    // Buscar tags existentes por nome
    try {
        const tagsResponse = await fetch('<?= \App\Helpers\Url::to("/tags/all") ?>');
        const tagsData = await tagsResponse.json();
        
        if (!tagsData.success || !tagsData.tags) {
            throw new Error('Erro ao carregar tags');
        }
        
        const allTags = tagsData.tags;
        const tagsToAdd = [];
        
        // Encontrar IDs das tags sugeridas
        tags.forEach(suggestedTag => {
            const tag = allTags.find(t => t.name.toLowerCase() === suggestedTag.toLowerCase());
            if (tag) {
                tagsToAdd.push(tag.id);
            }
        });
        
        if (tagsToAdd.length === 0) {
            alert('Nenhuma das tags sugeridas foi encontrada no sistema');
            return;
        }
        
        // Adicionar tags á conversa
        const promises = tagsToAdd.map(tagId => 
            fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/tags`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ tag_id: tagId })
            })
        );
        
        await Promise.all(promises);
        
        // Fechar modal e recarregar pígina para mostrar tags aplicadas
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
        });
        
        // Mostrar mensagem de sucesso
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                          document.body.classList.contains('dark-mode') ||
                          window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        Swal.fire({
            icon: 'success',
            title: 'Tags Aplicadas',
            text: `${tagsToAdd.length} tag(s) aplicada(s) com sucesso!`,
            timer: 2000,
            showConfirmButton: false,
            colorScheme: isDarkMode ? 'dark' : 'light',
            customClass: {
                popup: isDarkMode ? 'swal2-dark' : '',
                title: isDarkMode ? 'text-white' : '',
                htmlContainer: isDarkMode ? 'text-white' : ''
            }
        });
        
        // Recarregar pígina após um breve delay
        setTimeout(() => {
            window.location.reload();
        }, 500);
        
    } catch (error) {
        console.error('Erro ao aplicar tags:', error);
        alert('Erro ao aplicar tags: ' + error.message);
    }
}

/**
 * Usar texto traduzido na mensagem
 */
function useTranslatedText(text) {
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.value = text;
        messageInput.focus();
        
        // Fechar modal
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
        });
    }
}

/**
 * Usar texto melhorado na mensagem
 */
function useImprovedText(text) {
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.value = text;
        messageInput.focus();
        
        // Fechar modal
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
        });
    }
}

/**
 * Copiar texto para írea de transferìncia
 */
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                          document.body.classList.contains('dark-mode') ||
                          window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        Swal.fire({
            icon: 'success',
            title: 'Copiado!',
            text: 'Texto copiado para írea de transferìncia',
            timer: 1500,
            showConfirmButton: false,
            colorScheme: isDarkMode ? 'dark' : 'light',
            customClass: {
                popup: isDarkMode ? 'swal2-dark' : '',
                title: isDarkMode ? 'text-white' : '',
                htmlContainer: isDarkMode ? 'text-white' : ''
            }
        });
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('Erro ao copiar texto');
    });
}

// Carregar funcionalidades quando modal for aberto
document.addEventListener('DOMContentLoaded', function() {
    const aiAssistantModal = document.getElementById('kt_modal_ai_assistant');
    if (aiAssistantModal) {
        aiAssistantModal.addEventListener('show.bs.modal', function() {
            loadAIAssistantFeatures();
        });
    }
    
    // Preservar dropdowns abertos durante atualizaçÁes
    // Usar delegação de eventos para dropdowns dinâmicos
    document.addEventListener('show.bs.dropdown', function(e) {
        const dropdown = e.target.closest('.conversation-item-actions');
        if (dropdown) {
            const conversationId = dropdown.querySelector('[data-conversation-id]')?.getAttribute('data-conversation-id');
            if (conversationId) {
                // Marcar que este dropdown está aberto
                dropdown.dataset.isOpen = 'true';
            }
        }
    });
    
    document.addEventListener('hide.bs.dropdown', function(e) {
        const dropdown = e.target.closest('.conversation-item-actions');
        if (dropdown) {
            dropdown.dataset.isOpen = 'false';
        }
    });
    
    // Inicializar seletor rípido de templates
    initTemplateQuickSelect();
    
    // Controlar visibilidade do campo de integração WhatsApp baseado no canal selecionado
    const channelSelect = document.getElementById('new_conversation_channel');
    const whatsappAccountContainer = document.getElementById('new_conversation_whatsapp_account_container');
    const whatsappAccountSelect = document.getElementById('new_conversation_whatsapp_account');
    const funnelSelect = document.getElementById('new_conversation_funnel');
    const stageSelect = document.getElementById('new_conversation_stage');
    
    if (channelSelect && whatsappAccountContainer) {
        // Função para atualizar visibilidade
        function updateWhatsAppAccountVisibility() {
            const channel = channelSelect.value;
            // Mostrar apenas para WhatsApp (não WhatsApp Oficial ou outros canais)
            if (channel === 'whatsapp') {
                whatsappAccountContainer.style.display = 'block';
                if (whatsappAccountSelect) {
                    whatsappAccountSelect.setAttribute('required', 'required');
                }
            } else {
                whatsappAccountContainer.style.display = 'none';
                if (whatsappAccountSelect) {
                    whatsappAccountSelect.removeAttribute('required');
                    whatsappAccountSelect.value = '';
                }
            }
        }
        
        // Atualizar ao mudar canal
        channelSelect.addEventListener('change', updateWhatsAppAccountVisibility);
        
        // Atualizar ao abrir modal
        const modal = document.getElementById('kt_modal_new_conversation');
        if (modal) {
            modal.addEventListener('show.bs.modal', function() {
                setTimeout(updateWhatsAppAccountVisibility, 100);
            });
        }
        
        // Atualizar inicialmente
        updateWhatsAppAccountVisibility();
    }

    // Funil / Etapa - carregar etapas conforme o funil e permissões do agente
    if (funnelSelect && stageSelect) {
        function resetStageSelect() {
            stageSelect.innerHTML = '<option value=\"\">Selecione um funil primeiro</option>';
            stageSelect.disabled = true;
        }

        async function loadStagesForFunnel(funnelId) {
            if (!funnelId) {
                resetStageSelect();
                return;
            }

            stageSelect.disabled = true;
            stageSelect.innerHTML = '<option value=\"\">Carregando etapas...</option>';

            try {
                const response = await fetch(`<?= \App\Helpers\Url::to('/funnels') ?>/${funnelId}/stages/json`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                const data = await response.json();
                if (!data.success || !data.stages) {
                    resetStageSelect();
                    return;
                }

                let options = '<option value=\"\">Selecione uma etapa...</option>';
                data.stages.forEach(stage => {
                    options += `<option value=\"${stage.id}\">${escapeHtml(stage.name || 'Etapa')}</option>`;
                });

                stageSelect.innerHTML = options;
                stageSelect.disabled = false;
            } catch (error) {
                console.error('Erro ao carregar etapas do funil:', error);
                resetStageSelect();
            }
        }

        funnelSelect.addEventListener('change', function() {
            const funnelId = this.value;
            loadStagesForFunnel(funnelId);
        });

        // Resetar etapas ao abrir modal
        const modal = document.getElementById('kt_modal_new_conversation');
        if (modal) {
            modal.addEventListener('show.bs.modal', function() {
                resetStageSelect();
                const currentFunnel = funnelSelect.value;
                if (currentFunnel) {
                    loadStagesForFunnel(currentFunnel);
                }
            });
        }
    }
    
    // Formulírio de nova conversa
    const newConversationForm = document.getElementById('newConversationForm');
    if (newConversationForm) {
        console.log('✓ Anexando listener ao formulírio de nova conversa');
        newConversationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('📤 Formulírio de nova conversa submetido');
            
            const channel = document.getElementById('new_conversation_channel').value.trim();
            const whatsappAccountId = document.getElementById('new_conversation_whatsapp_account')?.value.trim() || null;
            const name = document.getElementById('new_contact_name').value.trim();
            const phone = document.getElementById('new_contact_phone').value.trim();
            const message = document.getElementById('new_conversation_message').value.trim();
            const funnelId = document.getElementById('new_conversation_funnel')?.value.trim() || '';
            const stageId = document.getElementById('new_conversation_stage')?.value.trim() || '';
            
            console.log('👔 Dados do formulírio:', { channel, whatsappAccountId, name, phone, message, funnelId, stageId });
            
            if (!channel || !name || !phone || !message) {
                alert('Preencha todos os campos obrigatórios');
                return;
            }
            
            // Se canal for WhatsApp, validar integração
            if (channel === 'whatsapp' && !whatsappAccountId) {
                alert('Selecione uma integração WhatsApp');
                return;
            }
            
            // Normalizar telefone (remover caracteres não numéricos)
            let normalizedPhone = phone.replace(/\D/g, '');
            
            // Remover código do país 55 SOMENTE se vier com comprimento > 11 (ou seja, incluía o país)
            if (normalizedPhone.startsWith('55') && normalizedPhone.length > 11) {
                normalizedPhone = normalizedPhone.slice(2);
            }
            
            // Validar telefone (deve ter 10 ou 11 dígitos - DDD + número)
            if (normalizedPhone.length < 10 || normalizedPhone.length > 11) {
                alert('Telefone inválido. Digite DDD + número (ex: 11987654321)');
                return;
            }
            
            // Formatar telefone completo (55 + DDD + número)
            const fullPhone = '55' + normalizedPhone;
            console.log('📞 Telefone formatado:', fullPhone);
            
            const submitBtn = newConversationForm.querySelector('button[type="submit"]');
            const indicator = submitBtn.querySelector('.indicator-label');
            const progress = submitBtn.querySelector('.indicator-progress');
            
            // Mostrar loading
            submitBtn.setAttribute('data-kt-indicator', 'on');
            indicator.style.display = 'none';
            progress.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            console.log('⏳ Verificando conversas existentes...');
            
            try {
                // ✅ VERIFICAR SE JÁ EXISTE CONVERSA COM O CONTATO
                const checkResponse = await fetch('<?= \App\Helpers\Url::to("/conversations/check-existing") ?>', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ phone: fullPhone })
                });
                
                const checkData = await checkResponse.json();
                
                if (checkData.has_conversations && checkData.conversations && checkData.conversations.length > 0) {
                    // Resetar botão
                    submitBtn.removeAttribute('data-kt-indicator');
                    indicator.style.display = 'inline-block';
                    progress.style.display = 'none';
                    submitBtn.disabled = false;
                    
                    // Mostrar aviso com SweetAlert
                    const convList = checkData.conversations.map(c => 
                        `<li><strong>${c.account_phone || c.account_name}</strong> - Agente: <strong>${c.agent_name}</strong> - Status: <span class="badge badge-${c.status === 'open' ? 'success' : 'secondary'}">${c.status === 'open' ? 'Aberta' : 'Fechada'}</span></li>`
                    ).join('');
                    
                    const result = await Swal.fire({
                        icon: 'warning',
                        title: 'Já existe conversa com este contato!',
                        html: `
                            <div class="text-start">
                                <p><strong>Conversas encontradas:</strong></p>
                                <ul>${convList}</ul>
                                <p class="mt-3"><strong>Deseja continuar e criar uma nova conversa mesmo assim?</strong></p>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Sim, criar nova conversa',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#f1416c'
                    });
                    
                    if (!result.isConfirmed) {
                        return;
                    }
                    
                    // Reativar loading
                    submitBtn.setAttribute('data-kt-indicator', 'on');
                    indicator.style.display = 'none';
                    progress.style.display = 'inline-block';
                    submitBtn.disabled = true;
                }
                
                console.log('⏳ Enviando requisição para criar nova conversa...');
                
                const requestData = {
                    channel: channel,
                    name: name,
                    phone: fullPhone,
                    message: message
                };
                
                if (funnelId) {
                    requestData.funnel_id = parseInt(funnelId, 10);
                }
                if (stageId) {
                    requestData.stage_id = parseInt(stageId, 10);
                }
                
                // Adicionar whatsapp_account_id apenas se canal for WhatsApp
                if (channel === 'whatsapp' && whatsappAccountId) {
                    requestData.whatsapp_account_id = parseInt(whatsappAccountId);
                }
                
                const response = await fetch('<?= \App\Helpers\Url::to("/conversations/new") ?>', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('📥 Resposta HTTP:', response.status, response.statusText);
                
                const responseText = await response.text();
                console.log('📁 Resposta texto (primeiros 500 chars):', responseText.substring(0, 500));
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('✓ Resposta JSON parseada:', data);
                } catch (jsonErr) {
                    console.error('❌ Erro ao fazer parse do JSON:', jsonErr);
                    throw new Error(`Resposta não é JSON. HTTP ${response.status}. Corpo: ${responseText.substring(0, 500)}`);
                }
                
                if (data.success) {
                    console.log('✓ Conversa criada com sucesso!', data);
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_new_conversation'));
                    if (modal) modal.hide();
                    
                    // Limpar formulírio
                    newConversationForm.reset();
                    
                    // Redirecionar para a nova conversa (com status=open para garantir que apareça)
                    if (data.conversation_id) {
                        console.log('🔄 Redirecionando para conversa:', data.conversation_id);
                        window.location.href = '<?= \App\Helpers\Url::to("/conversations") ?>?status=open&id=' + data.conversation_id;
                    } else {
                        console.log('🔄 Recarregando lista de conversas...');
                        // Recarregar lista de conversas
                        refreshConversationList();
                        
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'success',
                                title: 'Conversa criada!',
                                text: 'Mensagem enviada com sucesso',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000
                            });
                        }
                    }
                } else {
                    console.error('Erro na resposta:', data);
                    
                    // ✅ NOVO: Tratamento específico por código de erro
                    if (data.code === 'conversation_exists_other_agent' && data.can_request_participation) {
                        // Conversa existe e está atribuída a outro agente - oferecer opções
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'info',
                                title: 'Conversa já existe',
                                html: `
                                    <div class="text-start">
                                        <p class="mb-3">${data.message}</p>
                                        <div class="d-flex align-items-center mb-3 p-3 bg-light-primary rounded">
                                            <i class="ki-duotone ki-profile-user fs-2x text-primary me-3">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                                <span class="path3"></span>
                                            </i>
                                            <div>
                                                <div class="fw-bold">Agente atribuído:</div>
                                                <div class="text-gray-600">${data.existing_agent_name || 'Não identificado'}</div>
                                            </div>
                                        </div>
                                        <p class="text-muted fs-7">Você pode solicitar participação nesta conversa ou visualizá-la.</p>
                                    </div>
                                `,
                                showDenyButton: true,
                                showCancelButton: true,
                                confirmButtonText: '<i class="ki-duotone ki-send fs-4 me-1"><span class="path1"></span><span class="path2"></span></i> Solicitar Participação',
                                denyButtonText: '<i class="ki-duotone ki-eye fs-4 me-1"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i> Ver Conversa',
                                cancelButtonText: 'Cancelar',
                                confirmButtonColor: '#009ef7',
                                denyButtonColor: '#50cd89',
                                customClass: {
                                    confirmButton: 'btn btn-primary',
                                    denyButton: 'btn btn-success',
                                    cancelButton: 'btn btn-light'
                                }
                            }).then((result) => {
                                if (result.isConfirmed && data.existing_conversation_id) {
                                    // Solicitar participação
                                    requestParticipation(data.existing_conversation_id, data.existing_agent_name);
                                } else if (result.isDenied && data.existing_conversation_id) {
                                    // Ir para a conversa
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_new_conversation'));
                                    if (modal) modal.hide();
                                    window.location.href = '<?= \App\Helpers\Url::to("/conversations") ?>?id=' + data.existing_conversation_id;
                                }
                            });
                        } else {
                            if (confirm(data.message + '\n\nDeseja ver a conversa existente?')) {
                                window.location.href = '<?= \App\Helpers\Url::to("/conversations") ?>?id=' + data.existing_conversation_id;
                            }
                        }
                    } else if (data.code === 'conversation_exists_unassigned' && data.can_view) {
                        // Conversa existe mas não está atribuída - oferecer ir para ela
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'info',
                                title: 'Conversa já existe',
                                html: `
                                    <p>${data.message}</p>
                                    <p class="text-muted fs-7">Deseja ir para esta conversa?</p>
                                `,
                                showCancelButton: true,
                                confirmButtonText: '<i class="ki-duotone ki-arrow-right fs-4 me-1"><span class="path1"></span><span class="path2"></span></i> Ir para Conversa',
                                cancelButtonText: 'Cancelar',
                                confirmButtonColor: '#009ef7'
                            }).then((result) => {
                                if (result.isConfirmed && data.existing_conversation_id) {
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_new_conversation'));
                                    if (modal) modal.hide();
                                    window.location.href = '<?= \App\Helpers\Url::to("/conversations") ?>?id=' + data.existing_conversation_id;
                                }
                            });
                        } else {
                            if (confirm(data.message + '\n\nDeseja ir para esta conversa?')) {
                                window.location.href = '<?= \App\Helpers\Url::to("/conversations") ?>?id=' + data.existing_conversation_id;
                            }
                        }
                    } else if (data.existing_agent) {
                        // Fallback: tratamento antigo para compatibilidade
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Conversa já atribuída',
                                html: `<p>${data.message}</p>`,
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#009ef7'
                            });
                        } else {
                            alert(data.message);
                        }
                    } else {
                        alert('Erro ao criar conversa: ' + (data.message || 'Erro desconhecido'));
                    }
                }
            } catch (error) {
                console.error('Erro capturado:', error);
                alert('Erro ao criar conversa: ' + error.message);
            } finally {
                console.log('Finalizando requisição, escondendo loading...');
                // Esconder loading
                submitBtn.removeAttribute('data-kt-indicator');
                indicator.style.display = 'inline-block';
                progress.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    } else {
        console.warn('Formulírio newConversationForm não encontrado');
    }
    
    // Formulírio de agendar mensagem
    const scheduleMessageForm = document.getElementById('scheduleMessageForm');
    if (scheduleMessageForm) {
        scheduleMessageForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const conversationId = document.getElementById('schedule_conversation_id').value;
            const content = document.getElementById('schedule_message_content').value;
            const date = document.getElementById('schedule_message_date').value;
            const time = document.getElementById('schedule_message_time').value;
            const cancelIfResolved = document.getElementById('schedule_cancel_if_resolved').checked;
            const cancelIfResponded = document.getElementById('schedule_cancel_if_responded').checked;
            
            if (!content.trim() && !document.getElementById('schedule_message_attachment').files.length) {
                alert('Digite uma mensagem ou anexe um arquivo');
                return;
            }
            
            if (!date || !time) {
                alert('Selecione data e hora');
                return;
            }
            
            const scheduledAt = `${date} ${time}:00`;
            const scheduledDate = new Date(scheduledAt);
            const now = new Date();
            
            if (scheduledDate <= now) {
                alert('Data/hora deve ser no futuro');
                return;
            }
            
            const formData = new FormData();
            formData.append('content', content);
            formData.append('scheduled_at', scheduledAt);
            formData.append('cancel_if_resolved', cancelIfResolved ? '1' : '0');
            formData.append('cancel_if_responded', cancelIfResponded ? '1' : '0');
            
            // Adicionar anexo se houver
            const attachment = document.getElementById('schedule_message_attachment').files[0];
            if (attachment) {
                formData.append('attachment', attachment);
            }
            
            try {
                const response = await fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/schedule-message`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (jsonErr) {
                    throw new Error(`Resposta não é JSON. HTTP ${response.status}. Corpo: ${responseText.substring(0, 500)}`);
                }
                
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_schedule_message'));
                    if (modal) modal.hide();
                    
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Mensagem agendada!',
                            text: `Mensagem será enviada em ${new Date(scheduledAt).toLocaleString('pt-BR')}`,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                    }
                } else {
                    alert('Erro ao agendar mensagem: ' + (data.message || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao agendar mensagem: ' + error.message);
            }
        });
    }
    
    // Mostrar modal de mensagens agendadas
    window.showScheduledMessagesModal = function() {
        const conversationId = window.currentConversationId;
        if (!conversationId) {
            alert('Nenhuma conversa selecionada');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('kt_modal_scheduled_messages'));
        modal.show();
        
        // Carregar mensagens
        loadScheduledMessages();
        
        // Configurar filtros
        const filterInputs = document.querySelectorAll('input[name="scheduled_status_filter"]');
        filterInputs.forEach(input => {
            input.addEventListener('change', function() {
                loadScheduledMessages(this.value);
            });
        });
    };
    
    // Carregar mensagens agendadas
    async function loadScheduledMessages(status = '') {
        const conversationId = window.currentConversationId;
        if (!conversationId) return;
        
        const listContainer = document.getElementById('scheduledMessagesList');
        listContainer.innerHTML = '<div class="text-center py-10"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';
        
        try {
            const url = `<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/scheduled-messages${status ? '?status=' + status : ''}`;
            const response = await fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                const messages = data.messages || [];
                
                if (messages.length === 0) {
                    listContainer.innerHTML = `
                        <div class="text-center py-10">
                            <i class="ki-duotone ki-calendar fs-3x text-muted mb-5">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <h5 class="text-muted">Nenhuma mensagem agendada</h5>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                messages.forEach(msg => {
                    const scheduledDate = new Date(msg.scheduled_at);
                    const formattedDate = scheduledDate.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let statusBadge = '';
                    let statusClass = '';
                    let actionButtons = '';
                    
                    switch(msg.status) {
                        case 'pending':
                            statusBadge = '<span class="badge badge-light-warning">Pendente</span>';
                            statusClass = 'border-warning';
                            actionButtons = `<button class="btn btn-sm btn-light-danger" onclick="cancelScheduledMessage(${msg.id})">Cancelar</button>`;
                            break;
                        case 'sent':
                            statusBadge = '<span class="badge badge-light-success">Enviada</span>';
                            statusClass = 'border-success';
                            break;
                        case 'cancelled':
                            statusBadge = '<span class="badge badge-light-danger">Cancelada</span>';
                            statusClass = 'border-danger';
                            break;
                        case 'failed':
                            statusBadge = '<span class="badge badge-light-dark">Falhou</span>';
                            statusClass = 'border-dark';
                            break;
                    }
                    
                    const content = msg.content || '';
                    const truncatedContent = content.length > 100 ? content.substring(0, 100) + '...' : content;
                    
                    html += `
                        <div class="card mb-3 ${statusClass}" style="border-left: 4px solid;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <span class="fw-bold text-gray-800 fs-6">
                                            <i class="ki-duotone ki-calendar fs-5 me-1">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                            ${formattedDate}
                                        </span>
                                    </div>
                                    <div>
                                        ${statusBadge}
                                    </div>
                                </div>
                                <div class="text-gray-700 mb-3">${escapeHtml(truncatedContent)}</div>
                                ${msg.error_message ? `<div class="alert alert-danger mb-3 py-2">${escapeHtml(msg.error_message)}</div>` : ''}
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        ${msg.cancel_if_resolved ? '<i class="ki-duotone ki-check-circle fs-6 text-info me-1"><span class="path1"></span><span class="path2"></span></i>Cancelar se resolvida ' : ''}
                                        ${msg.cancel_if_responded ? '<i class="ki-duotone ki-message-text fs-6 text-info me-1"><span class="path1"></span><span class="path2"></span></i>Cancelar se respondida' : ''}
                                    </small>
                                    <div>
                                        ${actionButtons}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = `
                    <div class="alert alert-danger">
                        ${data.message || 'Erro ao carregar mensagens'}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Erro:', error);
            listContainer.innerHTML = `
                <div class="alert alert-danger">
                    Erro ao carregar mensagens: ${error.message}
                </div>
            `;
        }
    }
    
    // Cancelar mensagem agendada
    window.cancelScheduledMessage = async function(messageId) {
        const conversationId = window.currentConversationId;
        if (!conversationId) return;
        
        const result = await Swal.fire({
            title: 'Confirmar cancelamento',
            text: 'Deseja cancelar esta mensagem agendada?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, cancelar',
            cancelButtonText: 'Não',
            customClass: {
                confirmButton: 'btn btn-danger',
                cancelButton: 'btn btn-light'
            }
        });
        
        if (!result.isConfirmed) return;
        
        try {
            const response = await fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/scheduled-messages/${messageId}`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Sucesso!',
                    text: 'Mensagem cancelada com sucesso',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                
                // Recarregar lista
                const activeFilter = document.querySelector('input[name="scheduled_status_filter"]:checked');
                loadScheduledMessages(activeFilter ? activeFilter.value : '');
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: data.message || 'Erro ao cancelar mensagem'
                });
            }
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'Erro ao cancelar mensagem: ' + error.message
            });
        }
    };
    
    // Função auxiliar para escapar HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Máscara de telefone brasileiro (DDD + número)
    const phoneInput = document.getElementById('new_contact_phone');
    if (phoneInput) {
        const formatPhone = (digits) => {
            const v = digits.slice(0, 11);
            if (v.length <= 2) return `(${v}`;
            if (v.length <= 6) return `(${v.slice(0, 2)}) ${v.slice(2)}`;
            if (v.length <= 10) return `(${v.slice(0, 2)}) ${v.slice(2, 6)}-${v.slice(6, 10)}`;
            return `(${v.slice(0, 2)}) ${v.slice(2, 3)} ${v.slice(3, 7)}-${v.slice(7, 11)}`;
        };
        
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é dígito
            value = value.substring(0, 11); // Limita a 11 dígitos
            e.target.value = formatPhone(value);
        });
    }
    
    // Formulírio de criar lembrete
    const reminderForm = document.getElementById('reminderForm');
    if (reminderForm) {
        reminderForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const conversationId = document.getElementById('reminder_conversation_id').value;
            const date = document.getElementById('reminder_date').value;
            const time = document.getElementById('reminder_time').value;
            const note = document.getElementById('reminder_note').value;
            
            if (!date || !time) {
                alert('Selecione data e hora');
                return;
            }
            
            const reminderAt = `${date} ${time}:00`;
            const reminderDate = new Date(reminderAt);
            const now = new Date();
            
            if (reminderDate <= now) {
                alert('Data/hora deve ser no futuro');
                return;
            }
            
            try {
                const response = await fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/reminders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        reminder_at: reminderAt,
                        note: note || null
                    })
                });
                
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (jsonErr) {
                    throw new Error(`Resposta não é JSON. HTTP ${response.status}. Corpo: ${responseText.substring(0, 500)}`);
                }
                
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_reminder'));
                    if (modal) modal.hide();
                    
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Lembrete criado!',
                            text: `Lembrete será exibido em ${new Date(reminderAt).toLocaleString('pt-BR')}`,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                    }
                } else {
                    alert('Erro ao criar lembrete: ' + (data.message || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao criar lembrete: ' + error.message);
            }
        });
    }
    
    // Inicializar seletor rípido de variíveis (ao digitar {{)
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('input', function(e) {
            const value = e.target.value;
            const cursorPos = e.target.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);
            
            // Se digitar {{, mostrar seletor rípido de templates ou variíveis
            if (textBeforeCursor.endsWith('{{')) {
                // Mostrar seletor rípido de templates (pode ser expandido para variíveis tambêm)
                showTemplateQuickSelect();
            }
        });
    }
});

// ============================================
// SISTEMA DE ABAS DE CONVERSAS
// ============================================

// Cache das tags carregadas
window._allTagsCache = null;
window._allTagsCacheTime = 0;

/**
 * Função consolidada para renderizar um item de conversa (usada por refreshConversationList e addConversationToList)
 */
function renderConversationItemHtml(conv, selectedConversationId) {
    const channelInfo = getChannelInfo(conv.channel || 'chat');
    const channelIcon = channelInfo.icon;
    const channelName = channelInfo.name;
    
    const isActive = selectedConversationId == conv.id;
    const nameRaw = conv.contact_name || 'NN';
    const maxName = 22;
    const name = nameRaw.length > maxName ? nameRaw.substring(0, maxName) + '...' : nameRaw;
    const parts = nameRaw.split(' ');
    const initials = (parts[0].charAt(0) + (parts[1] ? parts[1].charAt(0) : '')).toUpperCase();
    
    const lastMessage = conv.last_message || '';
    const maxCharsPreview = 37;
    const lastMessagePreview = lastMessage.length > maxCharsPreview ? lastMessage.substring(0, maxCharsPreview) + '...' : lastMessage;
    
    const unreadCount = conv.unread_count || 0;
    const pinned = conv.pinned || 0;
    
    // Tags
    let tagsHtml = '';
    if (conv.tags_data) {
        const tags = conv.tags_data.split('|||');
        tags.slice(0, 2).forEach(tagStr => {
            const [tagId, tagName, tagColor] = tagStr.split(':');
            if (tagName) {
                tagsHtml += `<span class="badge badge-sm" style="background-color: ${tagColor || '#009ef7'}20; color: ${tagColor || '#009ef7'};">${escapeHtml(tagName)}</span>`;
            }
        });
    }
    
    const avatarHtml = conv.contact_avatar
        ? `<div class="symbol-label"><img src="${escapeHtml(conv.contact_avatar)}" alt="${escapeHtml(name)}" class="h-45px w-45px rounded" style="object-fit: cover;"></div>`
        : `<div class="symbol-label bg-light-primary text-primary fw-bold">${initials}</div>`;

    const firstResponseAt = conv.first_response_at_calc || conv.first_response_at || '';
    const lastContactAt = conv.last_contact_message_at || '';
    const lastAgentAt = conv.last_agent_message_at || '';
    const createdAt = conv.created_at || '';
    const lastMessageAt = conv.last_message_at || conv.updated_at || '';

    // Search match (se existir)
    let searchMatchHtml = '';
    if (conv.search_match_type) {
        const matchLabel = conv.search_match_type === 'name' ? 'Nome' : 
                          conv.search_match_type === 'phone' ? 'Telefone' : 
                          conv.search_match_type === 'email' ? 'Email' : 
                          conv.search_match_type === 'tag' ? 'Tag' :
                          conv.search_match_type === 'participant' ? 'Participante' : 'Mensagem';
        searchMatchHtml = `
            <div class="conversation-item-search-match mt-1">
                <span class="badge badge-sm badge-light-info">
                    <i class="ki-duotone ki-magnifier fs-7 me-1"><span class="path1"></span><span class="path2"></span></i>
                    ${matchLabel}: 
                    <span class="fw-semibold">${escapeHtml((conv.search_match_text || '').substring(0, 40))}${(conv.search_match_text || '').length > 40 ? '...' : ''}</span>
                </span>
            </div>`;
    }

    return `
        <div class="conversation-item ${isActive ? 'active' : ''} ${pinned ? 'pinned' : ''}" 
             data-conversation-id="${conv.id}"
             data-status="${escapeHtml(conv.status || 'open')}"
             data-created-at="${escapeHtml(createdAt)}"
             data-first-response-at="${escapeHtml(firstResponseAt)}"
             data-last-message-at="${escapeHtml(lastMessageAt)}"
             data-last-contact-message-at="${escapeHtml(lastContactAt)}"
             data-last-agent-message-at="${escapeHtml(lastAgentAt)}"
             data-agent-id="${escapeHtml(conv.agent_id || '')}"
             data-updated-at="${lastMessageAt || new Date().toISOString()}"
             data-onclick="selectConversation">
            <div class="d-flex gap-3 w-100">
                <div class="symbol symbol-45px flex-shrink-0">
                    ${avatarHtml}
                </div>
                <div class="flex-grow-1 min-w-0">
                    <div class="conversation-item-header">
                        <div class="conversation-item-name d-flex align-items-center gap-2">
                            ${pinned ? '<i class="ki-duotone ki-pin fs-7 text-warning" title="Fixada"><span class="path1"></span><span class="path2"></span></i>' : ''}
                            ${conv.is_spam ? '<span class="badge badge-sm badge-danger" title="Marcada como spam">SPAM</span>' : ''}
                            ${escapeHtml(name)}
                        </div>
                        <div class="conversation-item-time d-flex align-items-center gap-2">
                            ${formatTime(conv.last_message_at || conv.updated_at)}
                            <div class="dropdown conversation-item-actions">
                                <button type="button" class="btn btn-sm btn-icon btn-light p-0" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false"
                                        onclick="event.stopPropagation();">
                                    <i class="ki-duotone ki-setting-2 text-muted">
                                        <span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span>
                                    </i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" data-conversation-id="${conv.id}">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="event.stopPropagation(); togglePin(${conv.id}, ${pinned ? 'true' : 'false'}); return false;">
                                            <i class="ki-duotone ki-pin fs-7 me-2 ${pinned ? 'text-warning' : ''}"><span class="path1"></span><span class="path2"></span></i>
                                            ${pinned ? 'Desfixar' : 'Fixar'}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="event.stopPropagation(); markConversationAsRead(${conv.id}); return false;">
                                            <i class="ki-duotone ki-check fs-7 me-2 text-success"><span class="path1"></span><span class="path2"></span></i>
                                            Marcar como Lido
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="event.stopPropagation(); markConversationAsUnread(${conv.id}); return false;">
                                            <i class="ki-duotone ki-eye-slash fs-7 me-2 text-danger"><span class="path1"></span><span class="path2"></span></i>
                                            Marcar como Não Lido
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="event.stopPropagation(); showReminderModal(${conv.id}); return false;">
                                            <i class="ki-duotone ki-notification-bing fs-7 me-2 text-primary"><span class="path1"></span><span class="path2"></span></i>
                                            Agendar Lembrete
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="dropdown-submenu">
                                        <a class="dropdown-item d-flex align-items-center justify-content-between" href="#" onclick="event.stopPropagation(); event.preventDefault(); toggleSetAsSubmenu(this, ${conv.id});">
                                            <span>
                                                <i class="ki-duotone ki-tag fs-7 me-2 text-info"><span class="path1"></span><span class="path2"></span></i>
                                                Setar como
                                            </span>
                                            <i class="ki-duotone ki-right fs-8 ms-2"><span class="path1"></span><span class="path2"></span></i>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="conversation-item-preview">${escapeHtml(lastMessagePreview || 'Sem mensagens')}</div>
                    ${searchMatchHtml}
                    <div class="conversation-item-meta">
                        <span class="conversation-item-channel">${channelIcon} ${channelName}</span>
                        <span class="conversation-item-tags d-flex gap-1 flex-wrap">${tagsHtml}</span>
                        ${unreadCount > 0 ? `<span class="conversation-item-badge">${unreadCount}</span>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * Alternar submenu "Setar como" no dropdown do gear icon
 */
function toggleSetAsSubmenu(triggerEl, conversationId) {
    // Remover submenu anterior se existir
    const existingSubmenu = triggerEl.closest('ul').querySelector('.set-as-submenu');
    if (existingSubmenu) {
        existingSubmenu.remove();
        return;
    }

    // Criar submenu inline
    const submenuContainer = document.createElement('div');
    submenuContainer.className = 'set-as-submenu px-3 py-2';
    submenuContainer.style.cssText = 'max-height: 250px; overflow-y: auto;';
    submenuContainer.innerHTML = `
        <div class="d-flex align-items-center justify-content-center py-2">
            <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
            <span class="ms-2 fs-7 text-muted">Carregando tags...</span>
        </div>
    `;
    
    // Inserir após o item "Setar como"
    triggerEl.closest('li').after(submenuContainer);

    // Carregar tags
    loadTagsForSetAs(submenuContainer, conversationId);
}

/**
 * Carregar tags para o submenu "Setar como"
 */
async function loadTagsForSetAs(container, conversationId) {
    try {
        // Usar cache se disponível (5 min)
        const now = Date.now();
        if (window._allTagsCache && (now - window._allTagsCacheTime) < 300000) {
            renderSetAsSubmenu(container, window._allTagsCache, conversationId);
            return;
        }

        const response = await fetch('<?= \App\Helpers\Url::to("/tags/all") ?>', {
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success && data.tags) {
            window._allTagsCache = data.tags;
            window._allTagsCacheTime = now;
            renderSetAsSubmenu(container, data.tags, conversationId);
        } else {
            container.innerHTML = '<div class="text-muted fs-7 py-2">Erro ao carregar tags</div>';
        }
    } catch (error) {
        console.error('Erro ao carregar tags:', error);
        container.innerHTML = '<div class="text-danger fs-7 py-2">Erro ao carregar</div>';
    }
}

/**
 * Renderizar o submenu com a lista de tags
 */
function renderSetAsSubmenu(container, tags, conversationId) {
    let html = '<div class="fs-8 fw-semibold text-muted mb-2">Selecione a tag:</div>';
    
    if (tags.length === 0) {
        html += '<div class="text-muted fs-7 py-1">Nenhuma tag disponível</div>';
    } else {
        tags.forEach(tag => {
            html += `
                <a href="#" class="d-flex align-items-center gap-2 py-1 px-2 rounded text-gray-800 text-hover-primary" 
                   style="text-decoration: none; font-size: 12px;"
                   onclick="event.preventDefault(); event.stopPropagation(); setConversationTag(${conversationId}, ${tag.id}, '${escapeHtml(tag.name)}', '${escapeHtml(tag.color || '#009ef7')}');">
                    <span class="rounded-circle d-inline-block" style="width: 10px; height: 10px; background-color: ${escapeHtml(tag.color || '#009ef7')};"></span>
                    ${escapeHtml(tag.name)}
                </a>`;
        });
    }
    
    html += `<hr class="my-2">
        <a href="#" class="d-flex align-items-center gap-2 py-1 px-2 rounded text-primary fw-semibold" 
           style="text-decoration: none; font-size: 12px;"
           onclick="event.preventDefault(); event.stopPropagation(); showCreateTabModal(${conversationId});">
            <i class="ki-duotone ki-plus fs-7"><span class="path1"></span><span class="path2"></span></i>
            Criar nova aba
        </a>`;
    
    container.innerHTML = html;
}

/**
 * Setar tag na conversa e adicionar como aba se ainda não for
 */
async function setConversationTag(conversationId, tagId, tagName, tagColor) {
    try {
        // Fechar dropdown
        document.querySelectorAll('.dropdown-menu.show').forEach(m => {
            const dropdown = bootstrap.Dropdown.getInstance(m.previousElementSibling) || 
                           bootstrap.Dropdown.getOrCreateInstance(m.previousElementSibling);
            if (dropdown) dropdown.hide();
        });

        // Adicionar tag à conversa
        const response = await fetch(`<?= \App\Helpers\Url::to("/conversations") ?>/${conversationId}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({ tag_id: tagId })
        });
        const data = await response.json();
        
        if (data.success) {
            // Adicionar como aba do usuário (se não for)
            await fetch('<?= \App\Helpers\Url::to("/conversation-tabs") ?>', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify({ tag_id: tagId })
            });

            // Atualizar abas e lista
            await refreshConversationTabs();
            
            // Atualizar tags visíveis no item da conversa
            const convItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (convItem) {
                const tagsContainer = convItem.querySelector('.conversation-item-tags');
                if (tagsContainer) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-sm';
                    badge.style.cssText = `background-color: ${tagColor}20; color: ${tagColor};`;
                    badge.textContent = tagName;
                    tagsContainer.appendChild(badge);
                }
            }

            // Toast de sucesso
            if (typeof Swal !== 'undefined') {
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `Tag "${tagName}" adicionada`, showConfirmButton: false, timer: 2000 });
            }
        } else {
            if (typeof Swal !== 'undefined') {
                Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: data.message || 'Erro ao setar tag', showConfirmButton: false, timer: 3000 });
            }
        }
    } catch (error) {
        console.error('Erro ao setar tag:', error);
    }
}

/**
 * Alternar aba ativa na listagem de conversas
 */
function switchConversationTab(tabEl) {
    // Atualizar estado visual
    document.querySelectorAll('.conversation-tab').forEach(t => t.classList.remove('active'));
    tabEl.classList.add('active');
    
    const tagId = tabEl.dataset.tagId;
    
    // Salvar aba ativa no localStorage
    localStorage.setItem('activeConversationTab', tagId || 'all');
    
    // ✅ CORREÇÃO: Preservar conversa atualmente aberta
    const preservedConversationId = window.currentConversationId;
    
    // Aplicar filtro por tag
    const params = new URLSearchParams(window.location.search);
    
    if (tagId) {
        params.set('tag_id', tagId);
    } else {
        params.delete('tag_id');
    }
    
    // ✅ CORREÇÃO: Manter o ID da conversa aberta na URL
    if (preservedConversationId) {
        params.set('id', preservedConversationId);
    }
    
    // Sincronizar dropdown de filtro de tags
    const filterTag = document.getElementById('filter_tag');
    if (filterTag) {
        filterTag.value = tagId || '';
    }
    
    // Resetar paginação
    params.delete('offset');
    
    // Atualizar URL sem recarregar
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.history.replaceState({}, '', newUrl);
    
    // Resetar assinatura para forçar re-render
    window.lastConversationListSignature = null;
    
    // ✅ CORREÇÃO: NÃO alterar currentConversationId nem o chat ao trocar de aba
    // O refreshConversationList vai preservar o estado active baseado em window.currentConversationId
    refreshConversationList(params);
}

/**
 * Atualizar abas via API (recarrega contagens)
 */
async function refreshConversationTabs() {
    try {
        const response = await fetch('<?= \App\Helpers\Url::to("/conversation-tabs") ?>', {
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success && data.tabs) {
            const tabsList = document.getElementById('conversationTabsList');
            if (!tabsList) return;
            
            const activeTab = localStorage.getItem('activeConversationTab') || 'all';
            
            const totalCount = data.total_count || 0;
            
            let html = `
                <button type="button" class="btn btn-sm conversation-tab ${activeTab === 'all' ? 'active' : ''}" 
                        data-tab-id="all" data-tag-id="" onclick="switchConversationTab(this)">
                    <span class="tab-name">Todas</span>
                    ${totalCount > 0 ? `<span class="tab-count">${totalCount}</span>` : ''}
                </button>`;
            
            data.tabs.forEach(tab => {
                const isActive = activeTab === String(tab.tag_id);
                html += `
                    <button type="button" class="btn btn-sm conversation-tab ${isActive ? 'active' : ''}" 
                            data-tab-id="${tab.id}" data-tag-id="${tab.tag_id}"
                            onclick="switchConversationTab(this)">
                        <span class="tab-color-dot" style="background-color: ${escapeHtml(tab.tag_color || '#009ef7')};"></span>
                        <span class="tab-name">${escapeHtml(tab.tag_name)}</span>
                        ${tab.conversation_count > 0 ? `<span class="tab-count">${tab.conversation_count}</span>` : ''}
                    </button>`;
            });
            
            html += `
                <button type="button" class="btn btn-sm btn-icon conversation-tab-add" 
                        title="Gerenciar abas" onclick="showManageTabsModal()">
                    <i class="ki-duotone ki-plus fs-7"><span class="path1"></span><span class="path2"></span></i>
                </button>`;
            
            tabsList.innerHTML = html;
        }
    } catch (error) {
        console.error('Erro ao atualizar abas:', error);
    }
}

/**
 * Modal para gerenciar abas (adicionar/remover)
 */
async function showManageTabsModal() {
    try {
        // Carregar tags disponíveis e abas atuais
        const [tagsRes, tabsRes] = await Promise.all([
            fetch('<?= \App\Helpers\Url::to("/tags/all") ?>', { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } }),
            fetch('<?= \App\Helpers\Url::to("/conversation-tabs") ?>', { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } })
        ]);
        
        const tagsData = await tagsRes.json();
        const tabsData = await tabsRes.json();
        
        const allTags = tagsData.success ? tagsData.tags : [];
        const userTabs = tabsData.success ? tabsData.tabs : [];
        const tabTagIds = userTabs.map(t => t.tag_id);
        
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        
        let tagsListHtml = '';
        allTags.forEach(tag => {
            const isTab = tabTagIds.includes(tag.id);
            tagsListHtml += `
                <div class="d-flex align-items-center justify-content-between py-2 px-3 rounded mb-1 ${isTab ? 'bg-light-primary' : 'bg-hover-light'}">
                    <div class="d-flex align-items-center gap-2">
                        <span class="rounded-circle d-inline-block" style="width: 12px; height: 12px; background-color: ${escapeHtml(tag.color || '#009ef7')};"></span>
                        <span class="fw-semibold">${escapeHtml(tag.name)}</span>
                        ${tag.description ? `<span class="text-muted fs-8">${escapeHtml(tag.description)}</span>` : ''}
                    </div>
                    <button type="button" class="btn btn-sm ${isTab ? 'btn-light-danger' : 'btn-light-primary'}" 
                            onclick="toggleTabTag(${tag.id}, ${isTab}, this)">
                        ${isTab ? '<i class="ki-duotone ki-cross fs-7"><span class="path1"></span><span class="path2"></span></i> Remover' : '<i class="ki-duotone ki-plus fs-7"><span class="path1"></span><span class="path2"></span></i> Adicionar'}
                    </button>
                </div>`;
        });
        
        Swal.fire({
            title: 'Gerenciar Abas',
            html: `
                <div class="text-start">
                    <p class="text-muted fs-7 mb-3">Selecione quais tags deseja usar como abas na listagem de conversas.</p>
                    <div class="mb-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="ki-duotone ki-magnifier fs-7"><span class="path1"></span><span class="path2"></span></i></span>
                            <input type="text" class="form-control form-control-sm" placeholder="Filtrar tags..." 
                                   oninput="filterManageTabsTags(this.value)">
                        </div>
                    </div>
                    <div id="manageTabsTagsList" style="max-height: 450px; overflow-y: auto;">
                        ${tagsListHtml}
                    </div>
                    <hr class="my-3">
                    <div class="d-flex align-items-center gap-2">
                        <input type="text" id="newTabTagName" class="form-control form-control-sm" placeholder="Nova aba (nome da tag)">
                        <input type="color" id="newTabTagColor" class="form-control form-control-sm form-control-color" value="#009EF7" style="width: 40px; padding: 2px;">
                        <button type="button" class="btn btn-sm btn-primary text-nowrap" onclick="createNewTabFromModal()">
                            <i class="ki-duotone ki-plus fs-7"><span class="path1"></span><span class="path2"></span></i> Criar
                        </button>
                    </div>
                </div>`,
            showConfirmButton: false,
            showCloseButton: true,
            width: 520,
            customClass: { 
                popup: isDarkMode ? 'swal2-dark' : '',
                htmlContainer: 'swal2-html-container-tabs'
            }
        });
    } catch (error) {
        console.error('Erro ao abrir gerenciador de abas:', error);
    }
}

/**
 * Filtrar tags no modal de gerenciamento
 */
function filterManageTabsTags(search) {
    const container = document.getElementById('manageTabsTagsList');
    if (!container) return;
    const items = container.querySelectorAll('.d-flex.align-items-center.justify-content-between');
    items.forEach(item => {
        const name = item.querySelector('.fw-semibold')?.textContent || '';
        item.style.display = name.toLowerCase().includes(search.toLowerCase()) ? '' : 'none';
    });
}

/**
 * Toggle tag como aba (adicionar/remover)
 */
async function toggleTabTag(tagId, isCurrentlyTab, btnEl) {
    try {
        btnEl.disabled = true;
        
        const url = isCurrentlyTab 
            ? '<?= \App\Helpers\Url::to("/conversation-tabs/remove") ?>'
            : '<?= \App\Helpers\Url::to("/conversation-tabs") ?>';
        
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({ tag_id: tagId })
        });
        const data = await response.json();
        
        if (data.success) {
            // Atualizar botão no modal
            const container = btnEl.closest('.d-flex.align-items-center.justify-content-between');
            if (isCurrentlyTab) {
                container.classList.remove('bg-light-primary');
                btnEl.className = 'btn btn-sm btn-light-primary';
                btnEl.innerHTML = '<i class="ki-duotone ki-plus fs-7"><span class="path1"></span><span class="path2"></span></i> Adicionar';
                btnEl.onclick = function() { toggleTabTag(tagId, false, this); };
            } else {
                container.classList.add('bg-light-primary');
                btnEl.className = 'btn btn-sm btn-light-danger';
                btnEl.innerHTML = '<i class="ki-duotone ki-cross fs-7"><span class="path1"></span><span class="path2"></span></i> Remover';
                btnEl.onclick = function() { toggleTabTag(tagId, true, this); };
            }
            
            // Atualizar barra de abas
            await refreshConversationTabs();
        }
        
        btnEl.disabled = false;
    } catch (error) {
        console.error('Erro ao alternar aba:', error);
        btnEl.disabled = false;
    }
}

/**
 * Criar nova tag + aba a partir do modal de gerenciamento
 */
async function createNewTabFromModal() {
    const nameInput = document.getElementById('newTabTagName');
    const colorInput = document.getElementById('newTabTagColor');
    
    if (!nameInput || !nameInput.value.trim()) {
        nameInput?.focus();
        return;
    }
    
    try {
        const response = await fetch('<?= \App\Helpers\Url::to("/conversation-tabs/create") ?>', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({ 
                name: nameInput.value.trim(), 
                color: colorInput?.value || '#009EF7' 
            })
        });
        const data = await response.json();
        
        if (data.success) {
            // Invalidar cache de tags
            window._allTagsCache = null;
            
            // Fechar modal e reabrir atualizado
            Swal.close();
            await refreshConversationTabs();
            
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `Aba "${nameInput.value.trim()}" criada!`, showConfirmButton: false, timer: 2000 });
        } else {
            Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: data.message || 'Erro ao criar aba', showConfirmButton: false, timer: 3000 });
        }
    } catch (error) {
        console.error('Erro ao criar aba:', error);
    }
}

/**
 * Modal de criação rápida de aba (a partir do "Setar como" no gear icon)
 */
function showCreateTabModal(conversationId) {
    // Fechar dropdown
    document.querySelectorAll('.dropdown-menu.show').forEach(m => {
        const dropdown = bootstrap.Dropdown.getInstance(m.previousElementSibling);
        if (dropdown) dropdown.hide();
    });

    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    
    Swal.fire({
        title: 'Criar Nova Aba',
        html: `
            <div class="text-start">
                <div class="mb-3">
                    <label class="form-label fs-7">Nome da aba (tag)</label>
                    <input type="text" id="quickTabName" class="form-control form-control-sm" placeholder="Ex: Urgente, VIP, Aguardando...">
                </div>
                <div class="mb-3">
                    <label class="form-label fs-7">Cor</label>
                    <input type="color" id="quickTabColor" class="form-control form-control-sm form-control-color" value="#009EF7" style="width: 60px;">
                </div>
            </div>`,
        confirmButtonText: 'Criar e Setar',
        showCancelButton: true,
        cancelButtonText: 'Cancelar',
        customClass: { popup: isDarkMode ? 'swal2-dark' : '' },
        preConfirm: async () => {
            const name = document.getElementById('quickTabName')?.value?.trim();
            const color = document.getElementById('quickTabColor')?.value || '#009EF7';
            
            if (!name) {
                Swal.showValidationMessage('Nome é obrigatório');
                return false;
            }
            
            try {
                const response = await fetch('<?= \App\Helpers\Url::to("/conversation-tabs/create") ?>', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ name, color, conversation_id: conversationId })
                });
                const data = await response.json();
                
                if (!data.success) {
                    Swal.showValidationMessage(data.message || 'Erro ao criar');
                    return false;
                }
                return data;
            } catch (error) {
                Swal.showValidationMessage('Erro de conexão');
                return false;
            }
        }
    }).then(async (result) => {
        if (result.isConfirmed && result.value) {
            window._allTagsCache = null;
            await refreshConversationTabs();
            
            // Atualizar tags visíveis no item
            const tag = result.value.tag;
            if (tag) {
                const convItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (convItem) {
                    const tagsContainer = convItem.querySelector('.conversation-item-tags');
                    if (tagsContainer) {
                        const badge = document.createElement('span');
                        badge.className = 'badge badge-sm';
                        badge.style.cssText = `background-color: ${tag.color || '#009ef7'}20; color: ${tag.color || '#009ef7'};`;
                        badge.textContent = tag.name;
                        tagsContainer.appendChild(badge);
                    }
                }
            }
            
            // Recarregar lista
            const urlParams = new URLSearchParams(window.location.search);
            refreshConversationList(urlParams);
        }
    });
}

// ============================================
// RESTAURAR ABA ATIVA NO CARREGAMENTO
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    const savedTab = localStorage.getItem('activeConversationTab');
    if (savedTab && savedTab !== 'all') {
        const tabBtn = document.querySelector(`.conversation-tab[data-tag-id="${savedTab}"]`);
        if (tabBtn) {
            switchConversationTab(tabBtn);
        }
    }
    
    // Atualizar contagens das abas a cada 60 segundos
    setInterval(() => {
        refreshConversationTabs();
    }, 60000);
});

// Formulírio de edição de contato
const editContactForm = document.getElementById('editContactForm');
if (editContactForm) {
    editContactForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const contactId = document.getElementById('editContactId').value;
        if (!contactId) {
            return;
        }
        
        // Validação customizada - apenas nome é obrigatório
        const nameField = document.getElementById('editContactName');
        const emailField = document.getElementById('editContactEmail');
        
        // Resetar estados de validação
        nameField.classList.remove('is-invalid');
        emailField.classList.remove('is-invalid');
        
        let hasError = false;
        
        // Validar nome (obrigatório)
        if (!nameField.value || nameField.value.trim() === '') {
            nameField.classList.add('is-invalid');
            hasError = true;
        }
        
        // Validar email apenas se preenchido (formato básico)
        if (emailField.value && emailField.value.trim() !== '') {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailField.value)) {
                emailField.classList.add('is-invalid');
                if (!emailField.nextElementSibling || !emailField.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = 'Por favor, informe um email válido.';
                    emailField.parentNode.insertBefore(feedback, emailField.nextElementSibling);
                }
                hasError = true;
            }
        }
        
        if (hasError) {
            return;
        }
        
        const formData = new FormData(this);
        
        // Remover o campo telefone do envio (não pode ser editado)
        formData.delete('phone');
        
        // Mostrar loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
        
        fetch(`<?= \App\Helpers\Url::to('/contacts') ?>/${contactId}`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('kt_modal_edit_contact'));
                if (modal) {
                    modal.hide();
                }
                
                // Atualizar interface com novos dados
                if (data.contact) {
                    const contact = data.contact;
                    
                    // 1. Atualizar window.currentConversation com novos dados
                    if (window.currentConversation && window.currentConversation.contact_id == contactId) {
                        window.currentConversation.contact_name = contact.name;
                        window.currentConversation.contact_email = contact.email || '';
                        window.currentConversation.contact_phone = contact.phone || '';
                        window.currentConversation.contact_city = contact.city || '';
                        window.currentConversation.contact_country = contact.country || '';
                        window.currentConversation.contact_company = contact.company || '';
                        window.currentConversation.contact_bio = contact.bio || '';
                    }
                    
                    // 2. Atualizar todos os elementos no sidebar
                    const sidebar = document.getElementById('kt_conversation_sidebar');
                    if (sidebar) {
                        // Nome em todos os lugares
                        sidebar.querySelectorAll('[data-field="contact_name"]').forEach(el => {
                            el.textContent = contact.name || '-';
                        });
                        
                        // Email
                        sidebar.querySelectorAll('[data-field="contact_email"]').forEach(el => {
                            el.textContent = contact.email || '-';
                        });
                        
                        // Telefone
                        sidebar.querySelectorAll('[data-field="contact_phone"]').forEach(el => {
                            el.textContent = contact.phone || '-';
                        });
                        
                        // Cidade
                        sidebar.querySelectorAll('[data-field="contact_city"]').forEach(el => {
                            el.textContent = contact.city || '-';
                        });
                        
                        // País
                        sidebar.querySelectorAll('[data-field="contact_country"]').forEach(el => {
                            el.textContent = contact.country || '-';
                        });
                        
                        // Empresa
                        sidebar.querySelectorAll('[data-field="contact_company"]').forEach(el => {
                            el.textContent = contact.company || '-';
                        });
                        
                        // Bio
                        sidebar.querySelectorAll('[data-field="contact_bio"]').forEach(el => {
                            el.textContent = contact.bio || '-';
                        });
                        
                        // Atualizar iniciais do avatar
                        const initialsEl = sidebar.querySelector('#sidebar-contact-initials');
                        if (initialsEl && contact.name) {
                            const nameParts = contact.name.trim().split(/\s+/);
                            let initials = 'NN';
                            if (nameParts.length === 1) {
                                initials = nameParts[0].substring(0, 2).toUpperCase();
                            } else {
                                initials = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                            }
                            initialsEl.textContent = initials;
                        }
                    }
                    
                    // 3. Atualizar nome do contato na lista de conversas
                    if (window.currentConversationId) {
                        const conversationItem = document.querySelector(`[data-conversation-id="${window.currentConversationId}"]`);
                        if (conversationItem) {
                            const nameEl = conversationItem.querySelector('.conversation-item-name');
                            if (nameEl) {
                                nameEl.textContent = contact.name || 'Sem nome';
                            }
                            
                            // Atualizar iniciais no avatar da lista também
                            const listAvatar = conversationItem.querySelector('.symbol-label');
                            if (listAvatar && contact.name) {
                                const nameParts = contact.name.trim().split(/\s+/);
                                let initials = 'NN';
                                if (nameParts.length === 1) {
                                    initials = nameParts[0].substring(0, 2).toUpperCase();
                                } else {
                                    initials = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                                }
                                listAvatar.textContent = initials;
                            }
                        }
                    }
                    
                    // 4. Atualizar cabeçalho do chat (nome do contato)
                    const chatHeader = document.getElementById('chat-header-contact-name');
                    if (chatHeader) {
                        chatHeader.textContent = contact.name || 'Sem nome';
                    }
                }
                
                const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                                   document.body.classList.contains('dark-mode') ||
                                   window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                Swal.fire({
                    icon: 'success',
                    title: 'Sucesso!',
                    text: data.message || 'Contato atualizado com sucesso',
                    colorScheme: isDarkMode ? 'dark' : 'light',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.message || 'Erro ao atualizar contato');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                               document.body.classList.contains('dark-mode') ||
                               window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: error.message || 'Erro ao atualizar contato',
                colorScheme: isDarkMode ? 'dark' : 'light'
            });
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
}

/**
 * Atualizar banner de IA ativa no topo do chat
 */
function updateAIActiveBanner(status, conversationId) {
    const banner = document.getElementById('aiActiveBanner');
    if (!banner) return;
    
    if (status.has_ai && status.ai_agent) {
        const aiAgent = status.ai_agent;
        const aiConv = status.ai_conversation;
        
        // Obter iniciais do agente
        const parts = aiAgent.name.split(' ');
        const initials = (parts[0].charAt(0) + (parts[1] ? parts[1].charAt(0) : '')).toUpperCase();
        
        // Atualizar conteúdo do banner
        const nameEl = banner.querySelector('.ai-agent-name');
        const typeEl = banner.querySelector('.ai-agent-type');
        const countEl = banner.querySelector('.ai-messages-count');
        
        if (nameEl) nameEl.textContent = aiAgent.name;
        if (typeEl) typeEl.textContent = aiAgent.type || 'GENERAL';
        if (countEl) {
            const count = status.messages_count || 0;
            countEl.textContent = `${count} ${count === 1 ? 'mensagem' : 'mensagens'}`;
        }
        
        // Atualizar onclick dos botÁes
        const historyBtn = document.getElementById('aiHistoryButton');
        const removeBtn = document.getElementById('removeAIButton');
        
        if (historyBtn) {
            historyBtn.onclick = function() {
                if(typeof showAIHistory === 'function') {
                    showAIHistory();
                } else {
                    console.error('showAIHistory não está disponível');
                }
            };
        }
        if (removeBtn) {
            removeBtn.onclick = function() {
                if(typeof removeAIAgent === 'function') {
                    removeAIAgent();
                } else {
                    console.error('removeAIAgent não está disponível');
                }
            };
        }
        
        // Mostrar banner
        banner.classList.remove('d-none');
        banner.style.display = '';
    } else {
        // Ocultar banner
        banner.classList.add('d-none');
        banner.style.display = 'none';
    }
}

// Função para atualizar mêtricas do agente atual
function updateAgentMetrics() {
    fetch('<?= \App\Helpers\Url::to('/conversations/metrics/current-agent') ?>', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.metrics) {
            const metrics = data.metrics;
            
            // Atualizar tempo primeira resposta
            const firstResponseEl = document.getElementById('metric-first-response');
            if (firstResponseEl) {
                const minutes = metrics.avg_first_response_minutes || 0;
                if (minutes > 0) {
                    if (minutes < 1) {
                        firstResponseEl.textContent = '< 1 min';
                    } else {
                        firstResponseEl.textContent = `${minutes.toFixed(1)} min`;
                    }
                } else {
                    firstResponseEl.textContent = '-';
                }
            }
            
            // Atualizar tempo de respostas
            const responseEl = document.getElementById('metric-response');
            if (responseEl) {
                const minutes = metrics.avg_response_minutes || 0;
                if (minutes > 0) {
                    if (minutes < 1) {
                        responseEl.textContent = '< 1 min';
                    } else {
                        responseEl.textContent = `${minutes.toFixed(1)} min`;
                    }
                } else {
                    responseEl.textContent = '-';
                }
            }
            
            // Atualizar SLA primeira resposta
            const slaFirstEl = document.getElementById('metric-sla-first-response');
            if (slaFirstEl) {
                const rate = metrics.sla_first_response_rate || 0;
                const slaMinutes = metrics.sla_first_response_minutes || 15;
                if (rate > 0) {
                    slaFirstEl.textContent = `${rate.toFixed(1)}% (${slaMinutes} min)`;
                    // Cor baseada na taxa
                    if (rate >= 90) {
                        slaFirstEl.className = 'fw-bold text-success';
                    } else if (rate >= 70) {
                        slaFirstEl.className = 'fw-bold text-warning';
                    } else {
                        slaFirstEl.className = 'fw-bold text-danger';
                    }
                } else {
                    slaFirstEl.textContent = `- (${slaMinutes} min)`;
                    slaFirstEl.className = 'fw-bold text-muted';
                }
            }
            
            // Atualizar SLA Respostas
            const slaResponseEl = document.getElementById('metric-sla-response');
            if (slaResponseEl) {
                const rate = metrics.sla_response_rate || 0;
                const slaMinutes = metrics.sla_response_minutes || 15;
                if (rate > 0) {
                    slaResponseEl.textContent = `${rate.toFixed(1)}% (${slaMinutes} min)`;
                    // Cor baseada na taxa
                    if (rate >= 90) {
                        slaResponseEl.className = 'fw-bold text-success';
                    } else if (rate >= 70) {
                        slaResponseEl.className = 'fw-bold text-warning';
                    } else {
                        slaResponseEl.className = 'fw-bold text-danger';
                    }
                } else {
                    slaResponseEl.textContent = `- (${slaMinutes} min)`;
                    slaResponseEl.className = 'fw-bold text-muted';
                }
            }
        }
    })
    .catch(error => {
        console.error('Erro ao atualizar mêtricas:', error);
    });
}

// Atualizar mêtricas ao carregar a pígina
document.addEventListener('DOMContentLoaded', function() {
    updateAgentMetrics();
    
    // Atualizar a cada 30 segundos
    setInterval(updateAgentMetrics, 30000);
});
</script>

<!-- SLA Indicator JavaScript -->
<script src="<?= \App\Helpers\Url::asset('js/custom/sla-indicator.js') ?>"></script>

<!-- Realtime Coaching Container -->
<div id="coaching-hints-container" class="coaching-hints-container"></div>

<!-- Realtime Coaching já incluído no layout principal (app.php) -->

<!-- WooCommerce Sidebar Bootstrap -->
<script>
// Garantir que os handlers do WooCommerce sejam registrados mesmo em carregamentos dinâmicos
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 WooCommerce sidebar bootstrap iniciado');

    let wooAttempts = 0;

    function tryInitWooSidebar() {
        wooAttempts += 1;
        const sidebarLoaded = typeof window.loadWooCommerceOrders === 'function';
        const integrationFilter = document.getElementById('woocommerce-integration-filter');
        const statusFilter = document.getElementById('woocommerce-status-filter');
        const refreshBtn = document.getElementById('btn-refresh-woocommerce-orders');

        console.log(`[Woo Init] Tentativa ${wooAttempts} | func loaded: ${sidebarLoaded} | elementos => integration:${!!integrationFilter} status:${!!statusFilter} refresh:${!!refreshBtn}`);

        // Se ainda não temos a função ou elementos, tentar de novo em 500ms
        if (!sidebarLoaded || (!integrationFilter && !statusFilter && !refreshBtn)) {
            setTimeout(tryInitWooSidebar, 500);
            return;
        }

        console.log('✅ WooCommerce sidebar detectada. Função carregada?', sidebarLoaded);

        // Registrar listeners apenas uma vez
        if (integrationFilter && !integrationFilter.dataset.wooInit) {
            integrationFilter.addEventListener('change', () => window.loadWooCommerceOrders && window.loadWooCommerceOrders());
            integrationFilter.dataset.wooInit = '1';
            console.log('✅ Listener do filtro de integração registrado (bootstrap)');
        }

        if (statusFilter && !statusFilter.dataset.wooInit) {
            statusFilter.addEventListener('change', () => window.loadWooCommerceOrders && window.loadWooCommerceOrders());
            statusFilter.dataset.wooInit = '1';
            console.log('✅ Listener do filtro de status registrado (bootstrap)');
        }

        if (refreshBtn && !refreshBtn.dataset.wooInit) {
            refreshBtn.addEventListener('click', () => window.loadWooCommerceOrders && window.loadWooCommerceOrders());
            refreshBtn.dataset.wooInit = '1';
            console.log('✅ Listener do botão de atualizar registrado (bootstrap)');
        }

        // Carregar integrações imediatamente para popular o select
        if (typeof window.loadWooCommerceIntegrations === 'function') {
            console.log('🔍 Bootstrap: carregando integrações WooCommerce...');
            window.loadWooCommerceIntegrations();
        } else {
            console.warn('⚠️ Bootstrap: loadWooCommerceIntegrations não disponível');
        }
    }

    tryInitWooSidebar();

    // Fallback: tentar carregar integrações mesmo sem encontrar sidebar (evitar cache vazio)
    setTimeout(() => {
        if (typeof window.loadWooCommerceIntegrations === 'function') {
            console.log('⏱️ Fallback: carregando integrações WooCommerce (2s)...');
            window.loadWooCommerceIntegrations();
        } else {
            console.warn('⚠️ Fallback: loadWooCommerceIntegrations ainda não disponível');
        }
    }, 2000);

    // Fallback definitivo: se a função ainda não existir após 3s, registramos uma implementação mínima
    setTimeout(() => {
        if (typeof window.loadWooCommerceOrders === 'function') {
            return;
        }

        console.warn('⚠️ Fallback: registrando funções WooCommerce diretamente no index (sidebar JS pode não ter carregado)');

        window.loadWooCommerceIntegrations = window.loadWooCommerceIntegrations || function() {
            const filterSelect = document.getElementById('woocommerce-integration-filter');
            if (!filterSelect) return;

            // Se já carregamos com sucesso, não repetir
            if (filterSelect.dataset.loaded === '1') {
                return;
            }
            
            // Evitar chamadas múltiplas durante carregamento (race condition)
            if (filterSelect.dataset.loading === '1') {
                return;
            }
            
            filterSelect.dataset.loading = '1';

            // Limpar opções anteriores mantendo placeholder
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }

            // Estado de carregamento
            const placeholder = filterSelect.options[0];
            placeholder.textContent = 'Carregando lojas...';
            filterSelect.disabled = true;

            fetch('<?= \App\Helpers\Url::to('/integrations/woocommerce') ?>', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(r => r.json())
            .then(data => {
                // Usar Map para garantir unicidade por ID
                const uniqueIntegrations = new Map();
                if (data.integrations && Array.isArray(data.integrations)) {
                    data.integrations.forEach(integration => {
                        if (integration.id && !uniqueIntegrations.has(integration.id)) {
                            uniqueIntegrations.set(integration.id, integration);
                        }
                    });
                    uniqueIntegrations.forEach(integration => {
                        const opt = document.createElement('option');
                        opt.value = integration.id;
                        opt.textContent = integration.name;
                        filterSelect.appendChild(opt);
                    });
                    filterSelect.dataset.loaded = '1';
                } else {
                    filterSelect.dataset.loaded = '0';
                }
            })
            .catch(err => {
                console.error('Woo Fallback: erro ao carregar integrações', err);
                filterSelect.dataset.loaded = '0';
            })
            .finally(() => {
                placeholder.textContent = 'Todas as lojas';
                filterSelect.disabled = false;
                filterSelect.dataset.loading = '0';
            });
        };

        window.loadWooCommerceOrders = function() {
            const ordersList = document.getElementById('woocommerce-orders-list');
            if (!ordersList) return;

            const conversationId = window.currentConversationId || null;
            const contactId = window.currentConversation?.contact_id || document.getElementById('conversationSidebar')?.dataset?.contactId || null;

            if (!conversationId || !contactId) {
                ordersList.innerHTML = '<div class="text-muted fs-7">Selecione uma conversa primeiro</div>';
                return;
            }

            const integrationFilter = document.getElementById('woocommerce-integration-filter')?.value || '';
            const statusFilter = document.getElementById('woocommerce-status-filter')?.value || '';

            ordersList.innerHTML = '<div class="text-muted fs-7">Carregando pedidos...</div>';

            let url = `<?= \App\Helpers\Url::to('/integrations/woocommerce/contacts') ?>/${contactId}/orders`;
            if (integrationFilter) {
                url += `?integration_id=${integrationFilter}`;
            }

            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar pedidos');
                }

                const orders = data.orders || [];
                let filtered = orders;
                if (statusFilter) {
                    filtered = orders.filter(o => o.status === statusFilter);
                }

                if (!filtered.length) {
                    ordersList.innerHTML = '<div class="text-center py-5 text-muted fs-7">Nenhum pedido encontrado</div>';
                    return;
                }

                let html = '<div class="d-flex flex-column gap-3">';
                filtered.forEach(order => {
                    const total = parseFloat(order.total || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    const statusLabels = {
                        'pending': 'Pendente',
                        'processing': 'Processando',
                        'on-hold': 'Em espera',
                        'completed': 'Concluído',
                        'cancelled': 'Cancelado',
                        'refunded': 'Reembolsado',
                        'failed': 'Falhou'
                    };
                    const statusColors = {
                        'pending': 'warning',
                        'processing': 'info',
                        'on-hold': 'warning',
                        'completed': 'success',
                        'cancelled': 'danger',
                        'refunded': 'secondary',
                        'failed': 'danger'
                    };
                    const statusLabel = statusLabels[order.status] || order.status || '-';
                    const statusColor = statusColors[order.status] || 'secondary';
                    
                    // Gerar URL do painel WooCommerce
                    const adminUrl = order.integration_url 
                        ? `${order.integration_url}/wp-admin/post.php?post=${order.id}&action=edit` 
                        : null;
                    
                    html += `
                        <div class="card card-flush card-hover">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <div class="fw-bold fs-6 text-gray-800">Pedido #${order.id || '-'}</div>
                                        <div class="fs-7 text-muted">${order.date_created || ''}</div>
                                        ${order.integration_name ? `<div class="fs-8 text-muted">${order.integration_name}</div>` : ''}
                                    </div>
                                    <span class="badge badge-light-${statusColor}">${statusLabel}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="fs-5 fw-bold text-primary">${total}</div>
                                    ${order.number ? `<div class="fs-7 text-muted">Nº ${order.number}</div>` : ''}
                                </div>
                                ${adminUrl ? `
                                    <div class="mt-3 pt-3 border-top">
                                        <a href="${adminUrl}" target="_blank" class="btn btn-sm btn-light-primary w-100">
                                            <i class="ki-duotone ki-exit-right-corner fs-5 me-1">
                                                <span class="path1"></span>
                                                <span class="path2"></span>
                                            </i>
                                            Ver no painel
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                ordersList.innerHTML = html;

                // Garantir que integrações apareçam
                window.loadWooCommerceIntegrations();
            })
            .catch(err => {
                console.error('Woo Fallback: erro ao carregar pedidos', err);
                ordersList.innerHTML = `<div class="text-center py-5 text-danger fs-7">Erro ao carregar pedidos<br><small>${err.message}</small></div>`;
            });
        };

        // Após registrar fallback, carregar apenas as integrações (pedidos só ao clicar na aba)
        window.loadWooCommerceIntegrations();
    }, 3000);
});
</script>

<!-- Mockup Generator Modal e Scripts -->
<?php include __DIR__ . '/mockup-modal.php'; ?>
<link rel="stylesheet" href="/assets/css/mockup-editor.css">
<script src="/assets/js/mockup-wizard.js"></script>
<script src="/assets/js/mockup-canvas-editor.js"></script>

<?php $content = ob_get_clean(); ?>

<?php include __DIR__ . '/../layouts/metronic/app.php'; ?>



